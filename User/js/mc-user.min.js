var g_catalog=[{name:"用户管理",icon:"user.png",link:"user_info.html"},{name:"用户订阅",icon:"rss.png",link:"user_subscribe.html"},{name:"服务管理",icon:"service.png",link:"user_service.html"},{name:"地图管理",icon:"map-mgr.png",link:"user_map.html"},{name:"文件管理",icon:"file.png",link:"user_file.html"},{name:"矢量数据",icon:"db.png",link:"user_vector.html"},{name:"影像数据",icon:"raster.png",link:"user_raster.html"},{name:"瓦片数据",icon:"tile.png",link:"user_tile.html"}];
MapCloud.AccountPanel=MapCloud.Class({loginPanel:null,loginName:null,registerPanel:null,registerName:null,initialize:function(n,e){this.loginPanel=$("."+n),this.registerPanel=$("."+e);var i=this;this.loginPanel.find(".btn-account").click(function(){i.login()}),this.loginPanel.find(".btn-register").click(function(){i.hideLoginPanel(),i.hideUserpPanel(),i.showRegisterPanel()}),this.loginPanel.find("input[name='password']").keypress(function(n){13==n.which&&i.login()}),this.registerPanel.find(".btn-account").click(function(){i.register()}),this.registerPanel.find(".btn-login").click(function(){i.hideRegisterPanel(),i.hideUserpPanel(),i.showLoginPanel()}),this.registerPanel.find("input[name='repassword']").keypress(function(n){13==n.which&&i.register()})},showLoginPanel:function(){this.loginName=null,this.loginPanel.css("display","block"),this.loginPanel.find("input").val(""),this.loginPanel.find("input").first().focus()},hideLoginPanel:function(){this.loginPanel.css("display","none")},showRegisterPanel:function(){this.registerName=null,this.registerPanel.css("display","block"),this.registerPanel.find("input").val(""),this.registerPanel.find("input").first().focus()},hideRegisterPanel:function(){this.registerPanel.css("display","none")},hideUserpPanel:function(){$(".user-panel").css("display","none")},showUserPanel:function(){$(".user-panel").css("display","block")},login:function(){var n=this.loginPanel.find("input[name='username']").val();if(""==n)return MapCloud.notify.showInfo("请输入用户名","Warning"),void this.loginPanel.find("input[name='username']").focus();var e=this.loginPanel.find("input[name='password']").val();return""==e?(MapCloud.notify.showInfo("请输入密码","Warning"),void this.loginPanel.find("input[name='password']").focus()):(MapCloud.notify.loading(),this.loginName=n,void authManager.login(n,e,this.login_callback))},login_callback:function(n){if(MapCloud.notify.showInfo(n,"登录"),"success"==n){var e=MapCloud.accountPanel;"admin"==e.loginName?(MapCloud.cookieObj.setCookie("username",e.loginName,"/MapCloud"),window.location.href="../Admin"):(e.hideLoginPanel(),e.hideRegisterPanel(),e.showUserPanel(),e.initUser(e.loginName))}},initUser:function(n){null!=n&&(user=new GeoBeans.User(n),mapManager=user.getMapManager(),styleManager=user.getStyleManager(),fileManager=user.getFileManager(),dbsManager=user.getDBSManager(),rasterDBManager=user.getRasterDBManager(),gpsManager=user.getGPSManager(),MapCloud.cookieObj.setCookie("username",n,"/MapCloud"),loadCatalog(),$("#title_panel").html("["+n+"]管理页面"),MapCloud.userPanel=new MapCloud.UserPanel("user_panel"),MapCloud.userPanel.panel=$("#iframeId").contents().find("#user_panel"),MapCloud.userPanel.registerPanelEvent(),MapCloud.userPanel.getUserInfo(n))},register:function(){var n=this.registerPanel.find("input[name='username']").val();if(null==n||""==n)return MapCloud.notify.showInfo("请输入注册的用户名","Warning"),void this.registerPanel.find("input[name='username']").focus();var e=/^[0-9a-zA-Z_]+$/;if(!e.test(n))return MapCloud.notify.showInfo("请输入有效的用户名","Warning"),void this.registerPanel.find("input[name='username']").focus();var i=this.registerPanel.find("input[name='alias']").val();if(null==i||""==i)return MapCloud.notify.showInfo("请输入注册的昵称","Warning"),void this.registerPanel.find("input[name='alias'").focus();if(!e.test(i))return MapCloud.notify.showInfo("请输入有效的昵称","Warning"),void this.registerPanel.find("input[name='alias'").focus();var a=this.registerPanel.find("input[name='email']").val();if(null==a||""==a)return MapCloud.notify.showInfo("请输入注册的邮箱","Warning"),void this.registerPanel.find("input[name='email']").focus();var s=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!s.test(a))return MapCloud.notify.showInfo("请输入有效的邮箱","Warning"),void this.registerPanel.find("input[name='email']").focus();var l=this.registerPanel.find("input[name='password']").val();if(null==l||""==l)return MapCloud.notify.showInfo("请输入注册的密码","Warning"),void this.registerPanel.find("input[name='password']").focus();var o=$("input[name='repassword'").val();return null==o||""==o?(MapCloud.notify.showInfo("请再次输入注册的密码","Warning"),void this.registerPanel.find("input[name='repassword']").focus()):l!=o?(MapCloud.notify.showInfo("两次输入的密码不同","Warning"),void this.registerPanel.find("input[name='repassword']").focus()):(this.registerName=n,MapCloud.notify.loading(),void authManager.createUser(n,i,l,a,"normal",this.register_callback))},register_callback:function(n){if(MapCloud.notify.showInfo(n,"注册"),"success"==n){var e=MapCloud.accountPanel;e.hideLoginPanel(),$(".map-panel").css("display","block"),e.initUser(e.registerName)}}});
function loadLoginPanel(){$(".user-panel").css("display","none"),$(".login-panel").css("display","block")}function logout_callback(e){MapCloud.notify.showInfo(e,"注销"),"success"==e&&(MapCloud.accountPanel.hideRegisterPanel(),MapCloud.accountPanel.hideUserpPanel(),MapCloud.accountPanel.showLoginPanel(),user.logout(),MapCloud.cookieObj.delCookie("username","/MapCloud"))}function loadCatalog(){$(".login-panel").css("display","none"),$(".user-panel").css("display","block");for(var e="",l=g_catalog.length,o=null,a=null,n=null,i=0;l>i;i++){var c=g_catalog[i];o=c.name,n=c.icon,a=c.link,e+="<div class='catalog-item' onclick='onItemClick(\""+o+'","'+a+"\");' iname='"+o+"'>	<img src='../images/"+n+"'>	<h5>"+o+"</h5></div>"}document.getElementById("catalog_container").innerHTML=e,$(".catalog-item").first().addClass("selected")}var user=null,cookieObj=null;$().ready(function(){user=null,cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");null!=e&&($("#title_panel").html("["+e+"]管理系统"),user=new GeoBeans.User(e)),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.accountPanel=new MapCloud.AccountPanel("login-panel","register-panel");var l="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(l),MapCloud.cookieObj=new MapCloud.Cookie,null==user?loadLoginPanel():loadCatalog(),$(".service_title").click(function(){var e=$(this).next();if("0px"==e.css("height")){var l=e.children().length;e.css("height",(25*l).toString()+"px")}else e.css("height","0px")}),$("#user_logout").click(function(){confirm("确定要退出当前账户吗？")&&(MapCloud.notify.loading(),authManager.logout(user.name,logout_callback))})});