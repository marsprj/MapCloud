$().ready(function(){cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");user=null,null!=e&&(user=new GeoBeans.User(e)),null!=user&&(dbsManager=user.getDBSManager(),fileManager=user.getFileManager(),rasterDBManager=user.getRasterDBManager(),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.pgis_connection_dialog=new MapCloud.PGISConnectDialog("pgisConnDialog"),MapCloud.create_folder_dialog=new MapCloud.CreateFolderDialog("create_folder_dialog"),MapCloud.import_raster_dialog=new MapCloud.ImportRasterDialog("import_raster_dialog"),MapCloud.file_dialog=new MapCloud.FileDialog("fileDialog"),MapCloud.rasterPanel=new MapCloud.RasterPanel("raster_panel"),$(".modal").draggable({handle:".modal-header"}))});
MapCloud.RasterPanel=MapCloud.Class({panel:null,raster:null,initialize:function(a){this.panel=$("#"+a),this.registerPanelEvent(),this.getDataSources()},registerPanelEvent:function(){var a=this;this.panel.find(".add-db").click(function(){MapCloud.pgis_connection_dialog.showDialog("raster","user-raster")}),this.panel.find(".return-datasources-list").click(function(){a.getDataSources()}),this.panel.find(".add-folder").click(function(){a.createFolder()}),this.panel.find(".remove-file").click(function(){var e=a.panel.find("#datasource_tab .current-db").html();if(null==e)return void MapCloud.notify.showInfo("请选择一个数据源","Warning");var t=a.panel.find("input[type='checkbox']:checked");if(0==t.length){var s=a.panel.find(".folder-tree[dname='"+e+"'] .tree-folder.selected").attr("fpath");if("/"==s)return void MapCloud.notify.showInfo("无法删除根目录","Warning");var l=a.panel.find(".folder-tree[dname='"+e+"'] .tree-folder.selected span").html();if(null==l)return void MapCloud.notify.showInfo("请选择删除的文件","Warning");if(!confirm("确定要删除文件夹["+l+"]?"))return;var r=a.panel.find(".folder-tree[dname='"+e+"'] .tree-folder.selected").parents(".nav").first().prev();a.panel.find(".folder-tree[dname='"+e+"'] .tree-folder").removeClass("selected"),r.addClass("selected");var n=r.attr("fpath");return a.panel.find(".current-path").val(n),void a.removeFolder(e,s)}confirm("确定要删除吗？")&&t.each(function(){var t=$(this).parent().parent().parent(),s=t.attr("fpath");if(t.hasClass("row-file")){var l=a.panel.find(".current-path").val(),r=t.find(".row-fname span").html();a.removeRaster(e,l,r)}else t.hasClass("row-folder")&&a.removeFolder(e,s)})}),this.panel.find(".refresh-folder").click(function(){a.getListRefresh()}),this.panel.find(".upload-raster").click(function(){var e=a.panel.find("#datasource_tab .current-db").html();if(null==e)return void MapCloud.notify.showInfo("请选择要上传的数据源","Warning");var t=a.panel.find(".current-path").val();MapCloud.import_raster_dialog.showDialog("raster-user"),MapCloud.import_raster_dialog.setRasterPath(e,t)}),this.panel.find("#show_raster_infos").click(function(){a.panel.find("#raster_tab .right-panel-content-tab").css("display","block"),a.panel.find("#raster_infos_tab").css("display","block"),$(this).attr("disabled",!0),a.panel.find("#show_raster_preview").attr("disabled",!1),a.showRasterInfo(a.raster)}),this.panel.find("#show_raster_preview").click(function(){a.panel.find("#raster_tab .right-panel-content-tab").css("display","block"),a.panel.find("#raster_preview_tab").css("display","block"),$(this).attr("disabled",!0),a.panel.find("#show_raster_infos").attr("disabled",!1);var e=a.panel.find("#raster_tab .current-db").html();a.showRasterPreview(e,a.rasterName,a.rasterPath)}),this.panel.find("#show-raster-list").click(function(){a.panel.find("#show-raster-thumb").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").hide(),a.panel.find("#raster_list_tab").show()}),this.panel.find("#show-raster-thumb").click(function(){a.panel.find("#show-raster-list").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").hide(),a.panel.find("#raster_thumb_tab").show()})},getDataSources:function(){$(".right-panel-tab").css("display","none"),$("#datasources_tab").css("display","block"),MapCloud.notify.loading(),dbsManager.getDataSources(this.getDataSources_callback,"Raster")},getDataSources_callback:function(a){var e=MapCloud.rasterPanel;MapCloud.notify.hideLoading(),e.showDataSourcesTree(a),e.showDataSourcesList(a)},showDataSourcesTree:function(a){if($.isArray(a)){for(var e=null,t=null,s="",l=0;l<a.length;++l)e=a[l],null!=e&&(t=e.name,s+='<div class="row" dname="'+t+'">	<div class="col-md-1 col-xs-1 col-md-20px">		<div class="glyphicon glyphicon-chevron-right mc-icon mc-icon-right mc-icon-rotate"></div>	</div>	<div class="col-md-1 col-xs-1 col-md-20px">		<i class="db-icon list-icon"></i>	</div>	<div class="col-md-7 col-xs-7 db-tree-name">'+t+'</div></div><ul class="nav folder-tree" dname="'+t+'">	<li>		<a href="javascript:void(0)" class="file-tree tree-folder selected" fpath="/">			<i class="fa fa-folder"></i>			<span>/</span>		</a>	</li></ul>');$(".raster-db-tree").html(s);var r=this;$(".raster-db-tree .glyphicon-chevron-right").click(function(){var a=$(this).parents(".row").first().attr("dname");$(this).hasClass("mc-icon-right")?($(this).removeClass("mc-icon-right"),$(this).addClass("mc-icon-down"),$(this).css("transform","rotate(90deg) translate(3px,0px)"),$(".raster-db-tree .folder-tree[dname='"+a+"'] .foler-ul").remove(),r.panel.find(".right-panel-tab").css("display","none"),r.panel.find("#datasource_tab").css("display","block"),r.panel.find("#datasource_tab .current-db").html(a),r.panel.find("#datasource_tab .current-path").val("/"),r.panel.find(".nav.folder-tree[dname='"+a+"']").css("display","block"),r.getList(a,"/")):($(this).css("transform","rotate(0deg) translate(0px,0px)"),$(this).addClass("mc-icon-right"),$(this).removeClass("mc-icon-down"),$(".raster-db-tree .folder-tree[dname='"+a+"']").slideUp(500))})}},showDataSourcesList:function(a){if($.isArray(a)){for(var e=null,t=null,s="",l=null,r=null,n=0;n<a.length;++n)if(e=a[n],null!=e){t=e.name,r=e.constr,l=e.engine;var i=this.getDataSourceInfo(r);s+='<div class="row" dname="'+t+'">	<div class="col-md-1 col-xs-1">'+(n+1)+'	</div>	<div class="col-md-2 col-xs-2">'+t+'	</div>	<div class="col-md-2 col-xs-2">'+i.server+'	</div>	<div class="col-md-1 col-xs-1">'+i.instance+'	</div>	<div class="col-md-1 col-xs-1">'+i.database+'	</div>	<div class="col-md-1 col-xs-1">'+i.user+'	</div>	<div class="col-md-2 col-xs-2">'+i.password+'	</div>	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-db">进入</a>		<a href="javascript:void(0)" class="oper remove-db">删除</a>	</div></div>'}$(".raster-db-list").html(s);var d=this;$(".raster-db-list .enter-db").click(function(){var a=$(this).parents(".row").first().attr("dname");if(null!=a){var e="/";d.panel.find(".right-panel-tab").css("display","none"),d.panel.find("#datasource_tab").css("display","block"),d.panel.find("#datasource_tab .current-db").html(a);var t=$(".raster-db-tree .row[dname='"+a+"'] .glyphicon-chevron-right");t.removeClass("mc-icon-right"),t.addClass("mc-icon-down"),t.css("transform","rotate(90deg) translate(3px,0px)"),d.panel.find(".nav.folder-tree[dname='"+a+"']").css("display","block"),d.getList(a,e)}}),$(".raster-db-list .remove-db").click(function(){var a=$(this).parents(".row").first().attr("dname");null!=a&&confirm("确定删除数据库["+a+"]?")&&(MapCloud.notify.loading(),dbsManager.unRegisterDataSource(a,d.unRegisterDataSource_callback))})}},getDataSourceInfo:function(a){if(null==a)return null;var e=a.indexOf("server="),t=a.indexOf(";"),s=a.slice(e+"server=".length,t);a=a.slice(t+1,a.length);var l=a.indexOf("instance=");t=a.indexOf(";");var r=a.slice(l+"instance=".length,t);a=a.slice(t+1,a.length);var n=a.indexOf("database=");t=a.indexOf(";");var i=a.slice(n+"database=".length,t);a=a.slice(t+1,a.length);var d=a.indexOf("user=");t=a.indexOf(";");var o=a.slice(d+"user=".length,t);a=a.slice(t+1,a.length);var c=a.indexOf("password=");t=a.indexOf(";");var f=a.slice(c+"password=".length,t);return{server:s,instance:r,database:i,user:o,password:f}},unRegisterDataSource_callback:function(a){MapCloud.notify.showInfo(a,"删除数据源");var e=MapCloud.rasterPanel;e.getDataSources()},getList:function(a,e){null!=a&&null!=e&&(MapCloud.notify.loading(),rasterDBManager.getList(a,e,this.getList_callback),rasterDBManager.getThumbnails(a,e,this.getThumbnails_callback))},getList_callback:function(a){MapCloud.notify.hideLoading();var e=MapCloud.rasterPanel;e.showListTree(a),e.showListPanel(a)},showListTree:function(a){for(var e=null,t=null,s="<ul class='nav folder-ul'>",l=0;l<a.length;++l)if(e=a[l],null!=e&&e instanceof GeoBeans.Folder){var r=e.name;s+="<li><a href='javascript:void(0)' class='tree-folder' fpath=\""+e.path+'"><i class="fa fa-folder"></i><span>'+r+"</span></a></li>"}s+="</ul>",t=this.panel.find(".current-path").val();var n=this.panel.find("#datasource_tab .current-db").html(),i=this.panel.find(".nav[dname='"+n+"'] a[fpath='"+t+"']");i.find("i").removeClass("fa-folder"),i.find("i").addClass("fa-folder-open"),i.parent().find("ul.nav").remove(),i.after(s);var d=this;this.panel.find(".tree-folder").unbind("click"),this.panel.find(".tree-folder").unbind("dblclick");var o=300,c=0,f=null;this.panel.find(".tree-folder").on("click",function(a){if(c++,1===c){var e=this;f=setTimeout(function(){var a=$(e).attr("fpath");d.panel.find(".current-path").val(a);var t=$(e).parents(".folder-tree").prev().attr("dname");d.panel.find("#datasource_tab .current-db").html(t),d.getListTreeClick(t,a),d.panel.find(".tree-folder.selected").removeClass("selected"),$(e).addClass("selected"),c=0},o)}else{clearTimeout(f);var t=$(this).attr("fpath"),s=$(this).parent();if(0!=s.find("ul.nav").length&&"none"==s.find("ul.nav").first().css("display")){s.find("ul.nav").first().css("display","block"),$(this).find("i").removeClass("fa-folder"),$(this).find("i").addClass("fa-folder-open");var l=$(this).parents(".folder-tree").prev().attr("dname");d.panel.find("#datasource_tab .current-db").html(l),d.getListTreeClick(l,t)}else if(0!=s.find("ul.nav").length&&"block"==s.find("ul.nav").first().css("display")){s.find("ul.nav").first().css("display","none"),$(this).find("i").addClass("fa-folder"),$(this).find("i").removeClass("fa-folder-open");var l=$(this).parents(".folder-tree").prev().attr("dname");d.panel.find("#datasource_tab .current-db").html(l),d.getListTreeClick(l,t)}else{var l=$(this).parents(".folder-tree").prev().attr("dname");d.panel.find("#datasource_tab .current-db").html(l),d.getList(l,t)}d.panel.find(".current-path").val(t),d.panel.find(".tree-folder").removeClass("selected"),$(this).addClass("selected"),c=0}}).on("dblclick",function(a){a.preventDefault()})},getListTreeClick:function(a,e){MapCloud.notify.loading(),rasterDBManager.getList(a,e,this.getListTreeClick_callback),rasterDBManager.getThumbnails(a,e,this.getThumbnails_callback)},getListTreeClick_callback:function(a){MapCloud.notify.hideLoading();var e=MapCloud.rasterPanel;e.list=a,e.showListPanel(a)},getThumbnails_callback:function(a){MapCloud.notify.hideLoading();var e=MapCloud.rasterPanel;e.showThumbnailList(a)},showListPanel:function(a){if($.isArray(a)){for(var e=null,t="",s="<ul id='maps_thumb_ul'>",l=0;l<a.length;++l){if(e=a[l],null==e)return;if(e instanceof GeoBeans.File){var r=e.name,n=e.accessTime,i=e.lastTime,d=e.size,o=e.path;t+="<div class='row row-file' fpath='"+o+"'><div class='col-md-1 col-xs-1 row'><div class='col-md-6 col-xs-6'>",t+=null!=this.source?"	<input type='radio' name='chooseRaster'>":"		<input type='checkbox' name='"+r+"'>",t+="</div><div class='col-md-6 col-xs-6'><i class='fa fa-file-o'></i></div>",t+="</div><div class='col-md-3 col-xs-3 row-fname'>		<span>"+r+"</span></div><div class='col-md-1 col-xs-1'>文件</div><div class='col-md-3 col-xs-3'>"+n+"</div><div class='col-md-3 col-xs-3'>"+i+"</div><div class='col-md-1 col-xs-1'>"+d+"</div></div>";var c=this.panel.find("#datasource_tab .current-db").html(),f=this.panel.find(".current-path").val();rasterDBManager.getRasterUrl(c,r,f),r.slice(0,r.lastIndexOf("."))}else if(e instanceof GeoBeans.Folder){var r=e.name,n=e.accessTime,i=e.lastTime,o=e.path;t+="<div class='row row-folder' fpath='"+o+"'><div class='col-md-1 col-xs-1 row'><div class='col-md-6 col-xs-6'>",t+=null!=this.source?"	<input type='radio' name='chooseRaster' disabled>":"	<input type='checkbox' name='"+r+"'>",t+="</div><div class='col-md-6 col-xs-6'><i class='fa fa-folder'></i></div>",t+="</div><div class='col-md-3 col-xs-3 row-fname'>		<span>"+r+"</span></div><div class='col-md-1 col-xs-1'>文件夹</div><div class='col-md-3 col-xs-3'>"+(null==n?" ":n)+"</div><div class='col-md-3 col-xs-3'>"+(null==i?" ":i)+"</div><div class='col-md-1 col-xs-1'></div></div>"}}this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasource_tab").css("display","block"),this.panel.find(".raster-folder-list").html(t),s+="</ul>";var p=this;this.panel.find(".raster-folder-list .row-folder .row-fname").click(function(){var a=p.panel.find("#datasource_tab .current-db").html(),e=$(this).parent().attr("fpath");p.panel.find(".nav.folder-tree[dname='"+a+"'] .tree-folder").removeClass("selected");var t=p.panel.find(".nav.folder-tree[dname='"+a+"'] .tree-folder[fpath='"+e+"']");t.parents(".nav").first().css("display","block"),t.addClass("selected"),p.panel.find(".current-path").val(e),p.getList(a,e)}),this.panel.find(".raster-folder-list .row-file .row-fname").click(function(){var a=p.panel.find("#datasource_tab .current-db").html(),e=$(this).find("span").html(),t=p.panel.find(".current-path").val();p.rasterName=e,p.rasterPath=t,p.showRasterTab(a,e,t)})}},showThumbnailList:function(a){if($.isArray(a)){for(var e=null,t="<ul id='maps_thumb_ul'>",s=0;s<a.length;++s){if(e=a[s],null==e)return;var l=e.name,r=l.slice(0,l.lastIndexOf("."));t+="<li class='map-thumb'><a href='javascript:void(0)' class='map-thumb-a' style='background-image:url("+e.thumb+")'></a><div class='caption text-center'><h6 sname='"+l+"'>"+r+"</h6></div></li>"}this.panel.find("#raster_thumb_tab").html(t);var n=this;this.panel.find("#raster_thumb_tab a").dblclick(function(){var a=n.panel.find("#datasource_tab .current-db").html(),e=$(this).parent().find("h6").attr("sname"),t=n.panel.find(".current-path").val();n.rasterName=e,n.rasterPath=t,n.showRasterTab(a,e,t)})}},showRasterTab:function(a,e,t){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#raster_tab").css("display","block"),this.panel.find("#raster_infos_tab").css("display","block"),this.panel.find("#raster_preview_tab").css("display","none"),this.panel.find("#show_raster_infos").attr("disabled",!0),this.panel.find("#show_raster_preview").attr("disabled",!1);var s="";s="/"==t?"/"+e:t+"/"+e,this.panel.find("#raster_tab .current-db").html(a),this.panel.find(".current-raster-path").val(s),this.panel.find("#raster_infos_tab").css("display","none"),rasterDBManager.describeRaster(a,e,t,this.describeRaster_callback)},describeRaster_callback:function(a){var e=MapCloud.rasterPanel;e.raster=a,e.showRasterInfo(a)},showRasterInfo:function(a){if(null!=a){var e="";e+="<div class='row'>		<div class='col-md-3 col-xs-3'>名称</div>		<div class='col-md-8 col-xs-8'>"+a.name+"</div>	</div>	<div class='row'>		<div class='col-md-3 col-xs-3'>格式</div>		<div class='col-md-8 col-xs-8'>"+a.format+"</div>	</div>	<div class='row'>		<div class='col-md-3 col-xs-3'>波段</div>		<div class='col-md-8 col-xs-8'>"+a.bands+"</div>	</div>	<div class='row'>		<div class='col-md-3 col-xs-3'>空间参考</div>		<div class='col-md-8 col-xs-8'>"+a.srid+"</div>	</div>	<div class='row'>		<div class='col-md-3 col-xs-3'>宽度</div>		<div class='col-md-8 col-xs-8'>"+a.width+"</div>	</div>	<div class='row'>		<div class='col-md-3  col-xs-3'>高度</div>		<div class='col-md-8 col-xs-8'>"+a.height+"</div>	</div>";var t=a.extent;null!=t&&(e+="	<div class='row'>		<div class='col-md-3 col-xs-3'>范围</div>		<div class='col-md-8 col-xs-8'>"+t.xmin+","+t.ymin+","+t.xmax+","+t.ymax+"</div>	</div>"),this.panel.find("#raster_infos_tab").html(e),this.panel.find("#raster_tab .right-panel-content-tab").css("display","block"),this.panel.find("#raster_infos_tab").css("display","block"),this.panel.find(".raster-preview-div").css("display","none")}},showRasterPreview:function(a,e,t){rasterDBManager.getThumbnail(a,t,e,this.getThumbnail_callback)},getThumbnail_callback:function(a){if(null!=a){var e=a.thumb;if(null!=e){var t=MapCloud.rasterPanel;t.panel.find("#raster_preview_tab img").attr("src",e),t.panel.find("#raster_infos_tab").css("display","none");var s=t.panel.find("#raster_preview_tab").parent().width(),l=t.panel.find("#raster_preview_tab").parent().height();t.panel.find("#raster_preview_tab").css("width",s+"px"),t.panel.find("#raster_preview_tab").css("height",l+"px"),t.panel.find("#raster_preview_tab").css("display","table-cell")}}},createFolder:function(){var a=this.panel.find("#datasource_tab .current-db").html();return null==a?void MapCloud.notify.showIno("请选择一个数据库","Warning"):void MapCloud.create_folder_dialog.showDialog("raster-user")},setCreateFolderName:function(a){var e=this.panel.find("#datasource_tab .current-path").val(),t=null;t="/"==e?"/"+a:e+"/"+a;var s=this.panel.find("#datasource_tab .current-db").html();this.rasterCreateFolder(s,t)},rasterCreateFolder:function(a,e){return null==a||null==e?void MapCloud.notify.showInfo("参数无效","Warning"):(MapCloud.notify.loading(),void rasterDBManager.createFolder(a,e,this.createFolder_callback))},createFolder_callback:function(a){var e="新建文件夹";MapCloud.notify.showInfo(a,e);var t=MapCloud.rasterPanel,s=t.panel.find("#datasource_tab .current-db").html(),l=t.panel.find(".current-path").val();t.getList(s,l)},getListRefresh:function(a,e){var a=this.panel.find("#datasource_tab .current-db").html();if(null==a)return void MapCloud.notify.showInfo("请选择一个数据源","Warning");var e=this.panel.find("#datasource_tab .current-path").val();null==e&&MapCloud.notify.showInfo("请选择刷新的路径","Warning"),MapCloud.notify.loading(),rasterDBManager.getList(a,e,this.getListRefresh_callback)},getListRefresh_callback:function(a){MapCloud.notify.showInfo("Success","刷新成功");var e=MapCloud.rasterPanel;e.showListTree(a),e.showListPanel(a)},removeRaster:function(a,e,t){rasterDBManager.removeRaster(a,t,e,this.removeRaster_callback)},removeRaster_callback:function(a){MapCloud.notify.showInfo(a,"删除影像");var e=MapCloud.rasterPanel,t=e.panel.find("#datasource_tab .current-db").html(),s=e.panel.find(".current-path").val();e.getList(t,s)},removeFolder:function(a,e){rasterDBManager.removeFolder(a,e,this.removeFolder_callback)},removeFolder_callback:function(a){MapCloud.notify.showInfo(a,"删除文件夹");var e=MapCloud.rasterPanel,t=e.panel.find("#datasource_tab .current-db").html(),s=e.panel.find(".current-path").val();e.panel.find(".tree-folder[fpath='"+s+"']").next().remove(),e.getList(t,s)}});