$().ready(function(){cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");user=null,null!=e&&(user=new GeoBeans.User(e)),null!=user&&(fileManager=user.getFileManager(),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.importVector_dialog=new MapCloud.ImportVectorDialog("importVectorDialog"),MapCloud.create_folder_dialog=new MapCloud.CreateFolderDialog("create_folder_dialog"),MapCloud.filePanel=new MapCloud.FilePanel("file_panel"),$(".modal").draggable({handle:".modal-header"}))});
MapCloud.FilePanel=MapCloud.Class({panel:null,initialize:function(e){this.panel=$("#"+e),this.registerPanelEvent(),this.getList("/")},registerPanelEvent:function(){var e=this;this.panel.find(".add-folder").click(function(){MapCloud.create_folder_dialog.showDialog("file-user")}),this.panel.find(".remove-file").click(function(){e.removeFileFolder()}),this.panel.find(".refresh-folder").click(function(){var l=e.panel.find("#current_path").val();e.getListRefresh(l)}),this.panel.find(".upload-file").click(function(){var l=e.panel.find("#current_path").val();MapCloud.importVector_dialog.showDialog(l,"file-user")})},getList:function(e){MapCloud.notify.loading(),fileManager.getList(e,this.getList_callback)},getList_callback:function(e){MapCloud.notify.hideLoading();var l=MapCloud.filePanel;l.list=e,l.showListTree(e,!0);var a=l.getFilterList();l.showListPanel(a)},getFilterList:function(){var e="all",l=e.split(",");if(0==l.length)return this.list;if(1==l.length&&"all"==l[0])return this.list;for(var a=null,i=null,t=null,n=[],s=0;s<this.list.length;++s)if(a=this.list[s],a instanceof GeoBeans.Folder)n.push(a);else if(a instanceof GeoBeans.File){t=a.name,t=t.toLowerCase();for(var r=0;r<l.length;++r)i=l[r],i="."+i,t.length<=i.length||t.lastIndexOf(i)==t.length-i.length&&n.push(a)}return n},showListTree:function(e,l){var a=null,i=null,t=null;t=1==l?"<ul class='nav'>":"<ul class='nav' style='display:none'>";for(var n=0;n<e.length;++n)if(a=e[n],null!=a&&a instanceof GeoBeans.Folder){var s=a.name;t+="<li><a href='javascript:void(0)' class='tree-folder' fpath=\""+a.path+'"><i class="fa fa-folder-o"></i><span>'+s+"</span></a></li>"}t+="</ul>",i=this.panel.find("#current_path").val();var r=this.panel.find(".file-tree-div a[fpath='"+i+"']");r.find("i").removeClass("fa-folder-o"),r.find("i").addClass("fa-folder-open-o"),r.parent().find("ul.nav").remove(),r.after(t);var o=this;this.panel.find(".tree-folder").unbind("click"),this.panel.find(".tree-folder").unbind("dblclick");var d=300,f=0,c=null;this.panel.find(".tree-folder").on("click",function(e){if(f++,1===f){var l=this;c=setTimeout(function(){console.log("Single Click");var e=$(l).attr("fpath");o.panel.find("#current_path").val(e),o.getListTreeClick(e),o.panel.find(".tree-folder").removeClass("selected"),$(l).addClass("selected"),f=0},d)}else{clearTimeout(c),console.log("Double Click");var a=$(this).attr("fpath"),i=$(this).parent();0!=i.find("ul.nav").length&&"none"==i.find("ul.nav").first().css("display")?(i.find("ul.nav").first().css("display","block"),$(this).find("i").removeClass("fa-folder-o"),$(this).find("i").addClass("fa-folder-open-o"),o.getListTreeClick(a)):0!=i.find("ul.nav").length&&"block"==i.find("ul.nav").first().css("display")?(i.find("ul.nav").first().css("display","none"),$(this).find("i").addClass("fa-folder-o"),$(this).find("i").removeClass("fa-folder-open-o"),o.getListTreeClick(a)):(o.panel.find("#current_path").val(a),o.getList(a)),o.panel.find(".tree-folder").removeClass("selected"),$(this).addClass("selected"),f=0}}).on("dblclick",function(e){e.preventDefault()})},showListPanel:function(e){for(var l=null,a="",i=0;i<e.length;++i)if(l=e[i],null!=l)if(l instanceof GeoBeans.File){var t=l.name,n=l.accessTime,s=l.lastTime,r=l.size,o=l.path;if(a+="<div class='row row-file' fpath='"+o+"'><div class='col-md-1 row'><div class='col-md-6'>","choose-shp"==this.flag){var d=t.slice(t.lastIndexOf(".")+1,t.length);a+="shp"==d.toLowerCase()?"		<input type='checkbox' name='"+t+"'>":"		<input type='checkbox' name='"+t+"' disabled>"}else if("image"==this.flag){var d=t.slice(t.lastIndexOf(".")+1,t.length);d=d.toLowerCase();var f=["jpeg","jpg","tif","png"];a+=-1!=f.indexOf(d)?"		<input type='checkbox' name='"+t+"'>":"		<input type='checkbox' name='"+t+"' disabled>"}else if("csv"==this.flag||"csvImport"==this.flag){var d=t.slice(t.lastIndexOf(".")+1,t.length);a+="csv"==d.toLowerCase()?"		<input type='radio' name='csv'>":"		<input type='radio' name='csv' disabled>"}else a+="		<input type='checkbox' name='"+t+"'>";a+="</div><div class='col-md-6'><i class='fa fa-file-o'></i></div>",a+="</div><div class='col-md-3 row-fname'>		<span>"+t+"</span></div><div class='col-md-1'>文件</div><div class='col-md-3'>"+n+"</div><div class='col-md-3'>"+s+"</div><div class='col-md-1'>"+r+"</div></div>"}else if(l instanceof GeoBeans.Folder){var t=l.name,n=l.accessTime,s=l.lastTime,o=l.path;a+="<div class='row row-folder' fpath='"+o+"'><div class='col-md-1 row'><div class='col-md-6'>",a+=null==this.flag?"	<input type='checkbox' name='"+t+"'>":"	<input type='checkbox' name='"+t+"' disabled>",a+="</div><div class='col-md-6'><i class='fa fa-folder-o'></i></div>",a+="</div><div class='col-md-3 row-fname'>		<span>"+t+"</span></div><div class='col-md-1'>文件夹</div><div class='col-md-3'>"+n+"</div><div class='col-md-3'>"+s+"</div><div class='col-md-1'></div></div>"}this.panel.find(".file-list-content-div").html(a);var c=this;this.panel.find(".row-folder .row-fname").click(function(){var e=$(this).parent().attr("fpath");c.panel.find(".tree-folder").removeClass("selected");var l=c.panel.find(".tree-folder[fpath='"+e+"']");l.parents(".nav").first().css("display","block"),l.addClass("selected"),c.panel.find("#current_path").val(e),c.getList(e)})},getListTreeClick:function(e){MapCloud.notify.loading(),fileManager.getList(e,this.getListTreeClick_callback)},getListTreeClick_callback:function(e){MapCloud.notify.hideLoading();var l=MapCloud.filePanel;l.list=e;var a=l.getFilterList();l.showListPanel(a)},setCreateFolderName:function(e){var l=this.panel.find("#current_path").val(),a=null;a="/"==l?"/"+e:l+"/"+e,this.createFolder(a)},createFolder:function(e){MapCloud.notify.loading(),fileManager.createFolder(e,this.createFolder_callback)},createFolder_callback:function(e){var l="新建文件夹";MapCloud.notify.showInfo(e,l);var a=MapCloud.filePanel,i=a.panel.find("#current_path").val();a.getList(i)},removeFileFolder:function(){var e=this,l=e.panel.find("input[type='checkbox']:checked");if(0==l.length){var a=e.panel.find(".tree-folder.selected").attr("fpath");if("/"==a)return void MapCloud.notify.showInfo("无法删除根目录","Warning");var i=e.panel.find(".tree-folder.selected span").html();if(!confirm("确定要删除文件夹["+i+"]?"))return;var t=e.panel.find(".tree-folder.selected").parents(".nav").first().prev();e.panel.find(".tree-folder.selected").parents(".nav").first().remove(),e.panel.find(".tree-folder").removeClass("selected"),t.addClass("selected");var n=t.attr("fpath");return e.panel.find("#current_path").val(n),void e.removeFolder(a)}confirm("确定要删除吗？")&&l.each(function(){var l=$(this).parent().parent().parent(),a=l.attr("fpath");l.hasClass("row-file")?e.removeFile(a):l.hasClass("row-folder")&&e.removeFolder(a)})},removeFile:function(e){fileManager.removeFile(e,this.removeFile_callback)},removeFile_callback:function(e){var l="删除文件";MapCloud.notify.showInfo(e,l);var a=MapCloud.filePanel,i=a.panel.find("#current_path").val();a.getList(i)},removeFolder:function(e){fileManager.removeFolder(e,this.removeFolder_callback)},removeFolder_callback:function(e){var l="删除文件夹";MapCloud.notify.showInfo(e,l);var a=MapCloud.filePanel,i=a.panel.find("#current_path").val();a.panel.find(".tree-folder[fpath='"+i+"']").next().remove(),a.getList(i)},getListRefresh:function(e){MapCloud.notify.loading(),fileManager.getList(e,this.getListRefresh_callback)},getListRefresh_callback:function(e){MapCloud.notify.showInfo("刷新","Info");var l=MapCloud.filePanel;l.list=e,l.showListTree(e,!0);var a=l.getFilterList();l.showListPanel(a)},refreshCurrentPath:function(){var e=this.panel.find("#current_path").val();this.getList(e)}});