$().ready(function(){cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");user=null,null!=e&&(user=new GeoBeans.User(e)),null!=user&&(dbsManager=user.getDBSManager(),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.pgis_connection_dialog=new MapCloud.PGISConnectDialog("pgisConnDialog"),MapCloud.create_tile_store_dialog=new MapCloud.CreateTileStoreDialog("create_tile_store_dialog"),MapCloud.tilePanel=new MapCloud.TilePanel("tile_panel"),$(".modal").draggable({handle:".modal-header"}))});
MapCloud.TilePanel=MapCloud.Class({panel:null,map:null,dataSourceNameCur:null,tileStore:null,initialize:function(e){this.panel=$("#"+e),this.registerPanelEvent(),this.getDataSources()},registerPanelEvent:function(){var e=this;this.panel.find(".return-datasources-list").click(function(){e.getDataSources()}),this.panel.find(".return-datasource").click(function(){var i=$(this).html();null!=i&&e.getTileStores(i)}),this.panel.find(".add-db").click(function(){MapCloud.pgis_connection_dialog.showDialog("tile","user-tile")}),this.panel.find(".create-tilestroe").click(function(){var i=e.panel.find("#datasource_tab .current-db").html();return null==i?void MapCloud.notify.showInfo("请选择一个数据源","Warning"):void MapCloud.create_tile_store_dialog.showDialog("tileDB-user",i)}),this.panel.find("#show_tilestore_infos").click(function(){e.panel.find("#show_tilestore_preview").attr("disabled",!1),$(this).attr("disabled",!0),null!=e.tileStore&&e.showTileStoreInfo(e.tileStore)}),this.panel.find("#show_tilestore_preview").click(function(){e.panel.find("#show_tilestore_infos").attr("disabled",!1),$(this).attr("disabled",!0),null!=e.tileStore&&e.showTileStorePreview(e.tileStore)})},getDataSources:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasources_tab").css("display","block"),MapCloud.notify.loading(),dbsManager.getDataSources(this.getDataSources_callback,"Tile")},getDataSources_callback:function(e){MapCloud.notify.hideLoading();var i=MapCloud.tilePanel;i.showDataSourcesTree(e),i.showDataSourcesList(e)},showDataSourcesTree:function(e){if($.isArray(e)){for(var i=null,l=null,a="",t=0;t<e.length;++t)i=e[t],null!=i&&(l=i.name,a+='<div class="row" dname="'+l+'">	<div class="col-md-1 col-xs-1 col-md-20px">		<div class="glyphicon glyphicon-chevron-right mc-icon mc-icon-right mc-icon-rotate"></div>	</div>	<div class="col-md-1 col-xs-1 col-md-20px">		<i class="db-icon list-icon"></i>	</div>	<div class="col-md-7 col-xs-7 db-tree-name">'+l+"</div></div>");this.panel.find(".tile-db-tree").html(a);var s=this;this.panel.find(".tile-db-tree .glyphicon-chevron-right").click(function(){var e=$(this).parents(".row").first().attr("dname");$(this).hasClass("mc-icon-right")?($(this).removeClass("mc-icon-right"),$(this).addClass("mc-icon-down"),$(this).css("transform","rotate(90deg) translate(3px,0px)"),s.panel.find(".tile-db-tree .nav[dname='"+e+"']").remove(),s.getTileStores(e)):($(this).css("transform","rotate(0deg) translate(0px,0px)"),$(this).addClass("mc-icon-right"),$(this).removeClass("mc-icon-down"),s.panel.find(".tile-db-tree .nav[dname='"+e+"']").slideUp(500))})}},showDataSourcesList:function(e){if($.isArray(e)){for(var i=null,l=null,a="",t=null,s=null,n=0;n<e.length;++n)if(i=e[n],null!=i){l=i.name,s=i.constr,t=i.engine;var o=this.getDataSourceInfo(s);a+='<div class="row" dname="'+l+'">	<div class="col-md-1 col-xs-1">'+(n+1)+'	</div>	<div class="col-md-2 col-xs-2">'+l+'	</div>	<div class="col-md-2 col-xs-2">'+o.server+'	</div>	<div class="col-md-1 col-xs-1">'+o.instance+'	</div>	<div class="col-md-1 col-xs-1">'+o.database+'	</div>	<div class="col-md-1 col-xs-1">'+o.user+'	</div>	<div class="col-md-2 col-xs-2">'+o.password+'	</div>	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-db">进入</a>		<a href="javascript:void(0)" class="oper remove-db">删除</a>	</div></div>'}this.panel.find(".tile-db-list").html(a);var r=this;$(".tile-db-list .enter-db").click(function(){var e=$(this).parents(".row").first().attr("dname");if(null!=e){var i=r.panel.find(".tile-db-tree .row[dname='"+e+"'] .glyphicon-chevron-right");i.removeClass("mc-icon-right"),i.addClass("mc-icon-down"),i.css("transform","rotate(90deg) translate(3px,0px)"),r.panel.find(".tile-db-tree .nav[dname='"+e+"']").remove(),r.getTileStores(e)}}),this.panel.find(".tile-db-list .remove-db").click(function(){var e=$(this).parents(".row").first().attr("dname");null!=e&&confirm("确定删除数据库["+e+"]?")&&(MapCloud.notify.loading(),dbsManager.unRegisterDataSource(e,unRegisterDataSource_callback))})}},getDataSourceInfo:function(e){if(null==e)return null;var i=e.indexOf("server="),l=e.indexOf(";"),a=e.slice(i+"server=".length,l);e=e.slice(l+1,e.length);var t=e.indexOf("instance=");l=e.indexOf(";");var s=e.slice(t+"instance=".length,l);e=e.slice(l+1,e.length);var n=e.indexOf("database=");l=e.indexOf(";");var o=e.slice(n+"database=".length,l);e=e.slice(l+1,e.length);var r=e.indexOf("user=");l=e.indexOf(";");var d=e.slice(r+"user=".length,l);e=e.slice(l+1,e.length);var c=e.indexOf("password=");l=e.indexOf(";");var v=e.slice(c+"password=".length,l);return{server:a,instance:s,database:o,user:d,password:v}},unRegisterDataSource_callback:function(e){MapCloud.notify.showInfo(e,"删除数据源");var i=MapCloud.tilePanel;i.getDataSources()},getTileStores:function(e){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasource_tab").css("display","block"),this.panel.find("#datasource_tab .tilestore-list").empty(),this.panel.find("#datasource_tab .current-db").html(e),this.panel.find(".nav[dname='"+e+"']").remove(),this.tileStore=null,null!=e&&(this.dataSourceNameCur=e,null!=this.map&&(this.map.removeBaseLayer("tile"),this.map.draw()),this.tileStore=null,MapCloud.notify.loading(),dbsManager.describeTileStores(e,this.getTileStores_callback))},getTileStores_callback:function(e){MapCloud.notify.hideLoading();var i=MapCloud.tilePanel;i.showTileStoreTree(e),i.showTileStoreListPanel(e)},showTileStoreTree:function(e){if($.isArray(e)){for(var i="<ul class='nav' dname='"+this.dataSourceNameCur+"'>",l=null,a=null,t=0;t<e.length;++t)l=e[t],null!=l&&(a=l.name,i+="<li  tname='"+a+"'>		<a href='javascript:void(0)' class='tile-store-name'>			<i class='mc-icon mc-icon-tilestore'></i>			<span title='"+a+"'>"+a+"</span>		</a></li>");i+="</ul>";var s=this.panel.find(".tile-db-tree .row[dname='"+this.dataSourceNameCur+"']");s.after(i);var n=this;this.panel.find(".nav[dname='"+this.dataSourceNameCur+"'] li").click(function(){if(null!=n.dataSourceNameCur){var e=$(this).attr("tname");null!=e&&n.showTileStore(n.dataSourceNameCur,e)}})}},showTileStoreListPanel:function(e){if($.isArray(e)){for(var i="",l=null,a=null,t=null,s=null,n=null,o="",r=0;r<e.length;++r)l=e[r],null!=l&&(a=l.name,t=l.format,n=l.tms,s=l.extent,i+="<div class='row' tname='"+a+"'>	<div class='col-md-1 col-xs-1'>"+(r+r)+"</div>	<div class='col-md-2 col-xs-2'>"+a+"</div>	<div class='col-md-2 col-xs-2'>"+t+"</div>	<div class='col-md-2 col-xs-2'>"+n+"</div>",null==s?i+="<div class='col-md-3 col-xs-3'></div>":(o=s.xmin.toFixed(2)+" , "+s.ymin.toFixed(2)+" , "+s.xmax.toFixed(2)+" , "+s.ymax.toFixed(2),i+="<div class='col-md-3 col-xs-3'>"+o+"</div>"),i+='	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-tilestore">进入</a>		<a href="javascript:void(0)" class="oper remove-tilestore">删除</a>	</div>',i+="</div>");this.panel.find("#datasource_tab .tilestore-list").html(i);var d=this;this.panel.find("#datasource_tab .enter-tilestore").click(function(){var e=$(this).parents(".row").attr("tname");if(null!=e){var i=d.panel.find("#datasource_tab .current-db").html();null!=i&&d.showTileStore(i,e)}}),this.panel.find("#datasource_tab .remove-tilestore").click(function(){var e=$(this).parents(".row").attr("tname");if(null!=e){var i=d.dataSourceNameCur;null!=i&&d.removeTileStore(i,e)}})}},showTileStore:function(e,i){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#tilestore_tab").css("display","block"),this.panel.find("#tilestore_tab .return-datasource").html(e),this.panel.find("#tilestore_tab .current-tilestore").html(i),this.panel.find(".nav[dname='"+e+"'] li").removeClass("selected"),this.panel.find(".nav[dname='"+e+"'] li[tname='"+i+"']").addClass("selected"),null!=name&&(MapCloud.notify.loading(),dbsManager.describeTileStore(e,i,this.describeTileStore_callback))},describeTileStore_callback:function(e){MapCloud.notify.hideLoading();var i=MapCloud.tilePanel;i.tileStore=e,"disabled"==i.panel.find("#show_tilestore_infos").attr("disabled")&&i.showTileStoreInfo(e),"disabled"==i.panel.find("#show_tilestore_preview").attr("disabled")&&i.showTileStorePreview(e)},showTileStoreInfo:function(e){if(this.panel.find("#tilestore_tab .right-panel-content-tab").css("display","none"),this.panel.find("#tilestore_infos_tab").css("display","block"),null!=e){var i="";i+="<div class='row'>			<div class='col-md-3 col-xs-3'>瓦片库名称</div>			<div class='col-md-8 col-xs-8'>"+e.name+"</div>		</div>		<div class='row'>			<div class='col-md-3 col-xs-3'>格式</div>			<div class='col-md-8 col-xs-8'>"+e.format+"</div>		</div>		<div class='row'>			<div class='col-md-3 col-xs-3'>切图标准</div>			<div class='col-md-8 col-xs-8'>"+e.tms+"</div>		</div>		<div class='row'>			<div class='col-md-3 col-xs-3'>范围</div>			<div class='col-md-8 col-xs-8'>"+(null!=e.extent?e.extent.toString():"")+"</div>		</div>		<div class='row'>			<div class='col-md-3 col-xs-3'>投影</div>			<div class='col-md-8 col-xs-8'>"+e.srid+"</div>		</div>		<div class='row'>			<div class='col-md-3 col-xs-3'>起始级别</div>			<div class='col-md-8 col-xs-8'>"+e.startLevel+"</div>		</div>		<div class='row'>			<div class='col-md-3 col-xs-3'>终止级别</div>			<div class='col-md-8 col-xs-8'>"+e.endLevel+"</div>		</div>",this.panel.find("#tilestore_infos_tab").html(i)}},showTileStorePreview:function(e){if(this.panel.find("#tilestore_tab .right-panel-content-tab").css("display","none"),this.panel.find("#tilestore_preview_tab").css("display","block"),null!=e){var i=new GeoBeans.Layer.WMTSLayer(e.name,dbsManager.server,e.name,e.extent,e.tms,e.format,e.sourceName),l=e.startLevel,a=e.endLevel;if(null!=l&&(i.MIN_ZOOM_LEVEL=l),null!=a&&(i.MAX_ZOOM_LEVEL=a),null!=this.map)this.map.removeBaseLayer(),this.map.draw(),this.map.setBaseLayer(i);else{var t=i.extent,s=4326;this.map=new GeoBeans.Map(user.server,"tilestore_preview_tab","tile",t,s,t),this.map.setBaseLayer(i)}if(null!=e.extent){var n=e.extent.getCenter();this.map.setCenter(n)}this.map.draw()}},removeTileStore:function(e,i){confirm("确定要删除["+i+"]")&&(MapCloud.notify.loading(),dbsManager.removeTileStore(e,i,this.removeTileStore_callback))},removeTileStore_callback:function(e){MapCloud.notify.showInfo(e,"删除瓦片库");var i=MapCloud.tilePanel,l=i.dataSourceNameCur;i.getTileStores(l)}});