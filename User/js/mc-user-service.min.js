$().ready(function(){cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");user=null,null!=e&&(user=new GeoBeans.User(e)),null!=user&&(serviceManager=user.getServiceManager(),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.servicePanel=new MapCloud.ServicePanel("service_panel"))});
MapCloud.ServicePanel=MapCloud.Class({panel:null,currentService:null,map:null,operService:null,initialize:function(e){this.panel=$("#"+e),this.registerPanelEvent(),this.describeServices()},registerPanelEvent:function(){var e=this;this.panel.find(".return-tree-list").click(function(){e.describeServices()}),this.panel.find("#show_service_info").click(function(){e.panel.find("#show_service_view").attr("disabled",!1),$(this).attr("disabled",!0),e.panel.find("#service_tab .right-panel-content-tab").hide(),e.panel.find("#service_tab #service_info_tab").show()}),this.panel.find("#show_service_view").click(function(){e.panel.find("#show_service_info").attr("disabled",!1),$(this).attr("disabled",!0),e.panel.find("#service_tab .right-panel-content-tab").hide(),e.panel.find("#service_tab #map_view_tab").show(),e.showServiceMap(e.currentService)}),this.panel.find(".service-oper").click(function(){if(null==e.currentService)return void MapCloud.notify.showInfo("当前服务为空","Warning");var i=e.currentService.state;"Started"==i?e.stopService(e.currentService.name):"Stopped"==i&&e.startService(e.currentService.name)})},describeServices:function(){this.panel.find(".service-tree").empty(),this.panel.find(".services-list").empty(),this.panel.find(".right-panel-tab").hide(),this.panel.find("#services_tab").show(),MapCloud.notify.loading(),serviceManager.describeServices(this.describeServices_callback)},describeServices_callback:function(e){MapCloud.notify.hideLoading();var i=MapCloud.servicePanel;i.showServicesTree(e),i.showServiceList(e)},showServicesTree:function(e){if($.isArray(e)){for(var i=null,s=null,a="",n=0;n<e.length;++n)i=e[n],null!=i&&(s=i.name,a+='<div class="row" sname="'+s+'">	<div class="col-md-1 col-xs-1">		<i class="service-icon list-icon"></i>	</div>	<div class="col-md-9 col-xs-9 map-tree-name">'+s+"	</div></div>");this.panel.find(".service-tree").html(a);var t=this;this.panel.find(".service-tree .row").click(function(){var e=$(this).attr("sname");t.describeService(e)})}},showServiceList:function(e){if($.isArray(e)){for(var i=null,s=null,a=null,n=null,t=null,l="",r=null,c=null,o=null,d=null,v="",p="",m=0;m<e.length;++m)if(i=e[m],null!=i){s=i.name,a=i.mapName,layers=i.layers,t=i.srid,n=i.extent,null!=n&&(l=n.xmin.toFixed(2)+" , "+n.ymin.toFixed(2)+" , "+n.xmax.toFixed(2)+" , "+n.ymax.toFixed(2)),r=i.thumb,c=i.state,o=i.operations,p="Started"==c?'<button class="btn btn-xs btn-primary btn-state">停止服务</button>':'<button class="btn btn-xs btn-primary btn-state">启动服务</button>';for(var f='<div class="row info-row-item">		<div class="col-md-3 col-xs-3">图层:</div>		<div class="col-md-5 col-xs-5">'+(null==layers[0]?"":layers[0].name)+"</div>	</div>",h=1;h<layers.length;++h)layer=layers[h],null!=layer&&(f+='<div class="row info-row-item">		<div class="col-md-3 col-md-3"></div>		<div class="col-md-5 col-xs-5">'+(null==layers[h]?"":layers[h].name)+"</div>	</div>");for(var u='<div class="row info-row-item">		<div class="col-md-3 col-xs-3">类型:</div>		<div class="col-md-5 col-xs-5">'+(null==o[0]?"":o[0])+"</div>	</div>",h=1;h<o.length;++h)d=o[h],null!=d&&(u+='<div class="row info-row-item">		<div class="col-md-3 col-xs-3"></div>		<div class="col-md-5 col-xs-5">'+(null==d?"":d)+"</div>	</div>");var w="";w="Started"==c?'<span class="state-icon service-state-start"></span>':'<span class="state-icon service-state-stop"></span>',v+='<div class="row service-row" sname="'+s+'">	<div class="col-md-1 col-xs-1 col-order">'+(m+1)+'	</div>	<div class="col-md-1 col-xs-1 col-order">'+w+'	</div>	<div class="col-md-2 col-xs-2 col-width-name">'+s+'	</div>	<div class="col-md-2 col-xs-2 col-width-name">'+a+'	</div>	<div class="col-md-2 col-xs-2 col-width-name">'+t+'	</div>	<div class="col-md-3 col-xs-3">'+l+'	</div>	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-service">进入</a>		<a href="javascript:void(0)" class="oper remove-service">删除</a>	</div></div><div class="row info-row" sname="'+s+'">	<div class="col-md-1 col-xs-1 col-order">	</div>	<div class="col-md-3 col-xs-3 thumb-div" style="background-image:url('+r+')">	</div>	<div class="col-md-4 col-xs-4">		<div class="row info-row-item">			<div class="col-md-3 col-xs-3">名称:</div>			<div class="col-md-5 col-xs-5">'+s+'</div>		</div>		<div class="row info-row-item">			<div class="col-md-3 col-xs-3">状态:</div>			<div class="col-md-5 col-xs-5">'+p+"</div>		</div>"+u+f+"	</div></div>"}this.panel.find(".services-list").html(v);var b=this;this.panel.find(".service-row").click(function(){var e=$(this),i=e.next();i.slideToggle(),i.toggleClass("selected"),e.toggleClass("selected")}),this.panel.find(".enter-service").click(function(){var e=$(this).parents(".row").attr("sname");b.describeService(e)}),this.panel.find(".remove-service").click(function(){var e=$(this).parents(".row").attr("sname");confirm("确定删除服务["+e+"]?")&&b.removeService(e)}),this.panel.find(".btn-state").click(function(){var e=$(this).parents(".info-row").attr("sname"),i=b.panel.find(".service-row[sname='"+e+"']").find(".state-icon");i.hasClass("service-state-start")?b.stopService(e):i.hasClass("service-state-stop")&&b.startService(e)})}},describeService:function(e){null!=e&&(this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#service_tab").show(),this.panel.find(".service-tree .row").removeClass("selected"),this.panel.find(".service-tree .row[sname='"+e+"']").addClass("selected"),this.panel.find(".current-service").html(e),this.panel.find(".map-info-layers").empty(),this.panel.find(".map-info-name").empty(),this.panel.find(".map-info-map").empty(),this.panel.find(".service-extent").remove(),this.panel.find(".map-info-srid").empty(),this.panel.find("#service_tab .right-panel-content-tab").hide(),this.panel.find("#service_info_tab").show(),this.panel.find("#show_service_info").attr("disabled",!0),this.panel.find("#show_service_view").attr("disabled",!1),this.panel.find(".thumb-big-div").css("background-image",""),this.currentService=null,MapCloud.notify.loading(),serviceManager.describeService(e,this.describeService_callback))},describeService_callback:function(e){MapCloud.notify.hideLoading();var i=MapCloud.servicePanel;i.currentService=e,i.showService(e)},showService:function(e){if(null!=e){var i=e.name,s=e.name,a=e.srid,n=e.extent,t=e.layers;if(this.panel.find(".map-info-name").html(i),this.panel.find(".map-info-map").html(s),this.panel.find(".map-info-srid").html(a),null!=n){var l="";l+='<div class="map-info-row service-extent">	<span class="map-info-item">空间范围 :</span>	<span class="map-info-extent">东 : '+n.xmax+'</span></div><div class="map-info-row service-extent">	<span class="map-info-item"></span>	<span class="map-info-extent">南 : '+n.ymin+'</span></div><div class="map-info-row service-extent">	<span class="map-info-item"></span>	<span class="map-info-extent">西 : '+n.xmin+'</span></div><div class="map-info-row service-extent">	<span class="map-info-item"></span>	<span class="map-info-extent">北 : '+n.ymax+"</span></div>",this.panel.find(".map-info-srid").parent().after(l)}var r=e.thumb;this.panel.find(".thumb-big-div").css("background-image","url("+r+")");for(var c,o=null,c=null,d=null,a=null,v="",p=0;p<t.length;++p)if(o=t[p],null!=o&&(i=o.name,c=o.extent,d=o.type,"Feature"==d||"Raster"==d)){if(v+='<div class="map-info-row">	<span class="map-info-layer-name">'+i+'</span>	<span class="map-info-item">类型：</span>	<span class="map-info-name">'+d+"</span>",null!=c){var m=c.xmin.toFixed(2)+" , "+c.ymin.toFixed(2)+" , "+c.xmax.toFixed(2)+" , "+c.ymax.toFixed(2);v+='	<span class="map-info-item">范围：</span>	<span class="map-info-extent">'+m+"</span>"}v+="</div>"}this.panel.find(".map-info-layers").html(v);var f=e.state;"Stopped"==f?(this.panel.find(".service-state").addClass("service-state-stop").removeClass("service-state-start"),this.panel.find(".service-oper").html("启动服务"),this.panel.find("#show_service_view").attr("disabled",!0)):"Started"==f&&(this.panel.find(".service-state").addClass("service-state-start").removeClass("service-state-stop"),this.panel.find(".service-oper").html("停止服务"),this.panel.find("#show_service_view").attr("disabled",!1))}},removeService:function(e){null!=e&&(MapCloud.notify.loading(),serviceManager.removeService(e,this.removeService_callback))},removeService_callback:function(e){MapCloud.notify.showInfo(e,"删除服务");var i=MapCloud.servicePanel;i.describeServices()},showServiceMap:function(e){if(null!=e){var i=new GeoBeans.Envelope(-180,-90,180,90),s="/ows/"+user.name+"/"+e.name+"/ims?",a=e.getWMSLayers();if(null==this.map?this.map=new GeoBeans.Map(null,"map_view_tab","name",i,4326):this.map.removeLayer("wms"),0!=a.length){var n=new GeoBeans.Layer.WMSLayer("wms",s,a,null,null);this.map.insertLayer(n,null)}this.map.draw()}},stopService:function(e){MapCloud.notify.loading(),this.operService=e,serviceManager.stopService(e,this.stopService_callback)},stopService_callback:function(e){var i=MapCloud.servicePanel;MapCloud.notify.showInfo(e,"停止服务"+i.operService),"success"==e&&(i.panel.find(".service-state").addClass("service-state-stop").removeClass("service-state-start"),i.panel.find(".service-oper").html("启动服务"),i.panel.find("#show_service_view").attr("disabled",!0),null!=i.currentService&&(i.currentService.state="Stopped"),i.panel.find(".service-row[sname='"+i.operService+"'] .state-icon").addClass("service-state-stop").removeClass("service-state-start"),i.panel.find(".info-row[sname='"+i.operService+"'] .btn-primary").html("启动服务")),i.operService=null},startService:function(e){MapCloud.notify.loading(),this.operService=e,serviceManager.startService(e,this.startService_callback)},startService_callback:function(e){var i=MapCloud.servicePanel;MapCloud.notify.showInfo(e,"启动服务"+i.operService),"success"==e&&(i.panel.find(".service-state").removeClass("service-state-stop").addClass("service-state-start"),i.panel.find(".service-oper").html("停止服务"),i.panel.find("#show_service_view").attr("disabled",!1),null!=i.currentService&&(i.currentService.state="Started"),i.panel.find(".service-row[sname='"+i.operService+"'] .state-icon").removeClass("service-state-stop").addClass("service-state-start"),i.panel.find(".info-row[sname='"+i.operService+"'] .btn-primary").html("停止服务")),i.operService=null}});