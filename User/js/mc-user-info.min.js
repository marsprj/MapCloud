$().ready(function(){cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");if(user=null,null!=e&&(user=new GeoBeans.User(e)),null!=user){var a="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(a),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),jobManager=user.getJobManager(),MapCloud.userPanel=new MapCloud.UserPanel("user_info_panel")}});
MapCloud.UserPanel=MapCloud.Class({panel:null,serviceChart:null,maxFeatures:15,currentPage:null,initialize:function(e){this.panel=$("#"+e),null!=user&&this.getUserInfo(user.name),this.registerPanelEvent()},registerPanelEvent:function(){var e=this;this.panel.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.panel.find(".user-info-btn").click(function(){e.panel.find(".user-panel-tab").removeClass("active"),e.panel.find("#user_info_tab").addClass("active"),$(this).removeClass("disabled"),e.panel.find(".user-job-btn").addClass("disabled")}),this.panel.find(".user-job-btn").click(function(){e.panel.find(".user-panel-tab").removeClass("active"),e.panel.find("#user_job_tab").addClass("active"),$(this).removeClass("disabled"),e.panel.find(".user-info-btn").addClass("disabled"),null==e.ipChart&&e.setDeafaultIpStat(),e.getJobList()}),this.panel.find(".info-edit").click(function(){var t=e.panel.find(".user-info"),a=e.panel.find(".user-password");"table-cell"==t.css("display")&&(t.css("display","none"),a.css("display","block"))}),this.panel.find(".btn-return").click(function(){var t=e.panel.find(".user-info"),a=e.panel.find(".user-password");t.css("display","table-cell"),a.css("display","none")}),this.panel.find(".btn-change-password").click(function(){e.changePassword()}),this.panel.find("#ip_list .btn-chart-table").click(function(){e.panel.find(".ip-chart-div").hasClass("active")?($(this).find("i").removeClass("fa-table").addClass("fa-bar-chart"),e.panel.find("#ip_list .tab-div").removeClass("active"),e.panel.find(".ip-table-div").addClass("active")):($(this).find("i").removeClass("fa-bar-chart").addClass("fa-table"),e.panel.find("#ip_list .tab-div").removeClass("active"),e.panel.find(".ip-chart-div").addClass("active"))}),this.panel.find("#service_list .btn-chart-table").click(function(){e.panel.find(".service-chart-div").hasClass("active")?($(this).find("i").removeClass("fa-table").addClass("fa-bar-chart"),e.panel.find("#service_list .tab-div").removeClass("active"),e.panel.find(".service-table-div").addClass("active")):($(this).find("i").removeClass("fa-bar-chart").addClass("fa-table"),e.panel.find("#service_list .tab-div").removeClass("active"),e.panel.find(".service-chart-div").addClass("active"))}),this.panel.find("input.date-picker").datetimepicker({format:"yyyy-mm-dd hh:00",minView:"day",autoclose:!0,maxView:"year",language:"zh-CN"}),this.panel.find("#ip_list .btn-refresh").click(function(){e.refreshIpStat()}),this.panel.find("#service_list .btn-refresh").click(function(){e.refreshServiceStat()}),this.panel.find("#job_list .pre-page").click(function(){e.currentPage>=1&&e.getJobListByPage(e.currentPage-1)}),this.panel.find("#job_list .next-page").click(function(){var t=e.panel.find("#job_list tbody tr").length;t<e.maxFeatures||e.getJobListByPage(e.currentPage+1)}),this.panel.find("#job_list .btn-refresh").click(function(){e.getJobListByPage(0)})},showIPChart:function(e,t){function a(e){var t=e.name;if(null!=t){var a=[{key:t,value:e.data}];s.setDefaultServiceStat(a)}}if(option={tooltip:{trigger:"axis"},legend:{data:["访问次数"]},grid:{x:100,y:40,y2:90},yAxis:[{type:"value"}],xAxis:[{type:"category",axisTick:{show:!1},data:e,axisLabel:{interval:0,rotate:45}}],toolbox:{show:!0,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},series:[{name:"访问次数",type:"bar",label:{normal:{show:!0,position:"inside"}},data:t,clickable:!0}]},null==this.ipChart){var i=echarts.init(document.getElementById("ip_chart_div"),"macarons");i.setOption(option),this.ipChart=i,this.ipChart.on(echarts.config.EVENT.CLICK,a)}else if(null==this.ipChart.getSeries()){this.ipChart.dispose();var i=echarts.init(document.getElementById("ip_chart_div"),"macarons");i.setOption(option),this.ipChart=i,this.ipChart.on(echarts.config.EVENT.CLICK,a)}else this.ipChart.clear(),this.ipChart.setOption(option);var s=this},showServiceChart:function(e,t){var a={tooltip:{trigger:"axis"},legend:{data:["访问次数"]},grid:{x:40,y:40,y2:120},yAxis:[{type:"value"}],xAxis:[{type:"category",axisTick:{show:!1},data:e,axisLabel:{interval:0,rotate:45}}],toolbox:{show:!0,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},series:[{name:"访问次数",type:"line",label:{normal:{show:!0,position:"inside"}},data:t,itemStyle:{normal:{areaStyle:{type:"default"}}}}]};if(null==this.serviceChart){var i=echarts.init(document.getElementById("service_chart_div"),"macarons");i.setOption(a),this.serviceChart=i}else if(null==this.serviceChart.getSeries()){this.serviceChart.dispose();var i=echarts.init(document.getElementById("service_chart_div"),"macarons");i.setOption(a),this.serviceChart=i}else this.serviceChart.clear(),this.serviceChart.setOption(a)},getServiceStat_callback:function(e){var t=MapCloud.userPanel;t.panel.find("#service_list .panel-body").removeClass("loading"),$.isArray(e)&&(t.showServiceTable(e),t.showServiceStat(e))},showServiceTable:function(e){if(null!=e){for(var t=null,a="",i=0;i<e.length;++i)t=e[i],null!=t&&(a+="<tr>	<td class='td-width-50'>"+t.key+"</td>	<td class='td-width-50'>"+t.count+"</td></tr>");this.panel.find(".service-table-div tbody").html(a)}},showServiceStat:function(e){if(null!=e){for(var t=[],a=[],i=0;i<e.length;++i)null!=e[i]&&(t.push(e[i].key),a.push(e[i].count));this.showServiceChart(t,a)}},dateAdd:function(e,t,a){var i=new Date(e);switch(t.toLowerCase()){case"year":i.setFullYear(i.getFullYear()+a);break;case"quarter":i.setMonth(i.getMonth()+3*a);break;case"month":i.setMonth(i.getMonth()+a);break;case"week":i.setDate(i.getDate()+7*a);break;case"day":i.setDate(i.getDate()+a);break;case"hour":i.setTime(i.getTime()+36e5*a);break;case"minute":i.setTime(i.getTime()+6e4*a);break;case"second":i.setTime(i.getTime()+1e3*a);break;default:i=void 0}return i},toTimeFormat:function(e){if(null==e)return null;var t=e.getFullYear().toString(),a=(e.getMonth()+1).toString(),i=e.getDate().toString(),s=e.getHours().toString(),n=e.getMinutes().toString(),l=e.getSeconds().toString();return t+"-"+(a[1]?a:"0"+a[0])+"-"+(i[1]?i:"0"+i[0])+" "+(s[1]?s:"0"+s[0])+":"+(n[1]?n:"0"+n[0])+":"+(l[1]?l:"0"+l[0])},refreshServiceStat:function(){var e=this.panel.find(".service-field").val(),t=this.panel.find("#service_start_date").val(),a=this.panel.find("#service_end_date").val();if(new Date(a)-new Date(t)<=0)return void MapCloud.notify.showInfo("请选择有效的时间段","Warning");var i=this.panel.find("#service_list .panel-heading strong  span").html();this.panel.find("#service_list .panel-body").addClass("loading"),jobManager.getJobStatistics(e,i,t,a,this.getServiceStat_callback)},setDeafaultIpStat:function(){var e=new Date;e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0);var t=(e.getHours(),this.dateAdd(e,"hour",1)),a=this.dateAdd(t,"month",-1),i=this.toTimeFormat(a),s=this.toTimeFormat(t);this.panel.find("#ip_start_date").val(i),this.panel.find("#ip_start_date").datetimepicker("update"),this.panel.find("#ip_end_date").val(s),this.panel.find("#ip_end_date").datetimepicker("update"),this.panel.find("#ip_list .panel-body").addClass("loading"),this.panel.find("#ip_list tbody").empty(),this.panel.find("#ip_chart_div").empty(),this.ipChart=null,jobManager.getJobStatistics("client",null,i,s,this.getIpStat_callback)},setDefaultServiceStat:function(e){if(null==e||0==e.length)return null!=this.serviceChart&&this.serviceChart.dispose(),this.panel.find(".service-chart-div").empty(),void this.panel.find(".service-table-div").empty();var t=e[0];if(null!=t){var a=t.key;this.panel.find("#service_list .panel-heading span").html(a);var i=this.panel.find("#ip_start_date").val(),s=this.panel.find("#ip_end_date").val();this.panel.find("#service_start_date").val(i),this.panel.find("#service_start_date").datetimepicker("update"),this.panel.find("#service_end_date").val(s),this.panel.find("#service_end_date").datetimepicker("update"),this.panel.find("#service_list .panel-body").addClass("loading"),jobManager.getJobStatistics("operation",a,i,s,this.getServiceStat_callback)}},getIpStat_callback:function(e){var t=MapCloud.userPanel;t.panel.find("#ip_list .panel-body").removeClass("loading"),$.isArray(e)&&(t.showIpTable(e),t.showIpStat(e),t.setDefaultServiceStat(e))},showIpTable:function(e){if(null!=e){for(var t=null,a="",i=0;i<e.length;++i)t=e[i],null!=t&&"192.168.111.82"!=t.key&&(a+="<tr>	<td class='td-width-50'>"+t.key+"</td>	<td class='td-width-50'>"+t.count+"</td></tr>");this.panel.find(".ip-table-div tbody").html(a)}},showIpStat:function(e){if(null!=e){for(var t=[],a=[],i=0;i<e.length;++i)if(null!=e[i]){if("192.168.111.82"==e[i].key)continue;t.push(e[i].key),a.push(e[i].count)}this.showIPChart(t,a)}},refreshIpStat:function(){var e=this.panel.find("#ip_start_date").val(),t=this.panel.find("#ip_end_date").val();return new Date(t)-new Date(e)<=0?void MapCloud.notify.showInfo("请选择有效的时间段","Warning"):(this.panel.find("#ip_list .panel-body").addClass("loading"),void jobManager.getJobStatistics("client",null,e,t,this.getIpStat_callback))},getJobList:function(){this.getJobListByPage(0)},getJobListByPage:function(e){if(!(0>e)){this.currentPage=e;var t=e*this.maxFeatures;this.panel.find("#job_list tbody").empty(),this.panel.find("#job_list .panel-body").addClass("loading"),jobManager.getJob(this.maxFeatures,t,this.getJobList_callback)}},getJobList_callback:function(e){var t=MapCloud.userPanel;t.panel.find("#job_list .panel-body").removeClass("loading"),$.isArray(e)&&t.showJobList(e)},showJobList:function(e){if(null!=e){for(var t=null,a="",i=0;i<e.length;++i)t=e[i],null!=t&&(a+="<tr>	<td class='td-width-15'>"+(null==t.client||""==t.client?"&nbsp;":t.client)+"</td>	<td class='td-width-15'>"+(null==t.server||""==t.server?"&nbsp;":t.server)+"</td>	<td class='td-width-20'>"+(null==t.operation||""==t.operation?"&nbsp;":t.operation)+"</td>	<td class='td-width-20'>"+(null==t.startTime||""==t.startTime?"&nbsp;":t.startTime)+"</td>	<td class='td-width-20'>"+(null==t.endTime||""==t.endTime?"&nbsp;":t.endTime)+"</td>	<td class='td-width-10'>"+(null==t.state||""==t.state?"&nbsp;":t.state)+"</td></tr>");this.panel.find("#job_list tbody").html(a)}},getUserInfo:function(e){authManager.getUser(e,this.getUserInfo_callback)},getUserInfo_callback:function(e){if(!(e instanceof Object))return void console.log(e);var t=MapCloud.userPanel;t.showUserInfo(e)},showUserInfo:function(e){var t=e.name,a=e.alias,i=e.email,s=e.role;this.panel.find(".user-name").html(t),this.panel.find(".user-alias").html(a),this.panel.find(".user-email").html(i),this.panel.find(".user-role").html(s)},changePassword:function(){var e=(user.name,this.panel.find(".user-passwd").val());if(""==e)return MapCloud.notify.showInfo("请输入密码","Warning"),void this.panel.find(".user-passwd").focus();var t=this.panel.find(".user-repasswd").val();return""==t?(MapCloud.notify.showInfo("请再次输入密码","Warning"),void this.panel.find(".user-repasswd").focus()):e!=t?void MapCloud.notify.showInfo("两次输入的密码不一致","Warning"):void 0}});