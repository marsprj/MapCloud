var user=null,subManager=null;$().ready(function(){cookieObj=new MapCloud.Cookie;var a=cookieObj.getCookie("username");if(user=null,null!=a&&(user=new GeoBeans.User(a)),null!=user){var e="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(e),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),subManager=user.getSubManager(),MapCloud.subPanel=new MapCloud.SubPanel("user_sub_panel"),MapCloud.aqi_city_dialog=new MapCloud.AQICityDialog("aqi_city_dialog")}});
MapCloud.SubPanel=MapCloud.Class({panel:null,poiNames:null,aqiCitys:null,setAQICity:null,initialize:function(i){this.panel=$("#"+i),null!=user&&null!=subManager&&subManager.getSubscription(this.getSubscription_callback),this.registerPanelEvent()},registerPanelEvent:function(){var i=this;this.panel.find(".select-city").click(function(){MapCloud.aqi_city_dialog.showDialog(i.aqiCitys,user.server)}),this.panel.find(".btn-subscribe").click(function(){i.subscribe()})},getSubscription:function(){var i=subManager.getSubscriptionKeywords();this.setSubscriptionNames(i)},getSubscription_callback:function(i,s){if(null!=i&&null!=s){var a=MapCloud.subPanel;a.setSubscriptionNames(s)}},setSubscriptionNames:function(i){var s=i.poi,a=i.aqi;if(this.poiNames=s,this.aqiCitys=a,null==a)return this.aqiCitys=[],void this.panel.find(".aqi-city").html("空");if(0==this.aqiCitys.length)return void this.panel.find(".aqi-city").html("空");for(var t="",n=0;n<a.length;++n)city=a[n],t+="<span class='label label-success aqi-city-label'>"+city+"</span>";this.panel.find(".aqi-city").html(t)},subscribeAQI_callback:function(i){var s=MapCloud.subPanel;MapCloud.notify.showInfo(i,"订阅AQI城市"),subManager.getSubscription(s.getSubscription_callback)},setSelectAQICity:function(i){this.setAQICity=i;for(var s="",a=null,t=0;t<i.length;++t)a=i[t],s+="<span class='label label-success aqi-city-label'>"+a+"</span>";this.panel.find(".aqi-city").html(s);for(var a=null,n=null,l=[],t=0;t<i.length;++t)a=i[t],n=this.aqiCitys.indexOf(a),-1==n&&l.push(a);0!=l.length&&subManager.subscribe("aqi",l,this.subscribeAQI_callback);for(var t=0;t<this.aqiCitys.length;++t)a=this.aqiCitys[t],n=i.indexOf(a),-1==n&&subManager.Unsubscribe("aqi",a,this.Unsubscribe_callback)},Unsubscribe_callback:function(i){var s=MapCloud.subPanel;MapCloud.notify.showInfo(i,"取消订阅AQI城市"),subManager.getSubscription(s.getSubscription_callback)},subscribe:function(){this.subscribeAQI()},subscribePOI:function(){var i=[];this.panel.find(".topic-label input:checked").each(function(){var s=$(this).parent().find("span").attr("pname");i.push(s)});for(var s=null,a=null,t=[],n=0;n<i.length;++n)s=i[n],a=this.poiNames.indexOf(s),-1==a&&t.push(s);0!=t.length&&subManager.subscribe("poi",t,this.subscribePOI_callback);for(var n=0;n<this.poiNames.length;++n)s=this.poiNames[n],a=i.indexOf(s),-1==a&&subManager.Unsubscribe("poi",s,this.unsubscribePoi_callback)},subscribePOI_callback:function(i){MapCloud.subPanel;MapCloud.notify.showInfo(i,"订阅兴趣点")},unsubscribePoi_callback:function(i){MapCloud.subPanel;MapCloud.notify.showInfo(i,"取消订阅兴趣点")},subscribeAQI:function(){for(var i=null,s=null,a=[],t=0;t<this.setAQICity.length;++t)i=this.setAQICity[t],s=this.aqiCitys.indexOf(i),-1==s&&a.push(i);0!=a.length&&subManager.subscribe("aqi",a,this.subscribeAQI_callback);for(var t=0;t<this.aqiCitys.length;++t)i=this.aqiCitys[t],s=this.setAQICity.indexOf(i),-1==s&&subManager.Unsubscribe("aqi",i,this.Unsubscribe_callback)}});