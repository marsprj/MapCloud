var user=null,subManager=null;$().ready(function(){cookieObj=new MapCloud.Cookie;var e=cookieObj.getCookie("username");if(user=null,null!=e&&(user=new GeoBeans.User(e)),null!=user){var a="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(a),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),subManager=user.getSubManager(),MapCloud.subPanel=new MapCloud.SubPanel("user_sub_panel")}});
MapCloud.SubPanel=MapCloud.Class({panel:null,poiNames:null,aqiCitys:null,setAQICity:null,citys:null,aqiCityLayer:"gc_aqi_city",sourceName:"base",aqiCityField:"name",featuretype:null,maxCount:10,pageCount:null,pageNumber:5,initialize:function(i){this.panel=$("#"+i),null!=user&&null!=subManager&&subManager.getSubscription(this.getSubscription_callback),this.registerPanelEvent(),this.showAQIList()},registerPanelEvent:function(){var i=this;this.panel.find(".btn-subscribe").click(function(){i.subscribe()}),this.panel.find(".query-city").click(function(){var t=i.panel.find(".query-city-name").val();return""==t?void MapCloud.notify.showInfo("请输出查询的城市名称","Warning"):void i.getAQICityByName(t,i.getAQICityByName_callback)}),this.panel.find(".return-list").click(function(){i.initPageControl(1,i.pageCount)}),this.panel.find(".btn-confirm").click(function(){confirm("确定进行订阅吗？")&&i.setSelectAQICity(i.aqiCitys)}),this.panel.find(".btn-cancel").click(function(){confirm("确定取消修改吗？")&&subManager.getSubscription(i.getSubscription_callback)})},getSubscription:function(){var i=subManager.getSubscriptionKeywords();this.setSubscriptionNames(i)},getSubscription_callback:function(i,t){if(null!=i&&null!=t){var a=MapCloud.subPanel;a.setSubscriptionNames(t)}},setSubscriptionNames:function(i){var t=i.poi,a=i.aqi;return this.poiNames=t,this.aqiCitys=a,this.beforeCitys=a.slice(0,a.length),null==a?(this.aqiCitys=[],void this.panel.find(".aqi-city").html("空")):0==this.aqiCitys.length?void this.panel.find(".aqi-city").html("空"):void this.showSelectedCity(this.aqiCitys)},subscribeAQI_callback:function(i){var t=MapCloud.subPanel;MapCloud.notify.showInfo(i,"订阅AQI城市"),subManager.getSubscription(t.getSubscription_callback)},setSelectAQICity:function(i){this.setAQICity=i;for(var t=null,a=null,e=[],s=0;s<i.length;++s)t=i[s],a=this.beforeCitys.indexOf(t),-1==a&&e.push(t);0!=e.length&&subManager.subscribe("aqi",e,this.subscribeAQI_callback);for(var s=0;s<this.beforeCitys.length;++s)t=this.beforeCitys[s],a=i.indexOf(t),-1==a&&subManager.Unsubscribe("aqi",t,this.Unsubscribe_callback)},Unsubscribe_callback:function(i){var t=MapCloud.subPanel;MapCloud.notify.showInfo(i,"取消订阅AQI城市"),subManager.getSubscription(t.getSubscription_callback)},subscribe:function(){this.subscribeAQI()},subscribePOI:function(){var i=[];this.panel.find(".topic-label input:checked").each(function(){var t=$(this).parent().find("span").attr("pname");i.push(t)});for(var t=null,a=null,e=[],s=0;s<i.length;++s)t=i[s],a=this.poiNames.indexOf(t),-1==a&&e.push(t);0!=e.length&&subManager.subscribe("poi",e,this.subscribePOI_callback);for(var s=0;s<this.poiNames.length;++s)t=this.poiNames[s],a=i.indexOf(t),-1==a&&subManager.Unsubscribe("poi",t,this.unsubscribePoi_callback)},subscribePOI_callback:function(i){MapCloud.subPanel;MapCloud.notify.showInfo(i,"订阅兴趣点")},unsubscribePoi_callback:function(i){MapCloud.subPanel;MapCloud.notify.showInfo(i,"取消订阅兴趣点")},subscribeAQI:function(){for(var i=null,t=null,a=[],e=0;e<this.setAQICity.length;++e)i=this.setAQICity[e],t=this.aqiCitys.indexOf(i),-1==t&&a.push(i);0!=a.length&&subManager.subscribe("aqi",a,this.subscribeAQI_callback);for(var e=0;e<this.aqiCitys.length;++e)i=this.aqiCitys[e],t=this.setAQICity.indexOf(i),-1==t&&subManager.Unsubscribe("aqi",i,this.Unsubscribe_callback)},showAQIList:function(){var i=new GeoBeans.WFSWorkspace("tmp",user.server,"1.0.0");this.featuretype=new GeoBeans.FeatureType(i,this.aqiCityLayer),this.getAQICitysCount()},getAQICitysCount:function(){this.featuretype.getFeatureFilterCountAsync(null,this.sourceName,null,null,this.getAQICitysCount_callback)},getAQICitysCount_callback:function(i,t){var a=MapCloud.subPanel,e=Math.ceil(t/a.maxCount);a.pageCount=e,a.initPageControl(1,a.pageCount)},initPageControl:function(i,t){if(!(0>=i||i>t)){var a="";if(a+=1==i?'<li class="disabled">		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>':'<li>		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>',t<=this.pageNumber)for(var e=1;t>=e;++e)a+=e==i?'<li class="active">	<a href="#">'+i.toString()+'		<span class="sr-only">(current)</span></a></li>':"<li><a href='#'>"+e+"</a></li>";else{var s=t-this.pageNumber+1;if(s>=i)for(var e=i;e<i+this.pageNumber;++e)a+=e==i?'<li class="active">	<a href="#">'+i+"</a></li>":"<li><a href='#'>"+e+"</a></li>";else for(var e=s;t>=e;++e)a+=e==i?'<li class="active">	<a href="#">'+i+"</a></li>":"<li><a href='#'>"+e+"</a></li>"}a+=i==t?'<li class="disabled">		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>':'<li>		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>',this.panel.find(".pagination").html(a),this.registerPageEvent();var n=(i-1)*this.maxCount;this.getAQICityList(this.maxCount,n)}},getAQICityList:function(i,t){MapCloud.notify.loading(),this.featuretype.getFeaturesAsync(null,this.sourceName,i,t,null,this.getAQICity_callback)},getAQICity_callback:function(i){MapCloud.notify.hideLoading();var t=MapCloud.subPanel;t.showAQICityList(i)},registerPageEvent:function(){var i=this;this.panel.find(".pagination li a").click(function(){var t=i.panel.find(".pagination li.active a").html(),a=parseInt(t),e=$(this).attr("aria-label");"Previous"==e?a-=1:"Next"==e?a+=1:a=parseInt($(this).html()),i.initPageControl(a,i.pageCount)})},getAQICityByName:function(i,t){if(null!=i){var a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var e=new GeoBeans.PropertyName;e.setName(this.aqiCityField);var s=new GeoBeans.Literal;s.setValue(i),a.expression1=e,a.expression2=s;var n=this.featuretype.buildGetFeatureFilterXML(null,this.sourceName,a,null,null,null),l=user.server,r=this;$.ajax({type:"post",url:l,data:n,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(i){},success:function(i,a){var e=r.featuretype.parseFeatures(i);void 0!=t&&t(e)},complete:function(i,t){},error:function(i,t,a){console.log("textStatus:"+t),console.log("error:"+a)}})}},getAQICityByName_callback:function(i){var t=MapCloud.subPanel;t.showAQICityList(i)},showAQICityList:function(i){for(var t=null,a=null,e=null,s=null,n=null,l=null,r="",c=0;c<i.length;++c){t=i[c],a=t.values,e=a[0],s=a[1],n=a[2],l=a[4];var o=!1,u=this.aqiCitys.indexOf(s);-1!=u&&(o=!0),r+="<div class='row' cname='"+s+"'>	<div class='col-md-1 col-xs-1'>",r+=o?"		<input type='checkbox' checked>":"		<input type='checkbox'>",r+="	</div>	<div class='col-md-2 col-xs-2'>"+e+"</div>	<div class='col-md-3 col-xs-3'>"+s+"</div>	<div class='col-md-4 col-xs-4'>"+n+"</div>	<div class='col-md-2 col-xs-2'>"+l+"</div></div>"}this.panel.find(".aqi-city-list-div").html(r);var h=this;this.panel.find(".aqi-city-list-div input").change(function(){var i=$(this).prop("checked"),t=$(this).parents(".row").attr("cname");if(i){if(-1==h.aqiCitys.indexOf(t)){if(5==h.aqiCitys.length)return $(this).prop("checked",!1),void MapCloud.notify.showInfo("最多选择5个城市","Warning");h.aqiCitys.push(t),h.showSelectedCity(h.aqiCitys)}}else{var a=h.aqiCitys.indexOf(t);-1!=a&&(h.aqiCitys.splice(a,1),h.showSelectedCity(h.aqiCitys))}})},showSelectedCity:function(i){for(var t="",a=0;a<i.length;++a)city=i[a],t+='<span class="label label-success aqi-city-label">	<span class="aqi-city-name">'+city+'</span>	<span aria-hidden="true">×</span></span>';this.panel.find(".aqi-city").html(t);var e=this;this.panel.find(".aqi-city .aqi-city-label").click(function(){var i=$(this).find(".aqi-city-name").html(),t=e.aqiCitys.indexOf(i);-1!=t&&(e.panel.find(".aqi-city-list-div .row[cname='"+i+"'] input").prop("checked",!1),e.aqiCitys.splice(t,1),e.showSelectedCity(e.aqiCitys))})}});