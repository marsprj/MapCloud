$().ready(function(){cookieObj=new MapCloud.Cookie;var a=cookieObj.getCookie("username");user=null,null!=a&&(user=new GeoBeans.User(a)),null!=user&&(dbsManager=user.getDBSManager(),fileManager=user.getFileManager(),gpsManager=user.getGPSManager(),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.pgis_connection_dialog=new MapCloud.PGISConnectDialog("pgisConnDialog"),MapCloud.import_dialog=new MapCloud.ImportDialog("import_dialog"),MapCloud.file_dialog=new MapCloud.FileDialog("fileDialog"),MapCloud.importCSV_dialog=new MapCloud.ImportCSVDialog("import_csv_dialog"),MapCloud.create_dataset_dialog=new MapCloud.CreateDataSetDialog("create_dataset_dialog"),MapCloud.vectorPanel=new MapCloud.VectorPanel("vector_panel"),$(".modal").draggable({handle:".modal-header"}))});
MapCloud.VectorPanel=MapCloud.Class({panel:null,dataSourceCur:null,dataSetCur:null,maxFeatures:30,initialize:function(a){this.panel=$("#"+a),this.registerPanelEvent(),this.getDataSources()},registerPanelEvent:function(){var a=this;this.panel.find(".return-datasources-list").click(function(){a.getDataSources()}),this.panel.find(".return-datasource").click(function(){var t=$(this).html();a.getDataSource(t)}),this.panel.find(".add-db").click(function(){MapCloud.pgis_connection_dialog.showDialog("feature","user-feature")}),this.panel.find("#show_datasets_list").click(function(){a.panel.find("#show_datasets_thumb").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").css("display","none"),a.panel.find("#datasets_list_tab").css("display","block")}),this.panel.find("#show_datasets_thumb").click(function(){a.panel.find("#show_datasets_list").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").css("display","none"),a.panel.find("#datasets_thumb_tab").css("display","block")}),this.panel.find(".import-vector").click(function(){return null==a.dataSourceCur?void MapCloud.notify.showInfo("请选择一个数据库","Warning"):(MapCloud.import_dialog.showDialog("vector-user"),void MapCloud.import_dialog.setDataSourceName(a.dataSourceCur.name))}),this.panel.find(".import-csv").click(function(){return null==a.dataSourceCur?void MapCloud.notify.showInfo("请选择一个数据库","Warning"):(MapCloud.importCSV_dialog.showDialog("vector-user"),void MapCloud.importCSV_dialog.setDataSourceName(a.dataSourceCur.name))}),this.panel.find(".create-dataset").click(function(){a.createDataSet()}),this.panel.find("#show_dataset_infos").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetInfos(a.dataSetCur)}),$("#show_dataset_fields").click(function(){$("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetFields(a.dataSetCur)}),this.panel.find("#show_dataset_features").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetFeatures(a.dataSetCur)}),this.panel.find("#show_dataset_preview").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetPreview(a.dataSetCur)}),this.panel.find(".glyphicon-step-backward").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-pages").html());t>=1&&a.setDataSetFeaturePage(1)})}),this.panel.find(".glyphicon-step-forward").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-pages").html());t>=1&&a.setDataSetFeaturePage(t)})}),this.panel.find(".glyphicon-chevron-left").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-page").val());a.setDataSetFeaturePage(t-1)})}),this.panel.find(".glyphicon-chevron-right").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-page").val());a.setDataSetFeaturePage(t+1)})})},getDataSources:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasources_tab").css("display","block"),MapCloud.notify.loading(),dbsManager.getDataSources(this.getDataSources_callback,"Feature")},getDataSources_callback:function(a){MapCloud.notify.hideLoading();var t=MapCloud.vectorPanel;t.showDataSourcesTree(a),t.showDataSourcesList(a)},showDataSourcesTree:function(a){if($.isArray(a)){for(var t=null,e=null,s="",l=0;l<a.length;++l)t=a[l],null!=t&&(e=t.name,s+='<div class="row" dname="'+e+'">	<div class="col-md-1 col-xs-1 col-md-20px">		<div class="glyphicon glyphicon-chevron-right mc-icon mc-icon-right mc-icon-rotate"></div>	</div>	<div class="col-md-1 col-xs-1 col-md-20px">		<i class="db-icon list-icon"></i>	</div>	<div class="col-md-7 col-xs-7 db-tree-name">'+e+"</div></div>");this.panel.find(".vector-db-tree").html(s);var i=this;this.panel.find(".vector-db-tree .glyphicon-chevron-right").click(function(){var a=$(this).parents(".row").first().attr("dname");$(this).hasClass("mc-icon-right")?($(this).removeClass("mc-icon-right"),$(this).addClass("mc-icon-down"),$(this).css("transform","rotate(90deg) translate(3px,0px)"),i.panel.find(".vector-db-tree .nav[dname='"+a+"']").remove(),i.getDataSource(a)):($(this).css("transform","rotate(0deg) translate(0px,0px)"),$(this).addClass("mc-icon-right"),$(this).removeClass("mc-icon-down"),i.panel.find(".vector-db-tree .nav[dname='"+a+"']").slideUp(500))})}},showDataSourcesList:function(a){if($.isArray(a)){for(var t=null,e=null,s="",l=null,i=null,n=0;n<a.length;++n)if(t=a[n],null!=t){e=t.name,i=t.constr,l=t.engine;var d=this.getDataSourceInfo(i);s+='<div class="row" dname="'+e+'">	<div class="col-md-1 col-xs-1">'+(n+1)+'	</div>	<div class="col-md-2 col-xs-2">'+e+'	</div>	<div class="col-md-2 col-xs-2">'+d.server+'	</div>	<div class="col-md-1 col-xs-1">'+d.instance+'	</div>	<div class="col-md-1 col-xs-1">'+d.database+'	</div>	<div class="col-md-1 col-xs-1">'+d.user+'	</div>	<div class="col-md-2 col-xs-2">'+d.password+'	</div>	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-db">进入</a>		<a href="javascript:void(0)" class="oper remove-db">删除</a>	</div></div>'}this.panel.find(".vector-db-list").html(s);var o=this;$(".vector-db-list .enter-db").click(function(){var a=$(this).parents(".row").first().attr("dname");if(null!=a){var t=o.panel.find(".vector-db-tree .row[dname='"+a+"'] .glyphicon-chevron-right");t.removeClass("mc-icon-right"),t.addClass("mc-icon-down"),t.css("transform","rotate(90deg) translate(3px,0px)"),o.panel.find(".vector-db-tree .nav[dname='"+a+"']").remove(),o.getDataSource(a)}}),this.panel.find(".vector-db-list .remove-db").click(function(){var a=$(this).parents(".row").first().attr("dname");null!=a&&confirm("确定删除数据库["+a+"]?")&&(MapCloud.notify.loading(),dbsManager.unRegisterDataSource(a,unRegisterDataSource_callback))})}},getDataSourceInfo:function(a){if(null==a)return null;var t=a.indexOf("server="),e=a.indexOf(";"),s=a.slice(t+"server=".length,e);a=a.slice(e+1,a.length);var l=a.indexOf("instance=");e=a.indexOf(";");var i=a.slice(l+"instance=".length,e);a=a.slice(e+1,a.length);var n=a.indexOf("database=");e=a.indexOf(";");var d=a.slice(n+"database=".length,e);a=a.slice(e+1,a.length);var o=a.indexOf("user=");e=a.indexOf(";");var r=a.slice(o+"user=".length,e);a=a.slice(e+1,a.length);var c=a.indexOf("password=");e=a.indexOf(";");var u=a.slice(c+"password=".length,e);return{server:s,instance:i,database:d,user:r,password:u}},unRegisterDataSource_callback:function(a){MapCloud.notify.showInfo(a,"删除数据源");var t=MapCloud.vectorPanel;dbsManager.getDataSources(t.getDataSources_callback,"Feature")},getDataSource:function(a){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasource_tab").css("display","block"),this.panel.find("#show_datasets_list").css("disabled",!1),this.panel.find("#show_datasets_thumb").css("disabled",!0),this.panel.find(".vector-db-tree .row").removeClass("selected"),this.panel.find(".vector-db-tree .row[dname='"+a+"']").addClass("selected"),this.panel.find(".vector-db-tree .nav[dname='"+a+"']").remove(),this.panel.find(".current-db").html(a),this.panel.find(".datasets-list").empty(),this.panel.find(".datasets_thumb_tab").empty(),null!=a&&(MapCloud.notify.hideLoading(),dbsManager.getDataSource(a,this.getDataSource_callback))},getDataSource_callback:function(a){if(MapCloud.notify.hideLoading(),null!=a){var t=MapCloud.vectorPanel;t.dataSourceCur=a,t.getDataSets(t.dataSourceCur)}},getDataSets:function(a){this.panel.find(".vector-db-tree .row").removeClass("selected"),this.panel.find(".vector-db-tree .row[dname='"+a.name+"']").addClass("selected"),this.panel.find(".vector-db-tree .nav[dname='"+a.name+"']").remove(),this.panel.find(".current-db").html(a.name),this.panel.find(".datasets-list").empty(),this.panel.find(".datasets_thumb_tab").empty(),null!=a&&(MapCloud.notify.loading(),a.getDataSets(this.getDataSets_callback))},getDataSets_callback:function(a){MapCloud.notify.hideLoading();var t=MapCloud.vectorPanel;t.showDataSetsTree(a),t.showDataSetsList(a),t.showDataSetsThumb(a)},showDataSetsTree:function(a){if($.isArray(a)){var t=null;if(a.length>0&&(s=a[0],null!=s)){var e=s.dataSource;null!=e&&(t=e.name)}if(null!=t){for(var s=null,l=null,i="<ul class='nav' dname='"+t+"'>",n=0;n<a.length;++n)s=a[n],null!=s&&(l=s.name,geomType=s.geometryType,geomTypeHtml=this.getDataSetGeomTypeHtml(geomType),i+="<li sname='"+l+"'>	<a href='#' class='tree-table' dindex='"+n+"'>"+geomTypeHtml+"		<span title='"+l+"'>"+l+"</span>	</a></li>");var d=this.panel.find(".vector-db-tree .row[dname='"+t+"']");d.after(i);var o=this;this.panel.find(".nav[dname='"+t+"'] li").click(function(){var a=$(this).attr("sname");null!=a&&null!=o.dataSourceCur&&o.getDataSet(o.dataSourceCur,a)})}}},showDataSetsList:function(a){if($.isArray(a)){for(var t=null,e=null,s=null,l=null,i="",n=0;n<a.length;++n)t=a[n],e=t.name,s=t.geometryType,null==s&&(s=""),l=t.srid,null==l&&(l=""),i+="<div class='row' sname='"+e+'\'>	<div class="col-md-1 col-xs-1">'+(n+1)+'</div>	<div class="col-md-4 col-xs-4">'+e+'</div>	<div class="col-md-3 col-xs-3">'+s+'</div>	<div class="col-md-2 col-xs-2">'+l+'</div>	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-dataset">进入</a>		<a href="javascript:void(0)" class="oper remove-dataset">删除</a>	</div></div>';this.panel.find(".datasets-list").html(i);var d=this;this.panel.find(".datasets-list .enter-dataset").click(function(){var a=$(this).parents(".row").attr("sname");null!=a&&null!=d.dataSourceCur&&d.getDataSet(d.dataSourceCur,a)}),this.panel.find(".datasets-list .remove-dataset").click(function(){var a=$(this).parents(".row").attr("sname");null!=a&&null!=d.dataSourceCur&&confirm("确定要删除["+a+"]?")&&(MapCloud.notify.loading(),d.dataSourceCur.removeDataSet(a,d.removeDataSet_callback))})}},removeDataSet_callback:function(a){MapCloud.notify.showInfo(a,"删除图层");var t=MapCloud.vectorPanel;t.getDataSource(t.dataSourceCur.name)},showDataSetsThumb:function(a){if($.isArray(a)){for(var t="",e=null,s=null,l=null,i=0;i<a.length;++i)e=a[i],name=e.name,s=e.geometryType,null!=s&&(l=e.thumbnail,null!=l&&(t+="<li class='dataset-thumb' dname='"+name+"'><a href='#' class='dataset-thumb-a' dindex='"+i+"' style='background-image:url("+l+")'></a>"),t+="<div class='caption text-center'>	<h6 title='"+name+" class='text-ellipsis'>"+name+"</h6></div></li>");this.panel.find("#datasets_thumb_tab").html(t);var n=this;this.panel.find("#datasets_thumb_tab .dataset-thumb-a").dblclick(function(){var a=$(this).parent().attr("dname");null!=a&&null!=n.dataSourceCur&&n.getDataSet(n.dataSourceCur,a)})}},getDataSetGeomTypeHtml:function(a){var t="";switch(a){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:t='<i class="mc-icon mc-db-icon-dataset-point"></i>';break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:t='<i class="mc-icon mc-db-icon-dataset-line"></i>';break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:t='<i class="mc-icon mc-db-icon-dataset-polygon"></i>';break;default:t='<i class="mc-icon mc-db-icon-dataset"></i>'}return t},getDataSet:function(a,t){this.panel.find(".vector-db-tree li").removeClass("selected"),this.panel.find(".vector-db-tree li[sname='"+t+"']").addClass("selected"),null!=a&&null!=t&&(this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#dataset_tab").css("display","block"),this.panel.find(".return-datasource").html(a.name),this.panel.find(".current-dataset").html(t),this.panel.find(".dataset-infos").empty(),this.panel.find(".dataset-fields").empty(),this.panel.find("#dataset_features_list table thead tr").html(""),this.panel.find("#dataset_features_list table tbody").html(""),this.panel.find(".dataset_preview_tab").empty(),a.getDataSet(t,this.getDataSet_callback))},getDataSet_callback:function(a){if(null!=a){var t=MapCloud.vectorPanel;t.dataSetCur=a;var e=t.panel.find("#dataset_tab .btn-group .btn[disabled='disabled']").attr("id");switch(null==a.geometryType?(t.panel.find("#show_dataset_preview").attr("disabled",!0),"show_dataset_preview"==e&&(t.panel.find("#dataset_tab .btn-group #show_dataset_infos").attr("disabled",!0),e="show_dataset_infos")):"show_dataset_preview"!=e&&t.panel.find("#show_dataset_preview").attr("disabled",!1),e){case"show_dataset_infos":t.showDataSetInfos(a);break;case"show_dataset_fields":t.showDataSetFields(a);break;case"show_dataset_features":t.showDataSetFeatures(a);break;case"show_dataset_preview":t.showDataSetPreview(a)}}},showDataSetInfos:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_infos_tab").css("display","block"),null!=a){var t="";t+="<div class='row'>	<div class='col-md-3 col-xs-3'>名称</div>	<div class='col-md-6 col-xs-6'>"+a.name+"</div></div>",null!=a.type&&(t+="<div class='row'>	<div class='col-md-3 col-xs-3'>类型</div>	<div class='col-md-6 col-xs-6'>"+a.type+"</div></div>"),null!=a.geometryType&&(t+="<div class='row'>	<div class='col-md-3 col-xs-3'>几何类型</div>	<div class='col-md-6 col-xs-6'>"+a.geometryType+"</div></div>"),null!=a.count&&(t+="<div class='row'>	<div class='col-md-3 col-xs-3'>个数</div>	<div class='col-md-6 col-xs-3'>"+a.count+"</div></div>"),null!=a.srid&&(t+="<div class='row'>	<div class='col-md-3 col-xs-3'>空间参考</div>	<div class='col-md-6 col-xs-6'>"+a.srid+"</div></div>");var e=a.extent;null!=e&&(t+="<div class='row'>	<div class='col-md-3 col-xs-3'>范围</div>	<div class='col-md-6 col-xs-6'>东 :"+e.xmax+"</div></div><div class='row'>	<div class='col-md-3 col-xs-3'></div>	<div class='col-md-6 col-xs-6'>西 :"+e.xmin+"</div></div><div class='row'>	<div class='col-md-3 col-xs-3'></div>	<div class='col-md-6 col-xs-6'>南 :"+e.ymin+"</div></div><div class='row'>	<div class='col-md-3 col-xs-3'></div>	<div class='col-md-6 col-xs-6'>北 :"+e.ymax+"</div></div>"),this.panel.find(".dataset-infos").html(t)}},showDataSetFields:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_fields_tab").css("display","block"),null!=a){var t=a.getFields();if(null!=t){for(var e="",s=null,l=null,i=null,n=null,d=0;d<t.length;++d)s=t[d],l=s.name,i=s.type,n=s.length,e+="<div class='row'>	<div class='col-md-4 col-xs-4'>"+l+"	</div>	<div class='col-md-3 col-xs-3'>"+i+"	</div>	<div class='col-md-3 col-xs-3'>"+(null==n?"":n)+"	</div></div>";this.panel.find(".dataset-fields").html(e)}}},showDataSetFeatures:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_features_tab").css("display","block"),null!=a){var t=a.getFields();if(null!=t){this.showDataSetFeautresFields(t);var e=a.count,s=Math.ceil(e/this.maxFeatures);this.panel.find(".pages-form-pages").html(s),this.panel.find(".query_count span").html(e),s>=1?this.setDataSetFeaturePage(1):this.panel.find(".pages-form-page").val(0)}}},setDataSetFeaturePage:function(a){var t=parseInt($(".pages-form-pages").html());$(".pages-form-page").val(a),1==a?this.panel.find(".glyphicon-step-backward").addClass("disabled"):this.panel.find(".glyphicon-step-backward").removeClass("disabled"),a==t?this.panel.find(".glyphicon-step-forward").addClass("disabled"):this.panel.find(".glyphicon-step-forward").removeClass("disabled"),0>=a-1?this.panel.find(".glyphicon-chevron-left").addClass("disabled"):this.panel.find(".glyphicon-chevron-left").removeClass("disabled"),a+1>t?this.panel.find(".glyphicon-chevron-right").addClass("disabled"):this.panel.find(".glyphicon-chevron-right").removeClass("disabled");var e=(a-1)*this.maxFeatures;MapCloud.notify.loading();var s=this.dataSetCur.getFieldsWithoutGeom();this.dataSetCur.getFeatures(this.maxFeatures,e,s,this.getFeatures_callback)},showDataSetFeautresFields:function(a){if(null!=a){for(var t=null,e=null,s="",l=0,i=0;i<a.length;++i)t=a[i],"geometry"!=t.type&&(e=t.name,s+="<th width='80'><nobr>"+e+"</nobr></th>",l+=1);this.panel.find("#dataset_features_list table thead tr").html(s)}},getFeatures_callback:function(a){MapCloud.notify.hideLoading();var t=MapCloud.vectorPanel;t.showFeatures(a)},showFeatures:function(a){if(null!=a){for(var t="",e=null,s=null,l=null,i=0;i<a.length;++i)if(e=a[i],null!=e&&(s=e.values,null!=s)){t+="<tr>";for(var n=0;n<s.length;++n)l=s[n],null!=l&&(l instanceof GeoBeans.Geometry||(t+="<td>"+l+"</td>"));t+="</tr>"}this.panel.find("#dataset_features_list table tbody").html(t)}},showDataSetPreview:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_preview_tab").css("display","block"),null!=a&&null!=a&&null!=a.geometryType){var t=this.panel.find("#dataset_preview_tab").width(),e=this.panel.find("#dataset_preview_tab").height(),s=512/384,l=t/e,i=null,n=null;s>l?(i=(e-t/s)/2,e=t/s):(n=(t-e*s)/2,t=e*s);var d=a.thumbnail,o="<img src='"+d+"' width='"+t+"'  height='"+e+"'>";this.panel.find("#dataset_preview_tab").html(o),null!=i&&this.panel.find("#dataset_preview_tab img").css("margin-top",i),null!=n&&this.panel.find("#dataset_preview_tab img").css("margin-left",n)}},createDataSet:function(){return null==this.dataSourceCur?void MapCloud.notify.showInfo("请选择一个数据库","Warning"):(MapCloud.create_dataset_dialog.showDialog("vector-user"),void MapCloud.create_dataset_dialog.setDataSourceName(this.dataSourceCur.name))}});