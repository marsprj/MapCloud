!function(){window.MapCloud={}}();
MapCloud.Class=function(){var t=arguments.length,n=arguments[0],o=arguments[t-1],e="function"==typeof o.initialize?o.initialize:function(){n.prototype.initialize.apply(this,arguments)};if(t>1){var i=[e,n].concat(Array.prototype.slice.call(arguments).slice(1,t-1),o);MapCloud.inherit.apply(null,i)}else e.prototype=o;return e},MapCloud.inherit=function(t,n){var o=function(){};o.prototype=n.prototype,t.prototype=new o;var e,i,r;for(e=2,i=arguments.length;i>e;e++)r=arguments[e],"function"==typeof r&&(r=r.prototype),MapCloud.Util.extend(t.prototype,r)},MapCloud.Util=MapCloud.Util||{},MapCloud.Util.extend=function(t,n){if(t=t||{},n){for(var o in n){var e=n[o];void 0!==e&&(t[o]=e)}var i="function"==typeof window.Event&&n instanceof window.Event;!i&&n.hasOwnProperty&&n.hasOwnProperty("toString")&&(t.toString=n.toString)}return t};
MapCloud.Cookie=MapCloud.Class({initialize:function(){},setCookie:function(e,o,i){var t=new Date;t.setTime(t.getTime()+864e5);var n=e+"="+escape(o)+";expires="+t.toGMTString();null!=i&&(n+=";path="+i),document.cookie=n},getCookie:function(e){var o=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=o?unescape(o[2]):null},delCookie:function(e,o){var i=new Date;i.setTime(i.getTime()-1);var t=this.getCookie(e);if(null!=t){var n=e+"="+t+";expires="+i.toGMTString();null!=o&&(n+=";path="+o),document.cookie=n}}});
MapCloud.CityPosition=MapCloud.Class({cityList:null,initialize:function(){this.cityList=[{name:"北京",lon:116.380943,lat:39.923615},{name:"天津",lon:117.203499,lat:39.131119},{name:"上海",lon:121.469269,lat:31.238176},{name:"南京",lon:118.772781,lat:32.047615},{name:"武汉",lon:114.291939,lat:30.567514},{name:"重庆",lon:106.510338,lat:29.558176},{name:"合肥",lon:117.275703,lat:31.863255},{name:"安庆",lon:117.034431,lat:30.512646},{name:"蚌埠",lon:117.361382,lat:32.939243},{name:"亳州",lon:115.7709,lat:33.879292},{name:"池州",lon:117.487494,lat:30.668548},{name:"滁州",lon:118.301163,lat:32.316532},{name:"阜阳",lon:115.809731,lat:32.902206},{name:"淮北",lon:116.787498,lat:33.97049},{name:"淮南",lon:117.02072,lat:32.616695},{name:"黄山",lon:118.309067,lat:29.720844},{name:"六安",lon:116.49279,lat:31.753523},{name:"马鞍山",lon:118.480713,lat:31.724924},{name:"宿州",lon:116.970154,lat:33.640133},{name:"铜陵",lon:117.813179,lat:30.925247},{name:"芜湖",lon:118.359833,lat:31.334496},{name:"宣城",lon:118.73,lat:30.965},{name:"福州",lon:119.297813,lat:26.07859},{name:"龙岩",lon:117.030388,lat:25.109703},{name:"南平",lon:118.169121,lat:26.644842},{name:"宁德",lon:119.518318,lat:26.666477},{name:"莆田",lon:119.010323,lat:25.438137},{name:"泉州",lon:118.589638,lat:24.915918},{name:"三明",lon:117.601227,lat:26.223013},{name:"厦门",lon:118.087517,lat:24.457436},{name:"漳州",lon:117.653091,lat:24.518164},{name:"广州",lon:113.261429,lat:23.118912},{name:"潮州",lon:116.63666,lat:23.667706},{name:"东莞",lon:113.748772,lat:23.048536},{name:"佛山",lon:113.114517,lat:23.034878},{name:"河源",lon:114.693817,lat:23.73484},{name:"惠州",lon:114.392403,lat:23.087957},{name:"江门",lon:113.084747,lat:22.59119},{name:"揭阳",lon:116.34977,lat:23.542976},{name:"茂名",lon:110.888847,lat:21.670717},{name:"梅州",lon:116.107941,lat:24.314501},{name:"清远",lon:113.021263,lat:23.719597},{name:"汕头",lon:116.6838,lat:23.362692},{name:"汕尾",lon:115.364014,lat:22.778687},{name:"韶关",lon:113.605392,lat:24.808777},{name:"深圳",lon:114.110672,lat:22.556396},{name:"阳江",lon:111.957893,lat:21.845234},{name:"云浮",lon:112.03999,lat:22.933193},{name:"湛江",lon:110.399223,lat:21.194998},{name:"肇庆",lon:112.451408,lat:23.057882},{name:"中山",lon:113.371452,lat:22.526854},{name:"珠海",lon:113.56826,lat:22.272589},{name:"南宁",lon:108.311768,lat:22.806543},{name:"百色",lon:106.612106,lat:23.901583},{name:"北海",lon:109.119171,lat:21.479797},{name:"崇左",lon:107.35506,lat:22.420197},{name:"防城港",lon:108.362153,lat:21.691939},{name:"贵港",lon:109.60844,lat:23.099092},{name:"桂林",lon:110.286682,lat:25.281883},{name:"河池",lon:108.051628,lat:24.696892},{name:"贺州",lon:111.549191,lat:24.40428},{name:"来宾",lon:109.23294,lat:23.73144},{name:"柳州",lon:109.402809,lat:24.310406},{name:"钦州",lon:108.6147,lat:21.949869},{name:"梧州",lon:111.305946,lat:23.48662},{name:"玉林",lon:110.141472,lat:22.631897},{name:"贵阳",lon:106.711372,lat:26.576874},{name:"安顺",lon:105.926071,lat:26.244259},{name:"毕节",lon:105.282417,lat:27.306295},{name:"六盘水",lon:104.873253,lat:26.576775},{name:"黔东南州",lon:107.989968,lat:26.599325},{name:"黔南州",lon:107.49,lat:26.65},{name:"黔西南州",lon:106.0367,lat:27.034166},{name:"铜仁地区",lon:109.19268,lat:27.722166},{name:"遵义",lon:106.929398,lat:27.695387},{name:"兰州",lon:103.750053,lat:36.068039},{name:"白银",lon:104.183777,lat:36.539417},{name:"定西",lon:104.618568,lat:35.575237},{name:"甘南州",lon:123.49532,lat:47.913578},{name:"嘉峪关",lon:98.274712,lat:39.802654},{name:"金昌",lon:102.165749,lat:38.495193},{name:"酒泉",lon:98.511116,lat:39.744968},{name:"临夏州",lon:103.214081,lat:35.606712},{name:"陇南",lon:104.929411,lat:33.405075},{name:"平凉",lon:106.683067,lat:35.535519},{name:"庆阳",lon:107.87602,lat:36.005165},{name:"天水",lon:105.71524,lat:34.584267},{name:"武威",lon:102.633461,lat:37.92691},{name:"张掖",lon:100.450287,lat:38.935059}]},getCityPosition:function(l){if(null==l)return null;for(var n=null,a=null,t=null,o=null,e=0;e<this.cityList.length;++e)if(n=this.cityList[e],a=n.name,a==l)return t=n.lon,o=n.lat,{lon:t,lat:o};return null}});
MapCloud.Dialog=MapCloud.Class({panel:null,initialize:function(i){var l=this;this.panel=$("#"+i),this.panel.find(".mc-dialog-close,.mc-dialog-close-button").each(function(){$(this).click(function(){l.closeDialog()})})},destory:function(){},showDialog:function(){this.cleanup(),this.panel.modal()},closeDialog:function(){this.panel.modal("hide")},cleanup:function(){}});
MapCloud.Panel=MapCloud.Class({panel:null,initialize:function(n){var l=this;this.panel=$("#"+n),this.panel.find(".close").click(function(){l.hidePanel()})},cleanup:function(){},hidePanel:function(){this.panel.css("display","none")},showPanel:function(){this.panel.css("display","block"),this.cleanup()}});
MapCloud.AQICityDialog=MapCloud.Class(MapCloud.Dialog,{citys:null,aqiCityLayer:"gc_aqi_city",sourceName:"base",aqiCityField:"name",featuretype:null,maxCount:10,pageCount:null,pageNumber:5,initialize:function(i){MapCloud.Dialog.prototype.initialize.apply(this,arguments),this.registerPanelEvent()},showDialog:function(i,t){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.server=t,this.citys=$.isArray(i)?i.slice():[];var e=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.featuretype=new GeoBeans.FeatureType(e,this.aqiCityLayer),this.getAQICitysCount(),this.showSelectedCity(this.citys)},registerPanelEvent:function(){var i=this;this.panel.find(".btn-confirm").click(function(){var t=i.citys,e=MapCloud.subPanel;e.setSelectAQICity(t),i.closeDialog()}),this.panel.find(".query-city").click(function(){var t=i.panel.find(".query-city-name").val();return""==t?void MapCloud.notify.showInfo("请输出查询的城市名称","Warning"):void i.getAQICityByName(t,i.getAQICityByName_callback)}),this.panel.find(".return-list").click(function(){i.initPageControl(1,i.pageCount)})},showSelectedCity:function(i){if($.isArray(i)){for(var t=null,e="",a=0;a<i.length;++a)t=i[a],e+="<span class='label label-success aqi-city-label'>	<span class='aqi-city-name'>"+t+"</span>	<span aria-hidden='true'>×</span></span>";this.panel.find(".selected-city-div").html(e);var l=this;this.panel.find(".selected-city-div .aqi-city-label").click(function(){var i=$(this).find(".aqi-city-name").html(),t=l.citys.indexOf(i);-1!=t&&(l.panel.find(".aqi-city-list-div .row[cname='"+i+"'] input").prop("checked",!1),l.citys.splice(t,1),l.showSelectedCity(l.citys))})}},getAQICitysCount:function(){this.featuretype.getFeatureFilterCountAsync(null,this.sourceName,null,null,this.getAQICitysCount_callback)},getAQICitysCount_callback:function(i,t){var e=MapCloud.aqi_city_dialog,a=Math.ceil(t/e.maxCount);e.pageCount=a,e.initPageControl(1,e.pageCount)},initPageControl:function(i,t){if(!(0>=i||i>t)){var e="";if(e+=1==i?'<li class="disabled">		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>':'<li>		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>',t<=this.pageNumber)for(var a=1;t>=a;++a)e+=a==i?'<li class="active">	<a href="#">'+i.toString()+'		<span class="sr-only">(current)</span></a></li>':"<li><a href='#'>"+a+"</a></li>";else{var l=t-this.pageNumber+1;if(l>=i)for(var a=i;a<i+this.pageNumber;++a)e+=a==i?'<li class="active">	<a href="#">'+i+"</a></li>":"<li><a href='#'>"+a+"</a></li>";else for(var a=l;t>=a;++a)e+=a==i?'<li class="active">	<a href="#">'+i+"</a></li>":"<li><a href='#'>"+a+"</a></li>"}e+=i==t?'<li class="disabled">		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>':'<li>		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>',this.panel.find(".pagination").html(e),this.registerPageEvent();var n=(i-1)*this.maxCount;this.getAQICityList(this.maxCount,n)}},getAQICityList:function(i,t){this.featuretype.getFeaturesAsync(null,this.sourceName,i,t,null,this.getAQICity_callback)},registerPageEvent:function(){var i=this;this.panel.find(".pagination li a").click(function(){var t=i.panel.find(".pagination li.active a").html(),e=parseInt(t),a=$(this).attr("aria-label");"Previous"==a?e-=1:"Next"==a?e+=1:e=parseInt($(this).html()),i.initPageControl(e,i.pageCount)})},getAQICity_callback:function(i){var t=MapCloud.aqi_city_dialog;t.showAQICityList(i)},showAQICityList:function(i){for(var t=null,e=null,a=null,l=null,n=null,s=null,r="",o=0;o<i.length;++o){t=i[o],e=t.values,a=e[0],l=e[1],n=e[2],s=e[4];var c=!1,u=this.citys.indexOf(l);-1!=u&&(c=!0),r+="<div class='row' cname='"+l+"'>	<div class='col-md-1'>",r+=c?"		<input type='checkbox' checked>":"		<input type='checkbox'>",r+="	</div>	<div class='col-md-2'>"+a+"</div>	<div class='col-md-3'>"+l+"</div>	<div class='col-md-4'>"+n+"</div>	<div class='col-md-2'>"+s+"</div></div>"}this.panel.find(".aqi-city-list-div").html(r);var p=this;this.panel.find(".aqi-city-list-div input").change(function(){var i=$(this).prop("checked"),t=$(this).parents(".row").attr("cname");if(i){if(-1==p.citys.indexOf(t)){if(5==p.citys.length)return $(this).prop("checked",!1),void MapCloud.notify.showInfo("最多选择5个城市","Warning");p.citys.push(t),p.showSelectedCity(p.citys)}}else{var e=p.citys.indexOf(t);-1!=e&&(p.citys.splice(e,1),p.showSelectedCity(p.citys))}})},getAQICityByName:function(i,t){if(null!=i){var e=new GeoBeans.BinaryComparisionFilter;e.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var a=new GeoBeans.PropertyName;a.setName(this.aqiCityField);var l=new GeoBeans.Literal;l.setValue(i),e.expression1=a,e.expression2=l;var n=this.featuretype.buildGetFeatureFilterXML(null,this.sourceName,e,null,null,null),s=this.server,r=this;$.ajax({type:"post",url:s,data:n,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(i){},success:function(i,e){var a=r.featuretype.parseFeatures(i);void 0!=t&&t(a)},complete:function(i,t){},error:function(i,t,e){console.log("textStatus:"+t),console.log("error:"+e)}})}},getAQICityByName_callback:function(i){var t=MapCloud.aqi_city_dialog;t.showAQICityList(i)}});
MapCloud.CreateDataSetDialog=MapCloud.Class(MapCloud.Dialog,{source:null,dataSourceName:null,initialize:function(e){MapCloud.Dialog.prototype.initialize.apply(this,arguments),this.registerPanelEvent()},registerPanelEvent:function(){var e=this;this.panel.find(".btn-create-field").click(function(){e.createField()}),this.panel.find(".btn-remove-fields").click(function(){e.removeFields()}),this.panel.find(".btn-create-dataset").click(function(){e.createDataset()}),this.panel.on("hidden.bs.modal",function(){e.closeDialog()})},showDialog:function(e){MapCloud.Dialog.prototype.showDialog.apply(this,arguments);var t=this;this.panel.on("shown.bs.modal",function(){t.panel.find(".dataset-name").focus()}),this.source=e},cleanup:function(){this.panel.find(".db-name").val(""),this.panel.find(".dataset-name").val("");var e='<div class="text-center">	<h2 class="text-muted fields-empty">空白字段</h2></div>';this.panel.find(".fields-form").html(e),this.dataSourceName=null,this.source=null},closeDialog:function(){if(this.panel.modal("hide"),"vector"==this.source){var e=MapCloud.vector_db_dialog;e.getDataSets(e.dataSourceCur)}else if("vector-user"==this.source){var e=MapCloud.vectorPanel;e.getDataSets(e.dataSourceCur)}},setDataSourceName:function(e){this.dataSourceName=e,this.panel.find(".db-name").val(this.dataSourceName)},createField:function(){var e=this.panel.find(".fields-form .form-group").length,t="";0==e&&(this.panel.find(".fields-form").empty(),t+='<div class="form-group form-group-header">	<div class="col-md-4">名称</div>	<div class="col-md-4">类型</div>	<div class="col-md-4">长度</div></div>'),t+='<div class="form-group form-group-sm">	<div class="col-md-4">		<input class="form-control field-name" type="text">	</div>	<div class="col-md-4">		<select class="form-control field-type">			<option>int</option>			<option>string</option>			<option>double</option>		</select>	</div>	<div class="col-md-2">		<input class="form-control field-length" value="32" type="text" readonly="">	</div>	<div class="col-md-2">		<button class="btn btn-link btn-remove-field">删除</button>	</div></div>',this.panel.find(".fields-form").append(t);var i=this;this.panel.find(".fields-form .form-group").last().find(".btn-remove-field").click(function(){if($(this).parents(".form-group").first().remove(),0==i.panel.find(".fields-form .form-group-sm").length){var e='<div class="text-center">	<h2 class="text-muted fields-empty">空白字段</h2></div>';i.panel.find(".fields-form").html(e)}}),this.panel.find(".fields-form .form-group").last().find("select").change(function(){var e=$(this).val();"string"==e?$(this).parents(".form-group").first().find(".field-length").removeAttr("readonly"):$(this).parents(".form-group").first().find(".field-length").prop("readonly","true")})},removeFields:function(){if(confirm("确认删除所有的字段吗？")){var e='<div class="text-center">	<h2 class="text-muted fields-empty">空白字段</h2></div>';this.panel.find(".fields-form").html(e)}},createDataset:function(){var e=this.dataSourceName;if(null!=e){var t=this.panel.find(".dataset-name").val();if(null==t||""==t)return MapCloud.notify.showInfo("请输入表格的名称","Warning"),void this.panel.find(".dataset-name").focus();var i=/^[a-zA-Z][a-zA-Z0-9_]*$/;if(!i.test(t))return MapCloud.notify.showInfo("请输入有效的表格名称","Warning"),void this.panel.find(".dataSetName").focus();var a=!0,n=this.panel.find(".fields-form .form-group-sm .field-name");if(n.each(function(){""==$(this).val()&&(a=!1)}),!a)return void MapCloud.notify.showInfo("请输入字段名称","Warning");var o=!0,l=this.panel.find(".fields-form .form-group-sm .field-length:not([readonly])");if(l.each(function(){""==$(this).val()&&(o=!1)}),!o)return void MapCloud.notify.showInfo("请输入字段的长度","Warning");var s=this.getFields();if(null!=s){if(0==s.length)return void MapCloud.notify.showInfo("请添加表格的字段","Warning");MapCloud.notify.loading(),dbsManager.createDataSet(e,t,s,this.createDataset_callback)}}},getFields:function(){var e=[];return this.panel.find(".fields-form .form-group-sm").each(function(){var t=$(this).find(".field-name").val();if(null!=t&&""!=t){var i=null,a=$(this).find(".field-type").val();"string"==a&&(i=$(this).find(".field-length").val());var n=new GeoBeans.GField(t,a,i);e.push(n)}}),e},createDataset_callback:function(e){MapCloud.notify.showInfo(e,"创建表格");MapCloud.create_dataset_dialog}});
MapCloud.CreateFolderDialog=MapCloud.Class(MapCloud.Dialog,{source:null,initialize:function(e){MapCloud.Dialog.prototype.initialize.apply(this,arguments);var a=this;this.panel.find(".btn-confirm").click(function(){a.createFolder()}),this.panel.find("#create_folder_name").keypress(function(e){13==e.which&&a.createFolder()})},cleanup:function(){this.panel.find("#create_folder_name").val("")},showDialog:function(e){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.source=e;var a=this;this.panel.on("shown.bs.modal",function(){a.panel.find("#create_folder_name").focus()})},createFolder:function(){var e=this,a=e.panel.find("#create_folder_name").val();if(""==a)return MapCloud.notify.showInfo("请输入名称","Warning"),void e.panel.find("#create_folder_name").focus();var o=/^([\u4E00-\uFA29]|[\uE7C7-\uE7F3]|[a-zA-Z0-9]|[_])*$/;return o.test(a)?("file"==e.source?MapCloud.file_dialog.setCreateFolderName(a):"raster"==e.source?MapCloud.raster_db_dialog.setCreateFolderName(a):"file-user"==e.source?MapCloud.filePanel.setCreateFolderName(a):"raster-user"==e.source&&MapCloud.rasterPanel.setCreateFolderName(a),void e.closeDialog()):(MapCloud.notify.showInfo("请输入有效的名称","Warning"),void e.panel.find("#create_folder_name").focus())}});
MapCloud.CreateTileStoreDialog=MapCloud.Class(MapCloud.Dialog,{source:null,sourceName:null,option:null,initialize:function(e){MapCloud.Dialog.prototype.initialize.apply(this,arguments);this.registerPanelEvent()},registerPanelEvent:function(){var e=this;this.panel.find(".btn-confirm").click(function(){var o=e.panel.find(".tile-store-name").val();if(null==o||""==o)return MapCloud.notify.showInfo("请输入瓦片库的名称","Warning"),void e.panel.find(".tile-store-name").focus();var a=/^[0-9a-zA-Z_]+$/;if(!a.test(o))return MapCloud.notify.showInfo("请输入有效的瓦片库名称","Warning"),void e.panel.find(".tile-store-name").focus();var i=e.panel.find(".tile-store-type").val();if(null==i||""==i)return void MapCloud.notify.showInfo("请选择切图方式","Warning");if(null==e.sourceName)return void MapCloud.notify.showInfo("当前数据库为空","Warning");var l=e.sourceName,t=1,n=4,r=new GeoBeans.Envelope(-180,-90,180,90);null!=e.option&&(t=e.option.startLevel,n=e.option.endLevel,r=e.option.extent),e.createTileStore(l,o,i,t,n,r)})},showDialog:function(e,o,a){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.source=e,this.sourceName=o,this.option=a},cleanup:function(){this.panel.find(".tile-store-name").val("")},createTileStore:function(e,o,a,i,l,t){MapCloud.notify.loading(),dbsManager.createTileStore(e,o,a,t,i,l,this.createTileStore_callback)},createTileStore_callback:function(e){MapCloud.notify.showInfo(e,"新建瓦片库");var o=MapCloud.create_tile_store_dialog;o.closeDialog();var a=o.panel.find(".tile-store-name").val(),i=null;if("tileDB"==o.source){i=MapCloud.tile_db_dialog;var l=o.sourceName;i.getTileStores(l)}else if("cutMap"==o.source){i=MapCloud.cut_map_dialog;var l=o.sourceName;i.getTileStores(l),i.setCreateStoreName(a)}else if("tileDB-user"==o.source){var t=MapCloud.tilePanel;if(null!=t){var l=o.sourceName;t.getTileStores(l)}}}});
MapCloud.FileDialog=MapCloud.Class(MapCloud.Dialog,{list:null,initialize:function(e){MapCloud.Dialog.prototype.initialize.apply(this,arguments);var l=this;l.registerPanelEvent()},registerPanelEvent:function(){var e=this;this.panel.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.panel.find(".btn-confirm").click(function(){switch(e.flag){case"choose-shp":var l=e.getImportPaths();if(0==l.length)return void MapCloud.notify.showInfo("请选择要导入的shp文件","Warning");MapCloud.import_dialog.addImportPaths(l);break;case"gps-choose-shp":var l=e.getImportPaths();if(0==l.length)return void MapCloud.notify.showInfo("请选择要导入的shp文件","Warning");MapCloud.gps_feature_import_dialog.addImportPaths(l);break;case"image":var l=e.getImportPaths();if(0==l.length)return void MapCloud.notify.showInfo("请选择要导入的shp文件","Warning");MapCloud.import_raster_dialog.addImportPaths(l);break;case"csv":var t=e.getImportCSVPath();if(null==t)return void MapCloud.notify.showInfo("请选择要导入的csv文件","Warning");MapCloud.importCSV_dialog.setImportCsv(t);break;case"csvImport":var t=e.getImportCSVPath();if(null==t)return void MapCloud.notify.showInfo("请选择要导入的csv文件","Warning");MapCloud.gps_csv_import_dialog.setImportCsv(t)}e.closeDialog()}),this.panel.find(".btn-add-folder").click(function(){MapCloud.create_folder_dialog.showDialog("file")}),this.panel.find(".btn-remove-file").click(function(){var l=e.panel.find("input[type='checkbox']:checked");if(0==l.length){var t=e.panel.find(".tree-folder.selected").attr("fpath");if("/"==t)return void MapCloud.notify.showInfo("无法删除根目录","Warning");var i=e.panel.find(".tree-folder.selected span").html();if(!confirm("确定要删除文件夹["+i+"]?"))return;var a=e.panel.find(".tree-folder.selected").parents(".nav").first().prev();e.panel.find(".tree-folder.selected").parents(".nav").first().remove(),e.panel.find(".tree-folder").removeClass("selected"),a.addClass("selected");var n=a.attr("fpath");return e.panel.find("#current_path").val(n),void e.removeFolder(t)}confirm("确定要删除吗？")&&l.each(function(){var l=$(this).parent().parent().parent(),t=l.attr("fpath");l.hasClass("row-file")?e.removeFile(t):l.hasClass("row-folder")&&e.removeFolder(t)})}),this.panel.find(".btn-upload-file").click(function(){var l=e.panel.find("#current_path").val();MapCloud.importVector_dialog.showDialog(l,"file")}),this.panel.find(".btn-refresh").click(function(){var l=e.panel.find("#current_path").val();e.getListRefresh(l)}),this.panel.find("#file_filter_select").change(function(){var l=e.getFilterList();e.showListPanel(l)}),this.panel.find(".select-list").click(function(){var l=e.panel.find(".file-list-content-div>.row input");$(this).prop("checked")?l.prop("checked",!0):l.prop("checked",!1)})},cleanup:function(){this.list=null,this.flag=null,this.panel.find("#file_filter_select option[value='all']").attr("selected",!0),this.panel.find("#current_path").val("/"),this.panel.find(".select-list").prop("checked",!1)},showDialog:function(e){this.cleanup(),this.flag=e,null!=this.flag?(this.panel.find(".btn-confirm").html("选择"),this.panel.find(".btn-group-tool").css("display","none"),this.panel.find("#current_path").parent().removeClass("col-md-8").addClass("col-md-12")):(this.panel.find(".btn-confirm").html("确定"),this.panel.find(".btn-group-tool").css("display","block"),this.panel.find("#current_path").parent().addClass("col-md-8").removeClass("col-md-12")),this.panel.modal(),this.getList("/")},getList:function(e){MapCloud.notify.loading(),fileManager.getList(e,this.getList_callback)},getList_callback:function(e){MapCloud.notify.hideLoading();var l=MapCloud.file_dialog;l.list=e,l.showListTree(e,!0);var t=l.getFilterList();l.showListPanel(t)},getListRefresh:function(e){MapCloud.notify.loading(),fileManager.getList(e,this.getListRefresh_callback)},getListRefresh_callback:function(e){MapCloud.notify.showInfo("刷新","Info");var l=MapCloud.file_dialog;l.list=e,l.showListTree(e,!0);var t=l.getFilterList();l.showListPanel(t)},getListTreeClick:function(e){MapCloud.notify.loading(),fileManager.getList(e,this.getListTreeClick_callback)},getListTreeClick_callback:function(e){MapCloud.notify.hideLoading();var l=MapCloud.file_dialog;l.list=e;var t=l.getFilterList();l.showListPanel(t)},showListTree:function(e,l){var t=null,i=null,a=null;a=1==l?"<ul class='nav'>":"<ul class='nav' style='display:none'>";for(var n=0;n<e.length;++n)if(t=e[n],null!=t&&t instanceof GeoBeans.Folder){var s=t.name;a+="<li><a href='javascript:void(0)' class='tree-folder' fpath=\""+t.path+'"><i class="fa fa-folder-o"></i><span>'+s+"</span></a></li>"}a+="</ul>",i=this.panel.find("#current_path").val();var o=this.panel.find(".file-tree-div a[fpath='"+i+"']");o.find("i").removeClass("fa-folder-o"),o.find("i").addClass("fa-folder-open-o"),o.parent().find("ul.nav").remove(),o.after(a);var r=this;this.panel.find(".tree-folder").unbind("click"),this.panel.find(".tree-folder").unbind("dblclick");var d=300,f=0,c=null;this.panel.find(".tree-folder").on("click",function(e){if(f++,1===f){var l=this;c=setTimeout(function(){console.log("Single Click");var e=$(l).attr("fpath");r.panel.find("#current_path").val(e),r.getListTreeClick(e),r.panel.find(".tree-folder").removeClass("selected"),$(l).addClass("selected"),f=0},d)}else{clearTimeout(c),console.log("Double Click");var t=$(this).attr("fpath"),i=$(this).parent();0!=i.find("ul.nav").length&&"none"==i.find("ul.nav").first().css("display")?(i.find("ul.nav").first().css("display","block"),$(this).find("i").removeClass("fa-folder-o"),$(this).find("i").addClass("fa-folder-open-o"),r.getListTreeClick(t)):0!=i.find("ul.nav").length&&"block"==i.find("ul.nav").first().css("display")?(i.find("ul.nav").first().css("display","none"),$(this).find("i").addClass("fa-folder-o"),$(this).find("i").removeClass("fa-folder-open-o"),r.getListTreeClick(t)):(r.panel.find("#current_path").val(t),r.getList(t)),r.panel.find(".tree-folder").removeClass("selected"),$(this).addClass("selected"),f=0}}).on("dblclick",function(e){e.preventDefault()})},showListPanel:function(e){var l=null,t="";this.panel.find(".select-list").prop("checked",!1);for(var i=0;i<e.length;++i)if(l=e[i],null!=l)if(l instanceof GeoBeans.File){var a=l.name,n=l.accessTime,s=l.lastTime,o=l.size,r=l.path;if(t+="<div class='row row-file' fpath='"+r+"'><div class='col-md-1 row'><div class='col-md-6'>","choose-shp"==this.flag){var d=a.slice(a.lastIndexOf(".")+1,a.length);t+="shp"==d.toLowerCase()?"		<input type='checkbox' name='"+a+"'>":"		<input type='checkbox' name='"+a+"' disabled>"}else if("image"==this.flag){var d=a.slice(a.lastIndexOf(".")+1,a.length);d=d.toLowerCase();var f=["jpeg","jpg","tif","png"];t+=-1!=f.indexOf(d)?"		<input type='checkbox' name='"+a+"'>":"		<input type='checkbox' name='"+a+"' disabled>"}else if("csv"==this.flag||"csvImport"==this.flag){var d=a.slice(a.lastIndexOf(".")+1,a.length);t+="csv"==d.toLowerCase()?"		<input type='radio' name='csv'>":"		<input type='radio' name='csv' disabled>"}else t+="		<input type='checkbox' name='"+a+"'>";t+="</div><div class='col-md-6'><i class='fa fa-file-o'></i></div>",t+="</div><div class='col-md-3 row-fname'>		<span>"+a+"</span></div><div class='col-md-1'>文件</div><div class='col-md-3'>"+n+"</div><div class='col-md-3'>"+s+"</div><div class='col-md-1'>"+o+"</div></div>"}else if(l instanceof GeoBeans.Folder){var a=l.name,n=l.accessTime,s=l.lastTime,r=l.path;t+="<div class='row row-folder' fpath='"+r+"'><div class='col-md-1 row'><div class='col-md-6'>",t+=null==this.flag?"	<input type='checkbox' name='"+a+"'>":"	<input type='checkbox' name='"+a+"' disabled>",t+="</div><div class='col-md-6'><i class='fa fa-folder-o'></i></div>",t+="</div><div class='col-md-3 row-fname'>		<span>"+a+"</span></div><div class='col-md-1'>文件夹</div><div class='col-md-3'>"+n+"</div><div class='col-md-3'>"+s+"</div><div class='col-md-1'></div></div>"}this.panel.find(".file-list-content-div").html(t);var c=this;this.panel.find(".row-folder .row-fname").click(function(){var e=$(this).parent().attr("fpath");c.panel.find(".tree-folder").removeClass("selected");var l=c.panel.find(".tree-folder[fpath='"+e+"']");l.parents(".nav").first().css("display","block"),l.addClass("selected"),c.panel.find("#current_path").val(e),c.getList(e)})},setCreateFolderName:function(e){var l=this.panel.find("#current_path").val(),t=null;t="/"==l?"/"+e:l+"/"+e,this.createFolder(t)},createFolder:function(e){MapCloud.notify.loading(),fileManager.createFolder(e,this.createFolder_callback)},createFolder_callback:function(e){var l="新建文件夹";MapCloud.notify.showInfo(e,l);var t=MapCloud.file_dialog,i=t.panel.find("#current_path").val();t.getList(i)},removeFile:function(e){fileManager.removeFile(e,this.removeFile_callback)},removeFile_callback:function(e){var l="删除文件";MapCloud.notify.showInfo(e,l);var t=MapCloud.file_dialog,i=t.panel.find("#current_path").val();t.getList(i)},removeFolder:function(e){fileManager.removeFolder(e,this.removeFolder_callback)},removeFolder_callback:function(e){var l="删除文件夹";MapCloud.notify.showInfo(e,l);var t=MapCloud.file_dialog,i=t.panel.find("#current_path").val();t.panel.find(".tree-folder[fpath='"+i+"']").next().remove(),t.getList(i)},refreshCurrentPath:function(){var e=this.panel.find("#current_path").val();this.getList(e)},getFilterList:function(){var e=this.panel.find("#file_filter_select").val(),l=e.split(",");if(0==l.length)return this.list;if(1==l.length&&"all"==l[0])return this.list;for(var t=null,i=null,a=null,n=[],s=0;s<this.list.length;++s)if(t=this.list[s],t instanceof GeoBeans.Folder)n.push(t);else if(t instanceof GeoBeans.File){a=t.name,a=a.toLowerCase();for(var o=0;o<l.length;++o)i=l[o],i="."+i,a.length<=i.length||a.lastIndexOf(i)==a.length-i.length&&n.push(t)}return n},getImportPaths:function(){for(var e=this.panel.find("input[type='checkbox']:checked"),l=null,t=[],i=0;i<e.length;++i)if(l=e[i],null!=l){var a=$(l).parents(".row-file").attr("fpath");null!=a&&t.push(a)}return t},getImportCSVPath:function(){var e=this.panel.find("input[name='csv']:checked");if(0==e.length)return null;var l=e.parents(".row-file").attr("fpath");return l}});
MapCloud.ImportCSVDialog=MapCloud.Class(MapCloud.Dialog,{dataSourceName:null,csvPath:null,typeName:null,source:null,initialize:function(i){MapCloud.Dialog.prototype.initialize.apply(this,arguments),this.registerPanelEvent()},registerPanelEvent:function(){var i=this;this.panel.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.panel.find(".import-btn-add").click(function(){MapCloud.file_dialog.showDialog("csv")}),this.panel.find(".import-btn-remove").click(function(){}),this.panel.find(".import-btn-upload").click(function(){var t=i.getFields(),a=(i.csvPath,i.panel.find(".csv-typename").val());if(null==a||""==a)return MapCloud.notify.showInfo("请输入导入后的文件名称","Warning"),void i.panel.find(".csv-typename").focus();var e=/^[a-zA-Z][a-zA-Z0-9_]*$/;if(!e.test(a))return MapCloud.notify.showInfo("请输入有效的文件名称","Warning"),void i.panel.find(".csv-typename").focus();i.typeName=a;var l="<div class='row'>开始新建表格</div>";i.panel.find(".import-log-div").append(l),dbsManager.createDataSet(i.dataSourceName,a,t,i.createDataSet_callback)}),this.panel.find(".import-btn-log").click(function(){$(this).hasClass("log-col")?(i.panel.find(".modal-body").css("height","600px"),i.panel.find(".import-log-wrapper").slideDown(500),$(this).find("i").removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(this).removeClass("log-col").addClass("log-exp")):(i.panel.find(".modal-body").css("height","470px"),i.panel.find(".import-log-wrapper").slideUp(500),$(this).find("i").removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(this).removeClass("log-exp").addClass("log-col"))}),this.panel.on("hidden.bs.modal",function(){i.closeDialog()})},cleanup:function(){this.panel.find(".csv-fields-div").empty(),this.panel.find(".csv-path").val(""),this.panel.find(".csv-typename").val(""),this.panel.find(".import-log-div").empty(),this.dataSourceName=null,this.csvPath=null,this.typeName=null,this.source=null},showDialog:function(i){this.cleanup(),this.panel.modal(),this.source=i},closeDialog:function(){if(this.panel.modal("hide"),"vector"==this.source){var i=MapCloud.vector_db_dialog;i.getDataSets(i.dataSourceCur)}else if("vector-user"==this.source){var i=MapCloud.vectorPanel;null!=i&&i.getDataSets(i.dataSourceCur)}},setDataSourceName:function(i){this.dataSourceName=i},setImportCsv:function(i){if(null!=i){this.csvPath=i,this.panel.find(".csv-path").val(this.csvPath);var t=this.csvPath.slice(this.csvPath.lastIndexOf("/")+1,this.csvPath.length-4);this.panel.find(".csv-typename").val(t),fileManager.describeCsv(this.csvPath,this.describeCsv_callback)}},describeCsv_callback:function(i){if(!$.isArray(i))return void MapCloud.notify.showInfo(i,"Warning");var t=MapCloud.importCSV_dialog;t.setCSVFields(i)},setCSVFields:function(i){if(null!=i){for(var t="",a=null,e=0;e<i.length;++e)a=i[e],null!=a&&(t+="<div class='row'>	<div class='col-md-5'>		<input class='form-control input-sm csv-field-name' type='text' value='"+a+"' disabled=''>	</div>	<div class='col-md-4'>		<select class='form-control input-sm csv-field-type'>			<option>int</option>			<option>string</option>			<option>double</option>		</select>	</div>	<div class='col-md-3'>		<input class='form-control input-sm csv-field-length' type='text' value='32' readonly=''>	</div></div>");this.panel.find(".csv-fields-div").html(t),this.panel.find(".csv-field-type").change(function(){var i=$(this).val();"string"==i?$(this).parents(".row").first().find(".csv-field-length").removeAttr("readonly"):$(this).parents(".row").first().find(".csv-field-length").prop("readonly","true")})}},getFields:function(){var i=[];return this.panel.find(".csv-fields-div .row").each(function(){var t=$(this).find(".csv-field-name").val(),a=$(this).find(".csv-field-type").val(),e=null;"string"==a&&(e=$(this).find(".csv-field-length").val());var l=new GeoBeans.GField(t,a,e);i.push(l)}),i},createDataSet_callback:function(i){var t="<div class='row'>创建表格结束："+i+"</div>",a=MapCloud.importCSV_dialog;a.panel.find(".import-log-div").append(t),"success"==i&&a.importCsv()},importCsv:function(){var i=this.dataSourceName,t=this.typeName,a=(this.csvPath,this.csvPath.slice(this.csvPath.lastIndexOf("/")+1,this.csvPath.length)),e=this.csvPath.slice(0,this.csvPath.lastIndexOf("/")),l="<div class='row'>开始导入到数据中</div>";this.panel.find(".import-log-div").append(l),gpsManager.csvImport(i,t,e,a,null,this.importCsv_callback)},importCsv_callback:function(i){var t="<div class='row'>导入到数据库结束："+i+"</div>",a=MapCloud.importCSV_dialog;a.panel.find(".import-log-div").append(t)}});
MapCloud.ImportDialog=MapCloud.Class(MapCloud.Dialog,{dataSourceName:null,features:null,initialize:function(t){MapCloud.Dialog.prototype.initialize.apply(this,arguments),this.registerPanelEvent()},registerPanelEvent:function(){var t=this;this.panel.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.panel.find(".import-btn-add").click(function(){MapCloud.file_dialog.showDialog("choose-shp")}),this.panel.find(".import-btn-remove").click(function(){t.removePath()}),this.panel.find(".import-btn-upload").click(function(){t.importFeatures()}),this.panel.find(".import-btn-log").click(function(){$(this).hasClass("log-col")?(t.panel.find(".modal-body").css("height","578px"),t.panel.find(".import-log-wrapper").slideDown(500),$(this).find("i").removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(this).removeClass("log-col").addClass("log-exp")):(t.panel.find(".modal-body").css("height","366px"),t.panel.find(".import-log-wrapper").slideUp(500),$(this).find("i").removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(this).removeClass("log-exp").addClass("log-col"))}),this.panel.find("button.close").click(function(){t.closeDialog()}),this.panel.on("hidden.bs.modal",function(){t.closeDialog()})},showDialog:function(t){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.source=t},cleanup:function(){this.panel.find(".import-list-div").html(""),this.panel.find(".import-log-div").html(""),this.paths=[],this.source=null},closeDialog:function(){if(this.panel.modal("hide"),"vector"==this.source){var t=MapCloud.vector_db_dialog;t.getDataSets(t.dataSourceCur)}else if("dataPanel"==this.source){var t=MapCloud.data_source_panel;t.refresh()}else if("vector-user"==this.source){var t=MapCloud.vectorPanel;null!=t&&t.getDataSets(t.dataSourceCur)}},setDataSourceName:function(t){this.dataSourceName=t,this.panel.find(".import-db-name").html(this.dataSourceName)},addImportPaths:function(t){if(null==this.paths)this.paths=t;else for(var i=null,a=0;a<t.length;++a)i=t[a],-1==this.paths.indexOf(i)&&this.paths.push(i);this.setImportPaths(this.paths)},setImportPaths:function(t){for(var i=null,a="",l=null,n=0;n<t.length;++n)if(i=t[n],null!=i){var s=i.lastIndexOf("."),e=i.lastIndexOf("/");l=i.slice(e+1,s),a+="<div class='row'><div class='col-md-4 fpath'>"+i+"</div><div class='col-md-2'>public</div><div class='col-md-3 col-md-edit fname'><span>"+l+"</span></div><div class='col-md-2 col-md-edit fgeom'><span>shape</span></div><div class='col-md-1 col-md-edit fsrid'><span>4326</span></div></div>"}this.panel.find(".import-list-div").html(a),this.panel.find(".import-list-div .col-md-edit").dblclick(function(){var t=$(this).find("span").html();if(void 0!=t){var i=$(this).css("width"),a=i.slice(0,i.lastIndexOf("px"));a-=2;var l="<input type='text' value='"+t+"' style='width:"+a+"px;padding:0px'>";$(this).html(l),$(this).css("padding","4px 2px 4px 2px");$(this).find("input").focus(),$(this).find("input").focusout(function(){var t=$(this).val();$(this).parent().html("<span>"+t+"</span>"),$(this).parent().css("padding","6px 2px 6px 2px")})}});var o=this;this.panel.find(".import-list-div .row").click(function(){o.panel.find(".import-list-div .row").removeClass("selected"),$(this).addClass("selected")})},removePath:function(){var t=this.panel.find(".import-list-div .row.selected");if(0==t.length)return void MapCloud.notify.showInfo("请选择一行记录进行删除","Warning");for(var i=t.find(".fpath").html(),a=0;a<this.paths.length;++a){var l=this.paths[a];if(l==i){this.paths.splice(a,1);break}}this.setImportPaths(this.paths)},getFeaturesValid:function(){for(var t=this.panel.find(".import-list-div .row"),i=null,a=null,l=null,n=null,s=null,e=/^([\u4E00-\uFA29]|[\uE7C7-\uE7F3]|[a-zA-Z0-9]|[_])*$/,o=/^[0-9]+$/,d=0;d<t.length;++d){if(i=t[d],a=$(i).find(".fpath").html(),l=$(i).find(".fname span").html(),!e.test(l))return MapCloud.notify.showInfo("请输入有效的表名称","Warning"),!1;if(n=$(i).find(".fgeom span").html(),!e.test(n))return MapCloud.notify.showInfo("请输入有效的空间列","Warning"),!1;if(s=$(i).find(".fsrid span").html(),!o.test(s))return MapCloud.notify.showInfo("请输入有效的空间参考","Warning"),!1}return!0},getFeatures:function(){for(var t=this.panel.find(".import-list-div .row"),i=[],a=null,l=null,n=null,s=null,e=null,o=null,d=0;d<t.length;++d)l=t[d],n=$(l).find(".fpath").html(),s=$(l).find(".fname span").html(),e=$(l).find(".fgeom span").html(),o=$(l).find(".fsrid span").html(),a={path:n,name:s,geom:e,srid:o},i.push(a);return i},importFeatures:function(){if(null==this.paths||0==this.paths.length)return void MapCloud.notify.showInfo("请添加上传数据","Warning");if(null==this.dataSourceName)return void MapCloud.notify.showInfo("请选择要导入的数据库","Warning");var t=this.getFeaturesValid();if(t){var i=this.getFeatures();this.features=i;var a=i[0];null!=a&&this.importFeature(a)}},importFeature:function(t){if(null!=t){var i=t.name,a=t.path,l=t.srid,n=t.geom,s=a.lastIndexOf("/"),e=a.slice(s+1,a.length);e=e.slice(0,e.lastIndexOf(".shp")),a=a.slice(0,s+1),MapCloud.notify.loading(),dbsManager.featureImport(this.dataSourceName,i,a,e,l,n,this.importFeature_callback)}},importFeature_callback:function(t){MapCloud.notify.hideLoading();var i=MapCloud.import_dialog,a=i.features[0];if(null!=a){var l="<div class='row'>"+a.path+" : "+t+"</div>";i.features.splice(0,1),i.panel.find(".import-log-div").append(l)}if(null!=i.features){var n=i.features.length;if(n>=1){var s=i.features[0];i.importFeature(s)}}}});
MapCloud.ImportRasterDialog=MapCloud.Class(MapCloud.Dialog,{sourceName:null,rasterPath:null,rasters:null,path:null,source:null,initialize:function(t){MapCloud.Dialog.prototype.initialize.apply(this,arguments);this.registerPanelEvent()},registerPanelEvent:function(){var t=this;this.panel.find('[data-toggle="tooltip"]').tooltip({container:"body"}),t.panel.find(".import-btn-log").click(function(){if($(this).hasClass("log-col")){var s=t.panel.find(".modal-body").css("height");s=parseInt(s.slice(0,s.lastIndexOf("px")));var a=s+200;t.panel.find(".modal-body").css("height",a+"px"),t.panel.find(".import-log-wrapper").slideDown(500),$(this).find("i").removeClass("fa-chevron-down").addClass("fa-chevron-up"),$(this).removeClass("log-col").addClass("log-exp")}else{var s=t.panel.find(".modal-body").css("height");s=parseInt(s.slice(0,s.lastIndexOf("px")));var i=s-200;t.panel.find(".modal-body").css("height",i+"px"),t.panel.find(".import-log-wrapper").slideUp(500),$(this).find("i").removeClass("fa-chevron-up").addClass("fa-chevron-down"),$(this).removeClass("log-exp").addClass("log-col")}}),this.panel.find(".import-btn-add").click(function(){MapCloud.file_dialog.showDialog("image")}),this.panel.find(".import-btn-remove").click(function(){t.removePath()}),this.panel.find(".import-btn-upload").click(function(){t.addRasters()}),this.panel.on("hidden.bs.modal",function(){t.closeDialog()})},cleanup:function(){this.sourceName=null,this.rasterPath=null,this.rasters=null,this.paths=null,this.source=null,this.panel.find(".import-list-div").empty(),this.panel.find(".import-db-name").val(""),this.panel.find(".import-raster-path").val(""),this.panel.find(".import-log-div").empty()},showDialog:function(t){this.cleanup(),this.panel.modal(),this.source=t},closeDialog:function(){if(this.panel.modal("hide"),"raster"==this.source){var t=MapCloud.raster_db_dialog;t.getListRefresh(this.sourceName,this.rasterPath)}else if("raster-user"==this.source){var s=MapCloud.rasterPanel;null!=s&&s.getListRefresh(this.sourceName,this.rasterPath)}},setRasterPath:function(t,s){this.sourceName=t,this.rasterPath=s,this.panel.find(".import-db-name").val(this.sourceName),this.panel.find(".import-raster-path").val(this.rasterPath)},addImportPaths:function(t){if(null==this.paths)this.paths=t;else for(var s=null,a=0;a<t.length;++a)s=t[a],-1==this.paths.indexOf(s)&&this.paths.push(s);this.setImportPaths(this.paths)},setImportPaths:function(t){for(var s=null,a=null,i="",e=0;e<t.length;++e)if(s=t[e],null!=s){var l=s.lastIndexOf("/");a=s.slice(l+1,s.length),i+="<div class='row'><div class='col-md-6 fpath'>"+s+"</div><div class='col-md-6 col-md-edit rname'><span>"+a+"</span></div></div>"}this.panel.find(".import-list-div").html(i),this.panel.find(".import-list-div .col-md-edit").dblclick(function(){var t=$(this).find("span").html();if(void 0!=t){var s=$(this).css("width"),a=s.slice(0,s.lastIndexOf("px"));a-=2;var i="<input type='text' value='"+t+"' style='width:"+a+"px;padding:0px'>";$(this).html(i),$(this).css("padding","4px 2px 4px 2px");$(this).find("input").focus(),$(this).find("input").focusout(function(){var t=$(this).val();$(this).parent().html("<span>"+t+"</span>"),$(this).parent().css("padding","6px 2px 6px 2px")})}});var n=this;this.panel.find(".import-list-div .row").click(function(){n.panel.find(".import-list-div .row").removeClass("selected"),$(this).addClass("selected")})},removePath:function(){var t=this.panel.find(".import-list-div .row.selected");if(0==t.length)return void MapCloud.notify.showInfo("请选择一行记录进行删除","Warning");for(var s=t.find(".fpath").html(),a=0;a<this.paths.length;++a){var i=this.paths[a];if(i==s){this.paths.splice(a,1);break}}this.setImportPaths(this.paths)},getRasterInfos:function(){for(var t=this.panel.find(".import-list-div .row"),s=[],a=null,i=null,e=null,l=null,n=0;n<t.length;++n)l=t[n],e=$(l).find(".fpath").html(),i=$(l).find(".rname span").html(),a={filePath:e,rasterName:i},s.push(a);return s},addRasters:function(){if(null==this.paths||0==this.paths.length)return void MapCloud.notify.showInfo("请添加要导入的影像","Warning");if(null==this.sourceName||null==this.rasterPath)return void MapCloud.notify.showInfo("请设置要导入的数据库和路径","Warning");var t=this.getRasterInfos();this.rasters=t;var s=t[0];null!=s&&this.addRaster(this.sourceName,s.rasterName,this.rasterPath,s.filePath)},addRaster:function(t,s,a,i){rasterDBManager.addRaster(t,s,a,i,this.addRaster_callback)},addRaster_callback:function(t){var s=MapCloud.import_raster_dialog,a=s.rasters,i=a[0];if(null!=i){var e="<div class='row'>"+i.filePath+" : "+t+"</div>";s.rasters.splice(0,1),s.panel.find(".import-log-div").append(e)}if(null!=s.rasters){var l=s.rasters.length;if(l>=1){var i=s.rasters[0];s.addRaster(s.sourceName,i.rasterName,s.rasterPath,i.filePath)}}}});
MapCloud.ImportVectorDialog=MapCloud.Class(MapCloud.Dialog,{uploader:null,uploadBtn:null,uploadList:null,uploadState:null,dataSources:null,dataSourceName:null,uploadPath:null,source:null,initialize:function(l){MapCloud.Dialog.prototype.initialize.apply(this,arguments);var a=this;this.uploadBtn=this.panel.find("#vector_upload"),this.uploadBtn.click(function(){"uploading"===a.uploadState?a.uploader.stop():a.uploader.upload()}),this.panel.on("hidden.bs.modal",function(){a.closeDialog()})},cleanup:function(){this.dataSourceName=null,this.source=null,this.uploadPath=null,this.panel.find("#vector_list").html("")},showDialog:function(l,a){this.cleanup(),this.panel.modal(),this.uploadList=this.panel.find("#vector_list"),this.uploadState="pending";this.source=a,null!=l&&this.setUploadPath(l),null==this.uploader?this.createUploader():(this.panel.find("#picker").html("选择文件"),this.panel.find("#picker").removeClass("webuploader-container"),this.uploader=null,this.createUploader())},closeDialog:function(){if("file"==this.source){var l=MapCloud.file_dialog;l.refreshCurrentPath()}else if("file-user"==this.source){var l=MapCloud.filePanel;l.refreshCurrentPath()}this.panel.modal("hide")},createUploader:function(){var l=this,a=null;null!=user&&(a=user.name),this.uploader=WebUploader.create({server:"/uploader/fileupload.php",pick:"#picker",resize:!1,chunked:!0,path:l.uploadPath,user:a}),this.uploader.on("fileQueued",function(a){var i=l.getFileHtml(a);l.uploadList.append(i),l.panel.find("#"+a.id+" .btn-drop").click(function(){var a=$(this).parents(".list-group-item"),i=a.attr("id"),e=l.panel.find(".list-group-item[fid='"+i+"']");e.hasClass("info-invis")?(e.removeClass("info-invis"),e.addClass("info-vis"),e.slideDown().css("display","block")):(e.addClass("info-invis"),e.removeClass("info-vis"),e.slideUp())})}),this.uploader.on("uploadProgress",function(a,i){var e=l.panel.find("#"+a.id);e.find(".progress .progress-bar").css("width",100*i+"%"),e.find(".state").text("上传中")}),this.uploader.on("uploadSuccess",function(a){var i=null;i=null!=l.dataSourceName?l.dataSourceName:l.panel.find("#"+a.id+" .import-vector-db option:selected").val();var e=l.panel.find("#"+a.id);e.find(".progress").removeClass("active");var t=l.panel.find("#"+a.id).find(".state");t.html("上传完毕");var o=l.panel.find(".list-group-item[fid='"+a.id+"']");o.find(".vector-type-name").val(),o.find(".vector-srid").val()}),this.uploader.on("uploadError",function(a){l.panel.find("#"+a.id).find(".state").text("上传出错")}),this.uploader.on("uploadComplete",function(l){}),this.uploader.on("all",function(a){"startUpload"===a?l.uploadState="uploading":"stopUpload"===a?l.uploadState="paused":"uploadFinished"===a&&(l.uploadState="done"),"uploading"===l.uploadState?l.uploadBtn.text("暂停上传"):l.uploadBtn.text("开始上传")})},getFileHtml:function(l){var a=(l.name,l.name.slice(0,l.name.indexOf(".zip")),"<li class='list-group-item row' id='"+l.id+"'>    <div class='col-md-3 info'>"+l.name+"    </div>");return a+="    <div class='col-md-6 progress-div'>        <div class='progress progress-striped active'>            <div class='progress-bar' role='progressbar' style='width: 0%;''></div>        </div>    </div>",a+="   <div class='col-md-3 state'>等待上传</div></li>"},setUploadPath:function(l){this.uploadPath=l}});
MapCloud.PGISConnectDialog=MapCloud.Class(MapCloud.Dialog,{type:null,source:null,initialize:function(n){MapCloud.Dialog.prototype.initialize.apply(this,arguments);var a=this;this.panel.find("#data_source_conn_test").each(function(){$(this).click(function(){var n=a.getConnetStr();null!=n&&a.tryConnection(n)})}),this.panel.find(".btn-confirm").each(function(){$(this).click(function(){var n=a.panel.find("#data_source_conn_name").val();if(null==n||""==n)return MapCloud.notify.showInfo("请输入名称","Warning"),void a.panel.find("#data_source_conn_name").focus();var o=/^[0-9a-zA-Z_]+$/;if(!o.test(n))return MapCloud.notify.showInfo("请输入有效的名称","Warning"),void a.panel.find("#data_source_conn_name").focus();var e=a.getConnetStr();a.registerDBS(n,e)})})},destory:function(){MapCloud.Dialog.prototype.destory.apply(this,arguments)},showDialog:function(n,a){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.type=n,this.source=a,"tile"==this.type?(this.panel.find("#data_source_conn_instance").val("27017"),this.panel.find("#data_source_conn_test").css("display","none")):(this.panel.find("#data_source_conn_instance").val("5432"),this.panel.find("#data_source_conn_test").css("display","inline-block"))},cleanup:function(){this.panel.find("#data_source_conn_name").val("")},getConnetStr:function(){var n=this.panel.find("#data_source_conn_server").val();if(null==n||""==n)return MapCloud.notify.showInfo("请输入服务器地址","Warning"),this.panel.find("#data_source_conn_server").focus(),null;var a=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;if(!a.test(n))return MapCloud.notify.showInfo("请输入有效的服务器地址","Warning"),this.panel.find("#data_source_conn_server").focus(),null;var o=this.panel.find("#data_source_conn_instance").val();if(null==o||""==o)return MapCloud.notify.showInfo("请输入端口","Warning"),this.panel.find("#data_source_conn_instance").focus(),null;var e=/^[0-9]*[1-9][0-9]*$/;if(!e.test(o))return MapCloud.notify.showInfo("请输入有效的端口","Warning"),this.panel.find("#data_source_conn_instance").focus(),null;var t=this.panel.find("#data_source_conn_db").val();if(null==t||""==t)return MapCloud.notify.showInfo("请输入数据库名称","Warning"),this.panel.find("#data_source_conn_db").focus(),null;var i=/^[0-9a-zA-Z_]+$/;if(!i.test(t))return MapCloud.notify.showInfo("请输入有效的数据库名称","Warning"),this.panel.find("#data_source_conn_db").focus(),null;var s=this.panel.find("#data_source_conn_user").val();if(null==s||""==s)return MapCloud.notify.showInfo("请输入用户","Warning"),this.panel.find("#data_source_conn_user").focus(),null;if(!i.test(s))return MapCloud.notify.showInfo("请输入有效的用户","Warning"),this.panel.find("#data_source_conn_user").focus(),null;var r=this.panel.find("#data_source_conn_password").val();if(null==r||""==r)return MapCloud.notify.showInfo("请输入密码","Warning"),this.panel.find("#data_source_conn_password").focus(),null;var l="server="+n+";instance="+o+";database="+t+";user="+s+";password="+r+";encoding=GBK";return l},tryConnection:function(n){MapCloud.notify.loading(),dbsManager.tryConnection(n,this.connection_callback)},connection_callback:function(n){var a="连接测试";MapCloud.notify.showInfo(n,a)},registerDBS:function(n,a){MapCloud.notify.loading();var o=null;o="tile"==this.type?"tilemgo":"Postgres",dbsManager.registerDataSource(n,o,a,this.type,this.registerDBS_callback)},registerDBS_callback:function(n){var a="注册数据源";MapCloud.notify.showInfo(n,a);var o=MapCloud.pgis_connection_dialog,e=o.panel.find("#data_source_conn_name").val();if("raster"==o.source){var t=MapCloud.raster_db_dialog;t.getDataSources(),t.setRegisterDataSourceName(e)}else if("feature"==o.source){var t=MapCloud.vector_db_dialog;t.getDataSources(),t.setRegisterDataSourceName(e)}else if("tile"==o.source){var t=MapCloud.tile_db_dialog;t.getDataSources(),t.setRegisterDataSourceName(e)}else if("user-feature"==o.source){var i=MapCloud.vectorPanel;null!=i&&i.getDataSources()}else if("user-raster"==o.source){var i=MapCloud.rasterPanel;null!=i&&i.getDataSources()}else if("user-tile"==o.source){var i=MapCloud.tilePanel;null!=i&&i.getDataSources()}o.closeDialog()}});
MapCloud.Notify=MapCloud.Class(MapCloud.Panel,{container:null,initialize:function(i,n){this.loadingPanel=$("#"+n),this.panel=$("#"+i),this.container=this.panel.notify()},loading:function(){this.loadingPanel.show()},hideLoading:function(){this.loadingPanel.hide()},showInfo:function(i,n){this.hideLoading();var e={title:n,text:i};null==i&&(i=""),"success"==i.toLowerCase()?this.container.notify("create","default",e,{expires:3e3}):this.container.notify("create","default",e,{expires:5e3})}});