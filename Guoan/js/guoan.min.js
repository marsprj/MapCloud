$().ready(function(){var a="user1",e="guoan";if(user=new GeoBeans.User(a),mapManager=user.getMapManager(),mapObj=mapManager.getMap("map_container",e),null!=mapObj){var n=new GeoBeans.Layer.QSLayer("base","/QuadServer/maprequest?services=world_vector"),r=new GeoBeans.Geometry.Point(117.203499,39.131119);n.MAX_ZOOM_LEVEL=19,mapObj.setBaseLayer(n),mapObj.setLevel(10),mapObj.setCenter(r),mapObj.draw()}$("[data-toggle='tooltip']").tooltip({container:"body"}),MapCloud.currentLayer=null,MapCloud.mapBar=new MapCloud.MapBar("map_bar_wrapper"),MapCloud.mapLayersPanel=new MapCloud.MapLayersPanel("map_layers_wrapper"),MapCloud.searchPanel=new MapCloud.SearchPanel("left_panel"),MapCloud.baseLayerPanel=new MapCloud.BaseLayerPanel("base_layer_wrapper"),MapCloud.queryResultPanel=new MapCloud.QueryResultPanel("query_results_container"),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.currentCityPanel=new MapCloud.CurrentCityPanel("city_container"),MapCloud.cityPanel=new MapCloud.CityPanel("city_list_container"),MapCloud.cityPosition=new MapCloud.CityPosition,MapCloud.positionControl=new MapCloud.PositionControl});
MapCloud.SearchPanel=MapCloud.Class(MapCloud.Panel,{poiPageCount:20,poiCurrentPage:null,overlayControlPanel:null,trackOverlayControl:null,baseLayer:"prov_bount_4m",baseLayerField:"name",chartSourceName:"gisdb",chartPositionField:"地区",chartOption:{colorMapID:12,opacity:.9,border:"#cccccc",borderOpacity:.9},heatLayerName:null,initialize:function(a){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.poiManager=user.getPoiManager(),this.overlayControlPanel=$("#map_overlay_wrapper"),this.trackOverlayControl=new GeoBeans.Control.TrackOverlayControl,null!=mapObj&&mapObj.controls.add(this.trackOverlayControl),this.registerEvent(),mapObj.registerOverlayEvent(),this.showHeatMapLayers()},registerEvent:function(){var a=this;this.panel.find("#map_btn").click(function(){var e=a.panel.find(".search-panel");"0px"==e.css("width")?(e.css("width","269px"),a.panel.css("width","330px"),$(this).css("left","329px"),$("#right_panel").css("width","calc( 100% - 360px)"),$(this).find(".fa-angle-right").removeClass(".fa-angle-right").addClass("fa-angle-left")):(e.css("width","0px"),a.panel.css("width","60px"),$(this).css("left","59px"),$("#right_panel").css("width","calc( 100% - 60px)"),$(this).find(".fa-angle-left").removeClass(".fa-angle-left").addClass("fa-angle-right")),e.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){null!=mapObj&&mapObj.resize("width")})}),this.panel.find(".menu li").mouseenter(function(){}),this.panel.find(".menu li").click(function(){var e=a.panel.find(".menu li.active").attr("sname"),l=$(this).attr("sname");(e!=l||"poi"==e)&&(a.panel.find(".menu li").removeClass("active"),$(this).addClass("active"),a.panel.find(".search-tab-panel").hide(),a.panel.find(".search-tab-panel[sname='"+l+"']").show(),"overlay"==l?a.showOverlayPanel():mapObj.unregisterOverlayEvent(),"chart"!=l&&a.removeChart(),"poi"==l&&a.showPoiPanel())}),this.panel.find(".search-panel .search-btn").click(function(){var e=a.panel.find(".search-keyword").val();return""==e?void MapCloud.notify.showInfo("请输入查询关键词","Warning"):void a.searchPoi([e])}),this.panel.find(".poi-item,.poi-list-row span").click(function(){var e=$(this).attr("piname"),l=[];switch(e){case"hotel":l.push("hotel"),l.push("酒店");break;case"restaurant":l.push("饭店"),l.push("饭馆");break;case"shop":l.push("商场"),l.push("商店");break;case"cinema":l.push("电影院");break;case"site":l.push("公园");break;case"bank":l.push("银行"),l.push("ATM");break;case"supermarker":l.push("超市");break;case"subway":l.push("地铁");break;case"gas":l.push("加油站");break;case"park":l.push("停车场");break;case"ktv":l.push("ktv");break;case"bar":l.push("酒吧");break;case"hospital":l.push("医院");break;case"school":l.push("学校"),l.push("小学"),l.push("中学"),l.push("大学");break;case"harmacy":l.push("药店");break;case"atm":l.push("atm");break;case"chafing_dish":l.push("火锅");break;case"barbecue":l.push("烧烤"),l.push("烤串");break;case"snack":l.push("快餐"),l.push("麦当劳"),l.push("肯德基");break;case"sichuan":l.push("川菜");break;case"embassy":l.push("大使馆");break;case"gas":l.push("加油站");break;case"train":l.push("火车站");break;case"bus":l.push("汽车站");break;case"factory":l.push("工厂")}0!=l.length&&a.searchPoi(l)}),this.panel.find(".search-keyword").on("input",function(e){var l=$(this).val();l.length>0?a.panel.find(".remove-poi-search").show():a.panel.find(".remove-poi-search").hide()}),this.panel.find(".remove-poi-search").click(function(){$(this).hide(),a.clearPoiSearch()}),this.panel.find(".overlay-panel .current-layer-row").click(function(){a.startDrawOverlay()}),this.overlayControlPanel.find("#track_marker").each(function(){$(this).click(function(e){e.preventDefault(),a.trackMarker()})}),this.overlayControlPanel.find("#track_polyline").each(function(){$(this).click(function(e){e.preventDefault(),a.trackPolyline()})}),this.overlayControlPanel.find("#track_polygon").each(function(){$(this).click(function(e){e.preventDefault(),a.trackPolygon()})}),this.panel.find(".remove-overlays").click(function(){if(confirm("确定删除所有标注吗?")){mapObj.clearOverlays();var e=mapObj.getOverlays();a.showOverlaysList(e)}}),this.panel.find(".remove-overlay").click(function(){if(confirm("确定删除该标注吗?")){a.editOverlay.endEdit(),mapObj.removeOverlayObj(a.editOverlay),a.editOverlay=null,a.panel.find(".overlay-tab-panel").hide(),a.panel.find(".overlay-list-tab").show();var e=mapObj.getOverlays();a.showOverlaysList(e)}}),this.panel.find(".return-overlay-list").click(function(){a.editOverlay.endEdit(),a.editOverlay=null,a.panel.find(".overlay-tab-panel").hide(),a.panel.find(".overlay-list-tab").show();var e=mapObj.getOverlays();a.showOverlaysList(e)}),this.panel.find(".save-overlay").click(function(){a.editOverlay.removeKeys();var e=a.panel.find("#overlay_edit_name").val();a.panel.find("#overlay_edit_values_row li").each(function(){var e=$(this).find(".overlay_key input").val(),l=$(this).find(".overlay_value input").val();a.editOverlay.addKeyValue(e,l)}),a.editOverlay.name=e,a.editOverlay.endEdit(),a.editOverlay=null;var l=mapObj.getOverlays();a.showOverlaysList(l)});var a=this;this.panel.find(".chart-item").click(function(){var e=$(this).attr("cname"),l=a.panel.find(".chart-item-list[cname='"+e+"']");"block"==l.css("display")?l.slideUp():l.slideDown()}),this.panel.find(".chart-item-list .row").click(function(){var e=$(this).parents(".chart-item-list").attr("cname"),l=$(this).attr("findex"),n=null,i=null;switch(a.panel.find(".chart-item-list .row").removeClass("active"),$(this).addClass("active"),e){case"jumin":switch(n="jumin",l){case"1":i="居民人均可支配收入_元";break;case"2":i="居民人均可支配收入_同比增长";break;case"3":i="城镇居民人均可支配收入_元";break;case"4":i="城镇居民人均可支配收入_同比增长";break;case"5":i="农村居民人均可支配收入_元";break;case"6":i="农村居民人均可支配收入_同比增长";break;case"7":i="居民人均消费支出_元";break;case"8":i="居民人均消费支出_同比增长"}break;case"nongye":switch(n="nongye",l){case"1":i="粮食产量_万吨";break;case"2":i="蔬菜产量_万吨";break;case"3":i="糖料产量_万吨"}break;case"gongye":switch(n="gongye",l){case"1":i="钢材产量_万吨";break;case"2":i="水泥产量_万吨";break;case"3":i="发电量_亿千瓦小时"}}if(null!=n&&null!=i){mapObj.removeLayer("chart");var t=new GeoBeans.Layer.RangeChartLayer("chart",a.baseLayer,a.baseLayerField,a.chartSourceName,n,a.chartPositionField,[i],a.chartOption);mapObj.addLayer(t,null),mapObj.zoomToLayer(a.baseLayer)}}),this.panel.find(".remove-chart").click(function(){a.removeChart()}),this.panel.find(".chart-panel .link").click(function(){var e=$(this).next(),l=$(this).parent();"none"==e.css("display")?(a.panel.find(".chart-panel li.open").removeClass("open"),l.addClass("open"),a.panel.find(".chart-panel .submenu").slideUp(),e.slideDown()):(a.panel.find(".chart-panel li.open").removeClass("open"),a.panel.find(".chart-panel .submenu").slideUp())}),this.panel.find(".heatmap-submenu button").click(function(){a.removeChart();var e=$(this).parent().find("select").val();if(null!=e&&""!=e){a.heatLayerName=e;var l=mapObj.getLayer(e);l.visible||l.setVisiable(!0),mapObj.addHeatMap(e,null,"1"),mapObj.draw(),MapCloud.mapLayersPanel.showLayers()}}),this.panel.find(".slider").each(function(){$(this).slider({tooltip:"hide"}),$(this).on("slide",function(e){var l=e.value;a.panel.find(".chart-opacity").html(l/100)})}),this.panel.find(".panel-collapse:not(:eq(0))").each(function(){$(this).hasClass("in")&&$(this).collapse("hide")});var e=this.panel.find(".panel-collapse").first();e.hasClass("in")||e.collapse("show")},showPoiPanel:function(){this.panel.find(".result-tab-div").hide(),this.panel.find(".poi-tab").show(),this.panel.find(".result-main-div").empty(),mapObj.clearOverlays()},searchPoi:function(a){null!=a&&(this.panel.find(".result-tab-div").hide(),this.panel.find(".result-main-div").show(),this.keyword=a,this.poiCurrentPage=0,this.searchPoiByPage(a,this.poiCurrentPage))},searchPoiByPage:function(a,e){if(!(0>e||null==a)){this.panel.find(".result-content-div .pagination").remove(),this.panel.find(".result-main-div").empty(),mapObj.clearOverlays();var l=e*this.poiPageCount;this.poiManager.getPoi(a,this.poiPageCount,l,null,this.searchPoi_callback)}},searchPoi_callback:function(a){if($.isArray(a)){var e=MapCloud.searchPanel;e.showPoiResults(a),e.showPoiInMap(a)}},showPoiResults:function(a){if(null!=a){for(var e="<ul>",l=null,n=null,i=null,t=null,r=null,s=0;s<a.length;++s)if(l=a[s],null!=l){if(n=l.name,i=l.x,t=l.y,i=parseFloat(i),t=parseFloat(t),i>180){var o=this.mercator2lonlat(i,t);i=o.x,t=o.y}r=l.address,e+="<li pindex='"+s+"'>	<div class='row'>		<div class='col-md-2'>			<img src='../images/marker.png'>		</div>		<div class='col-md-10'>			<div class='row poi-name'>"+n+"			</div>			<div class='row poi-address'>				地址:"+r+"			</div>		</div>	</div></li>"}e+="</ul>",this.panel.find(".result-main-div").html(e),this.panel.find(".result-main-div li").click(function(){var a=$(this).attr("pindex"),e=mapObj.getOverlay(a);mapObj.setFitView(e)});var p='<ul class="pagination">	<li class="pre-page">上一页</li>	<li class="next-page">下一页</li></ul>';this.panel.find(".result-main-div").append(p);var c=this;this.panel.find(".result-content-div .pre-page").click(function(){var a=c.poiCurrentPage;0>=a||(c.poiCurrentPage=a-1,c.searchPoiByPage(c.keyword,c.poiCurrentPage))}),this.panel.find(".result-content-div .next-page").click(function(){var a=c.panel.find(".result-main-div li").length;if(!(a<c.poiPageCount)){var e=c.poiCurrentPage;c.poiCurrentPage=e+1,c.searchPoiByPage(c.keyword,c.poiCurrentPage)}})}},mercator2lonlat:function(a,e){var l={x:0,y:0},a=a/20037508.34*180,e=e/20037508.34*180;return e=180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2),l.x=a,l.y=e,l},showPoiInMap:function(a){for(var e=null,l=null,n=null,i=null,t=null,r=0;r<a.length;++r)if(e=a[r],null!=e){if(l=e.name,n=e.x,i=e.y,n=parseFloat(n),i=parseFloat(i),n>180){var s=this.mercator2lonlat(n,i);n=s.x,i=s.y}t=e.address;var o=new GeoBeans.Geometry.Point(n,i),p=this.getSymbolizer("point"),c=new GeoBeans.Overlay.Marker("maker",o,p);mapObj.addOverlay(c)}mapObj.draw()},getSymbolizer:function(a){if("point"==a){var e=new GeoBeans.Symbolizer.PointSymbolizer;return e.icon_url="../images/marker.png",e.icon_offset_x=0,e.icon_offset_y=0,e}},clearPoiSearch:function(){null!=mapObj&&mapObj.clearOverlays(),this.panel.find(".result-content-div .pagination").remove(),this.panel.find(".result-main-div").empty(),this.poiCurrentPage=null,this.panel.find(".search-keyword").val("")},showOverlayPanel:function(){if(mapObj.clearOverlays(),this.panel.find(".overlay-tab-panel").hide(),this.panel.find(".overlay-list-tab").show(),this.panel.find(".overlay-list-div").empty(),null!=MapCloud.currentLayer){var a=MapCloud.mapLayersPanel.getDataSetName(MapCloud.currentLayer);this.panel.find(".overlay-panel .current-layer-row span").html(a)}},startDrawOverlay:function(){if(null!=MapCloud.currentLayer){var a=mapObj.getLayer(MapCloud.currentLayer);if(null!=a){var e=a.geomType;e==GeoBeans.Geometry.Type.POINT||e==GeoBeans.Geometry.Type.MULTIPOINT?this.trackMarker():e==GeoBeans.Geometry.Type.LINESTRING||e==GeoBeans.Geometry.Type.MULTILINESTRING?this.trackPolyline():(e==GeoBeans.Geometry.Type.POLYGON||e==GeoBeans.Geometry.Type.MULTIPOLYGON)&&this.trackPolygon()}}},trackMarker:function(){this.trackOverlayControl.trackMarker(this.callbackTrackOverlay)},trackPolyline:function(){this.trackOverlayControl.trackLine(this.callbackTrackOverlay)},trackPolygon:function(){this.trackOverlayControl.trackPolygon(this.callbackTrackOverlay)},callbackTrackOverlay:function(a){if(null!=a){var e=MapCloud.searchPanel,l=mapObj.getOverlays();e.showOverlaysList(l)}},showOverlaysList:function(a){if(null!=a){this.panel.find(".overlay-tab-panel").hide(),this.panel.find(".overlay-list-tab").show();for(var e=null,l=null,n=null,i="",t=0;t<a.length;++t)if(e=a[t],null!=e){l=e.name,n=e.type;var r=this.getOverlayTypeSpanHtml(n);i+="<div class='row' oindex='"+t+"'>	<div class='col-md-2'>"+r+"	</div>	<div class='col-md-6'>		<span class='overlay-name'>"+l+"</span>	</div>	<div class='col-md-4'>		<a class='oper oper-edit-overlay' href='javascript:void(0)'>编辑</a>		<a class='oper oper-remove-overlay' href='javascript:void(0)'>删除</a>	</div></div>"}this.panel.find(".overlay-list-div").html(i);var s=this;this.panel.find(".overlay-list-div .oper-remove-overlay").click(function(){var a=$(this).parents(".row").find(".overlay-name").html();if(confirm("确定要删除["+a+"]吗?")){var e=$(this).parents(".row").attr("oindex");mapObj.removeOverlay(parseInt(e)),mapObj.draw();var l=mapObj.getOverlays();s.showOverlaysList(l)}}),this.panel.find(".overlay-list-div .oper-edit-overlay").click(function(){var a=$(this).parents(".row").attr("oindex"),e=mapObj.getOverlay(a);null!=e&&(s.editOverlay=e,s.showEditOverlayPanel(e),e.beginEdit(),mapObj.setFitView(e))})}},getOverlayTypeSpanHtml:function(a){var e="";switch(a){case GeoBeans.Overlay.Type.MARKER:e="<span class=' glyphicon glyphicon-map-marker span-overlay-marker'></span>";break;case GeoBeans.Overlay.Type.PLOYLINE:e="<span class=' mc-icon mc-icon-line span-overlay-marker'></span>";break;case GeoBeans.Overlay.Type.POLYGON:e="<span class=' glyphicon glyphicon-unchecked span-overlay-marker'></span>";break;default:e="<span class=' glyphicon glyphicon-globe span-overlay-marker'></span>"}return e},showEditOverlayPanel:function(a){if(null!=a){this.panel.find(".overlay-tab-panel").hide(),this.panel.find(".overlay-edit-tab").show(),this.editOverlay=a;var e="",l=a.name,n=a.type,i=(this.getOverlayTypeSpanHtml(n),a.kvMap),t=this.getEditOverlayValuesHtml(i);e="<div class='row overlay-edit-name-row'>	<div class='input-group'><span class='input-group-addon'>名称</span>	  <input type='text' class='form-control input-overlay-read' id='overlay_edit_name'		 value='"+l+"'>	</div></div>	"+t,this.panel.find(".overlay-edit-div").html(e),this.panel.find("[data-toggle='tooltip']").tooltip({container:"body"});var r=this;this.panel.find(".glyphicon-plus").each(function(){$(this).click(function(){var a="<li class='row left_row'>	<div class='col-md-4 overlay_key'>		<input type='text' class='form-control' placeholder='key' value=''>	</div>	<div class='input-group col-md-8 overlay_value'>		<input type='text' class='form-control' placeholder='Value' value=''>		<span class='input-group-addon glyphicon glyphicon-trash span-overlay-marker'></span>	</div></li>";r.panel.find("#overlay_edit_values_row").append(a),r.panel.find(".glyphicon-trash").each(function(){$(this).click(function(){$(this).parents("li").remove()})})})}),this.panel.find(".glyphicon-trash").each(function(){$(this).click(function(){$(this).parents("li").remove()})})}},getEditOverlayValuesHtml:function(a){var e="<div class='row left_row_wrapper' id='overlay_add_value_row'>	 <button type='button' class='btn glyphicon glyphicon-plus 		col-md-4 col-md-offset-4' data-toggle='tooltip' data-placement='top' data-original-title='添加属性'></button></div><ul class='row left_row_wrapper' id='overlay_edit_values_row'>";for(var l in a){var n=a[l];e+="<li class='row left_row'>	<div class='col-md-4 overlay_key'>		<input type='text' class='form-control' value='"+l+"'>	</div>	<div class='input-group col-md-8 overlay_value'>		<input type='text' class='form-control' value='"+n+"'>		<span class='input-group-addon glyphicon glyphicon-trash span-overlay-marker'></span>	</div></li>"}return e+="</ul>"},showHeatMapLayers:function(){if(null!=mapObj){for(var a=mapObj.getLayers(),e=null,l=null,n=null,i=null,t="",r=0;r<a.length;++r)e=a[r],null!=e&&(l=e.name,i=e.geomType,null==MapCloud.mapLayersPanel&&(MapCloud.mapLayersPanel=new MapCloud.MapLayersPanel("map_layers_wrapper")),n=MapCloud.mapLayersPanel.getDataSetName(l),(i==GeoBeans.Geometry.Type.POINT||i==GeoBeans.Geometry.Type.MULTIPOINT)&&(t+="<option value='"+l+"'>"+n+"</option>"));this.panel.find("#heatmap_layers").html(t)}},removeChart:function(){null!=this.heatLayerName&&(mapObj.removeHeatMap(this.heatLayerName),mapObj.draw()),mapObj.removeLayer("chart"),mapObj.draw()},setOverlayLayer:function(a,e){null!=a&&null!=e&&this.panel.find(".current-layer-div span").html(a)}});
MapCloud.BaseLayerPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(e){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},registerEvent:function(){var e=this;this.panel.find(".base-layer-icon").click(function(){$(this).hasClass("vector-base")?(e.showBaseLayer("vector"),e.panel.find(".base-layer-icon").removeClass("active"),e.panel.find(".image-base").addClass("active")):$(this).hasClass("image-base")&&(e.showBaseLayer("image"),e.panel.find(".base-layer-icon").removeClass("active"),e.panel.find(".vector-base").addClass("active"))})},showBaseLayer:function(e){if(null!=mapObj){var a=(mapObj.baseLayer,null),s=null;a=mapObj.center,null==a&&(a=new GeoBeans.Geometry.Point(0,0)),s=mapObj.level,null==s&&(s=2),mapObj.removeBaseLayer();var l=null;"vector"==e?l=new GeoBeans.Layer.QSLayer("base","/QuadServer/maprequest?services=world_vector"):"image"==e&&(l=new GeoBeans.Layer.QSLayer("base","/QuadServer/maprequest?services=world_image")),null!=l&&(l.MAX_ZOOM_LEVEL=17,mapObj.setBaseLayer(l),mapObj.setCenter(a),mapObj.setLevel(s),mapObj.draw())}}});
MapCloud.MapBar=MapCloud.Class(MapCloud.Panel,{layerName:"country",initialize:function(n){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},registerEvent:function(){var n=this;this.panel.find(".mc-icon").each(function(e,a){$(this).click(function(){switch(e){case 0:n.onFeatureInfo();break;case 1:n.endQuery();break;case 2:n.onMapGlobe()}})}),this.panel.find(".current-layer").click(function(){var n=MapCloud.mapLayersPanel;"none"==n.panel.css("display")?n.show():n.hide()}),this.panel.find(".layer-query-tool").click(function(){var e=n.panel.find(".query-tools");"none"==e.css("display")?e.slideDown():e.slideUp()}),this.panel.find(".query-tools li").each(function(e,a){$(this).click(function(){if(null==MapCloud.currentLayer)return void MapCloud.notify.showInfo("请在图层列表中选择一个图层","Warning");switch(e){case 0:n.onArea();break;case 1:n.onPolygon();break;case 2:n.onLine()}var a=$(this).html();n.panel.find(".layer-query-tool").html(a),n.panel.find(".query-tools").slideUp()})})},onStretch:function(){var n=this.panel.find("a.btn i");n.hasClass("fa-angle-double-left")?(n.removeClass("fa-angle-double-left"),n.addClass("fa-angle-double-right"),this.panel.children().not(".control-icon").css("display","none"),this.panel.animate({width:"30px"},300)):n.hasClass("fa-angle-double-right")&&(n.removeClass("fa-angle-double-right"),n.addClass("fa-angle-double-left"),this.panel.animate({width:"392px"},300),this.panel.children().not(".control-icon").css("display","block"))},onArea:function(){if(null!=mapObj){if(null==MapCloud.currentLayer)return void MapCloud.notify.showInfo("请在图层列表中选择一个图层","Warning");var n=mapObj.getLayer(MapCloud.currentLayer);null!=n&&(this.panel.find(".mc-icon").removeClass("active"),this.panel.find(".mc-icon-area").addClass("active"),mapObj.queryByRect(MapCloud.currentLayer,this.query_callback))}},query_callback:function(n,e){(null!=n||null!=e)&&(e=parseInt(e),$.isNumeric(e)&&(MapCloud.queryResultPanel.showPanel(),MapCloud.queryResultPanel.setQuery(n,e,MapCloud.mapBar.query_function),MapCloud.queryResultPanel.setOutput(MapCloud.mapBar.output_function),MapCloud.mapBar.cancelQueryTool()))},query_function:function(n,e){var a=mapObj.queryByRectPage(n,e);return a},output_function:function(){var n=mapObj.queryByRectOutput(null,null);return n},onPolygon:function(){if(null!=mapObj){if(null==MapCloud.currentLayer)return void MapCloud.notify.showInfo("请在图层列表中选择一个图层","Warning");var n=mapObj.getLayer(MapCloud.currentLayer);null!=n&&(this.panel.find(".mc-icon").removeClass("active"),this.panel.find(".mc-icon-polygon").addClass("active"),mapObj.queryByPolygon(MapCloud.currentLayer,this.queryByPolygon_callback))}},queryByPolygon_callback:function(n,e){var a=MapCloud.mapBar;MapCloud.queryResultPanel.setQuery(n,e,MapCloud.mapBar.queryByPolygon_function),MapCloud.queryResultPanel.setOutput(MapCloud.mapBar.queryByPolygonOutput_function),a.cancelQueryTool()},queryByPolygon_function:function(n,e){var a=mapObj.queryByPolygonPage(n,e);return a},queryByPolygonOutput_function:function(){var n=mapObj.queryByPolygonOutput(null,null);return n},onLine:function(){if(null!=mapObj){if(null==MapCloud.currentLayer)return void MapCloud.notify.showInfo("请在图层列表中选择一个图层","Warning");var n=mapObj.getLayer(MapCloud.currentLayer);null!=n&&(this.panel.find(".mc-icon").removeClass("active"),this.panel.find(".mc-icon-polygon").addClass("active"),mapObj.queryByLine(MapCloud.currentLayer,this.queryByLine_callback))}},queryByLine_callback:function(n,e){var a=MapCloud.mapBar;MapCloud.queryResultPanel.setQuery(n,e,a.queryByLine_function),MapCloud.queryResultPanel.setOutput(a.queryByLineOutput_function),a.cancelQueryTool()},queryByLine_function:function(n,e){var a=mapObj.queryByLinePage(n,e);return a},queryByLineOutput_function:function(){var n=mapObj.queryByLineOutput(null,null);return n},onFeatureInfo:function(){if(null!=mapObj){if(null==MapCloud.currentLayer)return void MapCloud.notify.showInfo("请在图层列表中选择一个图层","Warning");var n=mapObj.getLayer(MapCloud.currentLayer);null!=n&&(this.panel.find(".mc-icon").removeClass("active"),this.panel.find(".mc-icon-info").addClass("active"),mapObj.queryByClick(MapCloud.currentLayer,this.onFeatureInfo_callback))}},onFeatureInfo_callback:function(n,e,a){if(null!=e&&null!=n){var l=n.getFields();if(null!=l){var u=e.values;if(null!=u){for(var t="<div style='width:220px;max-height:280px'><table class='table table-striped' ><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>",o=0;o<l.length;++o)field=l[o],null!=field&&(type=field.type,"geometry"!=type&&(name=field.name,value=u[o],t+="<tr>	<td>"+name+"</td>	<td>"+value+"</td>	</tr>"));t+="</tbody>",t+="</table>",t+="</div>";var r={title:n.name},i=new GeoBeans.InfoWindow(t,r);mapObj.openInfoWindow(i,a)}}}},endQuery:function(){null!=mapObj&&(this.panel.find(".mc-icon").removeClass("active"),this.panel.find(".mc-icon-mouse").addClass("active"),mapObj.endQuery(),MapCloud.queryResultPanel.cleanup())},onMapGlobe:function(){return null==mapObj?void MapCloud.notify.showInfo("当前地图为空","Warning"):void mapManager.zoomToGlobeMap(mapObj,this.zoomToGlobeMap_callback)},zoomToGlobeMap_callback:function(n){},setCurrentLayer:function(n,e){null==n||null==e?(this.panel.find(".current-layer").html("当前图层: 空"),MapCloud.currentLayer=null):(this.panel.find(".current-layer").html("当前图层: "+n),null!=MapCloud.searchPanel&&MapCloud.searchPanel.setOverlayLayer(n,e),MapCloud.currentLayer=e)},cancelQueryTool:function(){var n='<div class="query-label">查询工具</div>';this.panel.find(".layer-query-tool").html(n)}});
MapCloud.QueryResultPanel=MapCloud.Class(MapCloud.Panel,{maxFeatures:20,layer:null,features:null,query_function:null,output_function:null,initialize:function(t){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent(),this.registerPageEvent()},registerEvent:function(){var t=this;this.panel.find(".btn-hide").click(function(){t.hidePanel()})},showPanel:function(){this.panel.animate({height:"250px"},300)},hidePanel:function(){this.panel.animate({height:"0px"},300)},registerPageEvent:function(){var t=this;this.panel.find(".glyphicon-step-backward").each(function(){$(this).click(function(){var e=parseInt(t.panel.find(".pages-form-pages").html());e>=1&&t.setPage(1)})}),this.panel.find(".glyphicon-step-forward").each(function(){$(this).click(function(){var e=parseInt(t.panel.find(".pages-form-pages").html());e>=1&&t.setPage(e)})}),this.panel.find(".glyphicon-chevron-left").each(function(){$(this).click(function(){var e=parseInt(t.panel.find(".pages-form-page").val());t.setPage(e-1)})}),this.panel.find(".glyphicon-chevron-right").each(function(){$(this).click(function(){var e=parseInt(t.panel.find(".pages-form-page").val());t.setPage(e+1)})}),this.panel.find(".download-features").click(function(){if(null!=t.output_function){var e=t.output_function();window.open(e,"_blank")}}),this.panel.find(".clear-features").click(function(){mapObj.endQuery(),t.cleanup()})},showFeatures:function(t){if(null!=t){this.features=t;var e=null,n=t[0];if(null!=n&&(e=n.featureType),null!=e){var a=e.getFields();null!=a&&(this.setFieldsHtml(a),this.setValuesHtml(t))}}},setFieldsHtml:function(t){for(var e="",n=null,a=null,e="",i=0,l=0;l<t.length;++l)n=t[l],"geometry"!=n.type&&(a=n.name,e+="<th width='80'>"+a+"</th>",i+=1);this.panel.find("#datagrid_content table thead tr").html(e)},setValuesHtml:function(t){html="";for(var e=null,n=null,a=null,i=0;i<t.length;++i)if(e=t[i],null!=e&&(n=e.values,null!=n)){html+="<tr index='"+i+"'>";for(var l=0;l<n.length;++l)a=n[l],a instanceof GeoBeans.Geometry||(html+="<td>"+a+"</td>");html+="</tr>"}this.panel.find("#datagrid_content table tbody").html(html),this.registerFeatureSelected()},setQuery:function(t,e,n){if(null!=t&&null!=e){if(this.layer=t,this.query_function=n,0==e)return this.clearData(),void this.showPanel();this.panel.find(".query_count").html(e);var a=Math.ceil(e/this.maxFeatures);this.panel.find(".pages-form-pages").html(a),this.panel.find("#datagrid_content table thead tr").html(""),this.panel.find("#datagrid_content table tbody").html(""),this.setPage(1),this.showPanel()}},setOutput:function(t){this.output_function=t},setPage:function(t){var e=parseInt(this.panel.find(".pages-form-pages").html());if(this.panel.find(".pages-form-page").val(t),1==t?this.panel.find(".glyphicon-step-backward").addClass("disabled"):this.panel.find(".glyphicon-step-backward").removeClass("disabled"),t==e?this.panel.find(".glyphicon-step-forward").addClass("disabled"):this.panel.find(".glyphicon-step-forward").removeClass("disabled"),0>=t-1?this.panel.find(".glyphicon-chevron-left").addClass("disabled"):this.panel.find(".glyphicon-chevron-left").removeClass("disabled"),t+1>e?this.panel.find(".glyphicon-chevron-right").addClass("disabled"):this.panel.find(".glyphicon-chevron-right").removeClass("disabled"),!(0>t||t>e)){var n=(t-1)*this.maxFeatures,a=this.query_function(this.maxFeatures,n);this.showFeatures(a)}},clearData:function(){this.panel.find("#datagrid_content table thead tr").html(""),this.panel.find("#datagrid_content table tbody").html(""),this.panel.find(".query_count").html("0"),this.panel.find(".pages-form-page").val(0),this.panel.find(".pages-form-pages").html("0")},registerFeatureSelected:function(){var t=this;this.panel.find("#datagrid_content table tbody tr").each(function(){$(this).click(function(){$(this).parents("tbody").children().removeClass("selected"),$(this).addClass("selected");var e=$(this).attr("index"),n=t.features[e];null!=n&&mapObj.setFeatureBlink(n,3)})})}});
MapCloud.MapLayersPanel=MapCloud.Class(MapCloud.Panel,{dbsManager:null,sourceName:"tianjin",initialize:function(a){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.dbsManager=user.getDBSManager(),this.registerPanelEvent(),this.showLayers()},showPanel:function(){MapCloud.Panel.prototype.showPanel.apply(this,arguments)},show:function(){this.showLayers(),this.panel.slideDown()},hide:function(){this.panel.slideUp()},registerPanelEvent:function(){var a=this;this.panel.mouseleave(function(){a.hide()})},getDataSource:function(){this.dbsManager.getDataSource(this.sourceName,this.getDataSource_callback)},getDataSource_callback:function(a){var e=MapCloud.mapLayersPanel;e.getDataSets(a)},getDataSets:function(a){null!=a&&a.getDataSets(this.getDataSets_callback)},getDataSets_callback:function(a){var e=MapCloud.mapLayersPanel;e.showDataSets(a)},showLayers:function(){if(null!=mapObj){for(var a=mapObj.getLayers(),e=null,s=null,c=null,r="",t=0;t<a.length;++t){var e=a[t];if(null!=e){s=e.name;var l="<input type='checkbox'>";e.visible&&(l="<input type='checkbox' checked>");var c=this.getDataSetName(s);null!=c?r+="<div class='row' lname='"+s+"'>	<div class='col-md-2'>"+l+"	</div>	<div class='col-md-9'>		<span class='layer-name'>"+c+"</span>	</div></div>":console.log(s)}}this.panel.find(".map-layers-list").html(r);var n=this;this.panel.find("input[type='checkbox']").change(function(){var a=$(this).parents(".row").attr("lname"),e=mapObj.getLayer(a);null!=e&&($(this).prop("checked")?(e.setVisiable(!0),mapObj.draw()):(e.setVisiable(!1),mapObj.draw()))}),this.panel.find(".layer-name").click(function(){var a=$(this).parents(".row"),e=a.find("input[type='checkbox']"),s=a.attr("lname");if(e.prop("checked"));else{e.prop("checked",!0);var c=mapObj.getLayer(s);null!=c&&(c.setVisiable(!0),mapObj.draw())}n.panel.find(".row").removeClass("active"),a.addClass("active");var r=n.getDataSetName(s);MapCloud.mapBar.setCurrentLayer(r,s)});this.panel.find(".row[lname='wwjz']").addClass("active");null!=MapCloud.mapBar&&MapCloud.mapBar.setCurrentLayer("文物旧址","wwjz")}},showDataSets:function(a){for(var e=null,s=null,c=null,r="",t=0;t<a.length;++t)if(e=a[t],null!=e){s=e.name;var l=this.getLayerName(s);c=mapObj.getLayer(l);var n="<input type='checkbox'>";null!=c&&c instanceof GeoBeans.Layer.FeatureDBLayer&&(n="<input type='checkbox' checked>"),r+="<div class='row' lname='"+s+"'>	<div class='col-md-2'>"+n+"	</div>	<div class='col-md-9'>		<span class='layer-name'>"+s+"</span>	</div></div>"}this.panel.find(".map-layers-list").html(r);var i=this;this.panel.find(".layer-name").click(function(){var a=i.panel.find(".row.active"),e=a.attr("lname"),s=$(this).parents(".row").attr("lname");if(s!=e){a.removeClass("active"),$(this).parents(".row").addClass("active");var c=i.getLayerName(s),r=mapObj.getLayer(c);if(null==r){var r=new GeoBeans.Layer.FeatureDBLayer(c,null,i.sourceName,s,null,null);mapObj.insertLayer(r,i.addLayer_callback),$(this).parents(".row").find("input[type='checkbox']").prop("checked",!0)}else mapObj.zoomToLayer(c);MapCloud.mapBar.setCurrentLayer(s,c)}});var b=this.panel.find("input[type='checkbox']:checked").first().parents(".row");b.addClass("active");var k=b.attr("lname"),l=this.getLayerName(k);MapCloud.mapBar.setCurrentLayer(k,l)},removeLayer_callback:function(a){mapObj.draw()},addLayer_callback:function(a,e){mapObj.draw(),mapObj.zoomToLayer(e.name);var s=MapCloud.mapLayersPanel;"success"==a&&s.setLayerStyle(e)},setLayerStyle:function(a){if(null!=a){var e=this.getStyleName(a);if(null!=e){var s=new GeoBeans.Style.FeatureStyle(e,null);mapObj.setStyle(a.name,s,this.setStyle_callback)}}},setStyle_callback:function(a){},getStyleName:function(a){if(null!=a){var e=a.name,s=null;switch(e){case"餐饮场所":case"cymscs":s="tj_cymscs";break;case"车辆服务":case"clfw":s="tj_clfw";break;case"次要道路":case"cydl":s="tj_cydl";break;case"地标":case"db":s="tj_db";break;case"地名地址":case"dmdz":s="tj_dmdz";break;case"地铁站":case"subway":s="tj_subway";break;case"公安局":case"police":s="tj_police";break;case"公共设施":case"ggss":s="tj_ggss";break;case"公园":case"zb":s="tj_zb";break;case"工厂":case"gc":s="tj_gc";break;case"国道环线":case"gdhx":s="tj_gdhx";break;case"行政区":case"xzq":s="tj_xzq";break;case"河流":case"hyda":s="tj_hyda";break;case"建筑物":case"jzw":s="tj_jzw";break;case"交通设施":case"jtss":s="tj_jtss";break;case"街道楼盘":case"jdlp":s="tj_jdlp";break;case"金融服务":case"jrfw":s="tj_jrfw";break;case"酒吧":case"jb":s="tj_jb";break;case"立交桥":case"lijiaoqiao":s="tj_lijiaoqiao";break;case"旅游景点":case"spot":s="tj_spot";break;case"其他":case"other":s="tj_xzq";break;case"区县行政区":case"qx":s="tj_qx";break;case"人民政府":case"rmzf":s="tj_jdlp";break;case"商店":case"sd":s="tj_gc";break;case"生活服务":case"life":s="tj_ggss";break;case"市界线":case"xz_shijie":s="tj_xz_shijie";break;case"水系":case"sx":s="tj_sx";break;case"铁路":case"railway":s="tj_railway";break;case"文化剧院":case"whjy":s="tj_clfw";break;case"文物旧址":case"wwjz":s="tj_db";break;case"县级行政区":case"xjxzq":s="tj_gdhx";break;case"县界":case"xz_xianjie":s="th_xz_xianjie";break;case"乡镇地址":case"xzdz":s="tj_dmdz";break;case"学校":case"xx":s="tj_police";break;case"医疗服务机构":case"ylfw":s="tj_jzw";break;case"医院":case"yy":s="tj_spot";break;case"主要道路":case"zydl":s="tj_zzdl";break;case"住宿场所":case"zscs":s="tj_cymscs"}return null!=s&&""!=s?s:null}},getLayerName:function(a){var e=null;switch(a){case"餐饮场所":e="cymscs";break;case"车辆服务":e="clfw";break;case"次要道路":e="cydl";break;case"地标":e="db";break;case"地名地址":e="dmdz";break;case"地铁站":e="subway";break;case"公安局":e="police";break;case"公共设施":e="ggss";break;case"公园":e="zb";break;case"工厂":e="gc";break;case"国道环线":e="gdhx";break;case"行政区":e="xzq";break;case"河流":e="hyda";break;case"建筑物":e="jzw";break;case"交通设施":e="jtss";break;case"街道楼盘":e="jdlp";break;case"金融服务":e="jrfw";break;case"酒吧":e="jb";break;case"立交桥":e="lijiaoqiao";break;case"旅游景点":e="spot";break;case"其他":e="other";break;case"区县行政区":e="qx";break;case"人民政府":e="rmzf";break;case"商店":e="sd";break;case"生活服务":e="life";break;case"市界线":e="xz_shijie";break;case"水系":e="sx";break;case"铁路":e="railway";break;case"文化剧院":e="whjy";break;case"文物旧址":e="wwjz";break;case"县级行政区":e="xjxzq";break;case"县界":e="xz_xianjie";break;case"乡镇地址":e="xzdz";break;case"学校":e="xx";break;case"医疗服务机构":e="ylfw";break;case"医院":e="yy";break;case"主要道路":e="zydl";break;case"住宿场所":e="zscs"}return e},getDataSetName:function(a){var e=null;switch(a){case"cymscs":e="餐饮场所";break;case"clfw":e="车辆服务";break;case"cydl":e="次要道路";break;case"db":e="地标";break;case"dmdz":e="地名地址";break;case"subway":e="地铁站";break;case"police":e="公安局";break;case"ggss":e="公共设施";break;case"zb":e="公园";break;case"gc":e="工厂";break;case"gdhx":e="国道环线";break;case"xzq":e="行政区";break;case"hyda":e="河流";break;case"jzw":e="建筑物";break;case"jtss":e="交通设施";break;case"jdlp":e="街道楼盘";break;case"jrfw":e="金融服务";break;case"jb":e="酒吧";break;case"lijiaoqiao":e="立交桥";break;case"spot":e="旅游景点";break;case"other":e="其他";break;case"qx":e="区县行政区";break;case"rmzf":e="人民政府";break;case"sd":e="商店";break;case"life":e="生活服务";break;case"xz_shijie":e="市界线";break;case"sx":e="水系";break;case"railway":e="铁路";break;case"whjy":e="文化剧院";break;case"wwjz":e="文物旧址";break;case"xjxzq":e="县级行政区";break;case"xz_xianjie":e="县界";break;case"xzdz":e="乡镇地址";break;case"xx":e="学校";break;case"ylfw":e="医疗服务机构";break;case"yy":e="医院";break;case"zydl":e="主要道路";break;case"zscs":e="住宿场所"}return e}});
MapCloud.CurrentCityPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(e){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerPanelEvent(),this.cleanup()},registerPanelEvent:function(){this.panel.find(".current-city").click(function(){var e=MapCloud.cityPanel.panel.css("display");"block"==e?MapCloud.cityPanel.hide():MapCloud.cityPanel.show()})},setCity:function(e,n,t){if(this.panel.find(".current-city-name").html(e),MapCloud.cityPanel.setCity(e),null!=n&&null!=t&&null!=mapObj){var a=new GeoBeans.Geometry.Point(n,t);mapObj.setCenter(a),mapObj.setLevel(10),mapObj.draw()}}});
MapCloud.CityPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerPanelEvent()},show:function(){this.panel.slideDown()},hide:function(){this.panel.slideUp()},registerPanelEvent:function(){var i=this;this.panel.find("li").click(function(){var t=$(this).html(),n=MapCloud.cityPosition.getCityPosition(t);if(null!=n){var l=n.lon,e=n.lat;MapCloud.currentCity=t,MapCloud.currentCityPanel.setCity(t,l,e),i.hide()}}),this.panel.mouseleave(function(){i.hide()})},setCity:function(i){null!=i&&this.panel.find(".city-list-current span").html(i)}});
MapCloud.PositionControl=MapCloud.Class({tolerance:.1,cityRegionLayer:"china_city_region",chinaLayer:"china_china",sourceName:"base",nameField:"aname",chinaNameField:"name_engli",chinaFeatureType:null,cityFeatureType:null,initialize:function(){null!=mapObj&&(mapObj.addEventListener(GeoBeans.Event.MOUSE_MOVE,this.onMapMove),mapObj.addEventListener(GeoBeans.Event.MOUSE_DOWN,this.onMapClick));var e=new GeoBeans.WFSWorkspace("tmp",user.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(e,this.cityRegionLayer),this.chinaFeatureType=new GeoBeans.FeatureType(e,this.chinaLayer)},onMapMove:function(e){if(null!=e){var i=e.mapX,t=e.mapY;if(null!=i&&null!=t){var n=i.toFixed(4)+" , "+t.toFixed(4);$(".float-coordinates .coor-value").html(n)}}},onMapClick:function(e){var i=mapObj.center,t=MapCloud.positionControl,n=new GeoBeans.Geometry.Point(i.x,i.y);null==t.position&&(t.x=i.x,t.y=i.y),t.position=i,t.getPositionInChina(n)},getPositionInChina:function(e){if(null!=e){this.chinaFeatureType.fields=this.chinaFeatureType.getFields(null,this.sourceName);var i=[this.chinaNameField];this.chinaFeatureType.getFeaturesWithinAsync(null,this.sourceName,e,this.getPositionInChina_callback,i)}},getPositionInChina_callback:function(e){if($.isArray(e)){var i=MapCloud.positionControl;i.setPositionInChina(e)}},setPositionInChina:function(e){if(null!=e){var i=e.length;if(0==i)MapCloud.currentCityPanel.setCity("其它地区");else{var t=mapObj.level;if(t>10)MapCloud.currentCityPanel.setCity("全国");else{var n=this.x,a=this.y,o=this.position,s=Math.sqrt((o.x-n)*(o.x-n)+(o.y-a)*(o.y-a));if(console.log(s),s>this.tolerance){var l=new GeoBeans.Geometry.Point(o.x,o.y);this.getPositionWithinCity(l)}}this.x=this.position.x,this.y=this.position.y}}},getPositionWithinCity:function(e){if(null!=e){this.featureType.fields=this.featureType.getFields(null,this.sourceName);var i=[this.nameField];this.featureType.getFeaturesWithinAsync(null,this.sourceName,e,this.getPositionWithinCity_callback,i)}},getPositionWithinCity_callback:function(e){if($.isArray(e)&&0!=e.length){var i=MapCloud.positionControl,t=e[0];if(null!=t){var n=t.values,a=i.featureType.getFieldIndex(i.nameField),o=n[a];null!=o&&MapCloud.currentCityPanel.setCity(o)}}}});