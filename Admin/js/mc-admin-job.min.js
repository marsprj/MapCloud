var authManager=null;$().ready(function(){cookieObj=new MapCloud.Cookie;var a=cookieObj.getCookie("username");if(admin=null,null!=a&&(admin=new GeoBeans.User(a)),null!=admin){var n="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(n),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.jobPanel=new MapCloud.JobPanel("job_panel"),MapCloud.jobPanel.setCurrentUser("admin")}});
MapCloud.JobPanel=MapCloud.Class({panel:null,jobManager:null,maxFeatures:15,currentPage:null,initialize:function(t){this.panel=$("#"+t),this.registerPanelEvent()},registerPanelEvent:function(){var t=this;this.panel.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.panel.find("#ip_list .btn-chart-table").click(function(){t.panel.find(".ip-chart-div").hasClass("active")?($(this).find("i").removeClass("fa-table").addClass("fa-bar-chart"),t.panel.find("#ip_list .tab-div").removeClass("active"),t.panel.find(".ip-table-div").addClass("active")):($(this).find("i").removeClass("fa-bar-chart").addClass("fa-table"),t.panel.find("#ip_list .tab-div").removeClass("active"),t.panel.find(".ip-chart-div").addClass("active"))}),this.panel.find("#service_list .btn-chart-table").click(function(){t.panel.find(".service-chart-div").hasClass("active")?($(this).find("i").removeClass("fa-table").addClass("fa-bar-chart"),t.panel.find("#service_list .tab-div").removeClass("active"),t.panel.find(".service-table-div").addClass("active")):($(this).find("i").removeClass("fa-bar-chart").addClass("fa-table"),t.panel.find("#service_list .tab-div").removeClass("active"),t.panel.find(".service-chart-div").addClass("active"))}),this.panel.find("input.date-picker").datetimepicker({format:"yyyy-mm-dd hh:00",minView:"day",autoclose:!0,maxView:"year",language:"zh-CN"}),this.panel.find("#ip_list .btn-refresh").click(function(){t.refreshIpStat()}),this.panel.find("#service_list .btn-refresh").click(function(){t.refreshServiceStat()}),this.panel.find("#job_list .pre-page").click(function(){t.currentPage>=1&&t.getJobListByPage(t.currentPage-1)}),this.panel.find("#job_list .next-page").click(function(){var e=t.panel.find("#job_list tbody tr").length;e<t.maxFeatures||t.getJobListByPage(t.currentPage+1)}),this.panel.find("#job_list .btn-refresh").click(function(){t.getJobListByPage(0)}),this.panel.find(".search-user").click(function(){var e=t.panel.find(".search-wrapper input").val();return null==e||""==e?void MapCloud.notify.showInfo("请输入查询用户","Warning"):(MapCloud.notify.loading(),void authManager.getUser(e,t.getUser_callback))}),this.panel.find(".all-user").click(function(){t.setCurrentUser("admin")})},setCurrentUser:function(t){if(null!=t){var e=new GeoBeans.User(t);this.jobManager=e.getJobManager();var a="";a="admin"==t?"[全部用户]访问统计":"用户["+t+"]访问统计",this.panel.find(".title_box").html(a),this.getJobList(),this.setDeafaultIpStat(),this.getUseStat()}},getJobList:function(){this.getJobListByPage(0)},getJobListByPage:function(t){if(!(0>t)){this.currentPage=t;var e=t*this.maxFeatures;this.panel.find("#job_list tbody").empty(),this.panel.find("#job_list .panel-body").addClass("loading"),this.jobManager.getJob(this.maxFeatures,e,this.getJobList_callback)}},getJobList_callback:function(t){var e=MapCloud.jobPanel;e.panel.find("#job_list .panel-body").removeClass("loading"),$.isArray(t)&&e.showJobList(t)},showJobList:function(t){if(null!=t){for(var e=null,a="",i=0;i<t.length;++i)e=t[i],null!=e&&(a+="<tr>	<td class='td-width-15'>"+(null==e.client||""==e.client?"&nbsp;":e.client)+"</td>	<td class='td-width-15'>"+(null==e.server||""==e.server?"&nbsp;":e.server)+"</td>	<td class='td-width-20'>"+(null==e.operation||""==e.operation?"&nbsp;":e.operation)+"</td>	<td class='td-width-20'>"+(null==e.startTime||""==e.startTime?"&nbsp;":e.startTime)+"</td>	<td class='td-width-20'>"+(null==e.endTime||""==e.endTime?"&nbsp;":e.endTime)+"</td>	<td class='td-width-10'>"+(null==e.state||""==e.state?"&nbsp;":e.state)+"</td></tr>");this.panel.find("#job_list tbody").html(a)}},setDeafaultIpStat:function(){var t=new Date;t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0);var e=(t.getHours(),this.dateAdd(t,"hour",1)),a=this.dateAdd(e,"month",-1),i=this.toTimeFormat(a),s=this.toTimeFormat(e);this.panel.find("#ip_start_date").val(i),this.panel.find("#ip_start_date").datetimepicker("update"),this.panel.find("#ip_end_date").val(s),this.panel.find("#ip_end_date").datetimepicker("update"),this.panel.find("#ip_list .panel-body").addClass("loading"),this.panel.find("#ip_list tbody").empty(),null!=this.ipChart&&(this.ipChart.dispose(),this.ipChart=null),this.jobManager.getJobStatistics("client",null,i,s,this.getIpStat_callback)},getIpStat_callback:function(t){var e=MapCloud.jobPanel;e.panel.find("#ip_list .panel-body").removeClass("loading"),$.isArray(t)&&(e.showIpTable(t),e.showIpStat(t),e.setDefaultServiceStat(t))},showIpTable:function(t){if(null!=t){for(var e=null,a="",i=0;i<t.length;++i)e=t[i],null!=e&&"192.168.111.82"!=e.key&&(a+="<tr>	<td class='td-width-50'>"+e.key+"</td>	<td class='td-width-50'>"+e.count+"</td></tr>");this.panel.find(".ip-table-div tbody").html(a)}},showIpStat:function(t){if(null!=t){for(var e=[],a=[],i=0;i<t.length;++i)if(null!=t[i]){if("192.168.111.82"==t[i].key)continue;e.push(t[i].key),a.push(parseFloat(t[i].count))}this.showIPChart(e,a)}},showIPChart:function(t,e){function a(t){var e=t.name;if(null!=e){var a=[{key:e,value:t.data}];s.setDefaultServiceStat(a)}}if(option={tooltip:{trigger:"axis"},legend:{data:["访问次数"]},grid:{x:100,y:40,y2:90},xAxis:[{type:"category",axisTick:{show:!1},data:t,axisLabel:{interval:"0",rotate:45}}],yAxis:[{type:"value"}],toolbox:{show:!0,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},series:[{name:"访问次数",type:"bar",label:{normal:{show:!0,position:"inside"}},data:e,clickable:!0,markPoint:{data:[{type:"max",name:"最大值"}]}}]},null==this.ipChart){var i=echarts.init(document.getElementById("ip_chart_div"),"macarons");i.setOption(option),this.ipChart=i,this.ipChart.on(echarts.config.EVENT.CLICK,a)}else if(null==this.ipChart.getSeries()){this.ipChart.dispose();var i=echarts.init(document.getElementById("ip_chart_div"),"macarons");i.setOption(option),this.ipChart=i,this.ipChart.on(echarts.config.EVENT.CLICK,a)}else this.ipChart.clear(),this.ipChart.setOption(option);var s=this},dateAdd:function(t,e,a){var i=new Date(t);switch(e.toLowerCase()){case"year":i.setFullYear(i.getFullYear()+a);break;case"quarter":i.setMonth(i.getMonth()+3*a);break;case"month":i.setMonth(i.getMonth()+a);break;case"week":i.setDate(i.getDate()+7*a);break;case"day":i.setDate(i.getDate()+a);break;case"hour":i.setTime(i.getTime()+36e5*a);break;case"minute":i.setTime(i.getTime()+6e4*a);break;case"second":i.setTime(i.getTime()+1e3*a);break;default:i=void 0}return i},toTimeFormat:function(t){if(null==t)return null;var e=t.getFullYear().toString(),a=(t.getMonth()+1).toString(),i=t.getDate().toString(),s=t.getHours().toString(),n=t.getMinutes().toString(),l=t.getSeconds().toString();return e+"-"+(a[1]?a:"0"+a[0])+"-"+(i[1]?i:"0"+i[0])+" "+(s[1]?s:"0"+s[0])+":"+(n[1]?n:"0"+n[0])+":"+(l[1]?l:"0"+l[0])},setDefaultServiceStat:function(t){if(null==t||0==t.length)return null!=this.serviceChart&&this.serviceChart.dispose(),this.panel.find(".service-chart-div").empty(),void this.panel.find(".service-table-div").empty();var e=t[0];if(null!=e){var a=e.key;this.panel.find("#service_list .panel-heading span").html(a);var i=this.panel.find("#ip_start_date").val(),s=this.panel.find("#ip_end_date").val();this.panel.find("#service_start_date").val(i),this.panel.find("#service_start_date").datetimepicker("update"),this.panel.find("#service_end_date").val(s),this.panel.find("#service_end_date").datetimepicker("update"),null!=this.serviceChart&&(this.serviceChart.dispose(),this.serviceChart=null),this.panel.find("#service_list .panel-body").addClass("loading"),this.panel.find(".service-field option[value='operation']").prop("selected",!0),this.jobManager.getJobStatistics("operation",a,i,s,this.getServiceStat_callback)}},getServiceStat_callback:function(t){var e=MapCloud.jobPanel;e.panel.find("#service_list .panel-body").removeClass("loading"),$.isArray(t)&&(e.showServiceTable(t),e.showServiceStat(t))},showServiceTable:function(t){if(null!=t){for(var e=null,a="",i=0;i<t.length;++i)e=t[i],null!=e&&(a+="<tr>	<td class='td-width-50'>"+e.key+"</td>	<td class='td-width-50'>"+e.count+"</td></tr>");this.panel.find(".service-table-div tbody").html(a)}},showServiceStat:function(t){if(null!=t){for(var e=[],a=[],i=0;i<t.length;++i)null!=t[i]&&(e.push(t[i].key),a.push(t[i].count));this.showServiceChart(e,a)}},showServiceChart:function(t,e){var a={tooltip:{trigger:"axis"},legend:{data:["访问次数"]},grid:{x:40,y:40,y2:120},yAxis:[{type:"value"}],xAxis:[{type:"category",axisTick:{show:!1},data:t,axisLabel:{interval:0,rotate:45}}],toolbox:{show:!0,feature:{mark:{show:!1},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},series:[{name:"访问次数",type:"line",label:{normal:{show:!0,position:"inside"}},data:e,itemStyle:{normal:{areaStyle:{type:"default"}}}}]};if(null==this.serviceChart){var i=echarts.init(document.getElementById("service_chart_div"),"macarons");i.setOption(a),this.serviceChart=i}else if(null==this.serviceChart.getSeries()){this.serviceChart.dispose();var i=echarts.init(document.getElementById("service_chart_div"),"macarons");i.setOption(a),this.serviceChart=i}else this.serviceChart.clear(),this.serviceChart.setOption(a)},refreshIpStat:function(){var t=this.panel.find("#ip_start_date").val(),e=this.panel.find("#ip_end_date").val();return new Date(e)-new Date(t)<=0?void MapCloud.notify.showInfo("请选择有效的时间段","Warning"):(this.panel.find("#ip_list .panel-body").addClass("loading"),void this.jobManager.getJobStatistics("client",null,t,e,this.getIpStat_callback))},refreshServiceStat:function(){var t=this.panel.find(".service-field").val(),e=this.panel.find("#service_start_date").val(),a=this.panel.find("#service_end_date").val();if(new Date(a)-new Date(e)<=0)return void MapCloud.notify.showInfo("请选择有效的时间段","Warning");var i=this.panel.find("#service_list .panel-heading strong  span").html();this.panel.find(".service-table-div tbody").empty(),this.panel.find("#service_list .panel-body").addClass("loading"),this.jobManager.getJobStatistics(t,i,e,a,this.getServiceStat_callback)},getUser_callback:function(t){if(!(t instanceof Object))return void MapCloud.notify.showInfo(t,"Warning");MapCloud.notify.hideLoading();var e=MapCloud.jobPanel;e.setCurrentUser(t.name)},getUseStat:function(){},getUseStat:function(){var t=this,e="service="+this.service+"&version="+this.version+"&request=RemoveMap&name="+name;this.removeMapResult=null,$.ajax({type:"get",url:this.server,data:encodeURI(e),dataType:"xml",async:!1,beforeSend:function(t){},success:function(e,a){var i=t.parseRemoveMap(e);t.removeMapResult=i},complete:function(t,e){},error:function(){}})}});