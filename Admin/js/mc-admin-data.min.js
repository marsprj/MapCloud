var authManager=null;$().ready(function(){cookieObj=new MapCloud.Cookie;var a=cookieObj.getCookie("username");if(admin=null,null!=a&&(admin=new GeoBeans.User(a)),null!=admin){dbsManager=admin.getDBSManager();var n="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(n),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.dataPanel=new MapCloud.DataPanel("data_panel")}});
MapCloud.DataPanel=MapCloud.Class({panel:null,baseDB:"base",maxFeatures:30,map:null,baseLayerUrl:"/QuadServer/maprequest?services=",aqiLayers:["gc_aqi","gc_aqi_ranking"],poiLayers:["poi_146m"],initialize:function(a){this.panel=$("#"+a),this.registerPanelEvent(),this.getBaseDataSource()},registerPanelEvent:function(){var a=this;this.panel.find(".db-tree .glyphicon-chevron-right").click(function(){var t=$(this).parents(".row").first().attr("dname");if($(this).hasClass("mc-icon-right"))switch($(this).removeClass("mc-icon-right"),$(this).addClass("mc-icon-down"),$(this).css("transform","rotate(90deg) translate(3px,0px)"),a.panel.find(".db-tree .nav[dname='"+t+"']").remove(),t){case"base":a.getDataSets("base");break;case"tile":a.showTileDataSource();break;case"poi":a.getDataSets("poi");break;case"aqi":a.getDataSets("aqi")}else $(this).css("transform","rotate(0deg) translate(0px,0px)"),$(this).addClass("mc-icon-right"),$(this).removeClass("mc-icon-down"),a.panel.find(".db-tree .nav[dname='"+t+"']").slideUp(500)}),this.panel.find(".enter-base").click(function(){a.getDataSets("base")}),this.panel.find(".enter-tile").click(function(){a.showTileDataSource()}),this.panel.find(".enter-poi").click(function(){a.getDataSets("poi")}),this.panel.find(".enter-aqi").click(function(){a.getDataSets("aqi")}),this.panel.find(".return-datasources-list").click(function(){a.showDataSourcesPanel()}),this.panel.find("#show_datasets_list").click(function(){a.panel.find("#show_datasets_thumb").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").css("display","none"),a.panel.find("#datasets_list_tab").css("display","block")}),this.panel.find("#show_datasets_thumb").click(function(){a.panel.find("#show_datasets_list").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").css("display","none"),a.panel.find("#datasets_thumb_tab").css("display","block")}),this.panel.find(".return-datasource").click(function(){var t=a.panel.find(".db-tree .row.selected").attr("dname");switch(t){case"base":a.getDataSets("base");break;case"tile":a.showTileDataSource();break;case"poi":a.getDataSets("poi");break;case"aqi":a.getDataSets("aqi")}}),this.panel.find("#show_dataset_infos").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetInfos(a.dataSetCur)}),$("#show_dataset_fields").click(function(){$("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetFields(a.dataSetCur)}),this.panel.find("#show_dataset_features").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetFeatures(a.dataSetCur)}),this.panel.find("#show_dataset_preview").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetPreview(a.dataSetCur)}),this.panel.find(".glyphicon-step-backward").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-pages").html());t>=1&&a.setDataSetFeaturePage(1)})}),this.panel.find(".glyphicon-step-forward").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-pages").html());t>=1&&a.setDataSetFeaturePage(t)})}),this.panel.find(".glyphicon-chevron-left").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-page").val());a.setDataSetFeaturePage(t-1)})}),this.panel.find(".pages-form .glyphicon-chevron-right").each(function(){$(this).click(function(){var t=parseInt(a.panel.find(".pages-form-page").val());a.setDataSetFeaturePage(t+1)})}),this.panel.find(".return-qs-list").click(function(){a.showTileDataSource()})},showDataSourcesPanel:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasources_tab").css("display","block")},getBaseDataSource:function(){dbsManager.getDataSource("base",this.getBaseDataSource_callback)},getBaseDataSource_callback:function(a){if(null!=a){var t=MapCloud.dataPanel;t.dataSource=a,null!=t.flag&&t.getDataSets(t.flag)}},getDataSets:function(a){return this.flag=a,null==this.dataSource?void this.getBaseDataSource():(this.flag=a,MapCloud.notify.loading(),this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasource_tab").css("display","block"),this.panel.find(".db-tree .row").removeClass("selected"),this.panel.find(".db-tree .row[dname='"+a+"']").addClass("selected"),this.panel.find(".db-tree .nav[dname='"+a+"']").remove(),this.panel.find(".datasets-list").empty(),this.panel.find(".datasets_thumb_tab").empty(),void this.dataSource.getDataSets(this.getDataSets_callback))},getDataSourceName:function(a){var t="";switch(a){case"base":t="基础地理数据";break;case"aqi":t="AQI数据";break;case"poi":t="poi数据";break;case"tile":t="瓦片数据"}return t},getDataSets_callback:function(a){MapCloud.notify.hideLoading();var t=MapCloud.dataPanel,e=t.getDataSourceName(t.flag);t.panel.find(".current-db").html(e);var a=t.getDataSetsByFlag(t.flag,a);t.showDataSetsTree(a),t.showDataSetsList(a),t.showDataSetsThumb(a)},getDataSetsByFlag:function(a,t){for(var e=[],s=null,i=null,l=null,n=null,d=0;d<t.length;++d)s=t[d],null!=s&&(i=s.name,l=this.aqiLayers.indexOf(i),n=this.poiLayers.indexOf(i),"base"==a?l==-1&&n==-1&&e.push(s):"aqi"==a?l!=-1&&e.push(s):"poi"==a&&n!=-1&&e.push(s));return e},showDataSetsTree:function(a){if($.isArray(a)){for(var t=null,e=null,s="<ul class='nav' dname='"+this.flag+"'>",i=0;i<a.length;++i)t=a[i],null!=t&&(e=t.name,geomType=t.geometryType,geomTypeHtml=this.getDataSetGeomTypeHtml(geomType),s+="<li sname='"+e+"'>\t<a href='#' class='tree-table' dindex='"+i+"'>"+geomTypeHtml+"\t\t<span title='"+e+"'>"+e+"</span>\t</a></li>");var l=this.panel.find(".db-tree .row[dname='"+this.flag+"']");l.after(s);var n=this;this.panel.find(".nav[dname='"+this.flag+"'] li").click(function(){var a=$(this).attr("sname");null!=a&&null!=n.dataSource&&n.getDataSet(n.dataSource,a)})}},showDataSetsList:function(a){if($.isArray(a)){for(var t=null,e=null,s=null,i=null,l="",n=0;n<a.length;++n)t=a[n],e=t.name,s=t.geometryType,null==s&&(s=""),i=t.srid,null==i&&(i=""),l+="<div class='row' sname='"+e+'\'>\t<div class="col-md-1 col-xs-1">'+(n+1)+'</div>\t<div class="col-md-4 col-xs-4">'+e+'</div>\t<div class="col-md-3 col-xs-3">'+s+'</div>\t<div class="col-md-2 col-xs-2">'+i+'</div>\t<div class="col-md-2 col-xs-2">\t\t<a href="javascript:void(0)" class="oper enter-dataset">进入</a>\t\t<a href="javascript:void(0)" class="oper remove-dataset">删除</a>\t</div></div>';this.panel.find(".datasets-list").html(l);var d=this;this.panel.find(".datasets-list .enter-dataset").click(function(){var a=$(this).parents(".row").attr("sname");null!=a&&null!=d.dataSource&&d.getDataSet(d.dataSource,a)}),this.panel.find(".datasets-list .remove-dataset").click(function(){var a=$(this).parents(".row").attr("sname");null!=a&&null!=d.dataSource&&confirm("确定要删除["+a+"]?")&&(MapCloud.notify.loading(),d.dataSource.removeDataSet(a,d.removeDataSet_callback))})}},removeDataSet_callback:function(a){MapCloud.notify.showInfo(a,"删除图层");var t=MapCloud.vectorPanel;t.getDataSets(t.flag)},showDataSetsThumb:function(a){if($.isArray(a)){for(var t="",e=null,s=null,i=null,l=0;l<a.length;++l)e=a[l],name=e.name,s=e.geometryType,null!=s&&(i=e.thumbnail,null!=i&&(t+="<li class='dataset-thumb' dname='"+name+"'><a href='#' class='dataset-thumb-a' dindex='"+l+"' style='background-image:url("+i+")'></a>"),t+="<div class='caption text-center'>\t<h6 title='"+name+" class='text-ellipsis'>"+name+"</h6></div></li>");this.panel.find("#datasets_thumb_tab").html(t);var n=this;this.panel.find("#datasets_thumb_tab .dataset-thumb-a").dblclick(function(){var a=$(this).parent().attr("dname");null!=a&&null!=n.dataSource&&n.getDataSet(n.dataSource,a)})}},getDataSetGeomTypeHtml:function(a){var t="";switch(a){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:t='<i class="mc-icon mc-db-icon-dataset-point"></i>';break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:t='<i class="mc-icon mc-db-icon-dataset-line"></i>';break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:t='<i class="mc-icon mc-db-icon-dataset-polygon"></i>';break;default:t='<i class="mc-icon mc-db-icon-dataset"></i>'}return t},getDataSet:function(a,t){if(this.panel.find(".db-tree li").removeClass("selected"),this.panel.find(".db-tree li[sname='"+t+"']").addClass("selected"),null!=a&&null!=t){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#dataset_tab").css("display","block");var e=this.getDataSourceName(this.flag);this.panel.find(".return-datasource").html(e),this.panel.find(".current-dataset").html(t),this.panel.find(".dataset-infos").empty(),this.panel.find(".dataset-fields").empty(),this.panel.find("#dataset_features_list table thead tr").html(""),this.panel.find("#dataset_features_list table tbody").html(""),this.panel.find(".dataset_preview_tab").empty(),a.getDataSet(t,this.getDataSet_callback)}},getDataSet_callback:function(a){if(null!=a){var t=MapCloud.dataPanel;t.dataSetCur=a;var e=t.panel.find("#dataset_tab .btn-group .btn[disabled='disabled']").attr("id");switch(null==a.geometryType?(t.panel.find("#show_dataset_preview").attr("disabled",!0),"show_dataset_preview"==e&&(t.panel.find("#dataset_tab .btn-group #show_dataset_infos").attr("disabled",!0),e="show_dataset_infos")):"show_dataset_preview"!=e&&t.panel.find("#show_dataset_preview").attr("disabled",!1),e){case"show_dataset_infos":t.showDataSetInfos(a);break;case"show_dataset_fields":t.showDataSetFields(a);break;case"show_dataset_features":t.showDataSetFeatures(a);break;case"show_dataset_preview":t.showDataSetPreview(a)}}},showDataSetInfos:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_infos_tab").css("display","block"),null!=a){var t="";t+="<div class='row'>\t<div class='col-md-3 col-xs-3'>名称</div>\t<div class='col-md-6 col-xs-6'>"+a.name+"</div></div>",null!=a.type&&(t+="<div class='row'>\t<div class='col-md-3 col-xs-3'>类型</div>\t<div class='col-md-6 col-xs-6'>"+a.type+"</div></div>"),null!=a.geometryType&&(t+="<div class='row'>\t<div class='col-md-3 col-xs-3'>几何类型</div>\t<div class='col-md-6 col-xs-6'>"+a.geometryType+"</div></div>"),null!=a.count&&(t+="<div class='row'>\t<div class='col-md-3 col-xs-3'>个数</div>\t<div class='col-md-6 col-xs-6'>"+a.count+"</div></div>"),null!=a.srid&&(t+="<div class='row'>\t<div class='col-md-3 col-xs-3'>空间参考</div>\t<div class='col-md-6 col-xs-6'>"+a.srid+"</div></div>");var e=a.extent;null!=e&&(t+="<div class='row'>\t<div class='col-md-3 col-xs-3'>范围</div>\t<div class='col-md-6 col-xs-6'>东 :"+e.xmax+"</div></div><div class='row'>\t<div class='col-md-3 col-xs-3'></div>\t<div class='col-md-6 col-xs-6'>西 :"+e.xmin+"</div></div><div class='row'>\t<div class='col-md-3 col-xs-3'></div>\t<div class='col-md-6 col-xs-6'>南 :"+e.ymin+"</div></div><div class='row'>\t<div class='col-md-3 col-xs-3'></div>\t<div class='col-md-6 col-xs-6'>北 :"+e.ymax+"</div></div>"),this.panel.find(".dataset-infos").html(t)}},showDataSetFields:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_fields_tab").css("display","block"),null!=a){var t=a.getFields();if(null!=t){for(var e="",s=null,i=null,l=null,n=null,d=0;d<t.length;++d)s=t[d],i=s.name,l=s.type,n=s.length,e+="<div class='row'>\t<div class='col-md-4 col-xs-4'>"+i+"\t</div>\t<div class='col-md-3 col-xs-3'>"+l+"\t</div>\t<div class='col-md-3 col-xs-3'>"+(null==n?"":n)+"\t</div></div>";this.panel.find(".dataset-fields").html(e)}}},showDataSetFeatures:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_features_tab").css("display","block"),null!=a){var t=a.getFields();if(null!=t){this.showDataSetFeautresFields(t);var e=a.count,s=Math.ceil(e/this.maxFeatures);this.panel.find(".pages-form-pages").html(s),this.panel.find(".query_count span").html(e),s>=1?this.setDataSetFeaturePage(1):this.panel.find(".pages-form-page").val(0)}}},setDataSetFeaturePage:function(a){var t=parseInt($(".pages-form-pages").html());$(".pages-form-page").val(a),1==a?this.panel.find(".glyphicon-step-backward").addClass("disabled"):this.panel.find(".glyphicon-step-backward").removeClass("disabled"),a==t?this.panel.find(".glyphicon-step-forward").addClass("disabled"):this.panel.find(".glyphicon-step-forward").removeClass("disabled"),a-1<=0?this.panel.find(".glyphicon-chevron-left").addClass("disabled"):this.panel.find(".glyphicon-chevron-left").removeClass("disabled"),a+1>t?this.panel.find(".glyphicon-chevron-right").addClass("disabled"):this.panel.find(".glyphicon-chevron-right").removeClass("disabled");var e=(a-1)*this.maxFeatures;MapCloud.notify.loading();var s=this.dataSetCur.getFieldsWithoutGeom();this.dataSetCur.getFeatures(this.maxFeatures,e,s,this.getFeatures_callback)},showDataSetFeautresFields:function(a){if(null!=a){for(var t=null,e=null,s="",i=0,l=0;l<a.length;++l)t=a[l],"geometry"!=t.type&&(e=t.name,s+="<th width='80'><nobr>"+e+"</nobr></th>",i+=1);this.panel.find("#dataset_features_list table thead tr").html(s)}},getFeatures_callback:function(a){MapCloud.notify.hideLoading();var t=MapCloud.dataPanel;t.showFeatures(a)},showFeatures:function(a){if(null!=a){for(var t="",e=null,s=null,i=null,l=0;l<a.length;++l)if(e=a[l],null!=e&&(s=e.values,null!=s)){t+="<tr>";for(var n=0;n<s.length;++n)i=s[n],null!=i&&(i instanceof GeoBeans.Geometry||(t+="<td>"+i+"</td>"));t+="</tr>"}this.panel.find("#dataset_features_list table tbody").html(t)}},showDataSetPreview:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_preview_tab").css("display","block"),null!=a&&null!=a&&null!=a.geometryType){var t=this.panel.find("#dataset_preview_tab").width(),e=this.panel.find("#dataset_preview_tab").height(),s=512/384,i=t/e,l=null,n=null;s>i?(l=(e-t/s)/2,e=t/s):(n=(t-e*s)/2,t=e*s);var d=a.thumbnail,c="<img src='"+d+"' width='"+t+"'  height='"+e+"'>";this.panel.find("#dataset_preview_tab").html(c),null!=l&&this.panel.find("#dataset_preview_tab img").css("margin-top",l),null!=n&&this.panel.find("#dataset_preview_tab img").css("margin-left",n)}},showTileDataSource:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#qs_list_tab").css("display","block");var a='<ul class="nav" dname="tile">\t<li sname="world_vector" tname="矢量底图">\t\t<a href="#" class="tree-table">\t\t\t<i class="mc-icon mc-base-layer-icon"></i>\t\t\t<span title="矢量底图">矢量底图</span>\t\t</a>\t</li>\t<li sname="world_image" tname="影像底图">\t\t<a href="#" class="tree-table">\t\t\t<i class="mc-icon mc-base-layer-icon"></i>\t\t\t<span title="影像底图">影像底图</span>\t\t</a>\t</li>\t<li sname="6m" tname="6米地图">\t\t<a href="#" class="tree-table">\t\t\t<i class="mc-icon mc-base-layer-icon"></i>\t\t\t<span title="6米地图">6米地图</span>\t\t</a>\t</li>\t<li sname="zy3" tname="资三地图">\t\t<a href="#" class="tree-table">\t\t\t<i class="mc-icon mc-base-layer-icon"></i>\t\t\t<span title="资三地图">资三地图</span>\t\t</a>\t</li></ul>';this.panel.find(".db-tree .row").removeClass("selected"),this.panel.find(".db-tree .row[dname='tile']").addClass("selected"),this.panel.find(".db-tree .nav[dname='tile']").remove(),this.panel.find(".db-tree .row[dname='tile']").after(a);var t=this;this.panel.find("ul[dname='tile'] li").click(function(){var a=$(this).attr("sname");if(null!=a){var e=$(this).attr("tname");t.showBaseLayer(a,e)}}),a="<div class='row' sname='world_vector' tname='矢量地图'>\t<div class='col-md-1 col-xs-1'>1</div>\t<div class='col-md-3 col-xs-3'>矢量地图</div>\t<div class='col-md-4 col-xs-4'>矢量地图</div>\t<div class='col-md-3 col-xs-3'>\t\t<a href='javascript:void(0)' class='oper enter-tile'>进入</a>\t</div></div><div class='row' sname='world_image' tname='影像地图'>\t<div class='col-md-1 col-xs-1'>2</div>\t<div class='col-md-3 col-xs-3'>影像地图</div>\t<div class='col-md-4 col-xs-4'>影像地图</div>\t<div class='col-md-3 col-xs-3'>\t\t<a href='javascript:void(0)' class='oper enter-tile'>进入</a>\t</div></div><div class='row' sname='6m' tname='6米地图'>\t<div class='col-md-1 col-xs-1'>2</div>\t<div class='col-md-3 col-xs-3'>6米地图</div>\t<div class='col-md-4 col-xs-4'>6米地图</div>\t<div class='col-md-3 col-xs-3'>\t\t<a href='javascript:void(0)' class='oper enter-tile'>进入</a>\t</div></div><div class='row' sname='zy3' tname='资三地图'>\t<div class='col-md-1 col-xs-1'>2</div>\t<div class='col-md-3 col-xs-3'>资三地图</div>\t<div class='col-md-4 col-xs-4'>资三地图</div>\t<div class='col-md-3 col-xs-3'>\t\t<a href='javascript:void(0)' class='oper enter-tile'>进入</a>\t</div></div>",this.panel.find(".tiles-list").html(a),this.panel.find(".tiles-list .enter-tile").click(function(){var a=$(this).parents(".row").first().attr("sname"),e=$(this).parents(".row").first().attr("tname");null!=a&&t.showBaseLayer(a,e)})},showBaseLayer:function(a,t){if(null!=a){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#qs_tab").css("display","block"),this.panel.find(".nav[dname='tile'] li").removeClass("selected"),this.panel.find(".nav[dname='tile'] li[sname='"+a+"']").addClass("selected"),this.panel.find(".current-qs").html(t);var e=null,s=null;if(this.map)this.map.removeBaseLayer(),this.map.draw();else{var i=new GeoBeans.Envelope((-180),(-90),180,90);this.map=new GeoBeans.Map(admin.server,"base_layer_canvas_wrapper","tmp",i,4326,i)}switch(a){case"world_vector":case"world_image":e=new GeoBeans.Geometry.Point(0,0),s=2;break;case"zy3":e=new GeoBeans.Geometry.Point(117.75,39),s=13;break;case"6m":e=new GeoBeans.Geometry.Point(164.87,60.125),s=11}var l=this.baseLayerUrl+a,n=new GeoBeans.Layer.QSLayer("base",l);this.map.setBaseLayer(n),this.map.setCenter(e),this.map.setLevel(s),this.map.draw()}},showPoiDataSource:function(){}});