var authManager=null;$().ready(function(){cookieObj=new MapCloud.Cookie;var a=cookieObj.getCookie("username");if(admin=null,null!=a&&(admin=new GeoBeans.User(a)),null!=admin){dbsManager=admin.getDBSManager();var n="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(n),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.dataPanel=new MapCloud.DataPanel("data_panel")}});
MapCloud.DataPanel=MapCloud.Class({panel:null,baseDB:"base",maxFeatures:30,map:null,baseLayerUrl:"/QuadServer/maprequest?services=",aqiLayers:["gc_aqi","gc_aqi_ranking"],poiLayers:["poi_146m"],initialize:function(a){this.panel=$("#"+a),this.registerPanelEvent(),this.getBaseDataSource()},registerPanelEvent:function(){var a=this;this.panel.find(".db-tree .glyphicon-chevron-right").click(function(){var e=$(this).parents(".row").first().attr("dname");if($(this).hasClass("mc-icon-right"))switch($(this).removeClass("mc-icon-right"),$(this).addClass("mc-icon-down"),$(this).css("transform","rotate(90deg) translate(3px,0px)"),a.panel.find(".db-tree .nav[dname='"+e+"']").remove(),e){case"base":a.getDataSets("base");break;case"tile":a.showTileDataSource();break;case"poi":a.getDataSets("poi");break;case"aqi":a.getDataSets("aqi")}else $(this).css("transform","rotate(0deg) translate(0px,0px)"),$(this).addClass("mc-icon-right"),$(this).removeClass("mc-icon-down"),a.panel.find(".db-tree .nav[dname='"+e+"']").slideUp(500)}),this.panel.find(".enter-base").click(function(){a.getDataSets("base")}),this.panel.find(".enter-tile").click(function(){a.showTileDataSource()}),this.panel.find(".enter-poi").click(function(){a.getDataSets("poi")}),this.panel.find(".enter-aqi").click(function(){a.getDataSets("aqi")}),this.panel.find(".return-datasources-list").click(function(){a.showDataSourcesPanel()}),this.panel.find("#show_datasets_list").click(function(){a.panel.find("#show_datasets_thumb").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").css("display","none"),a.panel.find("#datasets_list_tab").css("display","block")}),this.panel.find("#show_datasets_thumb").click(function(){a.panel.find("#show_datasets_list").attr("disabled",!1),$(this).attr("disabled",!0),a.panel.find("#datasource_tab .right-panel-content-tab").css("display","none"),a.panel.find("#datasets_thumb_tab").css("display","block")}),this.panel.find(".return-datasource").click(function(){var e=a.panel.find(".db-tree .row.selected").attr("dname");switch(e){case"base":a.getDataSets("base");break;case"tile":a.showTileDataSource();break;case"poi":a.getDataSets("poi");break;case"aqi":a.getDataSets("aqi")}}),this.panel.find("#show_dataset_infos").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetInfos(a.dataSetCur)}),$("#show_dataset_fields").click(function(){$("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetFields(a.dataSetCur)}),this.panel.find("#show_dataset_features").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetFeatures(a.dataSetCur)}),this.panel.find("#show_dataset_preview").click(function(){a.panel.find("#dataset_tab .btn-group .btn").attr("disabled",!1),$(this).attr("disabled",!0),null!=a.dataSetCur&&a.showDataSetPreview(a.dataSetCur)}),this.panel.find(".glyphicon-step-backward").each(function(){$(this).click(function(){var e=parseInt(a.panel.find(".pages-form-pages").html());e>=1&&a.setDataSetFeaturePage(1)})}),this.panel.find(".glyphicon-step-forward").each(function(){$(this).click(function(){var e=parseInt(a.panel.find(".pages-form-pages").html());e>=1&&a.setDataSetFeaturePage(e)})}),this.panel.find(".glyphicon-chevron-left").each(function(){$(this).click(function(){var e=parseInt(a.panel.find(".pages-form-page").val());a.setDataSetFeaturePage(e-1)})}),this.panel.find(".pages-form .glyphicon-chevron-right").each(function(){$(this).click(function(){var e=parseInt(a.panel.find(".pages-form-page").val());a.setDataSetFeaturePage(e+1)})}),this.panel.find(".return-qs-list").click(function(){a.showTileDataSource()})},showDataSourcesPanel:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasources_tab").css("display","block")},getBaseDataSource:function(){dbsManager.getDataSource("base",this.getBaseDataSource_callback)},getBaseDataSource_callback:function(a){if(null!=a){var e=MapCloud.dataPanel;e.dataSource=a,null!=e.flag&&e.getDataSets(e.flag)}},getDataSets:function(a){return this.flag=a,null==this.dataSource?void this.getBaseDataSource():(this.flag=a,MapCloud.notify.loading(),this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#datasource_tab").css("display","block"),this.panel.find(".db-tree .row").removeClass("selected"),this.panel.find(".db-tree .row[dname='"+a+"']").addClass("selected"),this.panel.find(".db-tree .nav[dname='"+a+"']").remove(),this.panel.find(".datasets-list").empty(),this.panel.find(".datasets_thumb_tab").empty(),void this.dataSource.getDataSets(this.getDataSets_callback))},getDataSourceName:function(a){var e="";switch(a){case"base":e="基础地理数据";break;case"aqi":e="AQI数据";break;case"poi":e="poi数据";break;case"tile":e="瓦片数据"}return e},getDataSets_callback:function(a){MapCloud.notify.hideLoading();var e=MapCloud.dataPanel,t=e.getDataSourceName(e.flag);e.panel.find(".current-db").html(t);var a=e.getDataSetsByFlag(e.flag,a);e.showDataSetsTree(a),e.showDataSetsList(a),e.showDataSetsThumb(a)},getDataSetsByFlag:function(a,e){for(var t=[],s=null,i=null,l=null,n=null,d=0;d<e.length;++d)s=e[d],null!=s&&(i=s.name,l=this.aqiLayers.indexOf(i),n=this.poiLayers.indexOf(i),"base"==a?-1==l&&-1==n&&t.push(s):"aqi"==a?-1!=l&&t.push(s):"poi"==a&&-1!=n&&t.push(s));return t},showDataSetsTree:function(a){if($.isArray(a)){for(var e=null,t=null,s="<ul class='nav' dname='"+this.flag+"'>",i=0;i<a.length;++i)e=a[i],null!=e&&(t=e.name,geomType=e.geometryType,geomTypeHtml=this.getDataSetGeomTypeHtml(geomType),s+="<li sname='"+t+"'>	<a href='#' class='tree-table' dindex='"+i+"'>"+geomTypeHtml+"		<span title='"+t+"'>"+t+"</span>	</a></li>");var l=this.panel.find(".db-tree .row[dname='"+this.flag+"']");l.after(s);var n=this;this.panel.find(".nav[dname='"+this.flag+"'] li").click(function(){var a=$(this).attr("sname");null!=a&&null!=n.dataSource&&n.getDataSet(n.dataSource,a)})}},showDataSetsList:function(a){if($.isArray(a)){for(var e=null,t=null,s=null,i=null,l="",n=0;n<a.length;++n)e=a[n],t=e.name,s=e.geometryType,null==s&&(s=""),i=e.srid,null==i&&(i=""),l+="<div class='row' sname='"+t+'\'>	<div class="col-md-1 col-xs-1">'+(n+1)+'</div>	<div class="col-md-4 col-xs-4">'+t+'</div>	<div class="col-md-3 col-xs-3">'+s+'</div>	<div class="col-md-2 col-xs-2">'+i+'</div>	<div class="col-md-2 col-xs-2">		<a href="javascript:void(0)" class="oper enter-dataset">进入</a>		<a href="javascript:void(0)" class="oper remove-dataset">删除</a>	</div></div>';this.panel.find(".datasets-list").html(l);var d=this;this.panel.find(".datasets-list .enter-dataset").click(function(){var a=$(this).parents(".row").attr("sname");null!=a&&null!=d.dataSource&&d.getDataSet(d.dataSource,a)}),this.panel.find(".datasets-list .remove-dataset").click(function(){var a=$(this).parents(".row").attr("sname");null!=a&&null!=d.dataSource&&confirm("确定要删除["+a+"]?")&&(MapCloud.notify.loading(),d.dataSource.removeDataSet(a,d.removeDataSet_callback))})}},removeDataSet_callback:function(a){MapCloud.notify.showInfo(a,"删除图层");var e=MapCloud.vectorPanel;e.getDataSets(e.flag)},showDataSetsThumb:function(a){if($.isArray(a)){for(var e="",t=null,s=null,i=null,l=0;l<a.length;++l)t=a[l],name=t.name,s=t.geometryType,null!=s&&(i=t.thumbnail,null!=i&&(e+="<li class='dataset-thumb' dname='"+name+"'><a href='#' class='dataset-thumb-a' dindex='"+l+"' style='background-image:url("+i+")'></a>"),e+="<div class='caption text-center'>	<h6 title='"+name+" class='text-ellipsis'>"+name+"</h6></div></li>");this.panel.find("#datasets_thumb_tab").html(e);var n=this;this.panel.find("#datasets_thumb_tab .dataset-thumb-a").dblclick(function(){var a=$(this).parent().attr("dname");null!=a&&null!=n.dataSource&&n.getDataSet(n.dataSource,a)})}},getDataSetGeomTypeHtml:function(a){var e="";switch(a){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:e='<i class="mc-icon mc-db-icon-dataset-point"></i>';break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:e='<i class="mc-icon mc-db-icon-dataset-line"></i>';break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:e='<i class="mc-icon mc-db-icon-dataset-polygon"></i>';break;default:e='<i class="mc-icon mc-db-icon-dataset"></i>'}return e},getDataSet:function(a,e){if(this.panel.find(".db-tree li").removeClass("selected"),this.panel.find(".db-tree li[sname='"+e+"']").addClass("selected"),null!=a&&null!=e){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#dataset_tab").css("display","block");var t=this.getDataSourceName(this.flag);this.panel.find(".return-datasource").html(t),this.panel.find(".current-dataset").html(e),this.panel.find(".dataset-infos").empty(),this.panel.find(".dataset-fields").empty(),this.panel.find("#dataset_features_list table thead tr").html(""),this.panel.find("#dataset_features_list table tbody").html(""),this.panel.find(".dataset_preview_tab").empty(),a.getDataSet(e,this.getDataSet_callback)}},getDataSet_callback:function(a){if(null!=a){var e=MapCloud.dataPanel;e.dataSetCur=a;var t=e.panel.find("#dataset_tab .btn-group .btn[disabled='disabled']").attr("id");switch(null==a.geometryType?(e.panel.find("#show_dataset_preview").attr("disabled",!0),"show_dataset_preview"==t&&(e.panel.find("#dataset_tab .btn-group #show_dataset_infos").attr("disabled",!0),t="show_dataset_infos")):"show_dataset_preview"!=t&&e.panel.find("#show_dataset_preview").attr("disabled",!1),t){case"show_dataset_infos":e.showDataSetInfos(a);break;case"show_dataset_fields":e.showDataSetFields(a);break;case"show_dataset_features":e.showDataSetFeatures(a);break;case"show_dataset_preview":e.showDataSetPreview(a)}}},showDataSetInfos:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_infos_tab").css("display","block"),null!=a){var e="";e+="<div class='row'>	<div class='col-md-3 col-xs-3'>名称</div>	<div class='col-md-6 col-xs-6'>"+a.name+"</div></div>",null!=a.type&&(e+="<div class='row'>	<div class='col-md-3 col-xs-3'>类型</div>	<div class='col-md-6 col-xs-6'>"+a.type+"</div></div>"),null!=a.geometryType&&(e+="<div class='row'>	<div class='col-md-3 col-xs-3'>几何类型</div>	<div class='col-md-6 col-xs-6'>"+a.geometryType+"</div></div>"),null!=a.count&&(e+="<div class='row'>	<div class='col-md-3 col-xs-3'>个数</div>	<div class='col-md-6 col-xs-6'>"+a.count+"</div></div>"),null!=a.srid&&(e+="<div class='row'>	<div class='col-md-3 col-xs-3'>空间参考</div>	<div class='col-md-6 col-xs-6'>"+a.srid+"</div></div>");var t=a.extent;null!=t&&(e+="<div class='row'>	<div class='col-md-3 col-xs-3'>范围</div>	<div class='col-md-6 col-xs-6'>东 :"+t.xmax+"</div></div><div class='row'>	<div class='col-md-3 col-xs-3'></div>	<div class='col-md-6 col-xs-6'>西 :"+t.xmin+"</div></div><div class='row'>	<div class='col-md-3 col-xs-3'></div>	<div class='col-md-6 col-xs-6'>南 :"+t.ymin+"</div></div><div class='row'>	<div class='col-md-3 col-xs-3'></div>	<div class='col-md-6 col-xs-6'>北 :"+t.ymax+"</div></div>"),this.panel.find(".dataset-infos").html(e)}},showDataSetFields:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_fields_tab").css("display","block"),null!=a){var e=a.getFields();if(null!=e){for(var t="",s=null,i=null,l=null,n=null,d=0;d<e.length;++d)s=e[d],i=s.name,l=s.type,n=s.length,t+="<div class='row'>	<div class='col-md-4 col-xs-4'>"+i+"	</div>	<div class='col-md-3 col-xs-3'>"+l+"	</div>	<div class='col-md-3 col-xs-3'>"+(null==n?"":n)+"	</div></div>";this.panel.find(".dataset-fields").html(t)}}},showDataSetFeatures:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_features_tab").css("display","block"),null!=a){var e=a.getFields();if(null!=e){this.showDataSetFeautresFields(e);var t=a.count,s=Math.ceil(t/this.maxFeatures);this.panel.find(".pages-form-pages").html(s),this.panel.find(".query_count span").html(t),s>=1?this.setDataSetFeaturePage(1):this.panel.find(".pages-form-page").val(0)}}},setDataSetFeaturePage:function(a){var e=parseInt($(".pages-form-pages").html());$(".pages-form-page").val(a),1==a?this.panel.find(".glyphicon-step-backward").addClass("disabled"):this.panel.find(".glyphicon-step-backward").removeClass("disabled"),a==e?this.panel.find(".glyphicon-step-forward").addClass("disabled"):this.panel.find(".glyphicon-step-forward").removeClass("disabled"),0>=a-1?this.panel.find(".glyphicon-chevron-left").addClass("disabled"):this.panel.find(".glyphicon-chevron-left").removeClass("disabled"),a+1>e?this.panel.find(".glyphicon-chevron-right").addClass("disabled"):this.panel.find(".glyphicon-chevron-right").removeClass("disabled");var t=(a-1)*this.maxFeatures;MapCloud.notify.loading();var s=this.dataSetCur.getFieldsWithoutGeom();this.dataSetCur.getFeatures(this.maxFeatures,t,s,this.getFeatures_callback)},showDataSetFeautresFields:function(a){if(null!=a){for(var e=null,t=null,s="",i=0,l=0;l<a.length;++l)e=a[l],"geometry"!=e.type&&(t=e.name,s+="<th width='80'><nobr>"+t+"</nobr></th>",i+=1);this.panel.find("#dataset_features_list table thead tr").html(s)}},getFeatures_callback:function(a){MapCloud.notify.hideLoading();var e=MapCloud.dataPanel;e.showFeatures(a)},showFeatures:function(a){if(null!=a){for(var e="",t=null,s=null,i=null,l=0;l<a.length;++l)if(t=a[l],null!=t&&(s=t.values,null!=s)){e+="<tr>";for(var n=0;n<s.length;++n)i=s[n],null!=i&&(i instanceof GeoBeans.Geometry||(e+="<td>"+i+"</td>"));e+="</tr>"}this.panel.find("#dataset_features_list table tbody").html(e)}},showDataSetPreview:function(a){if(this.panel.find("#dataset_tab .right-panel-content-tab").css("display","none"),this.panel.find("#dataset_preview_tab").css("display","block"),null!=a&&null!=a&&null!=a.geometryType){var e=this.panel.find("#dataset_preview_tab").width(),t=this.panel.find("#dataset_preview_tab").height(),s=512/384,i=e/t,l=null,n=null;s>i?(l=(t-e/s)/2,t=e/s):(n=(e-t*s)/2,e=t*s);var d=a.thumbnail,o="<img src='"+d+"' width='"+e+"'  height='"+t+"'>";this.panel.find("#dataset_preview_tab").html(o),null!=l&&this.panel.find("#dataset_preview_tab img").css("margin-top",l),null!=n&&this.panel.find("#dataset_preview_tab img").css("margin-left",n)}},showTileDataSource:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#qs_list_tab").css("display","block");var a='<ul class="nav" dname="tile">	<li sname="world_vector" tname="矢量底图">		<a href="#" class="tree-table">			<i class="mc-icon mc-base-layer-icon"></i>			<span title="矢量底图">矢量底图</span>		</a>	</li>	<li sname="world_image" tname="影像底图">		<a href="#" class="tree-table">			<i class="mc-icon mc-base-layer-icon"></i>			<span title="影像底图">影像底图</span>		</a>	</li></ul>';this.panel.find(".db-tree .row").removeClass("selected"),this.panel.find(".db-tree .row[dname='tile']").addClass("selected"),this.panel.find(".db-tree .nav[dname='tile']").remove(),this.panel.find(".db-tree .row[dname='tile']").after(a);var e=this;this.panel.find("ul[dname='tile'] li").click(function(){var a=$(this).attr("sname");if(null!=a){var t=$(this).attr("tname");e.showBaseLayer(a,t)}}),a="<div class='row' sname='world_vector' tname='矢量地图'>	<div class='col-md-1 col-xs-1'>1</div>	<div class='col-md-3 col-xs-3'>矢量地图</div>	<div class='col-md-4 col-xs-4'>矢量地图</div>	<div class='col-md-3 col-xs-3'>		<a href='javascript:void(0)' class='oper enter-tile'>进入</a>	</div></div><div class='row' sname='world_image' tname='影像地图'>	<div class='col-md-1 col-xs-1'>2</div>	<div class='col-md-3 col-xs-3'>影像地图</div>	<div class='col-md-4 col-xs-4'>影像地图</div>	<div class='col-md-3 col-xs-3'>		<a href='javascript:void(0)' class='oper enter-tile'>进入</a>	</div></div>",this.panel.find(".tiles-list").html(a),this.panel.find(".tiles-list .enter-tile").click(function(){var a=$(this).parents(".row").first().attr("sname"),t=$(this).parents(".row").first().attr("tname");null!=a&&e.showBaseLayer(a,t)})},showBaseLayer:function(a,e){if(null!=a){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#qs_tab").css("display","block"),this.panel.find(".nav[dname='tile'] li").removeClass("selected"),this.panel.find(".nav[dname='tile'] li[sname='"+a+"']").addClass("selected"),this.panel.find(".current-qs").html(e);var t=new GeoBeans.Geometry.Point(0,0),s=2,i=null,l=this.baseLayerUrl+a;if(null==this.map){var n=new GeoBeans.Envelope(-180,-90,180,90);this.map=new GeoBeans.Map(admin.server,"base_layer_canvas_wrapper","tmp",n,4326,n)}else this.map.removeBaseLayer(),this.map.draw(),t=this.map.center,s=this.map.level;i=new GeoBeans.Layer.QSLayer("base",l),this.map.setBaseLayer(i),this.map.setCenter(t),this.map.setLevel(s),this.map.draw()}},showPoiDataSource:function(){}});