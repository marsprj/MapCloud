var authManager=null;$().ready(function(){cookieObj=new MapCloud.Cookie;var a=cookieObj.getCookie("username");if(admin=null,null!=a&&(admin=new GeoBeans.User(a)),null!=admin){var e="/ows/admin/mgr";authManager=new GeoBeans.AuthManager(e),MapCloud.notify=new MapCloud.Notify("container","alert_loading"),MapCloud.userPanel=new MapCloud.UsersPanel("users_panel")}});
MapCloud.UsersPanel=MapCloud.Class({panel:null,onLineUserCount:null,maxCount:30,pageNumber:5,userCount:null,userPageCount:null,onLineUserCount:null,pageCount:null,initialize:function(a){this.panel=$("#"+a),this.registerPanelEvent(),this.getUserListCount()},registerPanelEvent:function(){var a=this;this.panel.find(".user-list-btn").click(function(){a.getUserListCount()}),this.panel.find(".online-user-btn").click(function(){a.getOnlineUserListCount()}),this.panel.find(".refresh-user-list").click(function(){a.getUserListCount()}),this.panel.find(".refresh-online-user-list").click(function(){a.getOnlineUserListCount()})},getUserList:function(a,e){MapCloud.notify.loading(),authManager.getUserList(a,e,this.getUserList_callback)},getUserList_callback:function(a){if(MapCloud.notify.hideLoading(),$.isArray(a)){for(var e=MapCloud.userPanel,i=null,n="",t=null,l=null,s=null,r=null,o=0;o<a.length;++o)i=a[o],null!=i&&(t=i.name,l=i.alias,s=i.email,r=i.role,n+="<div class='row' uname='"+t+"'>	<div class='col-md-1'>"+(o+1)+"</div>	<div class='col-md-2'>"+t+"</div>	<div class='col-md-2'>"+l+"</div>	<div class='col-md-3'>"+s+"</div>	<div class='col-md-2'>"+r+"</div>	<div class='col-md-2'>		<a href='javascript:void(0)' class='oper enter-user'>访问</a>		<a href='javascript:void(0)' class='oper remove-user'>删除</a>	</div></div>");e.panel.find(".user-list").html(n),e.panel.find(".enter-user").click(function(){var a=$(this).parents(".row").first().attr("uname");null!=a&&window.open("../Editor/index.html?name="+a)}),e.panel.find(".remove-user").click(function(){var a=$(this).parents(".row").first().attr("uname");null!=a&&confirm("确定删除用户["+a+"]吗？")&&e.removeUser(a)})}},getUserListCount:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#user_list_tab").css("display","block"),this.panel.find(".user-list").empty(),this.panel.find(".list-tree .row").removeClass("selected"),this.panel.find(".user-list-btn").parents(".row").first().addClass("selected"),this.panel.find(".users-count span").html(0),MapCloud.notify.loading(),authManager.getUserCount(this.getUserCount_callback)},getUserCount_callback:function(a){if($.isNumeric(a)){MapCloud.notify.hideLoading();var e=MapCloud.userPanel;e.userCount=a,e.panel.find(".users-count span").html(a);var i=Math.ceil(a/e.maxCount);e.userPageCount=i,e.initUserPageControl(1,e.userPageCount)}},initUserPageControl:function(a,e){if(!(0>=a||a>e)){var i="";if(i+=1==a?'<li class="disabled">		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>':'<li>		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>',e<=this.pageNumber)for(var n=1;e>=n;++n)i+=n==a?'<li class="active">	<a href="#">'+a.toString()+'		<span class="sr-only">(current)</span></a></li>':"<li><a href='#'>"+n+"</a></li>";else{var t=e-this.pageNumber+1;if(t>=a)for(var n=a;n<a+this.pageNumber;++n)i+=n==a?'<li class="active">	<a href="#">'+a+"</a></li>":"<li><a href='#'>"+n+"</a></li>";else for(var n=t;e>=n;++n)i+=n==a?'<li class="active">	<a href="#">'+a+"</a></li>":"<li><a href='#'>"+n+"</a></li>"}i+=a==e?'<li class="disabled">		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>':'<li>		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>',this.panel.find("#user_list_tab .pagination").html(i),this.registerUserPageEvent();var l=(a-1)*this.maxCount;this.getUserList(this.maxCount,l)}},registerUserPageEvent:function(){var a=this;this.panel.find("#user_list_tab .pagination li a").click(function(){var e=a.panel.find("#user_list_tab .pagination li.active a").html(),i=parseInt(e),n=$(this).attr("aria-label");"Previous"==n?i-=1:"Next"==n?i+=1:i=parseInt($(this).html()),a.initUserPageControl(i,a.userPageCount)})},getOnlineUserListCount:function(){this.panel.find(".right-panel-tab").css("display","none"),this.panel.find("#online_user_tab").css("display","block"),this.panel.find(".online-user-list").empty(),this.panel.find(".list-tree .row").removeClass("selected"),this.panel.find(".online-user-btn").parents(".row").first().addClass("selected"),this.panel.find(".online-users-count span").html(0),MapCloud.notify.loading(),authManager.getLoginCount(this.getOnlineUserListCount_callback)},getOnlineUserListCount_callback:function(a){if(null!=a){var e=MapCloud.userPanel;e.onLineUserCount=a,e.panel.find(".online-users-count span").html(a);var i=Math.ceil(a/e.maxCount);e.pageCount=i,e.initPageControl(1,e.pageCount)}},initPageControl:function(a,e){if(!(0>=a||a>e)){var i="";if(i+=1==a?'<li class="disabled">		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>':'<li>		<a href="#" aria-label="Previous">			<span aria-hidden="true">«</span>		</a>	</li>',e<=this.pageNumber)for(var n=1;e>=n;++n)i+=n==a?'<li class="active">	<a href="#">'+a.toString()+'		<span class="sr-only">(current)</span></a></li>':"<li><a href='#'>"+n+"</a></li>";else{var t=e-this.pageNumber+1;if(t>=a)for(var n=a;n<a+this.pageNumber;++n)i+=n==a?'<li class="active">	<a href="#">'+a+"</a></li>":"<li><a href='#'>"+n+"</a></li>";else for(var n=t;e>=n;++n)i+=n==a?'<li class="active">	<a href="#">'+a+"</a></li>":"<li><a href='#'>"+n+"</a></li>"}i+=a==e?'<li class="disabled">		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>':'<li>		<a href="#" aria-label="Next">			<span aria-hidden="true">»</span>		</a>	</li>',this.panel.find("#online_user_tab .pagination").html(i),this.registerPageEvent();var l=(a-1)*this.maxCount;this.getOnlineUserList(this.maxCount,l)}},registerPageEvent:function(){var a=this;this.panel.find("#online_user_tab .pagination li a").click(function(){var e=a.panel.find("#online_user_tab .pagination li.active a").html(),i=parseInt(e),n=$(this).attr("aria-label");"Previous"==n?i-=1:"Next"==n?i+=1:i=parseInt($(this).html()),a.initPageControl(i,a.pageCount)})},getOnlineUserList:function(a,e){MapCloud.notify.loading(),authManager.getOnlineUser(a,e,this.getOnlineUserList_callback)},getOnlineUserList_callback:function(a){if(MapCloud.notify.hideLoading(),$.isArray(a)){for(var e=MapCloud.userPanel,i="",n=0;n<a.length;++n){var t=a[n];null!=t&&(i+="<div class='row'>	<div class='col-md-1'>"+(n+1)+"</div>	<div class='col-md-2'>"+t+"</div></div>")}e.panel.find(".online-user-list").html(i)}},removeUser:function(a){MapCloud.notify.loading(),authManager.removeUser(a,this.removeUser_callback)},removeUser_callback:function(a){MapCloud.notify.showInfo(a,"删除用户");var e=MapCloud.userPanel;e.getUserListCount()}});