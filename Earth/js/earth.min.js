!function(){window.Radi={}}(),Radi.Earth={handler:null,initEarth:function(e){var i=256*Math.PI/180,t=new Cesium.Rectangle(-i,-i,i,i);g_earth_view=new Cesium.Viewer("earth_container",{animation:!1,baseLayerPicker:!1,geocoder:!1,timeline:!1,sceneModePicker:!1,fullscreenButton:!1,homeButton:!1,infoBox:!1,selectionIndicator:!1,navigationHelpButton:!1,navigationInstructionsInitiallyVisible:!1,scene3DOnly:!0,imageryProvider:new Cesium.WebMapTileServiceImageryProvider({url:"/QuadServer/services/maps/wmts100",layer:"world_image",style:"default",format:"image/jpeg",tileMatrixSetID:"PGIS_TILE_STORE",minimumLevel:0,maximumLevel:19,credit:new Cesium.Credit("world_country"),tilingScheme:new Cesium.GeographicTilingScheme({rectangle:t})})});var a=new Cesium.CesiumTerrainProvider({url:"//assets.agi.com/stk-terrain/world",requestVertexNormals:!0});g_earth_view.terrainProvider=a,g_earth_view.scene.globe.enableLighting=!1,this.addWorldTrans(),this.handler=new Cesium.ScreenSpaceEventHandler(g_earth_view.scene.canvas)},flyTo:function(e,i,t,a,r,n){g_earth_view.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(e,i,t),orientation:{heading:null==a?Cesium.Math.toRadians(360):Cesium.Math.toRadians(a),pitch:null==r?Cesium.Math.toRadians(-90):Cesium.Math.toRadians(r),roll:null==n?0:Cesium.Math.toRadians(n)}})},camera:function(){return g_earth_view.camera},getCameraPosition:function(){var e=this.camera(),i=e.positionCartographic,t=Cesium.Math.toDegrees(i.latitude),a=Cesium.Math.toDegrees(i.longitude);return{lat:t,lon:a,height:i.height}},addPin:function(e,i){var t=new Cesium.PinBuilder,a=g_earth_view.entities.add({name:"Blank blue pin",position:Cesium.Cartesian3.fromDegrees(118,39.9208667),billboard:{image:t.fromColor(Cesium.Color.ROYALBLUE,48).toDataURL(),verticalOrigin:Cesium.VerticalOrigin.BOTTOM}}),r=Cesium.buildModuleUrl("Assets/Textures/maki/grocery.png"),n=Cesium.when(t.fromUrl(r,Cesium.Color.GREEN,48),function(t){return g_earth_view.entities.add({name:"Grocery store",position:Cesium.Cartesian3.fromDegrees(e,i),billboard:{image:t.toDataURL(),verticalOrigin:Cesium.VerticalOrigin.BOTTOM}})});Cesium.when.all([a,n],function(e){g_earth_view.zoomTo(e)})},addPoint:function(e,i,t){g_earth_view.entities.add({position:Cesium.Cartesian3.fromDegrees(e,i),point:{pixelSize:t,color:Cesium.Color.YELLOW}})},addLine:function(e,i){g_earth_view.entities.add({name:"Glowing blue line on the surface",polyline:{positions:Cesium.Cartesian3.fromDegreesArray(e),width:i,material:new Cesium.PolylineGlowMaterialProperty({glowPower:.2,color:Cesium.Color.YELLOW})}})},addPolygon:function(e,i,t,a){var r=g_earth_view.entities.add({name:"polygon",polygon:{hierarchy:Cesium.Cartesian3.fromDegreesArray(e),material:i,extrudedHeight:t,outline:null==a?!0:a}});return r},addBillboard:function(e,i,t,a){var r={position:Cesium.Cartesian3.fromDegrees(e,i),billboard:{image:a},label:{text:t,font:"16px Microsoft YaHei",outlineColor:Cesium.Color.BLACK,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.MIDDLE,pixelOffset:new Cesium.Cartesian2(10,0)}};return g_earth_view.entities.add(r)},zoom:function(e){Cesium.when.all(e,function(i){g_earth_view.zoomTo(e)})},cleanup:function(){g_earth_view.entities.removeAll(),$("#legend_container").empty()},addCylinder:function(e,i,t,a,r){var n=g_earth_view.entities.add({name:"Cylinder",position:Cesium.Cartesian3.fromDegrees(e,i,0),cylinder:{length:t,topRadius:a,bottomRadius:a,material:r}});return n},addLabel:function(e,i,t,a){var r=g_earth_view.entities.add({position:Cesium.Cartesian3.fromDegrees(e,i,t),label:{text:a,font:"16px Microsoft YaHei",outlineColor:Cesium.Color.BLACK,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,pixelOffsetScaleByDistance:new Cesium.NearFarScalar(150,3,15e6,.5)}});return r},cartesianToDegrees:function(e){if(!(e instanceof Cesium.Cartesian3))return null;var i=ellipsoid.cartesianToCartographic(position),t=Cesium.Math.toDegrees(i.latitude),a=Cesium.Math.toDegrees(i.longitude);return{lat:t,lon:a,height:i.height}},mercator2lonlat:function(e,i){var t={x:0,y:0},e=e/20037508.34*180,i=i/20037508.34*180;return i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),t.x=e,t.y=i,t},addEventListener:function(e,i){var t=g_earth_view.scene.globe.ellipsoid;this.handler.setInputAction(function(e){if(null!=e.position)if(cartesian=g_earth_view.camera.pickEllipsoid(e.position,t),cartesian){var a=t.cartesianToCartographic(cartesian);longitudeString=Cesium.Math.toDegrees(a.longitude),latitudeString=Cesium.Math.toDegrees(a.latitude),height=Math.ceil(g_earth_view.camera.positionCartographic.height),i({lat:latitudeString,lon:longitudeString,height:height})}else i(null)},e)},addClickListener:function(e){var i=g_earth_view.scene.globe.ellipsoid;this.handler.setInputAction(function(t){if(null!=t.position)if(cartesian=g_earth_view.camera.pickEllipsoid(t.position,i),cartesian){var a=i.cartesianToCartographic(cartesian);longitudeString=Cesium.Math.toDegrees(a.longitude),latitudeString=Cesium.Math.toDegrees(a.latitude),height=Math.ceil(g_earth_view.camera.positionCartographic.height),e({lat:latitudeString,lon:longitudeString,height:height})}else e(null)},Cesium.ScreenSpaceEventType.LEFT_DOWN)},addMoveListener:function(e){var i=g_earth_view.scene.globe.ellipsoid;this.handler.setInputAction(function(t){if(null!=t.endPosition)if(cartesian=g_earth_view.camera.pickEllipsoid(t.endPosition,i),cartesian){var a=i.cartesianToCartographic(cartesian);longitudeString=Cesium.Math.toDegrees(a.longitude),latitudeString=Cesium.Math.toDegrees(a.latitude),height=Math.ceil(g_earth_view.camera.positionCartographic.height),e({lat:latitudeString,lon:longitudeString,height:height})}else e(null)},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},addScrollEventListener:function(e){this.handler.setInputAction(function(i){var t=Math.ceil(g_earth_view.camera.positionCartographic.height);e(t)},Cesium.ScreenSpaceEventType.WHEEL)},addWorldTrans:function(){var e=256*Math.PI/180,i=new Cesium.Rectangle(-e,-e,e,e),t=g_earth_view.scene.imageryLayers;t.addImageryProvider(new Cesium.WebMapTileServiceImageryProvider({url:"/QuadServer/services/maps/wmts100",layer:"world_trans",style:"default",format:"image/jpeg",tileMatrixSetID:"PGIS_TILE_STORE",minimumLevel:0,maximumLevel:19,credit:new Cesium.Credit("world_country"),tilingScheme:new Cesium.GeographicTilingScheme({rectangle:i})}))},addModel:function(){var e=g_earth_view.entities.add({position:Cesium.Cartesian3.fromDegrees(116,39),model:{uri:"Model/duck/duck.gltf"}});g_earth_view.trackedEntity=e}};
$().ready(function(){MapCloud.server="/ows/user1/mgr",MapCloud.currentCity="北京",Radi.Earth.initEarth("earth_container"),MapCloud.searchPanel=new MapCloud.SearchPanel("search_container"),MapCloud.currentCityPanel=new MapCloud.CurrentCityPanel("city_container"),MapCloud.cityPanel=new MapCloud.CityPanel("city_list_container"),MapCloud.aqiChartDialog=new MapCloud.AQIChartDialog("aqi_chart_dialog","aqi_chart_container"),MapCloud.positionControl=new MapCloud.PositionControl,MapCloud.positionPanel=new MapCloud.PositionPanel("position_container"),MapCloud.cityPosition=new MapCloud.CityPosition,MapCloud.topicPanel=new MapCloud.TopicPanel("topic_container"),MapCloud.currentCity="北京",Radi.Earth.flyTo(116.39,39.9,5e4),MapCloud.dateAdd=function(e,o,a){var l=new Date(e);switch(o.toLowerCase()){case"year":l.setFullYear(l.getFullYear()+a);break;case"quarter":l.setMonth(l.getMonth()+3*a);break;case"month":l.setMonth(l.getMonth()+a);break;case"week":l.setDate(l.getDate()+7*a);break;case"day":l.setDate(l.getDate()+a);break;case"hour":l.setTime(l.getTime()+36e5*a);break;case"minute":l.setTime(l.getTime()+6e4*a);break;case"second":l.setTime(l.getTime()+1e3*a);break;default:l=void 0}return l},MapCloud.dateFormat=function(e,o){var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(o)&&(o=o.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var l in a)new RegExp("("+l+")").test(o)&&(o=o.replace(RegExp.$1,1==RegExp.$1.length?a[l]:("00"+a[l]).substr((""+a[l]).length)));return o},MapCloud.getAQILevelClass=function(e){return $.isNumeric(e)?50>=e?"label-aqi-level-1":e>50&&100>=e?"label-aqi-level-2":e>100&&150>=e?"label-aqi-level-3":e>150&&200>=e?"label-aqi-level-4":e>200&&300>=e?"label-aqi-level-5":e>300?"label-aqi-level-6":void 0:"label-aqi-level-1"},MapCloud.getAQILevelColor=function(e){return $.isNumeric(e)?50>=e?Cesium.Color.GREEN:e>50&&100>=e?Cesium.Color.YELLOW:e>100&&150>=e?Cesium.Color.ORANGE:e>150&&200>=e?Cesium.Color.RED:e>200&&300>=e?Cesium.Color.PURPLE:e>300?Cesium.Color.BROWN:void 0:Cesium.Color.GREEN},MapCloud.getAQILevelColorAlpha=function(e,o){return $.isNumeric(e)?50>=e?Cesium.Color.fromAlpha(Cesium.Color.GREEN,o):e>50&&100>=e?Cesium.Color.fromAlpha(Cesium.Color.YELLOW,o):e>100&&150>=e?Cesium.Color.fromAlpha(Cesium.Color.ORANGE,o):e>150&&200>=e?Cesium.Color.fromAlpha(Cesium.Color.RED,o):e>200&&300>=e?Cesium.Color.fromAlpha(Cesium.Color.PURPLE,o):e>300?Cesium.Color.fromAlpha(Cesium.Color.BROWN,o):void 0:Cesium.Color.fromAlpha(Cesium.Color.GREEN,o)}});
MapCloud.SearchPanel=MapCloud.Class(MapCloud.Panel,{userName:"user1",poiManager:null,sourceName:"base",aqiRankingLayer:"gc_aqi_ranking",aqiRankingCityField:"area",aqiStatLayer:"gc_aqi",aqiUptimeLayer:"gc_aqi_ranking_uptime",placeLayer:"china_county_region",aqiRankingFeatureType:null,aqiStatFeatureType:null,aqiUptimeFeatureType:null,server:null,pm25Field:"pm2_5",pm10Field:"pm10",aqiField:"aqi",primaryPollutantField:"primary_pollutant",qualityField:"quality",levelField:"level",aqiTimeField:"time_point",areaField:"area",positionField:"position_name",statXField:"x",statYField:"y",stationCodeField:"station_code",uptimeFiled:"uptime",placeField:"name",aqiRankingCount:12,aqiRankingPageCount:null,aqiRankingCurrentPage:null,timepoint:null,showAQIChartFlag:!1,poiCurrentPage:null,poiPageCount:20,initialize:function(e){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent(),this.server="/ows/"+this.userName+"/mgr",this.poiManager=new GeoBeans.PoiManager("/ows/user1");var a=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.aqiRankingFeatureType=new GeoBeans.FeatureType(a,this.aqiRankingLayer),this.aqiStatFeatureType=new GeoBeans.FeatureType(a,this.aqiStatLayer),this.aqiUptimeFeatureType=new GeoBeans.FeatureType(a,this.aqiUptimeLayer),this.placeFeatureType=new GeoBeans.FeatureType(a,this.placeLayer),this.getCurrentTime()},getCurrentTime:function(){this.aqiUptimeFeatureType.getMinMaxValueAsync(this.uptimeFiled,null,this.sourceName,this.getCurrentTime_callback)},getCurrentTime_callback:function(e){if(null!=e){var a=MapCloud.searchPanel;a.setCurrentTime(e.max)}},setCurrentTime:function(e){if(null!=e){this.timepoint=e;var a=e.slice(e.lastIndexOf(" ")+1,e.length);this.panel.find(".current-time span").html(a),this.getAQICityInfo(MapCloud.currentCity)}},getAQICityInfo:function(e){if(null!=e){"block"==this.panel.find(".aqi-stat-tab").css("display")&&(this.panel.find(".search-tab-div").removeClass("active"),this.panel.find(".aqi-tab").addClass("active"),Radi.Earth.cleanup());var a=this.panel.find(".aqi-info .aqi-stat").html();a!=e&&this.getAQIInfo(e,this.timepoint,this.getAQIInfo_callback)}},registerEvent:function(){var e=this;this.panel.find("[data-toggle='tooltip']").tooltip({container:"body"}),e.panel.find(".logo").click(function(){var a=e.panel.find("#search_content_div");"block"==a.css("display")?a.slideUp():a.slideDown()}),e.panel.find(".search-item-menu li a").click(function(){var a=$(this).text(),i=a+"<span class='caret'></span>";e.panel.find(".search-item").html(i)}),e.panel.find(".search-btn").click(function(){var a=e.panel.find(".search-keyword").val();if(""!=a){var i=e.panel.find(".search-item").text();switch(i){case"POI":e.searchPoi(a);break;case"AQI":break;case"地名":e.searchPlace(a)}}}),this.panel.find(".search-menu-div li").click(function(){Radi.Earth.cleanup();var a=$(this).attr("pname");if("aqi"==a)return void e.showAQIPanel();e.panel.find(".search-menu-div li").removeClass("active"),$(this).addClass("active");var i="."+a+"-tab";e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(i).addClass("active")}),this.panel.find(".return-search-list-btn").click(function(){e.panel.find(".search-content-tab-div").css("display","none"),e.panel.find(".search-list-div").css("display","block")}),this.panel.find(".poi-item,.poi-list-row span").click(function(){var a=$(this).attr("piname"),i=[];switch(a){case"hotel":i.push("hotel"),i.push("酒店");break;case"restaurant":i.push("饭店"),i.push("饭馆");break;case"shop":i.push("商场"),i.push("商店");break;case"cinema":i.push("电影院");break;case"site":i.push("公园");break;case"bank":i.push("银行"),i.push("ATM");break;case"supermarker":i.push("超市");break;case"subway":i.push("地铁");break;case"bus":i.push("公交站");break;case"gas":i.push("加油站");break;case"park":i.push("停车场");break;case"ktv":i.push("ktv");break;case"bar":i.push("酒吧");break;case"hospital":i.push("医院");break;case"school":i.push("学校"),i.push("小学"),i.push("中学"),i.push("大学");break;case"harmacy":i.push("药店");break;case"atm":i.push("atm");break;case"chafing_dish":i.push("火锅");break;case"barbecue":i.push("烧烤"),i.push("烤串");break;case"snack":i.push("快餐"),i.push("麦当劳"),i.push("肯德基");break;case"sichuan":i.push("川菜")}0!=i.length&&e.searchPoi(i)}),this.panel.find(".aqi-ranking-page li").click(function(){var a=e.aqiRankingCurrentPage;$(this).hasClass("first-page")?(e.aqiRankingCurrentPage=1,e.getAQIRanking(e.timepoint,1)):$(this).hasClass("pre-page")?a>1&&a<=e.aqiRankingPageCount&&(e.aqiRankingCurrentPage=e.aqiRankingCurrentPage-1,e.getAQIRanking(e.timepoint,e.aqiRankingCurrentPage)):$(this).hasClass("next-page")?a>0&&a<e.aqiRankingPageCount&&(e.aqiRankingCurrentPage=e.aqiRankingCurrentPage+1,e.getAQIRanking(e.timepoint,e.aqiRankingCurrentPage)):$(this).hasClass("last-page")&&(e.aqiRankingCurrentPage=e.aqiRankingPageCount,e.getAQIRanking(e.timepoint,e.aqiRankingPageCount));var i=e.aqiRankingCurrentPage+" / "+e.aqiRankingPageCount+"页";e.panel.find(".aqi-ranking-page .current-page").html(i)}),this.panel.find(".aqi-chart-btn").click(function(){var a=$(this).parents(".board").find(".aqi-stat").html(),i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(e.areaField);var n=new GeoBeans.Literal;n.setValue(a),i.expression1=t,i.expression2=n,MapCloud.aqiChartDialog.showDialog(e.timepoint,e.aqiRankingFeatureType,a,i)}),this.panel.find(".show-stat").click(function(){null!=MapCloud.currentCity&&(e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".aqi-stat-tab").addClass("active"),e.getAQIStat(MapCloud.currentCity,e.timepoint))}),this.panel.find(".return-aqi").click(function(){e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".aqi-tab").addClass("active"),Radi.Earth.cleanup()}),this.panel.find(".result-content-div .pre-page").click(function(){var a=e.poiCurrentPage;0>=a||(e.poiCurrentPage=a-1,e.searchPoiByPage(e.keyword,e.poiCurrentPage))}),this.panel.find(".result-content-div .next-page").click(function(){var a=e.panel.find(".result-main-div li").length;if(!(a<e.poiPageCount)){var i=e.poiCurrentPage;e.poiCurrentPage=i+1,e.searchPoiByPage(e.keyword,e.poiCurrentPage)}})},searchPoi:function(e){null!=e&&(this.keyword=e,this.poiCurrentPage=0,this.searchPoiByPage(this.keyword,this.poiCurrentPage))},searchPoiByPage:function(e,a){if(!(0>a||null==e)){Radi.Earth.cleanup(),this.panel.find(".result-main-div").empty();var i=a*this.poiPageCount;this.poiManager.getPoi(e,this.poiPageCount,i,null,this.searchPoi_callback)}},searchPoi_callback:function(e){if(console.log(e.length),$.isArray(e)){var a=MapCloud.searchPanel;a.showPoisResult(e),a.showPoisIn3D(e)}},showPoisResult:function(e){if($.isArray(e)){for(var a="<ul>",i=null,t=null,n=null,l=null,s=null,r=0;r<e.length;++r)if(i=e[r],null!=i){if(t=i.name,n=i.x,l=i.y,n=parseFloat(n),l=parseFloat(l),n>180){var o=Radi.Earth.mercator2lonlat(n,l);n=o.x,l=o.y}s=i.address,a+="<li px='"+n+"' py='"+l+"'>	<div class='row'>		<div class='col-md-2'>			<img src='../images/marker.png'>		</div>		<div class='col-md-10'>			<div class='row poi-name'>"+t+"			</div>			<div class='row poi-address'>				地址:"+s+"			</div>		</div>	</div></li>"}a+="</ul>",this.panel.find(".result-main-div").html(a),this.panel.find(".search-content-tab-div").css("display","none"),this.panel.find(".result-div").css("display","block"),this.panel.find(".result-div ul li").click(function(){var e=$(this).attr("px"),a=$(this).attr("py");if(null!=e&&null!=a){var i=1e4;Radi.Earth.flyTo(e,a,i)}})}},showPoisIn3D:function(e){for(var a="../images/marker.png",i=null,t=null,n=null,l=null,s=null,r=[],o=null,u=0;u<e.length;++u)if(i=e[u],null!=i){if(t=i.name,n=i.x,l=i.y,n=parseFloat(n),l=parseFloat(l),n>180){var p=Radi.Earth.mercator2lonlat(n,l);n=p.x,l=p.y}s=i.address,type=i.type,o=Radi.Earth.addBillboard(n,l,t,a),r.push(o)}Radi.Earth.zoom(r)},showAQIPanel:function(){this.panel.find(".search-tab-div.active").hasClass("aqi-tab")||(this.panel.find(".search-menu-div li").removeClass("active"),this.panel.find(".search-menu-div li[pname='aqi']").addClass("active"),this.panel.find(".search-tab-div").removeClass("active"),this.panel.find(".aqi-tab").addClass("active"),this.getAQIRankingCount(this.timepoint,this.getAQIRankingCount_callback))},getAQIInfo:function(e,a,i){if(null!=e&&null!=a){this.panel.find(".aqi-tab .aqi-stat").html(e),this.panel.find(".aqi-tab .aqi-info .label").html(""),this.panel.find(".aqi-tab .aqi-number").html("");var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var n=new GeoBeans.PropertyName;n.setName(this.aqiRankingCityField);var l=new GeoBeans.Literal;l.setValue(e),t.expression1=n,t.expression2=l;var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var n=new GeoBeans.PropertyName;n.setName(this.aqiTimeField);var l=new GeoBeans.Literal;l.setValue(a),s.expression1=n,s.expression2=l;var r=new GeoBeans.BinaryLogicFilter;r.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,r.addFilter(t),r.addFilter(s),this.aqiRankingFeatureType.fields=this.aqiRankingFeatureType.getFields(null,this.sourceName);var o=this.aqiRankingFeatureType.buildGetFeatureFilterXML(null,this.sourceName,r,1,null,null),u=this.server,p=this;$.ajax({type:"post",url:u,data:o,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var t=p.aqiRankingFeatureType.parseFeatures(e);void 0!=i&&i(t)},complete:function(e,a){},error:function(e,a,i){console.log("textStatus:"+a),console.log("error:"+i)}})}},getAQIInfo_callback:function(e){if($.isArray(e)&&0!=e.length){var a=e[0],i=MapCloud.searchPanel;i.showAQIInfo(a)}},showAQIInfo:function(e){if(null!=e){var a=e.values,i=this.aqiRankingFeatureType.getFieldIndex(this.qualityField),t=a[i],n=this.aqiRankingFeatureType.getFieldIndex(this.levelField),l=a[n],s=this.aqiRankingFeatureType.getFieldIndex(this.pm25Field),r=a[s],o=this.aqiRankingFeatureType.getFieldIndex(this.aqiField),u=a[o],p=this.aqiRankingFeatureType.getFieldIndex(this.pm10Field),d=a[p];this.panel.find(".aqi-tab .aqi-quality-label").html(t),this.panel.find(".aqi-tab .aqi-level-label").html(l),this.panel.find(".aqi-tab .aqi-pm25-label").html(r),this.panel.find(".aqi-tab .aqi-pm10-label").html(d),this.panel.find(".aqi-tab .aqi-number").html(u),MapCloud.currentCityPanel.setAQI(u);var h=MapCloud.getAQILevelClass(u);null!=h&&(this.panel.find(".aqi-info .label,.aqi-number").removeClass("label-aqi-level-1 label-aqi-level-2").removeClass("label-aqi-level-3 label-aqi-level-4 label-aqi-level-5 label-aqi-level-6"),this.panel.find(".aqi-info .label").addClass(h),this.panel.find(".aqi-number").addClass(h))}},getAQILevelClass:function(e){var a=null;switch(e){case"一级":a="label-aqi-level-1";break;case"二级":a="label-aqi-level-2";break;case"三级":a="label-aqi-level-3";break;case"四级":a="label-aqi-level-4";break;case"五级":a="label-aqi-level-5";break;case"六级":a="label-aqi-level-6"}return a},getAQIRankingCount:function(e,a){if(null!=e){var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.aqiTimeField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n,this.aqiRankingFeatureType.getFeatureFilterCountAsync(null,this.sourceName,i,null,a)}},getAQIRankingCount_callback:function(e,a){if($.isNumeric(a)){var i=MapCloud.searchPanel,t=Math.ceil(a/i.aqiRankingCount);i.aqiRankingPageCount=t,i.aqiRankingCurrentPage=1;var n=i.aqiRankingCurrentPage+" / "+i.aqiRankingPageCount+"页";i.panel.find(".aqi-ranking-page .current-page").html(n),i.getAQIRanking(i.timepoint,1)}},getAQIRanking:function(e,a){if(null!=e&&null!=a){this.panel.find(".aqi-ranking-div").empty().addClass("loading");var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.aqiTimeField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n;var l=(a-1)*this.aqiRankingCount,s=["aqi","area","quality","x","y"],r=new GeoBeans.OrderBy;r.setOrder(GeoBeans.OrderBy.OrderType.OrderAsc),r.addField(this.aqiField),this.aqiRankingFeatureType.getFeaturesFilterAsync(null,this.sourceName,i,this.aqiRankingCount,l,s,r,this.getAQIRankingFeatures_callback)}},getAQIRankingFeatures_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showAQIRankingFeatures(e),a.panel.find(".aqi-ranking-div").removeClass("loading")}},showAQIRankingFeatures:function(e){for(var a=null,i=null,t=null,n=null,l=null,s="",r=(this.aqiRankingCurrentPage-1)*this.aqiRankingCount,o=this.aqiRankingFeatureType.getFieldIndex(this.areaField),u=this.aqiRankingFeatureType.getFieldIndex(this.aqiField),p=this.aqiRankingFeatureType.getFieldIndex(this.qualityField),d=this.aqiRankingFeatureType.getFieldIndex(this.statXField),h=this.aqiRankingFeatureType.getFieldIndex(this.statYField),c=0;c<e.length;++c)if(a=e[c],null!=a&&(l=a.values,null!=l)){i=l[o],t=l[u],n=l[p];var g=l[d];g=parseFloat(g);var v=l[h];v=parseFloat(v),s+="<div class='row' cx='"+g+"' cy='"+v+"'>	<div class='col-md-2'>"+(r+c+1)+"</div>	<div class='col-md-4'><a href='javascript:void(0)' class='aqi-city'>"+i+"</a></div>	<div class='col-md-2'>"+t+"</div>	<div class='col-md-4'>"+n+"</div></div>";MapCloud.getAQILevelColor(t),1e3*parseInt(t)}this.panel.find(".aqi-ranking-div").html(s);var m=this;this.panel.find(".aqi-city").click(function(){var e=$(this).html();if(null!=e&&""!=e){MapCloud.currentCity=e;var a=$(this).parents(".row").attr("cx"),i=$(this).parents(".row").attr("cy");m.getAQICityInfo(e),MapCloud.currentCityPanel.setCity(e,a,i)}})},getAQIStat:function(e,a){if(null!=e&&null!=a){var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.areaField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n;var l=new GeoBeans.BinaryComparisionFilter;l.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.aqiTimeField);var n=new GeoBeans.Literal;n.setValue(a),l.expression1=t,l.expression2=n;var s=new GeoBeans.BinaryLogicFilter;s.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,s.addFilter(i),s.addFilter(l);var r=[this.aqiField,this.pm25Field,this.pm10Field,this.qualityField,this.positionField,this.primaryPollutantField,this.statXField,this.statYField,this.stationCodeField];this.aqiStatFeatureType.fields=this.aqiStatFeatureType.getFields(null,this.sourceName),this.aqiStatFeatureType.getFeaturesFilterAsync(null,this.sourceName,s,30,null,r,null,this.getAQIStat_callback)}},getAQIStat_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showAQIStatFeatures(e)}},showAQIStatFeatures:function(e){if(null!=e){var a=null,i=null,t=null,n=null,l=null,s=null,r=null,o=null,u=null,p=null,d=-1,h=-1,c=null,g=null,v=-1;statXFieldIndex=-1,pm10FieldIndex=null,primaryPollutantFieldIndex=-1;var m=-1,F=null,f="",y=[],q=null;Radi.Earth.cleanup();for(var C=0;C<e.length;++C)if(a=e[C],null!=a&&(F=a.values,null!=F)){d=this.aqiStatFeatureType.getFieldIndex(this.positionField),i=F[d],h=this.aqiStatFeatureType.getFieldIndex(this.aqiField),s=F[h],c=this.aqiStatFeatureType.getFieldIndex(this.qualityField),t=F[c],primaryPollutantFieldIndex=this.aqiStatFeatureType.getFieldIndex(this.primaryPollutantField),u=F[primaryPollutantFieldIndex],g=this.aqiStatFeatureType.getFieldIndex(this.pm25Field),n=F[g],pm10FieldIndex=this.aqiStatFeatureType.getFieldIndex(this.pm10Field),l=F[pm10FieldIndex],m=this.aqiStatFeatureType.getFieldIndex(this.stationCodeField),p=F[m],statXFieldIndex=this.aqiStatFeatureType.getFieldIndex(this.statXField),r=F[statXFieldIndex],v=this.aqiStatFeatureType.getFieldIndex(this.statYField),o=F[v];var k=MapCloud.getAQILevelClass(s);f+="<div class='aqi-stat-info board'>	<div class='board-title' sx='"+r+"' sy='"+o+"'>		<span class='aqi-stat'><a href='javascript:void(0)'>"+i+"</a></span>		<span class='aqi-number "+k+"'>"+s+"</span>	</div>	<div class='board-content row'>		<div class='col-md-8'>			<div class='row'>				<div class='col-md-4'>PM2.5:</div>				<div class='col-md-6'>					<span class='label "+k+"'>"+n+"</span>				</div>			</div>			<div class='row'>				<div class='col-md-4'>PM10:</div>				<div class='col-md-6'>					<span class='label "+k+"'>"+l+"</span>				</div>			</div>			<div class='row'>				<div class='col-md-4'>空气质量:</div>				<div class='col-md-6'>					<span class='label  "+k+"'>"+t+"</span>				</div>			</div>		</div>		<div class='col-md-4'>			<div class='aqi-chart-btn' scode='"+p+"'></div>		</div>	</div></div>";var b=MapCloud.getAQILevelColor(s),I=60*parseInt(s);if(r=parseFloat(r),o=parseFloat(o),0!=r&&0!=o&&I>0){q=Radi.Earth.addCylinder(r,o,I,500,b);var P=i+" : "+s;Radi.Earth.addLabel(r,o,I/2+400,P),y.push(q)}}this.panel.find(".aqi-stat-div").html(f),this.panel.find(".aqi-stat a").click(function(){var e=$(this).parents(".board-title").attr("sx"),a=$(this).parents(".board-title").attr("sy");if(e=parseFloat(e),a=parseFloat(a),null!=e&&null!=a&&0!=e&&0!=a){var i=3e4;Radi.Earth.flyTo(e,a,i)}});var R=this;this.panel.find(".aqi-stat-div .aqi-chart-btn").click(function(){var e=$(this).attr("scode"),a=$(this).parents(".aqi-stat-info").find(".aqi-stat a").html(),i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(R.stationCodeField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n,MapCloud.aqiChartDialog.showDialog(R.timepoint,R.aqiStatFeatureType,a,i)})}},searchPlace:function(e){if(null!=e){var a=new GeoBeans.IsLikeFilter,i=new GeoBeans.PropertyName;i.setName(this.placeField),a.properyName=i;var t=new GeoBeans.Literal;t.setValue(e),a.literal=t,a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike,Radi.Earth.cleanup(),this.placeFeatureType.getFeaturesFilterAsync(null,this.sourceName,a,30,null,null,null,this.getPlace_callback)}},getPlace_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showPlaceResults(e),a.showPlaceIn3D(e)}},showPlaceResults:function(e){this.panel.find(".search-content-tab-div").hide(),this.panel.find(".result-div").show();for(var a=null,i=null,t=this.placeFeatureType.getFieldIndex(this.placeField),n="<ul>",l=0;l<e.length;++l)a=e[l],null!=a&&(i=a.values,null!=i&&(name=i[t],n+="<li>	<div class='row'>		<div class='col-md-2'>			<img src='../images/marker.png'>		</div>		<div class='col-md-10'>			<div class='row poi-name'>"+name+"			</div>		</div>	</div></li>"));n+="</ul>",this.panel.find(".result-content-div").html(n),this.panel.find(".search-content-tab-div").css("display","none"),this.panel.find(".result-div").css("display","block")},showPlaceIn3D:function(e){for(var a=null,i=null,t=this.placeFeatureType.geomFieldName,n=this.placeFeatureType.getFieldIndex(t),l=[],s=0;s<e.length;++s){if(a=e[s],null==a)return;if(i=a.values,null!=i){var r=Cesium.Color.fromRandom({alpha:1}),o=i[n],u=o.toPointsArray(),p=Radi.Earth.addPolygon(u,r,0,!0);l.push(p)}}Radi.Earth.zoom(l)},showRangeChart:function(){if(null==this.chart){var e="/ows/"+this.userName+"/mgr",a={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},i={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"人口_万人"},t=12,n=new MapCloud.RangeChart(e,a,i,t);n.show(),this.chart=n}else this.chart.cleanup(),this.chart=null},showAQIChart:function(){if(this.showAQIChartFlag)Radi.Earth.cleanup(),this.showAQIChartFlag=!1;else{Radi.Earth.cleanup();var e=this.timepoint,a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var i=new GeoBeans.PropertyName;i.setName(this.aqiTimeField);var t=new GeoBeans.Literal;t.setValue(e),a.expression1=i,a.expression2=t;var n=["aqi","area","x","y"];this.aqiRankingFeatureType.getFeaturesFilterAsync(null,this.sourceName,a,400,0,n,null,this.getAQIFeatures_callback)}},getAQIFeatures_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showAQIChartin3D(e)}},showAQIChartin3D:function(e){if(null!=e){for(var a=null,i=null,t=this.aqiRankingFeatureType.getFieldIndex(this.areaField),n=this.aqiRankingFeatureType.getFieldIndex(this.aqiField),l=this.aqiRankingFeatureType.getFieldIndex(this.statXField),s=this.aqiRankingFeatureType.getFieldIndex(this.statYField),r=null,o=null,u=null,p=null,d=null,h=[],c=0;c<e.length;++c)if(a=e[c],null!=a&&(i=a.values,null!=i)){r=i[t],o=i[n],u=i[l],u=parseFloat(u),p=i[s],p=parseFloat(p);var g=MapCloud.getAQILevelColor(o),v=1e3*parseInt(o);if(0!=u&&0!=p&&0!=v){d=Radi.Earth.addCylinder(u,p,v,12e3,g);var m=o;Radi.Earth.addLabel(u,p,v/2+3e3,m),h.push(d)}}Radi.Earth.zoom(h),this.showAQIChartFlag=!0}}});
MapCloud.CurrentCityPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(n){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent(),this.cleanup()},registerEvent:function(){this.panel.find(".current-city").click(function(){var n=MapCloud.cityPanel.panel.css("display");"block"==n?MapCloud.cityPanel.hide():MapCloud.cityPanel.show()});this.panel.find(".current-city-aqi").click(function(){MapCloud.searchPanel.showAQIPanel()})},cleanup:function(){this.panel.find(".current-city-name").html(MapCloud.currentCity),this.panel.find(".current-city-aqi span").html("")},setAQI:function(n){this.panel.find(".current-city-aqi span").html(n)},setCity:function(n,i,t){if(this.panel.find(".current-city-name").html(n),MapCloud.cityPanel.setCity(n),null!=i&&null!=t){var a=5e4;Radi.Earth.flyTo(i,t,a);var l={lon:i,lat:t,height:a};MapCloud.positionPanel.setPosition(l)}}});
MapCloud.CityPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},show:function(){this.panel.slideDown()},hide:function(){this.panel.slideUp()},registerEvent:function(){var i=this;this.panel.find("li").click(function(){var t=$(this).html(),n=MapCloud.cityPosition.getCityPosition(t);if(null!=n){var e=n.lon,l=n.lat;MapCloud.currentCity=t,MapCloud.searchPanel.getAQICityInfo(t),MapCloud.currentCityPanel.setCity(t,e,l),i.hide()}}),this.panel.mouseleave(function(){i.hide()})},setCity:function(i){null!=i&&this.panel.find(".city-list-current span").html(i)}});
MapCloud.AQIChartDialog=MapCloud.Class(MapCloud.Dialog,{userName:"user1",time:null,container:null,timeField:"time_point",aqiField:"aqi",stationCodeField:"station_code",aqiStatLayer:"gc_aqi",sourceName:"base",chart:null,features:null,featureType:null,initialize:function(e,t){MapCloud.Dialog.prototype.initialize.apply(this,arguments),this.container=this.panel.find("#"+t)[0],this.registerPanelEvent()},registerPanelEvent:function(){var e=this;e.panel.find(".btn-group .btn").click(function(){e.panel.find(".btn-group .btn").attr("disabled",!1),$(this).hasClass("aqi-24h")?e.showAQI24hFeatures():$(this).hasClass("aqi-7d")?e.showAQI7dFeatures():$(this).hasClass("aqi-30d")&&e.showAQI30dFeatures(),$(this).attr("disabled",!0)})},showDialog:function(e,t,a,i){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.featureType=t,this.time=e,this.panel.find(".modal-title").html("[ "+a+" ] 空气质量指数变化曲线图"),this.postionFilter=i,this.showAQI24hFeatures()},cleanup:function(){this.panel.find(".btn-group .btn").attr("disabled",!1),this.panel.find(".aqi-24h").attr("disabled",!0),null!=this.chart&&this.chart.clear(),this.panel.find(".modal-title").html("空气质量指数变化曲线图")},showAQI24hFeatures:function(){var e=new Date(this.time),t=MapCloud.dateAdd(e,"day",-1),a=MapCloud.dateFormat(t,"yyyy-MM-dd hh:mm:ss"),i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var r=new GeoBeans.BinaryComparisionFilter;r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(a),r.expression1=prop,r.expression2=literal;var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.time),s.expression1=prop,s.expression2=literal,i.addFilter(r),i.addFilter(s),this.getFeatures(i)},showAQI7dFeatures:function(){var e=null,t=null,a=new Date(this.time);a.setHours(0),a.setMinutes(0),a.setSeconds(0);var i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var r=null,s=0;7>s;++s){e=MapCloud.dateAdd(a,"day",-s),t=MapCloud.dateFormat(e,"yyyy-MM-dd hh:mm:ss"),r=new GeoBeans.BinaryComparisionFilter,r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var o=new GeoBeans.PropertyName;o.setName(this.timeField);var n=new GeoBeans.Literal;n.setValue(t),r.expression1=o,r.expression2=n,i.addFilter(r)}this.getFeatures(i)},showAQI30dFeatures:function(){var e=null,t=null,a=new Date(this.time);a.setHours(0),a.setMinutes(0),a.setSeconds(0);var i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var r=null,s=0;30>s;++s){e=MapCloud.dateAdd(a,"day",-s),t=MapCloud.dateFormat(e,"yyyy-MM-dd hh:mm:ss"),r=new GeoBeans.BinaryComparisionFilter,r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var o=new GeoBeans.PropertyName;o.setName(this.timeField);var n=new GeoBeans.Literal;n.setValue(t),r.expression1=o,r.expression2=n,i.addFilter(r)}this.getFeatures(i)},getFeatures:function(e){if(null!=e&&null!=this.postionFilter){var t=new GeoBeans.BinaryLogicFilter;t.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,t.addFilter(this.postionFilter),t.addFilter(e);var a=[this.aqiField,this.timeField],i=new GeoBeans.OrderBy;i.setOrder(GeoBeans.OrderBy.OrderType.OrderAsc),i.addField(this.timeField),this.featureType.getFeaturesFilterAsync(null,this.sourceName,t,100,null,a,i,this.getFeatures_callback)}},getFeatures_callback:function(e){if($.isArray(e)){var t=MapCloud.aqiChartDialog;t.setFeatures(e)}},setFeatures:function(e){if(this.features=e,null==this.chart){var t=this.getOption(),a=echarts.init(this.container,"macarons");this.chart=a,a.setOption(t)}else{this.chart.clear();var t=this.getOption();this.chart.setOption(t)}},getOption:function(){if(null!=this.features&&null!=this.featureType){for(var e=null,t=null,a=null,i=-1,r=-1,s=null,o=[],n=[],l=0;l<this.features.length;++l)e=this.features[l],null!=e&&(s=e.values,null!=s&&(i=this.featureType.getFieldIndex(this.aqiField),t=s[i],t=parseFloat(t),n.push(t),r=this.featureType.getFieldIndex(this.timeField),a=s[r],o.push(a)));var p={name:"AQI",type:"line",smooth:!0,data:n},u={title:{},toolbox:{show:!0,x:"640",y:"top",feature:{dataView:{show:!0,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{x:"40",y:"40",x2:"40",y2:"40"},tooltip:{trigger:"axis"},legend:{data:["AQI"]},calculable:!0,yAxis:[{type:"value"}],xAxis:[{type:"category",data:o}],series:[p]};return u}},dateAdd:function(e,t,a){var i=new Date(e);switch(t.toLowerCase()){case"year":i.setFullYear(i.getFullYear()+a);break;case"quarter":i.setMonth(i.getMonth()+3*a);break;case"month":i.setMonth(i.getMonth()+a);break;case"week":i.setDate(i.getDate()+7*a);break;case"day":i.setDate(i.getDate()+a);break;case"hour":i.setTime(i.getTime()+36e5*a);break;case"minute":i.setTime(i.getTime()+6e4*a);break;case"second":i.setTime(i.getTime()+1e3*a);break;default:i=void 0}return i}});
MapCloud.PositionControl=MapCloud.Class({tolerance:.01,heightTolerance:1e5,cityRegionLayer:"china_city_region",chinaLayer:"china_china",sourceName:"base",nameField:"aname",chinaNameField:"name_engli",featureType:null,chinaFeatureType:null,lat:null,lon:null,height:null,position:null,initialize:function(){this.lat=null,this.lon=null,this.height=null,Radi.Earth.addClickListener(this.getPositionHandler),Radi.Earth.addMoveListener(this.getMousePositionHandler),Radi.Earth.addScrollEventListener(this.getHeightHandler);var i=new GeoBeans.WFSWorkspace("tmp",MapCloud.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(i,this.cityRegionLayer),this.chinaFeatureType=new GeoBeans.FeatureType(i,this.chinaLayer)},getPositionHandler:function(i){if(null!=i){var t=MapCloud.positionControl;t.setPostion(i)}},setPostion:function(i){var t=Radi.Earth.getCameraPosition(),e=t.lat,n=t.lon;t.height;if(null==this.lat||null==this.lon)this.lat=e,this.lon=n;else{this.position=t;var o=new GeoBeans.Geometry.Point(n,e);this.getPositionInChina(o)}},getPositionWithinCity:function(i){if(null!=i){this.featureType.fields=this.featureType.getFields(null,this.sourceName);var t=[this.nameField];this.featureType.getFeaturesWithinAsync(null,this.sourceName,i,this.getPositionWithinCity_callback,t)}},getPositionWithinCity_callback:function(i){if($.isArray(i)&&0!=i.length){var t=MapCloud.positionControl,e=i[0];if(null!=e){var n=e.values,o=t.featureType.getFieldIndex(t.nameField),l=n[o];null!=l&&t.setCurrentCity(l)}}},setCurrentCity:function(i){console.log(i),MapCloud.currentCity=i,MapCloud.searchPanel.getAQICityInfo(i),MapCloud.currentCityPanel.setCity(i)},getMousePositionHandler:function(i){if(null!=i){var t=MapCloud.positionControl;t.setMousePosition(i)}},setMousePosition:function(i){null!=i&&MapCloud.positionPanel.setPosition(i)},getHeightHandler:function(i){if(null!=i){MapCloud.positionPanel.setHeight(i);var t=MapCloud.positionControl;t.setPostion(null)}},getPositionInChina:function(i){if(null!=i){this.chinaFeatureType.fields=this.chinaFeatureType.getFields(null,this.sourceName);var t=[this.chinaNameField];this.chinaFeatureType.getFeaturesWithinAsync(null,this.sourceName,i,this.getPositionInChina_callback,t)}},getPositionInChina_callback:function(i){if($.isArray(i)){var t=MapCloud.positionControl;t.setPositionInChina(i)}},setPositionInChina:function(i){if(null!=i){var t=i.length;if(0==t)MapCloud.currentCity=null,MapCloud.currentCityPanel.setCity("其它地区");else{var e=this.position.lat,n=this.position.lon,o=this.position.height;if(o>this.heightTolerance)MapCloud.currentCity=null,MapCloud.currentCityPanel.setCity("全国");else{var l=Math.sqrt((this.lat-e)*(this.lat-e)+(this.lon-n)*(this.lon-n));if(console.log("distance:"+l),l>this.tolerance){var a=new GeoBeans.Geometry.Point(n,e);this.getPositionWithinCity(a)}}}}}});
MapCloud.PositionPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments);var t=$(window).width(),n=this.panel.find(".postion-content").width(),l=(t-n)/2;this.panel.find(".postion-content").css("left",l+"px")},setPosition:function(i){if(null!=i){var t=i.lat,n=i.lon,l=i.height;null!=t&&(t=parseFloat(t),t=t.toFixed(3),this.panel.find(".position-lat").html(t)),null!=n&&(n=parseFloat(n),n=n.toFixed(3),this.panel.find(".position-lon").html(n)),this.setHeight(l)}},setHeight:function(i){null!=i&&this.panel.find(".position-height").html(i)}});
MapCloud.CityPosition=MapCloud.Class({cityList:null,initialize:function(){this.cityList=[{name:"北京",lon:116.380943,lat:39.923615},{name:"上海",lon:121.469269,lat:31.238176},{name:"南京",lon:118.772781,lat:32.047615},{name:"武汉",lon:114.291939,lat:30.567514},{name:"重庆",lon:106.510338,lat:29.558176},{name:"合肥",lon:117.275703,lat:31.863255},{name:"安庆",lon:117.034431,lat:30.512646},{name:"蚌埠",lon:117.361382,lat:32.939243},{name:"亳州",lon:115.7709,lat:33.879292},{name:"池州",lon:117.487494,lat:30.668548},{name:"滁州",lon:118.301163,lat:32.316532},{name:"阜阳",lon:115.809731,lat:32.902206},{name:"淮北",lon:116.787498,lat:33.97049},{name:"淮南",lon:117.02072,lat:32.616695},{name:"黄山",lon:118.309067,lat:29.720844},{name:"六安",lon:116.49279,lat:31.753523},{name:"马鞍山",lon:118.480713,lat:31.724924},{name:"宿州",lon:116.970154,lat:33.640133},{name:"铜陵",lon:117.813179,lat:30.925247},{name:"芜湖",lon:118.359833,lat:31.334496},{name:"宣城",lon:118.73,lat:30.965},{name:"福州",lon:119.297813,lat:26.07859},{name:"龙岩",lon:117.030388,lat:25.109703},{name:"南平",lon:118.169121,lat:26.644842},{name:"宁德",lon:119.518318,lat:26.666477},{name:"莆田",lon:119.010323,lat:25.438137},{name:"泉州",lon:118.589638,lat:24.915918},{name:"三明",lon:117.601227,lat:26.223013},{name:"厦门",lon:118.087517,lat:24.457436},{name:"漳州",lon:117.653091,lat:24.518164},{name:"广州",lon:113.261429,lat:23.118912},{name:"潮州",lon:116.63666,lat:23.667706},{name:"东莞",lon:113.748772,lat:23.048536},{name:"佛山",lon:113.114517,lat:23.034878},{name:"河源",lon:114.693817,lat:23.73484},{name:"惠州",lon:114.392403,lat:23.087957},{name:"江门",lon:113.084747,lat:22.59119},{name:"揭阳",lon:116.34977,lat:23.542976},{name:"茂名",lon:110.888847,lat:21.670717},{name:"梅州",lon:116.107941,lat:24.314501},{name:"清远",lon:113.021263,lat:23.719597},{name:"汕头",lon:116.6838,lat:23.362692},{name:"汕尾",lon:115.364014,lat:22.778687},{name:"韶关",lon:113.605392,lat:24.808777},{name:"深圳",lon:114.110672,lat:22.556396},{name:"阳江",lon:111.957893,lat:21.845234},{name:"云浮",lon:112.03999,lat:22.933193},{name:"湛江",lon:110.399223,lat:21.194998},{name:"肇庆",lon:112.451408,lat:23.057882},{name:"中山",lon:113.371452,lat:22.526854},{name:"珠海",lon:113.56826,lat:22.272589},{name:"南宁",lon:108.311768,lat:22.806543},{name:"百色",lon:106.612106,lat:23.901583},{name:"北海",lon:109.119171,lat:21.479797},{name:"崇左",lon:107.35506,lat:22.420197},{name:"防城港",lon:108.362153,lat:21.691939},{name:"贵港",lon:109.60844,lat:23.099092},{name:"桂林",lon:110.286682,lat:25.281883},{name:"河池",lon:108.051628,lat:24.696892},{name:"贺州",lon:111.549191,lat:24.40428},{name:"来宾",lon:109.23294,lat:23.73144},{name:"柳州",lon:109.402809,lat:24.310406},{name:"钦州",lon:108.6147,lat:21.949869},{name:"梧州",lon:111.305946,lat:23.48662},{name:"玉林",lon:110.141472,lat:22.631897},{name:"贵阳",lon:106.711372,lat:26.576874},{name:"安顺",lon:105.926071,lat:26.244259},{name:"毕节",lon:105.282417,lat:27.306295},{name:"六盘水",lon:104.873253,lat:26.576775},{name:"黔东南州",lon:107.989968,lat:26.599325},{name:"黔南州",lon:107.49,lat:26.65},{name:"黔西南州",lon:106.0367,lat:27.034166},{name:"铜仁地区",lon:109.19268,lat:27.722166},{name:"遵义",lon:106.929398,lat:27.695387},{name:"兰州",lon:103.750053,lat:36.068039},{name:"白银",lon:104.183777,lat:36.539417},{name:"定西",lon:104.618568,lat:35.575237},{name:"甘南州",lon:123.49532,lat:47.913578},{name:"嘉峪关",lon:98.274712,lat:39.802654},{name:"金昌",lon:102.165749,lat:38.495193},{name:"酒泉",lon:98.511116,lat:39.744968},{name:"临夏州",lon:103.214081,lat:35.606712},{name:"陇南",lon:104.929411,lat:33.405075},{name:"平凉",lon:106.683067,lat:35.535519},{name:"庆阳",lon:107.87602,lat:36.005165},{name:"天水",lon:105.71524,lat:34.584267},{name:"武威",lon:102.633461,lat:37.92691},{name:"张掖",lon:100.450287,lat:38.935059}]},getCityPosition:function(l){if(null==l)return null;for(var n=null,a=null,t=null,o=null,e=0;e<this.cityList.length;++e)if(n=this.cityList[e],a=n.name,a==l)return t=n.lon,o=n.lat,{lon:t,lat:o};return null}});
MapCloud.RangeChart=MapCloud.Class({server:null,baseSourceName:null,baseLayer:null,baseLayerPostionField:null,baseLayerFeatureType:null,chartSourceName:null,chartLayer:null,chartLayerPositionField:null,chartLayerChartField:null,chartLayerFeatureType:null,colorMapID:null,initialize:function(e,a,t,r){var l=null;null!=e&&(this.server=e,l=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0")),null!=a&&(this.baseSourceName=a.sourceName,this.baseLayer=a.layerName,this.baseLayerPostionField=a.positionField,null!=l&&null!=this.baseLayer&&(this.baseLayerFeatureType=new GeoBeans.FeatureType(l,this.baseLayer))),null!=t&&(this.chartSourceName=t.sourceName,this.chartLayer=t.layerName,this.chartLayerPositionField=t.positionField,this.chartLayerChartField=t.chartField,null!=l&&null!=this.chartLayer&&(this.chartLayerFeatureType=new GeoBeans.FeatureType(l,this.chartLayer))),this.colorMapID=r},show:function(){Radi.Earth.cleanup(),null!=this.baseLayerFeatureType&&null!=this.chartLayerFeatureType&&this.getFeatures()},getFeatures:function(){var e=(this.chartLayerFeatureType.getFields(null,this.chartSourceName),this.chartLayerFeatureType.getFeaturesFilter(null,this.chartSourceName,null,null,null,[this.chartLayerPositionField].concat(this.chartLayerChartField)));this.chartFeatures=e;var a=(this.baseLayerFeatureType.getFields(null,this.baseSourceName),[this.baseLayerFeatureType.geomFieldName,this.baseLayerPostionField]);this.baseLayerFeatureType.getFeaturesFilterAsync2(null,this.baseSourceName,null,null,null,a,null,this,this.getBaseLayerFeatures_callback)},getBaseLayerFeatures_callback:function(e,a){null!=e&&null!=a&&e.setBaseLayerFeatures(a)},setBaseLayerFeatures:function(e){if(null!=e){this.baseFeatures=e;var a=this.baseLayerFeatureType.getFieldIndex(this.baseLayerPostionField),t=this.chartLayerFeatureType.getFieldIndex(this.chartLayerPositionField),r=this.chartLayerFeatureType.getFieldIndex(this.chartLayerChartField);if(-1!=a&&-1!=t&&-1!=r){for(var l=null,s=null,i=null,n=null,u=0;u<e.length;++u)if(l=e[u],null!=l&&(s=l.values,null!=s))for(var h=s[a],c=0;c<this.chartFeatures.length;++c)if(i=this.chartFeatures[c],null!=i&&(n=i.values,null!=n)){var o=n[t];if(h==o){var d=n[r];l.chartValue=d}}this.drawBaseLayerFeatures()}}},drawBaseLayerFeatures:function(){if(null!=this.baseFeatures){for(var e=this.getColorRangeMap(),a=this.baseLayerFeatureType.geomFieldName,t=this.baseLayerFeatureType.getFieldIndex(a),r=null,l=null,s=null,i=[],n=0;n<this.baseFeatures.length;++n){if(r=this.baseFeatures[n],null==r)return;if(l=r.values,null==l)return;s=l[t],chartValue=r.chartValue;var u=chartValue,h=e.getValue(chartValue);h=Cesium.Color.fromCssColorString(h.getHex()),chartValue=20*parseFloat(chartValue),$.isNumeric(chartValue)||(chartValue=0);var c=s.toPointsArray(),o=Radi.Earth.addPolygon(c,h,chartValue,!1),d=s.getCentroid();Radi.Earth.addLabel(d.x,d.y,chartValue+4e4,u),i.push(o)}this.addLegend()}},getColorRangeMap:function(){null==this.colorMapID&&(this.colorMapID=1);var e=this.getMinMaxValue(),a=this.server.slice(0,this.server.lastIndexOf("/mgr")),t=new GeoBeans.StyleManager(a),r=t.getColorMapByID(this.colorMapID);this.colorMap=r;var l=new GeoBeans.ColorRangeMap(r.startColor,r.endColor,e.min,e.max);return l},getMinMaxValue:function(){if(null==this.baseFeatures)return null;for(var e=null,a=null,t=null,r=null,l=0;l<this.baseFeatures.length;++l)e=this.baseFeatures[l],null!=e&&(a=e.chartValue,a=parseFloat(a),t=null==t?a:t>a?a:t,r=null==r?a:a>r?a:r);return{min:t,max:r}},addLegend:function(){var e=this.getMinMaxValue(),a="<div class='chart-legend chart-legend-range' id='"+this.chartLayerChartField+"'>";a+="<div class='chart-legend-title'><h5>"+this.chartLayerChartField+"</h5></div>",a+="<div class='chart-legend-canvas'>	<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+e.max+"</div><div class='chart-legend-min'>"+e.min+"</div></div>",a+="</div>",$("#legend_container").html(a);var t=$("#legend_container .chart-legend-canvas canvas"),r=t[0].getContext("2d"),l=new Image;l.src=this.colorMap.url,l.onload=function(){var e=t.width()/2,a=t.height()/2,s=l.width,i=l.height;r.clearRect(0,0,s,i),r.translate(e,a),r.rotate(270*Math.PI/180),r.drawImage(l,-s/2,-i/2,s,i),r.rotate(-270*Math.PI/180),r.translate(-e,-a)}},cleanup:function(){Radi.Earth.cleanup(),$("#legend_container").empty()}});
MapCloud.TopicPanel=MapCloud.Class(MapCloud.Panel,{popRangeChart:null,encoRangeChart:null,perRangeChart:null,agroMapName:"agro",agroLayerName:"agro",agroFields:["ppt","x","y"],agroFeatureType:null,agroChartFlag:!1,initialize:function(a){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent();var e=new GeoBeans.WFSWorkspace("tmp",MapCloud.server,"1.0.0");this.agroFeatureType=new GeoBeans.FeatureType(e,this.agroLayerName)},registerEvent:function(){var a=this;this.panel.find("[data-toggle='tooltip']").tooltip({container:"body"}),this.panel.find(".mc-icon").click(function(){$(this).hasClass("mc-stretch")?a.onStretch(this):$(this).hasClass("mc-icon-enco")?a.showEncoRangeChart():$(this).hasClass("mc-icon-aqi")?MapCloud.searchPanel.showAQIChart():$(this).hasClass("mc-icon-pop")?a.showPopRangeChart():$(this).hasClass("mc-icon-per")?a.showPerRangeChart():$(this).hasClass("mc-icon-agro")&&(a.agroChartFlag?(Radi.Earth.cleanup(),a.agroChartFlag=!1):a.getAgroData())})},onStretch:function(a){$(a).hasClass("mc-icon-left")?(this.panel.children().not(".mc-stretch").css("display","block"),$(a).removeClass("mc-icon-left"),$(a).addClass("mc-icon-right"),this.panel.animate({width:"242px"},300)):(this.panel.children().not(".mc-stretch").css("display","none"),$(a).removeClass("mc-icon-right"),$(a).addClass("mc-icon-left"),this.panel.animate({width:"40px"},300))},showPopRangeChart:function(){if(null==this.popRangeChart){var a=MapCloud.server,e={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},t={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"人口_万人"},n=12,l=new MapCloud.RangeChart(a,e,t,n);l.show(),this.popRangeChart=l,this.setCameraPosition()}else this.popRangeChart.cleanup(),this.popRangeChart=null},showEncoRangeChart:function(){if(null==this.encoRangeChart){this.cleanupChart();var a=MapCloud.server,e={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},t={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"gdp_亿元"},n=12,l=new MapCloud.RangeChart(a,e,t,n);l.show(),this.encoRangeChart=l,this.setCameraPosition()}else this.encoRangeChart.cleanup(),this.encoRangeChart=null},showPerRangeChart:function(){if(null==this.perRangeChart){this.cleanupChart();var a=MapCloud.server,e={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},t={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"人均gdp_元"},n=12,l=new MapCloud.RangeChart(a,e,t,n);l.show(),this.perRangeChart=l,this.setCameraPosition()}else this.perRangeChart.cleanup(),this.perRangeChart=null},cleanupChart:function(){null!=this.popRangeChart&&(this.popRangeChart.cleanup(),this.popRangeChart=null),null!=this.encoRangeChart&&(this.encoRangeChart.cleanup(),this.encoRangeChart=null),null!=this.perRangeChart&&(this.perRangeChart.cleanup(),this.perRangeChart=null)},setCameraPosition:function(){var a=97.92627,e=15.730198,t=5543911,n=8.9819126,l=-70.75989,i=359.990288;Radi.Earth.flyTo(a,e,t,n,l,i)},getAgroData:function(){this.agroFeatureType.fields=this.agroFeatureType.getFields(this.agroMapName,null),this.agroFeatureType.getFeaturesFilterAsync(this.agroMapName,null,null,333,0,this.agroFields,null,this.getAgroData_callback)},getAgroData_callback:function(a){if($.isArray(a)){var e=MapCloud.topicPanel;e.showArgoData(a)}},showArgoData:function(a){if(null!=a){Radi.Earth.cleanup();for(var e="../images/agro_32_1.png",t=this.agroFeatureType.getFieldIndex("ppt"),n=this.agroFeatureType.getFieldIndex("x"),l=this.agroFeatureType.getFieldIndex("y"),i=null,r=null,o=null,s=null,h=null,p=null,c=[],u=0;u<a.length;++u)i=a[u],null!=i&&(r=i.values,null!=r&&(o=r[t],s=r[n],h=r[l],null!=s&&null!=h&&(p=Radi.Earth.addBillboard(s,h,"",e),c.push(p))));var g=107.18924,C=25.566601,d=11677693,m=358.15,R=-89.76141,F=0;Radi.Earth.flyTo(g,C,d,m,R,F),this.agroChartFlag=!0}}});