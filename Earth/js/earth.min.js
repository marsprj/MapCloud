!function(){window.Radi={}}(),Radi.Earth={handler:null,initEarth:function(e){var i=256*Math.PI/180,t=new Cesium.Rectangle(-i,-i,i,i);g_earth_view=new Cesium.Viewer("earth_container",{animation:!1,baseLayerPicker:!1,geocoder:!1,timeline:!1,sceneModePicker:!1,fullscreenButton:!1,homeButton:!1,infoBox:!1,selectionIndicator:!1,navigationHelpButton:!1,navigationInstructionsInitiallyVisible:!1,scene3DOnly:!0,imageryProvider:new Cesium.WebMapTileServiceImageryProvider({url:"/QuadServer/services/maps/wmts100",layer:"world_image",style:"default",format:"image/jpeg",tileMatrixSetID:"PGIS_TILE_STORE",minimumLevel:0,maximumLevel:19,credit:new Cesium.Credit("world_country"),tilingScheme:new Cesium.GeographicTilingScheme({rectangle:t})})});var a=new Cesium.CesiumTerrainProvider({url:"/aster",requestVertexNormals:!0});g_earth_view.terrainProvider=a,g_earth_view.scene.globe.enableLighting=!1,this.addWorldTrans(),this.handler=new Cesium.ScreenSpaceEventHandler(g_earth_view.scene.canvas)},flyTo:function(e,i,t,a,n,r){g_earth_view.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(e,i,t),orientation:{heading:null==a?Cesium.Math.toRadians(360):Cesium.Math.toRadians(a),pitch:null==n?Cesium.Math.toRadians(-90):Cesium.Math.toRadians(n),roll:null==r?0:Cesium.Math.toRadians(r)}})},camera:function(){return g_earth_view.camera},getCameraPosition:function(){var e=this.camera(),i=e.positionCartographic,t=Cesium.Math.toDegrees(i.latitude),a=Cesium.Math.toDegrees(i.longitude);return{lat:t,lon:a,height:i.height}},addPin:function(e,i){var t=new Cesium.PinBuilder,a=g_earth_view.entities.add({name:"Blank blue pin",position:Cesium.Cartesian3.fromDegrees(118,39.9208667),billboard:{image:t.fromColor(Cesium.Color.ROYALBLUE,48).toDataURL(),verticalOrigin:Cesium.VerticalOrigin.BOTTOM}}),n=Cesium.buildModuleUrl("Assets/Textures/maki/grocery.png"),r=Cesium.when(t.fromUrl(n,Cesium.Color.GREEN,48),function(t){return g_earth_view.entities.add({name:"Grocery store",position:Cesium.Cartesian3.fromDegrees(e,i),billboard:{image:t.toDataURL(),verticalOrigin:Cesium.VerticalOrigin.BOTTOM}})});Cesium.when.all([a,r],function(e){g_earth_view.zoomTo(e)})},addPoint:function(e,i,t){g_earth_view.entities.add({position:Cesium.Cartesian3.fromDegrees(e,i),point:{pixelSize:t,color:Cesium.Color.YELLOW}})},addLine:function(e,i){g_earth_view.entities.add({name:"Glowing blue line on the surface",polyline:{positions:Cesium.Cartesian3.fromDegreesArray(e),width:i,material:new Cesium.PolylineGlowMaterialProperty({glowPower:.2,color:Cesium.Color.YELLOW})}})},addPolygon:function(e,i,t,a){var n=g_earth_view.entities.add({name:"polygon",polygon:{hierarchy:Cesium.Cartesian3.fromDegreesArray(e),material:i,extrudedHeight:t,outline:null==a?!0:a}});return n},addBillboard:function(e,i,t,a){var n={position:Cesium.Cartesian3.fromDegrees(e,i),billboard:{image:a},label:{text:t,font:"16px Microsoft YaHei",outlineColor:Cesium.Color.BLACK,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.MIDDLE,pixelOffset:new Cesium.Cartesian2(10,0)}};return g_earth_view.entities.add(n)},zoom:function(e){Cesium.when.all(e,function(i){g_earth_view.zoomTo(e)})},cleanup:function(){g_earth_view.entities.removeAll(),$("#legend_container").empty()},addCylinder:function(e,i,t,a,n){var r=g_earth_view.entities.add({name:"Cylinder",position:Cesium.Cartesian3.fromDegrees(e,i,0),cylinder:{length:t,topRadius:a,bottomRadius:a,material:n}});return r},addLabel:function(e,i,t,a){var n=g_earth_view.entities.add({position:Cesium.Cartesian3.fromDegrees(e,i,t),label:{text:a,font:"16px Microsoft YaHei",outlineColor:Cesium.Color.BLACK,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineWidth:2,pixelOffsetScaleByDistance:new Cesium.NearFarScalar(150,3,15e6,.5)}});return n},cartesianToDegrees:function(e){if(!(e instanceof Cesium.Cartesian3))return null;var i=ellipsoid.cartesianToCartographic(position),t=Cesium.Math.toDegrees(i.latitude),a=Cesium.Math.toDegrees(i.longitude);return{lat:t,lon:a,height:i.height}},mercator2lonlat:function(e,i){var t={x:0,y:0},e=e/20037508.34*180,i=i/20037508.34*180;return i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),t.x=e,t.y=i,t},addEventListener:function(e,i){var t=g_earth_view.scene.globe.ellipsoid;this.handler.setInputAction(function(e){if(null!=e.position)if(cartesian=g_earth_view.camera.pickEllipsoid(e.position,t),cartesian){var a=t.cartesianToCartographic(cartesian);longitudeString=Cesium.Math.toDegrees(a.longitude),latitudeString=Cesium.Math.toDegrees(a.latitude),height=Math.ceil(g_earth_view.camera.positionCartographic.height),i({lat:latitudeString,lon:longitudeString,height:height})}else i(null)},e)},addClickListener:function(e){var i=g_earth_view.scene.globe.ellipsoid;this.handler.setInputAction(function(t){if(null!=t.position)if(cartesian=g_earth_view.camera.pickEllipsoid(t.position,i),cartesian){var a=i.cartesianToCartographic(cartesian);longitudeString=Cesium.Math.toDegrees(a.longitude),latitudeString=Cesium.Math.toDegrees(a.latitude),height=Math.ceil(g_earth_view.camera.positionCartographic.height),e({lat:latitudeString,lon:longitudeString,height:height})}else e(null)},Cesium.ScreenSpaceEventType.LEFT_DOWN)},addMoveListener:function(e){var i=g_earth_view.scene.globe.ellipsoid;this.handler.setInputAction(function(t){if(null!=t.endPosition)if(cartesian=g_earth_view.camera.pickEllipsoid(t.endPosition,i),cartesian){var a=i.cartesianToCartographic(cartesian);longitudeString=Cesium.Math.toDegrees(a.longitude),latitudeString=Cesium.Math.toDegrees(a.latitude),height=Math.ceil(g_earth_view.camera.positionCartographic.height),e({lat:latitudeString,lon:longitudeString,height:height})}else e(null)},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},addScrollEventListener:function(e){this.handler.setInputAction(function(i){var t=Math.ceil(g_earth_view.camera.positionCartographic.height);e(t)},Cesium.ScreenSpaceEventType.WHEEL)},addWorldTrans:function(){var e=256*Math.PI/180,i=new Cesium.Rectangle(-e,-e,e,e),t=g_earth_view.scene.imageryLayers;t.addImageryProvider(new Cesium.WebMapTileServiceImageryProvider({url:"/QuadServer/services/maps/wmts100",layer:"world_trans",style:"default",format:"image/jpeg",tileMatrixSetID:"PGIS_TILE_STORE",minimumLevel:0,maximumLevel:19,credit:new Cesium.Credit("world_country"),tilingScheme:new Cesium.GeographicTilingScheme({rectangle:i})}))},addModel:function(e,i,t,a,n){if(null!=e&&null!=i&&null!=t&&null!=a){var r=Cesium.Cartesian3.fromDegrees(i,t,a),o=Cesium.Math.toRadians(0),l=0,s=0,u=Cesium.Transforms.headingPitchRollQuaternion(r,o,l,s);null==n&&(n=1);g_earth_view.entities.add({name:e,position:r,orientation:u,model:{uri:e,scale:n}})}},getExtentView:function(){var e=g_earth_view.scene,i=g_earth_view.scene.globe.ellipsoid,t=new Cesium.Cartesian2(0,0),a=this.camera().pickEllipsoid(t,i);t=new Cesium.Cartesian2(e.canvas.width,e.canvas.height);var n=this.camera().pickEllipsoid(t,i);if(null!=a&&null!=n){a=i.cartesianToCartographic(a),n=i.cartesianToCartographic(n);var r=Number(Cesium.Math.toDegrees(a.longitude).toFixed(3)),o=Number(Cesium.Math.toDegrees(n.latitude).toFixed(3)),l=Number(Cesium.Math.toDegrees(n.longitude).toFixed(3)),s=Number(Cesium.Math.toDegrees(a.latitude).toFixed(3));return new GeoBeans.Envelope(r,o,l,s)}return null}};
$().ready(function(){MapCloud.server="/ows/user1/mgr",MapCloud.currentCity="北京",MapCloud.aqiTimeLineChart=null,Radi.Earth.initEarth("earth_container"),MapCloud.searchPanel=new MapCloud.SearchPanel("search_container"),MapCloud.currentCityPanel=new MapCloud.CurrentCityPanel("city_container"),MapCloud.cityPanel=new MapCloud.CityPanel("city_list_container"),MapCloud.aqiChartDialog=new MapCloud.AQIChartDialog("aqi_chart_dialog","aqi_chart_container"),MapCloud.positionControl=new MapCloud.PositionControl,MapCloud.positionPanel=new MapCloud.PositionPanel("position_container"),MapCloud.cityPosition=new MapCloud.CityPosition,MapCloud.topicPanel=new MapCloud.TopicPanel("topic_container"),MapCloud.aqiTimeList=new MapCloud.AQITimeList(MapCloud.server),MapCloud.aqiTimelinePanel=new MapCloud.AQITimeLinePanel("aqi_timeline_container"),MapCloud.aqi24TimelinePanel=new MapCloud.AQI24TimeLinePanel("aqi_24_timeline_container"),MapCloud.chartPanel=new MapCloud.ChartPanel("chart_container"),MapCloud.addressService=new MapCloud.AddressService,MapCloud.currentCity="北京";var e=Radi.Earth.camera();e.setView({destination:Cesium.Cartesian3.fromDegrees(106,31.69,26221083)}),MapCloud.dateAdd=function(e,a,o){var l=new Date(e);switch(a.toLowerCase()){case"year":l.setFullYear(l.getFullYear()+o);break;case"quarter":l.setMonth(l.getMonth()+3*o);break;case"month":l.setMonth(l.getMonth()+o);break;case"week":l.setDate(l.getDate()+7*o);break;case"day":l.setDate(l.getDate()+o);break;case"hour":l.setTime(l.getTime()+36e5*o);break;case"minute":l.setTime(l.getTime()+6e4*o);break;case"second":l.setTime(l.getTime()+1e3*o);break;default:l=void 0}return l},MapCloud.dateFormat=function(e,a){var o={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var l in o)new RegExp("("+l+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?o[l]:("00"+o[l]).substr((""+o[l]).length)));return a},MapCloud.getAQILevelClass=function(e){return $.isNumeric(e)?50>=e?"label-aqi-level-1":e>50&&100>=e?"label-aqi-level-2":e>100&&150>=e?"label-aqi-level-3":e>150&&200>=e?"label-aqi-level-4":e>200&&300>=e?"label-aqi-level-5":e>300?"label-aqi-level-6":void 0:"label-aqi-level-1"},MapCloud.getAQILevelColor=function(e){return $.isNumeric(e)?50>=e?Cesium.Color.GREEN:e>50&&100>=e?Cesium.Color.YELLOW:e>100&&150>=e?Cesium.Color.ORANGE:e>150&&200>=e?Cesium.Color.RED:e>200&&300>=e?Cesium.Color.PURPLE:e>300?Cesium.Color.BROWN:void 0:Cesium.Color.GREEN},MapCloud.getAQILevelColorAlpha=function(e,a){return $.isNumeric(e)?50>=e?Cesium.Color.fromAlpha(Cesium.Color.GREEN,a):e>50&&100>=e?Cesium.Color.fromAlpha(Cesium.Color.YELLOW,a):e>100&&150>=e?Cesium.Color.fromAlpha(Cesium.Color.ORANGE,a):e>150&&200>=e?Cesium.Color.fromAlpha(Cesium.Color.RED,a):e>200&&300>=e?Cesium.Color.fromAlpha(Cesium.Color.PURPLE,a):e>300?Cesium.Color.fromAlpha(Cesium.Color.BROWN,a):void 0:Cesium.Color.fromAlpha(Cesium.Color.GREEN,a)}});
MapCloud.SearchPanel=MapCloud.Class(MapCloud.Panel,{userName:"user1",poiManager:null,sourceName:"base",aqiRankingLayer:"gc_aqi_ranking",aqiRankingCityField:"area",aqiStatLayer:"gc_aqi",aqiUptimeLayer:"gc_aqi_ranking_uptime",placeLayer:"china_county_region",aqiRankingFeatureType:null,aqiStatFeatureType:null,aqiUptimeFeatureType:null,server:null,pm25Field:"pm2_5",pm10Field:"pm10",aqiField:"aqi",primaryPollutantField:"primary_pollutant",qualityField:"quality",levelField:"level",aqiTimeField:"time_point",areaField:"area",positionField:"position_name",statXField:"x",statYField:"y",stationCodeField:"station_code",uptimeFiled:"uptime",placeField:"name",aqiRankingCount:12,aqiRankingPageCount:null,aqiRankingCurrentPage:null,timepoint:null,showAQIChartFlag:!1,poiCurrentPage:null,poiPageCount:20,poiExent:null,addressCurrentPage:null,initialize:function(e){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent(),this.server="/ows/"+this.userName+"/mgr",this.poiManager=new GeoBeans.PoiManager("user1");var a=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.aqiRankingFeatureType=new GeoBeans.FeatureType(a,this.aqiRankingLayer),this.aqiStatFeatureType=new GeoBeans.FeatureType(a,this.aqiStatLayer),this.aqiUptimeFeatureType=new GeoBeans.FeatureType(a,this.aqiUptimeLayer),this.placeFeatureType=new GeoBeans.FeatureType(a,this.placeLayer),this.getCurrentTime()},getCurrentTime:function(){this.aqiUptimeFeatureType.getMinMaxValueAsync(this.uptimeFiled,null,this.sourceName,this.getCurrentTime_callback)},getCurrentTime_callback:function(e){if(null!=e){var a=MapCloud.searchPanel;a.setCurrentTime(e.max)}},setCurrentTime:function(e){if(null!=e){this.timepoint=e;var a=e.slice(e.lastIndexOf(" ")+1,e.length);this.panel.find(".current-time span").html(a),this.getAQICityInfo(MapCloud.currentCity)}},getAQICityInfo:function(e){if(null!=e){"block"==this.panel.find(".aqi-stat-tab").css("display")&&(this.panel.find(".search-tab-div").removeClass("active"),this.panel.find(".aqi-tab").addClass("active"),Radi.Earth.cleanup());var a=this.panel.find(".aqi-info .aqi-stat").html();a!=e&&this.getAQIInfo(e,this.timepoint,this.getAQIInfo_callback)}},registerEvent:function(){var e=this;this.panel.find("[data-toggle='tooltip']").tooltip({container:"body"}),e.panel.find(".logo").click(function(){var a=e.panel.find("#search_content_div");"block"==a.css("display")?a.slideUp():a.slideDown()}),e.panel.find(".search-item-menu li a").click(function(){var a=$(this).text(),i=a+"<span class='caret'></span>";e.panel.find(".search-item").html(i),e.panel.find(".search-keyword").val(""),"地名"==a?(e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".place-tab").addClass("active"),e.panel.find(".search-menu-div li").removeClass("active"),e.panel.find(".search-menu-div li[pname='place']").addClass("active"),e.panel.find(".place-tab").empty()):"POI"==a&&(e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".poi-tab").addClass("active"),e.panel.find(".search-menu-div li").removeClass("active"),e.panel.find(".search-menu-div li[pname='poi']").addClass("active"))}),e.panel.find(".search-btn").click(function(){var a=e.panel.find(".search-keyword").val();if(""!=a){var i=e.panel.find(".search-item").text();switch(i){case"POI":e.searchPoi(a);break;case"AQI":break;case"地名":e.searchPlace(a)}}}),this.panel.find(".search-menu-div li").click(function(){Radi.Earth.cleanup();var a=$(this).attr("pname");if("aqi"==a)return void e.showAQIPanel();e.panel.find(".search-menu-div li").removeClass("active"),$(this).addClass("active");var i="."+a+"-tab";if(e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(i).addClass("active"),"poi"==a){var t="POI<span class='caret'></span>";e.panel.find(".search-item").html(t),e.panel.find(".search-keyword").val("")}else if("place"==a){var t="地名<span class='caret'></span>";e.panel.find(".search-item").html(t),e.panel.find(".place-tab").empty(),e.panel.find(".search-keyword").val("")}}),this.panel.find(".return-search-list-btn").click(function(){Radi.Earth.cleanup(),e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".poi-tab").addClass("active")}),this.panel.find(".poi-item,.poi-list-row span").click(function(){var a=$(this).attr("piname"),i=[];switch(a){case"hotel":i.push("hotel"),i.push("酒店");break;case"restaurant":i.push("饭店"),i.push("饭馆");break;case"shop":i.push("商场"),i.push("商店");break;case"cinema":i.push("电影院");break;case"site":i.push("公园");break;case"bank":i.push("银行"),i.push("ATM");break;case"supermarker":i.push("超市");break;case"subway":i.push("地铁");break;case"bus":i.push("公交站");break;case"gas":i.push("加油站");break;case"park":i.push("停车场");break;case"ktv":i.push("ktv");break;case"bar":i.push("酒吧");break;case"hospital":i.push("医院");break;case"school":i.push("学校"),i.push("小学"),i.push("中学"),i.push("大学");break;case"harmacy":i.push("药店");break;case"atm":i.push("atm");break;case"chafing_dish":i.push("火锅");break;case"barbecue":i.push("烧烤"),i.push("烤串");break;case"snack":i.push("快餐"),i.push("麦当劳"),i.push("肯德基");break;case"sichuan":i.push("川菜")}0!=i.length&&e.searchPoi(i)}),this.panel.find(".aqi-ranking-page li").click(function(){var a=e.aqiRankingCurrentPage;$(this).hasClass("first-page")?(e.aqiRankingCurrentPage=1,e.getAQIRanking(e.timepoint,1)):$(this).hasClass("pre-page")?a>1&&a<=e.aqiRankingPageCount&&(e.aqiRankingCurrentPage=e.aqiRankingCurrentPage-1,e.getAQIRanking(e.timepoint,e.aqiRankingCurrentPage)):$(this).hasClass("next-page")?a>0&&a<e.aqiRankingPageCount&&(e.aqiRankingCurrentPage=e.aqiRankingCurrentPage+1,e.getAQIRanking(e.timepoint,e.aqiRankingCurrentPage)):$(this).hasClass("last-page")&&(e.aqiRankingCurrentPage=e.aqiRankingPageCount,e.getAQIRanking(e.timepoint,e.aqiRankingPageCount));var i=e.aqiRankingCurrentPage+" / "+e.aqiRankingPageCount+"页";e.panel.find(".aqi-ranking-page .current-page").html(i)}),this.panel.find(".aqi-chart-btn").click(function(){var a=$(this).parents(".board").find(".aqi-stat").html(),i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(e.areaField);var n=new GeoBeans.Literal;n.setValue(a),i.expression1=t,i.expression2=n,MapCloud.aqiChartDialog.showDialog(e.timepoint,e.aqiRankingFeatureType,a,i)}),this.panel.find(".show-stat").click(function(){null!=MapCloud.currentCity&&(e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".aqi-stat-tab").addClass("active"),e.getAQIStat(MapCloud.currentCity,e.timepoint))}),this.panel.find(".return-aqi").click(function(){e.panel.find(".search-tab-div").removeClass("active"),e.panel.find(".aqi-tab").addClass("active"),Radi.Earth.cleanup()}),this.panel.find(".result-content-div .pre-page").click(function(){var a=e.panel.find(".search-item").text();if("地名"==a){if(e.addressCurrentPage<=1)return;var i=e.panel.find(".search-keyword").val();e.getAddress(i,e.addressCurrentPage-1)}else if("POI"==a){var t=e.poiCurrentPage;if(0>=t)return;e.poiCurrentPage=t-1,e.searchPoiByPage(e.keyword,e.poiCurrentPage,e.poiExent)}}),this.panel.find(".result-content-div .next-page").click(function(){var a=e.panel.find(".result-main-div li").length;if(!(a<e.poiPageCount)){var i=e.panel.find(".search-item").text();if("地名"==i){var t=e.panel.find(".search-keyword").val();e.getAddress(t,e.addressCurrentPage+1)}else if("POI"==i){var n=e.poiCurrentPage;e.poiCurrentPage=n+1,e.searchPoiByPage(e.keyword,e.poiCurrentPage,e.poiExent)}}}),this.panel.find(".poi-result-tab .pre-page").click(function(){var a=e.poiCurrentPage;0>=a||(e.poiCurrentPage=a-1,e.searchPoiByPage(e.keyword,e.poiCurrentPage,e.poiExent))}),this.panel.find(".poi-result-tab .next-page").click(function(){var a=e.panel.find(".result-main-div li").length;if(!(a<e.poiPageCount)){var i=e.poiCurrentPage;e.poiCurrentPage=i+1,e.searchPoiByPage(e.keyword,e.poiCurrentPage,e.poiExent)}}),this.panel.find(".search-item").change(function(){console.log($(this).text())})},searchPoi:function(e){if(null!=e){this.keyword=e;var a=Radi.Earth.getExtentView();if(null==a)return void alert("请设定有效的范围");this.poiCurrentPage=0,this.poiExent=a,this.searchPoiByPage(this.keyword,this.poiCurrentPage,a)}},searchPoiByPage:function(e,a,i){if(!(0>a||null==e||null==i)){this.panel.find(".search-tab-div").removeClass("active"),this.panel.find(".poi-result-tab").addClass("active"),this.panel.find(".poi-result-tab").addClass("loading"),Radi.Earth.cleanup(),this.panel.find(".result-main-div").empty();var t=a*this.poiPageCount;this.poiManager.getPoi(e,this.poiPageCount,t,i,this.searchPoi_callback)}},searchPoi_callback:function(e){var a=MapCloud.searchPanel;a.panel.find(".poi-result-tab").removeClass("loading"),console.log(e.length),$.isArray(e)&&(a.showPoisResult(e),a.showPoisIn3D(e))},showPoisResult:function(e){if($.isArray(e)){for(var a="<ul>",i=null,t=null,n=null,l=null,s=null,r=0;r<e.length;++r)if(i=e[r],null!=i){if(t=i.name,n=i.x,l=i.y,n=parseFloat(n),l=parseFloat(l),n>180){var o=Radi.Earth.mercator2lonlat(n,l);n=o.x,l=o.y}s=i.address,a+="<li px='"+n+"' py='"+l+"'>	<div class='row'>		<div class='col-md-2'>			<img src='../images/marker.png'>		</div>		<div class='col-md-10'>			<div class='row poi-name'>"+t+"			</div>			<div class='row poi-address'>				地址:"+s+"			</div>		</div>	</div></li>"}a+="</ul>",this.panel.find(".result-main-div").html(a),this.panel.find(".result-main-div ul li").click(function(){var e=$(this).attr("px"),a=$(this).attr("py");if(null!=e&&null!=a){var i=1e4;Radi.Earth.flyTo(e,a,i)}})}},showPoisIn3D:function(e){for(var a="../images/marker.png",i=null,t=null,n=null,l=null,s=null,r=[],o=null,d=0;d<e.length;++d)if(i=e[d],null!=i){if(t=i.name,n=i.x,l=i.y,n=parseFloat(n),l=parseFloat(l),n>180){var p=Radi.Earth.mercator2lonlat(n,l);n=p.x,l=p.y}s=i.address,type=i.type,o=Radi.Earth.addBillboard(n,l,t,a),r.push(o)}},showAQIPanel:function(){this.panel.find(".search-tab-div.active").hasClass("aqi-tab")||(this.panel.find(".search-menu-div li").removeClass("active"),this.panel.find(".search-menu-div li[pname='aqi']").addClass("active"),this.panel.find(".search-tab-div").removeClass("active"),this.panel.find(".aqi-tab").addClass("active"),this.getAQIRankingCount(this.timepoint,this.getAQIRankingCount_callback))},getAQIInfo:function(e,a,i){if(null!=e&&null!=a){this.panel.find(".aqi-tab .aqi-stat").html(e),this.panel.find(".aqi-tab .aqi-info .label").html(""),this.panel.find(".aqi-tab .aqi-number").html("");var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var n=new GeoBeans.PropertyName;n.setName(this.aqiRankingCityField);var l=new GeoBeans.Literal;l.setValue(e),t.expression1=n,t.expression2=l;var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var n=new GeoBeans.PropertyName;n.setName(this.aqiTimeField);var l=new GeoBeans.Literal;l.setValue(a),s.expression1=n,s.expression2=l;var r=new GeoBeans.BinaryLogicFilter;r.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,r.addFilter(t),r.addFilter(s),this.aqiRankingFeatureType.fields=this.aqiRankingFeatureType.getFields(null,this.sourceName);var o=this.aqiRankingFeatureType.buildGetFeatureFilterXML(null,this.sourceName,r,1,null,null),d=this.server,p=this;$.ajax({type:"post",url:d,data:o,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var t=p.aqiRankingFeatureType.parseFeatures(e);void 0!=i&&i(t)},complete:function(e,a){},error:function(e,a,i){console.log("textStatus:"+a),console.log("error:"+i)}})}},getAQIInfo_callback:function(e){if($.isArray(e)&&0!=e.length){var a=e[0],i=MapCloud.searchPanel;i.showAQIInfo(a)}},showAQIInfo:function(e){if(null!=e){var a=e.values,i=this.aqiRankingFeatureType.getFieldIndex(this.qualityField),t=a[i],n=this.aqiRankingFeatureType.getFieldIndex(this.levelField),l=a[n],s=this.aqiRankingFeatureType.getFieldIndex(this.pm25Field),r=a[s],o=this.aqiRankingFeatureType.getFieldIndex(this.aqiField),d=a[o],p=this.aqiRankingFeatureType.getFieldIndex(this.pm10Field),u=a[p];this.panel.find(".aqi-tab .aqi-quality-label").html(t),this.panel.find(".aqi-tab .aqi-level-label").html(l),this.panel.find(".aqi-tab .aqi-pm25-label").html(r),this.panel.find(".aqi-tab .aqi-pm10-label").html(u),this.panel.find(".aqi-tab .aqi-number").html(d),MapCloud.currentCityPanel.setAQI(d);var c=MapCloud.getAQILevelClass(d);null!=c&&(this.panel.find(".aqi-info .label,.aqi-number").removeClass("label-aqi-level-1 label-aqi-level-2").removeClass("label-aqi-level-3 label-aqi-level-4 label-aqi-level-5 label-aqi-level-6"),this.panel.find(".aqi-info .label").addClass(c),this.panel.find(".aqi-number").addClass(c))}},getAQILevelClass:function(e){var a=null;switch(e){case"一级":a="label-aqi-level-1";break;case"二级":a="label-aqi-level-2";break;case"三级":a="label-aqi-level-3";break;case"四级":a="label-aqi-level-4";break;case"五级":a="label-aqi-level-5";break;case"六级":a="label-aqi-level-6"}return a},getAQIRankingCount:function(e,a){if(null!=e){var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.aqiTimeField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n,this.aqiRankingFeatureType.getFeatureFilterCountAsync(null,this.sourceName,i,null,a)}},getAQIRankingCount_callback:function(e,a){if($.isNumeric(a)){var i=MapCloud.searchPanel,t=Math.ceil(a/i.aqiRankingCount);i.aqiRankingPageCount=t,i.aqiRankingCurrentPage=1;var n=i.aqiRankingCurrentPage+" / "+i.aqiRankingPageCount+"页";i.panel.find(".aqi-ranking-page .current-page").html(n),i.getAQIRanking(i.timepoint,1)}},getAQIRanking:function(e,a){if(null!=e&&null!=a){this.panel.find(".aqi-ranking-div").empty().addClass("loading");var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.aqiTimeField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n;var l=(a-1)*this.aqiRankingCount,s=["aqi","area","quality","x","y"],r=new GeoBeans.OrderBy;r.setOrder(GeoBeans.OrderBy.OrderType.OrderAsc),r.addField(this.aqiField),this.aqiRankingFeatureType.getFeaturesFilterAsync(null,this.sourceName,i,this.aqiRankingCount,l,s,r,this.getAQIRankingFeatures_callback)}},getAQIRankingFeatures_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showAQIRankingFeatures(e),a.panel.find(".aqi-ranking-div").removeClass("loading")}},showAQIRankingFeatures:function(e){for(var a=null,i=null,t=null,n=null,l=null,s="",r=(this.aqiRankingCurrentPage-1)*this.aqiRankingCount,o=this.aqiRankingFeatureType.getFieldIndex(this.areaField),d=this.aqiRankingFeatureType.getFieldIndex(this.aqiField),p=this.aqiRankingFeatureType.getFieldIndex(this.qualityField),u=this.aqiRankingFeatureType.getFieldIndex(this.statXField),c=this.aqiRankingFeatureType.getFieldIndex(this.statYField),h=0;h<e.length;++h)if(a=e[h],null!=a&&(l=a.values,null!=l)){i=l[o],t=l[d],n=l[p];var v=l[u];v=parseFloat(v);var g=l[c];g=parseFloat(g),s+="<div class='row' cx='"+v+"' cy='"+g+"'>	<div class='col-md-2'>"+(r+h+1)+"</div>	<div class='col-md-4'><a href='javascript:void(0)' class='aqi-city'>"+i+"</a></div>	<div class='col-md-2'>"+t+"</div>	<div class='col-md-4'>"+n+"</div></div>";MapCloud.getAQILevelColor(t),1e3*parseInt(t)}this.panel.find(".aqi-ranking-div").html(s);var m=this;this.panel.find(".aqi-city").click(function(){var e=$(this).html();if(null!=e&&""!=e){MapCloud.currentCity=e;var a=$(this).parents(".row").attr("cx"),i=$(this).parents(".row").attr("cy");m.getAQICityInfo(e),MapCloud.currentCityPanel.setCity(e,a,i)}})},getAQIStat:function(e,a){if(null!=e&&null!=a){var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.areaField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n;var l=new GeoBeans.BinaryComparisionFilter;l.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.aqiTimeField);var n=new GeoBeans.Literal;n.setValue(a),l.expression1=t,l.expression2=n;var s=new GeoBeans.BinaryLogicFilter;s.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,s.addFilter(i),s.addFilter(l);var r=[this.aqiField,this.pm25Field,this.pm10Field,this.qualityField,this.positionField,this.primaryPollutantField,this.statXField,this.statYField,this.stationCodeField];this.aqiStatFeatureType.fields=this.aqiStatFeatureType.getFields(null,this.sourceName),this.aqiStatFeatureType.getFeaturesFilterAsync(null,this.sourceName,s,30,null,r,null,this.getAQIStat_callback)}},getAQIStat_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showAQIStatFeatures(e)}},showAQIStatFeatures:function(e){if(null!=e){var a=null,i=null,t=null,n=null,l=null,s=null,r=null,o=null,d=null,p=null,u=-1,c=-1,h=null,v=null,g=-1;statXFieldIndex=-1,pm10FieldIndex=null,primaryPollutantFieldIndex=-1;var m=-1,f=null,F="",C=[],y=null;Radi.Earth.cleanup();for(var q=0;q<e.length;++q)if(a=e[q],null!=a&&(f=a.values,null!=f)){u=this.aqiStatFeatureType.getFieldIndex(this.positionField),i=f[u],c=this.aqiStatFeatureType.getFieldIndex(this.aqiField),s=f[c],h=this.aqiStatFeatureType.getFieldIndex(this.qualityField),t=f[h],primaryPollutantFieldIndex=this.aqiStatFeatureType.getFieldIndex(this.primaryPollutantField),d=f[primaryPollutantFieldIndex],v=this.aqiStatFeatureType.getFieldIndex(this.pm25Field),n=f[v],pm10FieldIndex=this.aqiStatFeatureType.getFieldIndex(this.pm10Field),l=f[pm10FieldIndex],m=this.aqiStatFeatureType.getFieldIndex(this.stationCodeField),p=f[m],statXFieldIndex=this.aqiStatFeatureType.getFieldIndex(this.statXField),r=f[statXFieldIndex],g=this.aqiStatFeatureType.getFieldIndex(this.statYField),o=f[g];var k=MapCloud.getAQILevelClass(s);F+="<div class='aqi-stat-info board'>	<div class='board-title' sx='"+r+"' sy='"+o+"'>		<span class='aqi-stat'><a href='javascript:void(0)'>"+i+"</a></span>		<span class='aqi-number "+k+"'>"+s+"</span>	</div>	<div class='board-content row'>		<div class='col-md-8'>			<div class='row'>				<div class='col-md-4'>PM2.5:</div>				<div class='col-md-6'>					<span class='label "+k+"'>"+n+"</span>				</div>			</div>			<div class='row'>				<div class='col-md-4'>PM10:</div>				<div class='col-md-6'>					<span class='label "+k+"'>"+l+"</span>				</div>			</div>			<div class='row'>				<div class='col-md-4'>空气质量:</div>				<div class='col-md-6'>					<span class='label  "+k+"'>"+t+"</span>				</div>			</div>		</div>		<div class='col-md-4'>			<div class='aqi-chart-btn' scode='"+p+"'></div>		</div>	</div></div>";var b=MapCloud.getAQILevelColor(s),P=60*parseInt(s);if(r=parseFloat(r),o=parseFloat(o),0!=r&&0!=o&&P>0){y=Radi.Earth.addCylinder(r,o,P,500,b);var I=i+" : "+s;Radi.Earth.addLabel(r,o,P/2+400,I),C.push(y)}}this.panel.find(".aqi-stat-div").html(F),this.panel.find(".aqi-stat a").click(function(){var e=$(this).parents(".board-title").attr("sx"),a=$(this).parents(".board-title").attr("sy");if(e=parseFloat(e),a=parseFloat(a),null!=e&&null!=a&&0!=e&&0!=a){var i=3e4;Radi.Earth.flyTo(e,a,i)}});var w=this;this.panel.find(".aqi-stat-div .aqi-chart-btn").click(function(){var e=$(this).attr("scode"),a=$(this).parents(".aqi-stat-info").find(".aqi-stat a").html(),i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(w.stationCodeField);var n=new GeoBeans.Literal;n.setValue(e),i.expression1=t,i.expression2=n,MapCloud.aqiChartDialog.showDialog(w.timepoint,w.aqiStatFeatureType,a,i)})}},searchPlace:function(e){null!=e&&this.getAddress(e,1)},getAddress:function(e,a){if(!(0>a)){this.addressCurrentPage=a;var i=(a-1)*this.poiPageCount,t=a*this.poiPageCount;Radi.Earth.cleanup(),this.panel.find(".place-tab").empty(),this.panel.find(".search-tab-div").removeClass("active"),this.panel.find(".place-tab").addClass("active"),this.panel.find(".place-tab").addClass("loading"),MapCloud.addressService.getAddress(e,i,t,this.getPlace_callback)}},getPlace_callback:function(e){var a=MapCloud.searchPanel;a.panel.find(".place-tab").removeClass("loading"),$.isArray(e)&&(a.showPlaceResults(e),a.showPlaceIn3D(e))},showPlaceResults:function(e){for(var a=null,i="<div class='result-main-div'><ul>",t=0;t<e.length;++t)a=e[t],null!=a&&(i+="<li px='"+a.x+"' py='"+a.y+"'>	<div class='row'>		<div class='col-md-2'>			<img src='../images/marker.png'>		</div>		<div class='col-md-10'>			<div class='row poi-name'>"+a.address+"			</div>		</div>	</div></li>");i+="</ul></div>",i+="<ul class='pagination'>	<li class='pre-page'>上一页</li>	<li class='next-page'>下一页</li></ul>",this.panel.find(".place-tab").html(i),this.panel.find(".place-tab .result-main-div ul li").click(function(){var e=$(this).attr("px"),a=$(this).attr("py");if(null!=e&&null!=a){var i=1e4;Radi.Earth.flyTo(e,a,i)}});var n=this;this.panel.find(".place-tab .pre-page").click(function(){if(!(n.addressCurrentPage<=1)){var e=n.panel.find(".search-keyword").val();n.getAddress(e,n.addressCurrentPage-1)}}),this.panel.find(".place-tab .next-page").click(function(){var e=n.panel.find(".place-tab .result-main-div li").length;if(!(e<n.poiPageCount)){var a=n.panel.find(".search-keyword").val();n.getAddress(a,n.addressCurrentPage+1)}})},showPlaceIn3D:function(e){for(var a="../images/marker.png",i=null,t=null,n=null,l=null,s=null,r=[],o=0;o<e.length;++o)i=e[o],null!=i&&(n=i.x,l=i.y,t=i.address,s=Radi.Earth.addBillboard(n,l,t,a),r.push(s));Radi.Earth.zoom(r)},showRangeChart:function(){if(null==this.chart){var e="/ows/"+this.userName+"/mgr",a={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},i={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"人口_万人"},t=12,n=new MapCloud.RangeChart(e,a,i,t);n.show(),this.chart=n}else this.chart.cleanup(),this.chart=null},showAQIChart:function(){if(this.showAQIChartFlag)Radi.Earth.cleanup(),this.showAQIChartFlag=!1;else{Radi.Earth.cleanup();var e=this.timepoint,a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var i=new GeoBeans.PropertyName;i.setName(this.aqiTimeField);var t=new GeoBeans.Literal;t.setValue(e),a.expression1=i,a.expression2=t;var n=["aqi","area","x","y"];this.aqiRankingFeatureType.getFeaturesFilterAsync(null,this.sourceName,a,400,0,n,null,this.getAQIFeatures_callback)}},getAQIFeatures_callback:function(e){if($.isArray(e)){var a=MapCloud.searchPanel;a.showAQIChartin3D(e)}},showAQIChartin3D:function(e){if(null!=e){for(var a=null,i=null,t=this.aqiRankingFeatureType.getFieldIndex(this.areaField),n=this.aqiRankingFeatureType.getFieldIndex(this.aqiField),l=this.aqiRankingFeatureType.getFieldIndex(this.statXField),s=this.aqiRankingFeatureType.getFieldIndex(this.statYField),r=null,o=null,d=null,p=null,u=null,c=[],h=0;h<e.length;++h)if(a=e[h],null!=a&&(i=a.values,null!=i)){r=i[t],o=i[n],d=i[l],d=parseFloat(d),p=i[s],p=parseFloat(p);var v=MapCloud.getAQILevelColor(o),g=1e3*parseInt(o);if(0!=d&&0!=p&&0!=g){u=Radi.Earth.addCylinder(d,p,g,12e3,v);var m=o;Radi.Earth.addLabel(d,p,g/2+3e3,m),c.push(u)}}this.showAQIChartFlag=!0}}});
MapCloud.CurrentCityPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent(),this.cleanup()},registerEvent:function(){this.panel.find(".current-city").click(function(){var i=MapCloud.cityPanel.panel.css("display");"block"==i?MapCloud.cityPanel.hide():MapCloud.cityPanel.show()});this.panel.find(".current-city-aqi").click(function(){MapCloud.searchPanel.showAQIPanel()})},cleanup:function(){this.panel.find(".current-city-name").html(MapCloud.currentCity),this.panel.find(".current-city-aqi span").html("")},setAQI:function(i){this.panel.find(".current-city-aqi span").html(i)},setCity:function(i,n,t){if(this.panel.find(".current-city-name").html(i),MapCloud.cityPanel.setCity(i),null!=n&&null!=t){var a=5e4;Radi.Earth.flyTo(n,t,a);var l={lon:n,lat:t,height:a};MapCloud.positionPanel.setPosition(l),MapCloud.positionControl.setPosition(l)}}});
MapCloud.CityPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},show:function(){MapCloud.currentCityPanel.panel.find(".current-city").addClass("open"),this.panel.slideDown()},hide:function(){MapCloud.currentCityPanel.panel.find(".current-city").removeClass("open"),this.panel.slideUp()},registerEvent:function(){var i=this;this.panel.find("li").click(function(){var t=$(this).html(),n=MapCloud.cityPosition.getCityPosition(t);if(null!=n){var e=n.lon,l=n.lat;MapCloud.currentCity=t,MapCloud.searchPanel.getAQICityInfo(t),MapCloud.currentCityPanel.setCity(t,e,l),i.hide()}}),this.panel.mouseleave(function(){i.hide()})},setCity:function(i){null!=i&&this.panel.find(".city-list-current span").html(i)}});
MapCloud.AQIChartDialog=MapCloud.Class(MapCloud.Dialog,{userName:"user1",time:null,container:null,timeField:"time_point",aqiField:"aqi",stationCodeField:"station_code",aqiStatLayer:"gc_aqi",sourceName:"base",chart:null,features:null,featureType:null,initialize:function(e,t){MapCloud.Dialog.prototype.initialize.apply(this,arguments),this.container=this.panel.find("#"+t)[0],this.registerPanelEvent()},registerPanelEvent:function(){var e=this;e.panel.find(".btn-group .btn").click(function(){null!=e.chart&&e.chart.clear(),e.panel.find("#aqi_chart_container").addClass("loading"),e.panel.find(".btn-group .btn").attr("disabled",!1),$(this).hasClass("aqi-24h")?e.showAQI24hFeatures():$(this).hasClass("aqi-7d")?e.showAQI7dFeatures():$(this).hasClass("aqi-30d")&&e.showAQI30dFeatures(),$(this).attr("disabled",!0)})},showDialog:function(e,t,a,i){MapCloud.Dialog.prototype.showDialog.apply(this,arguments),this.featureType=t,this.time=e,this.panel.find(".modal-title").html("[ "+a+" ] 空气质量指数变化曲线图"),this.postionFilter=i,this.showAQI24hFeatures()},cleanup:function(){this.panel.find(".btn-group .btn").attr("disabled",!1),this.panel.find(".aqi-24h").attr("disabled",!0),null!=this.chart&&this.chart.clear(),this.panel.find(".modal-title").html("空气质量指数变化曲线图")},showAQI24hFeatures:function(){var e=new Date(this.time),t=MapCloud.dateAdd(e,"day",-1),a=MapCloud.dateFormat(t,"yyyy-MM-dd hh:mm:ss"),i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var r=new GeoBeans.BinaryComparisionFilter;r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(a),r.expression1=prop,r.expression2=literal;var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.time),s.expression1=prop,s.expression2=literal,i.addFilter(r),i.addFilter(s),this.getFeatures(i)},showAQI7dFeatures:function(){var e=null,t=null,a=new Date(this.time);a.setHours(0),a.setMinutes(0),a.setSeconds(0);var i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var r=null,s=0;7>s;++s){e=MapCloud.dateAdd(a,"day",-s),t=MapCloud.dateFormat(e,"yyyy-MM-dd hh:mm:ss"),r=new GeoBeans.BinaryComparisionFilter,r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var o=new GeoBeans.PropertyName;o.setName(this.timeField);var n=new GeoBeans.Literal;n.setValue(t),r.expression1=o,r.expression2=n,i.addFilter(r)}this.getFeatures(i)},showAQI30dFeatures:function(){var e=null,t=null,a=new Date(this.time);a.setHours(0),a.setMinutes(0),a.setSeconds(0);var i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var r=null,s=0;30>s;++s){e=MapCloud.dateAdd(a,"day",-s),t=MapCloud.dateFormat(e,"yyyy-MM-dd hh:mm:ss"),r=new GeoBeans.BinaryComparisionFilter,r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var o=new GeoBeans.PropertyName;o.setName(this.timeField);var n=new GeoBeans.Literal;n.setValue(t),r.expression1=o,r.expression2=n,i.addFilter(r)}this.getFeatures(i)},getFeatures:function(e){if(null!=e&&null!=this.postionFilter){var t=new GeoBeans.BinaryLogicFilter;t.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,t.addFilter(this.postionFilter),t.addFilter(e);var a=[this.aqiField,this.timeField],i=new GeoBeans.OrderBy;i.setOrder(GeoBeans.OrderBy.OrderType.OrderAsc),i.addField(this.timeField),this.featureType.getFeaturesFilterAsync(null,this.sourceName,t,100,null,a,i,this.getFeatures_callback)}},getFeatures_callback:function(e){if($.isArray(e)){var t=MapCloud.aqiChartDialog;t.setFeatures(e)}},setFeatures:function(e){if(this.panel.find("#aqi_chart_container").removeClass("loading"),this.features=e,null==this.chart){var t=this.getOption(),a=echarts.init(this.container,"macarons");this.chart=a,a.setOption(t)}else{this.chart.clear();var t=this.getOption();this.chart.setOption(t)}},getOption:function(){if(null!=this.features&&null!=this.featureType){for(var e=null,t=null,a=null,i=-1,r=-1,s=null,o=[],n=[],l=0;l<this.features.length;++l)e=this.features[l],null!=e&&(s=e.values,null!=s&&(i=this.featureType.getFieldIndex(this.aqiField),t=s[i],t=parseFloat(t),n.push(t),r=this.featureType.getFieldIndex(this.timeField),a=s[r],o.push(a)));var p={name:"AQI",type:"line",smooth:!0,data:n},d={title:{},toolbox:{show:!0,x:"640",y:"top",feature:{dataView:{show:!0,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{x:"40",y:"40",x2:"40",y2:"40"},tooltip:{trigger:"axis"},legend:{data:["AQI"]},calculable:!0,yAxis:[{type:"value"}],xAxis:[{type:"category",data:o}],series:[p]};return d}},dateAdd:function(e,t,a){var i=new Date(e);switch(t.toLowerCase()){case"year":i.setFullYear(i.getFullYear()+a);break;case"quarter":i.setMonth(i.getMonth()+3*a);break;case"month":i.setMonth(i.getMonth()+a);break;case"week":i.setDate(i.getDate()+7*a);break;case"day":i.setDate(i.getDate()+a);break;case"hour":i.setTime(i.getTime()+36e5*a);break;case"minute":i.setTime(i.getTime()+6e4*a);break;case"second":i.setTime(i.getTime()+1e3*a);break;default:i=void 0}return i}});
MapCloud.PositionControl=MapCloud.Class({tolerance:.03,heightTolerance:15e4,cityRegionLayer:"china_city_region",chinaLayer:"china_china",sourceName:"base",nameField:"aname",chinaNameField:"name_engli",featureType:null,chinaFeatureType:null,lat:null,lon:null,height:null,position:null,initialize:function(){this.lat=null,this.lon=null,this.height=null,Radi.Earth.addClickListener(this.getPositionHandler),Radi.Earth.addMoveListener(this.getMousePositionHandler),Radi.Earth.addScrollEventListener(this.getHeightHandler);var i=new GeoBeans.WFSWorkspace("tmp",MapCloud.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(i,this.cityRegionLayer),this.chinaFeatureType=new GeoBeans.FeatureType(i,this.chinaLayer)},getPositionHandler:function(i){if(null!=i){var t=MapCloud.positionControl;t.setPostion(i)}},setPostion:function(i){var t=Radi.Earth.getCameraPosition(),e=t.lat,n=t.lon;t.height;if(null==this.lat||null==this.lon)this.lat=e,this.lon=n;else{this.position=t;var o=new GeoBeans.Geometry.Point(n,e);this.getPositionInChina(o)}},getPositionWithinCity:function(i){if(null!=i){this.featureType.fields=this.featureType.getFields(null,this.sourceName);var t=[this.nameField];this.featureType.getFeaturesWithinAsync(null,this.sourceName,i,this.getPositionWithinCity_callback,t)}},getPositionWithinCity_callback:function(i,t){if($.isArray(t)&&0!=t.length){var e=MapCloud.positionControl,n=t[0];if(null!=n){var o=n.values,l=e.featureType.getFieldIndex(e.nameField),a=o[l];null!=a&&e.setCurrentCity(a)}}},setCurrentCity:function(i){console.log(i),MapCloud.currentCity=i,MapCloud.searchPanel.getAQICityInfo(i),MapCloud.currentCityPanel.setCity(i)},getMousePositionHandler:function(i){if(null!=i){var t=MapCloud.positionControl;t.setMousePosition(i)}},setMousePosition:function(i){null!=i&&MapCloud.positionPanel.setPosition(i)},getHeightHandler:function(i){if(null!=i){MapCloud.positionPanel.setHeight(i);var t=MapCloud.positionControl;t.setPostion(null)}},getPositionInChina:function(i){if(null!=i){this.chinaFeatureType.fields=this.chinaFeatureType.getFields(null,this.sourceName);var t=[this.chinaNameField];this.chinaFeatureType.getFeaturesWithinAsync(null,this.sourceName,i,this.getPositionInChina_callback,t)}},getPositionInChina_callback:function(i,t){if($.isArray(t)){var e=MapCloud.positionControl;e.setPositionInChina(t)}},setPositionInChina:function(i){if(null!=i){var t=i.length;if(0==t)MapCloud.currentCity=null,MapCloud.currentCityPanel.setCity("其它地区"),$(".current-city-aqi span").html("");else{var e=this.position.lat,n=this.position.lon,o=this.position.height;if(o>this.heightTolerance)MapCloud.currentCity=null,MapCloud.currentCityPanel.setCity("全国"),$(".current-city-aqi span").html("");else{var l=Math.sqrt((this.lat-e)*(this.lat-e)+(this.lon-n)*(this.lon-n));if(console.log("distance:"+l),l>this.tolerance){var a=new GeoBeans.Geometry.Point(n,e);this.getPositionWithinCity(a)}}}this.lat=this.position.lat,this.lon=this.position.lon}},setPosition:function(i){if(null!=i){var t=i.lat,e=i.lon;i.height;null!=e&&null!=t&&(this.lat=t,this.lon=e)}}});
MapCloud.PositionPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments);var t=$(window).width(),n=this.panel.find(".postion-content").width(),l=(t-n)/2;this.panel.find(".postion-content").css("left",l+"px")},setPosition:function(i){if(null!=i){var t=i.lat,n=i.lon,l=i.height;null!=t&&(t=parseFloat(t),t=t.toFixed(3),this.panel.find(".position-lat").html(t)),null!=n&&(n=parseFloat(n),n=n.toFixed(3),this.panel.find(".position-lon").html(n)),this.setHeight(l)}},setHeight:function(i){null!=i&&this.panel.find(".position-height").html(i)}});
MapCloud.CityPosition=MapCloud.Class({cityList:null,initialize:function(){this.cityList=[{name:"北京",lon:116.380943,lat:39.923615},{name:"上海",lon:121.469269,lat:31.238176},{name:"天津",lon:117.203499,lat:39.131119},{name:"南京",lon:118.772781,lat:32.047615},{name:"武汉",lon:114.291939,lat:30.567514},{name:"重庆",lon:106.510338,lat:29.558176},{name:"合肥",lon:117.275703,lat:31.863255},{name:"安庆",lon:117.034431,lat:30.512646},{name:"蚌埠",lon:117.361382,lat:32.939243},{name:"亳州",lon:115.7709,lat:33.879292},{name:"池州",lon:117.487494,lat:30.668548},{name:"滁州",lon:118.301163,lat:32.316532},{name:"阜阳",lon:115.809731,lat:32.902206},{name:"淮北",lon:116.787498,lat:33.97049},{name:"淮南",lon:117.02072,lat:32.616695},{name:"黄山",lon:118.309067,lat:29.720844},{name:"六安",lon:116.49279,lat:31.753523},{name:"马鞍山",lon:118.480713,lat:31.724924},{name:"宿州",lon:116.970154,lat:33.640133},{name:"铜陵",lon:117.813179,lat:30.925247},{name:"芜湖",lon:118.359833,lat:31.334496},{name:"宣城",lon:118.73,lat:30.965},{name:"福州",lon:119.297813,lat:26.07859},{name:"龙岩",lon:117.030388,lat:25.109703},{name:"南平",lon:118.169121,lat:26.644842},{name:"宁德",lon:119.518318,lat:26.666477},{name:"莆田",lon:119.010323,lat:25.438137},{name:"泉州",lon:118.589638,lat:24.915918},{name:"三明",lon:117.601227,lat:26.223013},{name:"厦门",lon:118.087517,lat:24.457436},{name:"漳州",lon:117.653091,lat:24.518164},{name:"广州",lon:113.261429,lat:23.118912},{name:"潮州",lon:116.63666,lat:23.667706},{name:"东莞",lon:113.748772,lat:23.048536},{name:"佛山",lon:113.114517,lat:23.034878},{name:"河源",lon:114.693817,lat:23.73484},{name:"惠州",lon:114.392403,lat:23.087957},{name:"江门",lon:113.084747,lat:22.59119},{name:"揭阳",lon:116.34977,lat:23.542976},{name:"茂名",lon:110.888847,lat:21.670717},{name:"梅州",lon:116.107941,lat:24.314501},{name:"清远",lon:113.021263,lat:23.719597},{name:"汕头",lon:116.6838,lat:23.362692},{name:"汕尾",lon:115.364014,lat:22.778687},{name:"韶关",lon:113.605392,lat:24.808777},{name:"深圳",lon:114.110672,lat:22.556396},{name:"阳江",lon:111.957893,lat:21.845234},{name:"云浮",lon:112.03999,lat:22.933193},{name:"湛江",lon:110.399223,lat:21.194998},{name:"肇庆",lon:112.451408,lat:23.057882},{name:"中山",lon:113.371452,lat:22.526854},{name:"珠海",lon:113.56826,lat:22.272589},{name:"南宁",lon:108.311768,lat:22.806543},{name:"百色",lon:106.612106,lat:23.901583},{name:"北海",lon:109.119171,lat:21.479797},{name:"崇左",lon:107.35506,lat:22.420197},{name:"防城港",lon:108.362153,lat:21.691939},{name:"贵港",lon:109.60844,lat:23.099092},{name:"桂林",lon:110.286682,lat:25.281883},{name:"河池",lon:108.051628,lat:24.696892},{name:"贺州",lon:111.549191,lat:24.40428},{name:"来宾",lon:109.23294,lat:23.73144},{name:"柳州",lon:109.402809,lat:24.310406},{name:"钦州",lon:108.6147,lat:21.949869},{name:"梧州",lon:111.305946,lat:23.48662},{name:"玉林",lon:110.141472,lat:22.631897},{name:"贵阳",lon:106.711372,lat:26.576874},{name:"安顺",lon:105.926071,lat:26.244259},{name:"毕节",lon:105.282417,lat:27.306295},{name:"六盘水",lon:104.873253,lat:26.576775},{name:"黔东南州",lon:107.989968,lat:26.599325},{name:"黔南州",lon:107.49,lat:26.65},{name:"黔西南州",lon:106.0367,lat:27.034166},{name:"铜仁地区",lon:109.19268,lat:27.722166},{name:"遵义",lon:106.929398,lat:27.695387},{name:"兰州",lon:103.750053,lat:36.068039},{name:"白银",lon:104.183777,lat:36.539417},{name:"定西",lon:104.618568,lat:35.575237},{name:"甘南州",lon:123.49532,lat:47.913578},{name:"嘉峪关",lon:98.274712,lat:39.802654},{name:"金昌",lon:102.165749,lat:38.495193},{name:"酒泉",lon:98.511116,lat:39.744968},{name:"临夏州",lon:103.214081,lat:35.606712},{name:"陇南",lon:104.929411,lat:33.405075},{name:"平凉",lon:106.683067,lat:35.535519},{name:"庆阳",lon:107.87602,lat:36.005165},{name:"天水",lon:105.71524,lat:34.584267},{name:"武威",lon:102.633461,lat:37.92691},{name:"张掖",lon:100.450287,lat:38.935059}]},getCityPosition:function(l){if(null==l)return null;for(var n=null,a=null,t=null,o=null,e=0;e<this.cityList.length;++e)if(n=this.cityList[e],a=n.name,a==l)return t=n.lon,o=n.lat,{lon:t,lat:o};return null}});
MapCloud.RangeChart=MapCloud.Class({server:null,baseSourceName:null,baseLayer:null,baseLayerPostionField:null,baseLayerFeatureType:null,chartSourceName:null,chartLayer:null,chartLayerPositionField:null,chartLayerChartField:null,chartLayerFeatureType:null,colorMapID:null,initialize:function(e,a,t,r){var l=null;null!=e&&(this.server=e,l=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0")),null!=a&&(this.baseSourceName=a.sourceName,this.baseLayer=a.layerName,this.baseLayerPostionField=a.positionField,null!=l&&null!=this.baseLayer&&(this.baseLayerFeatureType=new GeoBeans.FeatureType(l,this.baseLayer))),null!=t&&(this.chartSourceName=t.sourceName,this.chartLayer=t.layerName,this.chartLayerPositionField=t.positionField,this.chartLayerChartField=t.chartField,null!=l&&null!=this.chartLayer&&(this.chartLayerFeatureType=new GeoBeans.FeatureType(l,this.chartLayer))),this.colorMapID=r},show:function(){Radi.Earth.cleanup(),null!=this.baseLayerFeatureType&&null!=this.chartLayerFeatureType&&(null==this.baseFeatures?this.getFeatures():this.drawBaseLayerFeatures())},getFeatures:function(){var e=(this.chartLayerFeatureType.getFields(null,this.chartSourceName),this.chartLayerFeatureType.getFeaturesFilter(null,this.chartSourceName,null,null,null,[this.chartLayerPositionField].concat(this.chartLayerChartField)));this.chartFeatures=e;var a=(this.baseLayerFeatureType.getFields(null,this.baseSourceName),[this.baseLayerFeatureType.geomFieldName,this.baseLayerPostionField]);this.baseLayerFeatureType.getFeaturesFilterAsync2(null,this.baseSourceName,null,null,null,a,null,this,this.getBaseLayerFeatures_callback)},getBaseLayerFeatures_callback:function(e,a){null!=e&&null!=a&&e.setBaseLayerFeatures(a)},setBaseLayerFeatures:function(e){if(null!=e){this.baseFeatures=e;var a=this.baseLayerFeatureType.getFieldIndex(this.baseLayerPostionField),t=this.chartLayerFeatureType.getFieldIndex(this.chartLayerPositionField),r=this.chartLayerFeatureType.getFieldIndex(this.chartLayerChartField);if(-1!=a&&-1!=t&&-1!=r){for(var l=null,s=null,i=null,n=null,u=0;u<e.length;++u)if(l=e[u],null!=l&&(s=l.values,null!=s))for(var h=s[a],c=0;c<this.chartFeatures.length;++c)if(i=this.chartFeatures[c],null!=i&&(n=i.values,null!=n)){var o=n[t];if(h==o){var d=n[r];l.chartValue=d}}this.drawBaseLayerFeatures()}}},drawBaseLayerFeatures:function(){if(null!=this.baseFeatures){for(var e=this.getColorRangeMap(),a=this.baseLayerFeatureType.geomFieldName,t=this.baseLayerFeatureType.getFieldIndex(a),r=null,l=null,s=null,i=[],n=0;n<this.baseFeatures.length;++n){if(r=this.baseFeatures[n],null==r)return;if(l=r.values,null==l)return;s=l[t],chartValue=r.chartValue;var u=chartValue,h=e.getValue(chartValue);h=Cesium.Color.fromCssColorString(h.getHex()),chartValue=20*parseFloat(chartValue),$.isNumeric(chartValue)||(chartValue=0);var c=s.toPointsArray(),o=Radi.Earth.addPolygon(c,h,chartValue,!1),d=s.getCentroid();Radi.Earth.addLabel(d.x,d.y,chartValue+4e4,u),i.push(o)}this.addLegend()}},getColorRangeMap:function(){null==this.colorMapID&&(this.colorMapID=1);var e=this.getMinMaxValue(),a=this.server.slice(0,this.server.lastIndexOf("/mgr")),t=new GeoBeans.StyleManager(a),r=t.getColorMapByID(this.colorMapID);this.colorMap=r;var l=new GeoBeans.ColorRangeMap(r.startColor,r.endColor,e.min,e.max);return l},getMinMaxValue:function(){if(null==this.baseFeatures)return null;for(var e=null,a=null,t=null,r=null,l=0;l<this.baseFeatures.length;++l)e=this.baseFeatures[l],null!=e&&(a=e.chartValue,a=parseFloat(a),t=null==t?a:t>a?a:t,r=null==r?a:a>r?a:r);return{min:t,max:r}},addLegend:function(){var e=this.getMinMaxValue(),a="<div class='chart-legend chart-legend-range' id='"+this.chartLayerChartField+"'>";a+="<div class='chart-legend-title'><h5>"+this.chartLayerChartField+"</h5></div>",a+="<div class='chart-legend-canvas'>	<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+e.max+"</div><div class='chart-legend-min'>"+e.min+"</div></div>",a+="</div>",$("#legend_container").html(a);var t=$("#legend_container .chart-legend-canvas canvas"),r=t[0].getContext("2d"),l=new Image;l.src=this.colorMap.url,l.onload=function(){var e=t.width()/2,a=t.height()/2,s=l.width,i=l.height;r.clearRect(0,0,s,i),r.translate(e,a),r.rotate(270*Math.PI/180),r.drawImage(l,-s/2,-i/2,s,i),r.rotate(-270*Math.PI/180),r.translate(-e,-a)}},cleanup:function(){Radi.Earth.cleanup(),$("#legend_container").empty()}});
MapCloud.TopicPanel=MapCloud.Class(MapCloud.Panel,{aqiChart:null,popRangeChart:null,encoRangeChart:null,perRangeChart:null,agroMapName:"agro",agroLayerName:"agro",agroFields:["ppt","x","y"],agroFeatureType:null,agroChartFlag:!1,preIndex:null,showFlag:!1,argoFeatures:null,initialize:function(a){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent();var e=new GeoBeans.WFSWorkspace("tmp",MapCloud.server,"1.0.0");this.agroFeatureType=new GeoBeans.FeatureType(e,this.agroLayerName)},registerEvent:function(){var a=this;this.panel.find("[data-toggle='tooltip']").tooltip({container:"body"}),this.panel.find(".mc-icon").each(function(e,t){$(this).click(function(){switch(e){case 0:a.onStretch(this);break;case 1:1==a.preIndex&&a.showFlag?(Radi.Earth.cleanup(),a.showFlag=!1):(a.showPerRangeChart(),a.showFlag=!0);break;case 2:2==a.preIndex&&a.showFlag?(Radi.Earth.cleanup(),a.showFlag=!1):(a.showEncoRangeChart(),a.showFlag=!0);break;case 3:3==a.preIndex&&a.showFlag?(Radi.Earth.cleanup(),a.showFlag=!1):(a.showPopRangeChart(),a.showFlag=!0);break;case 4:4==a.preIndex&&a.showFlag?(Radi.Earth.cleanup(),a.showFlag=!1):(a.getAgroData(),a.showFlag=!0);break;case 5:5==a.preIndex&&a.showFlag?(Radi.Earth.cleanup(),a.showFlag=!1):(a.show3DModel(),a.showFlag=!0);break;case 6:6==a.preIndex&&a.showFlag?(Radi.Earth.cleanup(),a.showFlag=!1):(a.showAQIChart(),a.showFlag=!0);break;case 7:a.show24AQITimeLineChart();break;case 8:a.showAQITimeLineChart()}a.preIndex=e})})},onStretch:function(a){$(a).hasClass("mc-icon-left")?(this.panel.children().not(".mc-stretch").css("display","block"),$(a).removeClass("mc-icon-left"),$(a).addClass("mc-icon-right"),this.panel.animate({width:"362px"},300)):(this.panel.children().not(".mc-stretch").css("display","none"),$(a).removeClass("mc-icon-right"),$(a).addClass("mc-icon-left"),this.panel.animate({width:"40px"},300),MapCloud.aqiTimelinePanel.hide(),MapCloud.aqi24TimelinePanel.hide())},showAQIChart:function(){if(null==this.aqiChart){var a=MapCloud.server,e="aqi",t=MapCloud.searchPanel.timepoint,i=new MapCloud.AQIChart(a,e,t);i.show(),this.aqiChart=i}else Radi.Earth.cleanup(),this.aqiChart.show()},showPopRangeChart:function(){if(null==this.popRangeChart){var a=MapCloud.server,e={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},t={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"人口_万人"},i=2,n=new MapCloud.RangeChart(a,e,t,i);n.show(),this.popRangeChart=n,this.setCameraPosition()}else Radi.Earth.cleanup(),this.popRangeChart.show(),this.setCameraPosition()},showEncoRangeChart:function(){if(null==this.encoRangeChart){this.cleanupChart();var a=MapCloud.server,e={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},t={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"gdp_亿元"},i=2,n=new MapCloud.RangeChart(a,e,t,i);n.show(),this.encoRangeChart=n,this.setCameraPosition()}else Radi.Earth.cleanup(),this.encoRangeChart.show(),this.setCameraPosition()},showPerRangeChart:function(){if(null==this.perRangeChart){this.cleanupChart();var a=MapCloud.server,e={sourceName:"base",layerName:"prov_bount_4m",positionField:"name"},t={sourceName:"base",layerName:"china_econmic_2014",positionField:"省区市",chartField:"人均gdp_元"},i=2,n=new MapCloud.RangeChart(a,e,t,i);n.show(),this.perRangeChart=n,this.setCameraPosition()}else Radi.Earth.cleanup(),this.perRangeChart.show(),this.setCameraPosition()},cleanupChart:function(){null!=this.popRangeChart&&(this.popRangeChart.cleanup(),this.popRangeChart=null),null!=this.encoRangeChart&&(this.encoRangeChart.cleanup(),this.encoRangeChart=null),null!=this.perRangeChart&&(this.perRangeChart.cleanup(),this.perRangeChart=null)},setCameraPosition:function(){var a=97.92627,e=15.730198,t=5543911,i=8.9819126,n=-70.75989,l=359.990288;Radi.Earth.flyTo(a,e,t,i,n,l)},getAgroData:function(){return null!=this.argoFeatures?void this.showArgoData(this.argoFeatures):(this.agroFeatureType.fields=this.agroFeatureType.getFields(this.agroMapName,null),void this.agroFeatureType.getFeaturesFilterAsync(this.agroMapName,null,null,333,0,this.agroFields,null,this.getAgroData_callback))},getAgroData_callback:function(a){if($.isArray(a)){var e=MapCloud.topicPanel;e.argoFeatures=a,e.showArgoData(a)}},showArgoData:function(a){if(null!=a){Radi.Earth.cleanup();for(var e="../images/agro_marker.png",t=this.agroFeatureType.getFieldIndex("ppt"),i=this.agroFeatureType.getFieldIndex("x"),n=this.agroFeatureType.getFieldIndex("y"),l=null,r=null,o=null,h=null,s=null,d=null,p=[],u=0;u<a.length;++u)l=a[u],null!=l&&(r=l.values,null!=r&&(o=r[t],h=r[i],s=r[n],null!=h&&null!=s&&(d=Radi.Earth.addBillboard(h,s,"",e),p.push(d))));var g=107.18924,c=25.566601,C=11677693,m=358.15,R=-89.76141,w=0;Radi.Earth.flyTo(g,c,C,m,R,w),this.agroChartFlag=!0}},showAQITimeLineChart:function(){var a=MapCloud.aqi24TimelinePanel,e=MapCloud.aqiTimelinePanel;"none"==e.panel.css("display")?("block"==a.panel.css("display")&&a.hide(),e.show()):e.hide()},show24AQITimeLineChart:function(){var a=MapCloud.aqi24TimelinePanel,e=MapCloud.aqiTimelinePanel;"none"==a.panel.css("display")?("block"==e.panel.css("display")&&e.hide(),a.show()):a.hide()},show3DModel:function(){var a=this;Radi.Earth.camera().moveEnd.addEventListener(a.addTianjinModel),Radi.Earth.flyTo(117.17,39.092,3151,27,-49,-12)},addTianjinModel:function(){Radi.Earth.cleanup();var a="./data/tj/hepingqu/1-4/1-4.gltf",e=117.184,t=39.0986,i=0;Radi.Earth.addModel(a,e,t,i,2.5);var a="./data/tj/hepingqu/4330517/5.gltf",e=117.1998,t=39.1136,i=0;Radi.Earth.addModel(a,e,t,i,2.5);var a="./data/tj/hepingqu/4331515/4331515.gltf",e=117.18155,t=39.1216,i=0;Radi.Earth.addModel(a,e,t,i,1);var a="./data/tj/hepingqu/4331516/4331516.gltf",e=117.188,t=39.1261,i=0;Radi.Earth.addModel(a,e,t,i,1);var a="./data/tj/hepingqu/4331517/4331517.gltf",e=117.19305,t=39.11028,i=0;Radi.Earth.addModel(a,e,t,i,1);var a="./data/tj/hepingqu/4331518/4331518.gltf",e=117.20988,t=39.1113,i=0;Radi.Earth.addModel(a,e,t,i,2.5);var a="./data/tj/hepingqu/4332515/4332515.gltf",e=117.180775,t=39.12379,i=0;Radi.Earth.addModel(a,e,t,i,1);var a="./data/tj/hepingqu/4332516/4332516.gltf",e=117.1878,t=39.12658,i=0;Radi.Earth.addModel(a,e,t,i,1);var a="./data/tj/hepingqu/4332517/4332517.gltf",e=117.1985,t=39.131025,i=0;Radi.Earth.addModel(a,e,t,i,1);var a="./data/tj/hepingqu/4333515-7/4333515-7.gltf",e=117.1849,t=39.1331,i=0;Radi.Earth.addModel(a,e,t,i,1);var n=MapCloud.topicPanel;Radi.Earth.camera().moveEnd.removeEventListener(n.addTianjinModel)}});
MapCloud.AQIChart=MapCloud.Class({server:null,sourceName:"base",layerName:"gc_aqi_ranking",timepoint:null,chartField:null,areaField:"area",xField:"x",yField:"y",timepointField:"time_point",featureType:null,features:null,initialize:function(e,t,a){this.server=e,this.chartField=t,this.timepoint=a;var i=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(i,this.layerName)},show:function(){if(null!=this.features)return Radi.Earth.cleanup(),void this.showAQIChart(this.features);var e=new GeoBeans.BinaryComparisionFilter;e.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.timepointField);var a=new GeoBeans.Literal;a.setValue(this.timepoint),e.expression1=t,e.expression2=a;var i=[this.chartField,this.xField,this.yField];this.featureType.getFeaturesFilterAsync2(null,this.sourceName,e,400,0,i,null,this,this.getAQIFeatures_callback)},getAQIFeatures_callback:function(e,t){null!=e&&null!=t&&$.isArray(t)&&(e.features=t,Radi.Earth.cleanup(),e.showAQIChart(t))},showAQIChart:function(e){if(null!=e)for(var t=null,a=null,i=(this.featureType.getFieldIndex(this.areaField),this.featureType.getFieldIndex(this.chartField)),l=this.featureType.getFieldIndex(this.xField),r=this.featureType.getFieldIndex(this.yField),s=null,n=null,u=null,h=null,o=[],p=0;p<e.length;++p)if(t=e[p],null!=t&&(a=t.values,null!=a)){s=a[i],n=a[l],n=parseFloat(n),u=a[r],u=parseFloat(u);var d=MapCloud.getAQILevelColor(s),F=1e3*parseInt(s);if(0!=n&&0!=u&&0!=F){h=Radi.Earth.addCylinder(n,u,F,12e3,d);o.push(h)}}},cleanup:function(){this.features=null}});
MapCloud.AQITimeLineBar=MapCloud.Class({slider:null,wrapper:null,broadcastIntervalId:null,initialized:!1,boardcast:null,layer:null,intervalShort:1e3,firstLoop:!1,initialize:function(t){if(null!=t){this.layer=t,$("#slider").remove();var i='<div class="slider-wrap" id="slider">	<button class="timeline-play" id="slider_player">		<img src="../images/timeline-play.png">	</button>   <div class="timeline"></div>	  <div class="label-div"></div></div>';$("body").append(i);var a=t.timepoints;this.timepoints=a;var l=this;if(!this.initialized){this.wrapper=$("#slider"),this.slider=this.wrapper.find(".timeline"),this.slider.noUiSlider({start:0,range:{min:0,max:a.length-1},step:1});for(var e=1,s=1;s<a.length-1;s++){var r=s/(a.length-1)*100,n=$('<span class="ui-slider-segment"></span>');n.attr("data-content",e+s).css("left",r+"%"),this.slider.append(n)}this.boardcast=this.wrapper.find(".timeline-play"),this.boardcast.click(function(t){var i=$(this).find("img"),a=i.attr("src");/play/.test(a)?i.attr("src",a.replace("play","pause")):i.attr("src",a.replace("pause","play")),l.broadcast()}),this.slider.on("set",function(){var t=parseInt($(this).val());l.layer.currentLayerID=t,l.layer.drawAQIChart(t)}),this.addLabels(),this.initialized=!0}}},broadcast:function(){var t=this;null!=this.broadcastIntervalId?(clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null):this.broadcastIntervalId=setInterval(function(){var i=t.slider.val();i=parseInt(i),0==i&&(t.firstLoop?(clearInterval(t.broadcastIntervalId),t.broadcastIntervalId=null,t.broadcastShort()):t.firstLoop=!0),i===t.timepoints.length-1?t.slider.val(0):t.slider.val(i+1),console.log(i)},this.layer.interval)},broadcastShort:function(){var t=this;null!=this.broadcastIntervalId?(clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null):this.broadcastIntervalId=setInterval(function(){var i=t.slider.val();i=parseInt(i),i===t.timepoints.length-1?t.slider.val(0):t.slider.val(i+1),console.log(i)},this.intervalShort)},cleanup:function(){$("#slider").remove(),clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null,this.slider=null,this.wrapper=null,this.initialized=!1,this.boardcast=null},addLabels:function(){if(!(null==this.timepoints||this.timepoints.length<2)){var t=this.timepoints.length,i=this.timepoints[0],a=document.createElement("canvas"),l=a.getContext("2d");l.font="12px Arial, Verdana, sans-seri";var e=l.measureText(i).width,s=this.slider.width(),r=s/(t-1),n="";if(r>e){var d=e/2*-1;this.wrapper.find(".label-div").css("margin-left",d).css("width","calc(100% + "+e+"px)");for(var o=0;t>o;++o){var c=0;c=0==o?0:r-e,n+="<div class='time-label' style='padding-left:"+c+"px'>"+this.timepoints[o]+"</div>"}this.wrapper.find(".label-div").html(n)}else{for(var v=Math.ceil(e/r),o=0;t>o+v;o+=v){var c=0;c=0==o?0:v*r-e,n+="<div class='time-label' style='padding-left:"+c+"px'>"+this.timepoints[o]+"</div>"}c+=(t-1-o)*r,n+="<div class='time-label' style='padding-left:"+c+"px'>"+this.timepoints[t-1]+"</div>";var d=e/2*-1;this.wrapper.find(".label-div").css("margin-left",d).css("width","calc(100% + "+e+"px)"),this.wrapper.find(".label-div").html(n)}}}});
MapCloud.AQITimeLineChart=MapCloud.Class({server:null,sourceName:"base",layerName:"gc_aqi_ranking",interval:null,layers:null,aqiTimeLineBar:null,initialize:function(i,a,e,l){this.server=i,this.chartField=a,this.timepoints=e,this.interval=l,this.layers=[];var r=new MapCloud.AQITimeLineBar(this);this.aqiTimeLineBar=r;for(var t=null,n=0;n<this.timepoints.length;++n)if(t=e[n],null!=t){var s=new MapCloud.AQIChart(this.server,this.chartField,t);this.layers.push(s)}},show:function(){this.drawAQIChart(0)},drawAQIChart:function(i){var a=this.layers[i];null!=a&&a.show()},cleanup:function(){this.aqiTimeLineBar.cleanup();for(var i=0;i<this.layers.length;++i)this.layers[i].cleanup();Radi.Earth.cleanup()}});
MapCloud.AQITimeList=MapCloud.Class({server:null,sourceName:"base",layerName:"gc_aqi_uptime",timeField:"uptime",featureType:null,callback:null,initialize:function(e){this.server=e;var a=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(a,this.layerName)},get24hTimeList:function(e,a){if(null==e)return void(null!=a&&a("timepoint is null"));this.callback=a;var r=MapCloud.dateAdd(e,"day",-1),i=MapCloud.dateFormat(r,"yyyy-MM-dd hh:mm:ss"),t=new GeoBeans.BinaryLogicFilter;t.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var l=new GeoBeans.BinaryComparisionFilter;l.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(i),l.expression1=prop,l.expression2=literal;var o=new GeoBeans.BinaryComparisionFilter;o.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(e),o.expression1=prop,o.expression2=literal,t.addFilter(l),t.addFilter(o),this.featureType.getFields(null,this.sourceName);var s=[this.timeField];this.featureType.getFeaturesFilterAsync2(null,this.sourceName,t,24,0,s,null,this,this.getTimeList_callback)},getTimeList_callback:function(e,a){null!=e&&null!=a&&$.isArray(a)&&e.getTimeList(a)},getTimeList:function(e){if(null!=e){for(var a=null,r=null,i=null,t=[],l=this.featureType.getFieldIndex(this.timeField),o=0;o<e.length;++o)a=e[o],null!=a&&(r=a.values,null!=r&&(i=r[l],null!=i&&t.push(i)));null!=this.callback&&(this.callback(t),this.callback=null)}},getDayHourTimeList:function(e,a,r){if(null!=e&&null!=a){this.callback=r;var i=new GeoBeans.BinaryLogicFilter;i.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(e),t.expression1=prop,t.expression2=literal,i.addFilter(t);for(var l=MapCloud.dateAdd(e,"day",1),o=MapCloud.dateFormat(l,"yyyy-MM-dd hh:mm:ss");o!=a;){var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(o),s.expression1=prop,s.expression2=literal,i.addFilter(s),l=MapCloud.dateAdd(l,"day",1),o=MapCloud.dateFormat(l,"yyyy-MM-dd hh:mm:ss")}var n=new GeoBeans.BinaryComparisionFilter;n.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(a),n.expression1=prop,n.expression2=literal,i.addFilter(n),this.featureType.getFields(null,this.sourceName);var p=[this.timeField];this.featureType.getFeaturesFilterAsync2(null,this.sourceName,i,24,0,p,null,this,this.getTimeList_callback)}}});
MapCloud.AQITimeLinePanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},show:function(){this.panel.slideDown()},hide:function(){this.panel.slideUp()},registerEvent:function(){var i=this;this.panel.find(".aqi-24h").click(function(){i.show24AQITimeLineChart()}),this.panel.find(".start_form_datetime").datetimepicker({format:"yyyy-mm-dd",autoclose:!0,minView:"month",maxView:"year",language:"zh-CN"}).on("changeDate",function(i){}),this.panel.find(".end_form_datetime").datetimepicker({format:"yyyy-mm-dd",autoclose:!0,minView:"month",maxView:"year",language:"zh-CN"}).on("changeDate",function(i){}),this.panel.find(".btn-chart").click(function(){var e=i.panel.find(".timepoint").val(),a=i.panel.find(".start_form_datetime input").val();if(""==a)return void alert("请选择起始日期");var t=i.panel.find(".end_form_datetime input").val();if(""==t)return void alert("请选择终止日期");var n=a+" "+e,l=t+" "+e,o=new Date(n),r=new Date(l);return o>=r?void alert("请选择有效的时间段"):(i.cleanupChart(),void MapCloud.aqiTimeList.getDayHourTimeList(n,l,i.get24hTimeList_callback))}),this.panel.find(".btn-remove").click(function(){i.cleanupChart()})},show24AQITimeLineChart:function(){this.cleanupChart();var i=MapCloud.searchPanel.timepoint;MapCloud.aqiTimeList.get24hTimeList(i,this.get24hTimeList_callback)},get24hTimeList_callback:function(i){if($.isArray(i)){if(i.length<=1)return void alert("请选择有效的时间段");var e=(MapCloud.aqiTimelinePanel,MapCloud.server),a="aqi",t="3000",n=new MapCloud.AQITimeLineChart(e,a,i,t);n.show(),MapCloud.aqiTimeLineChart=n}},cleanupChart:function(){null!=MapCloud.aqiTimeLineChart&&(MapCloud.aqiTimeLineChart.cleanup(),MapCloud.aqiTimeLineChart=null),Radi.Earth.cleanup()}});
MapCloud.AQI24TimeLinePanel=MapCloud.Class(MapCloud.Panel,{initialize:function(i){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},registerEvent:function(){var i=this;this.panel.find(".aqi-24h").click(function(){i.show24AQITimeLineChart()}),this.panel.find(".start_form_datetime").datetimepicker({format:"yyyy-mm-dd",autoclose:!0,minView:"month",maxView:"year",language:"zh-CN"}).on("changeDate",function(e){var a=e.date;if(null!=a){var t=a.getUTCFullYear(),n=a.getUTCMonth(),l=a.getUTCDate(),o=(new Date(t+"-"+(n+1)+"-"+l+" 00:00:00"),i.panel.find(".aqi-start-time-points"),MapCloud.dateAdd(a,"day",1));o.setHours(0),i.panel.find(".timepoint").empty();var r=MapCloud.dateFormat(o,"yyyy-MM-dd hh:mm:ss");MapCloud.aqiTimeList.get24hTimeList(r,i.get24hTimeList_callback_2)}}),this.panel.find(".btn-chart").click(function(){var e=i.panel.find(".timepoint").val();return""==e?void alert("请设定一个时刻"):void MapCloud.aqiTimeList.get24hTimeList(e,i.get24hTimeList_callback)}),this.panel.find(".btn-remove").click(function(){i.cleanupChart()})},show:function(){var i=MapCloud.searchPanel.timepoint;if(null!=i){var e=i.slice(i.lastIndexOf(" ")+1,i.length);this.panel.find(".last-time").html(e)}this.panel.slideDown()},hide:function(){this.panel.slideUp()},show24AQITimeLineChart:function(){this.cleanupChart();var i=MapCloud.searchPanel.timepoint;MapCloud.aqiTimeList.get24hTimeList(i,this.get24hTimeList_callback)},get24hTimeList_callback:function(i){if($.isArray(i)){if(i.length<=1)return void alert("请选择有效的时间段");var e=MapCloud.aqi24TimelinePanel;e.cleanupChart();var a=MapCloud.server,t="aqi",n="3000",l=new MapCloud.AQITimeLineChart(a,t,i,n);l.show(),MapCloud.aqiTimeLineChart=l}},cleanupChart:function(){null!=MapCloud.aqiTimeLineChart&&(MapCloud.aqiTimeLineChart.cleanup(),MapCloud.aqiTimeLineChart=null),Radi.Earth.cleanup()},get24hTimeList_callback_2:function(i){if($.isArray(i)){if(i.length<=1)return void alert("请选择有效的时间段");var e=MapCloud.aqi24TimelinePanel;e.setTimepoints(i)}},setTimepoints:function(i){if(null!=i){for(var e=null,a="",t=0;t<i.length;++t)e=i[t],null!=e&&(a+="<option>"+e+"</option>");this.panel.find(".timepoint").html(a)}}});
MapCloud.ChartPanel=MapCloud.Class(MapCloud.Panel,{initialize:function(t){MapCloud.Panel.prototype.initialize.apply(this,arguments),this.registerEvent()},registerEvent:function(){var t=this;this.panel.find("[data-toggle='tooltip']").tooltip({container:"body"}),this.panel.find(".mc-stretch").click(function(){var i=t.panel.find(".chart-content-div");"none"==i.css("display")?($(this).removeClass("mc-icon-left"),$(this).addClass("mc-icon-right"),i.slideDown()):($(this).removeClass("mc-icon-right"),$(this).addClass("mc-icon-left"),i.slideUp())}),this.panel.find(".chart-content-div li").click(function(){var t=$(this).attr("mname");switch(t){}})},showFenghuangModel:function(){var t="./data/test/028.gltf",i=109.482,n=18.255,a=0;Radi.Earth.addModel(t,i,n,a,.01)}});
MapCloud.AddressService=MapCloud.Class({initialize:function(){},getAddress:function(e,n,t,s){if(null!=e&&null!=n&&null!=t){var a="/PADD_S_Match/addressService?",d=(new Date).getTime(),r="type=Geocode&mode=single&address="+e+"&timespan="+d+"&startIndex="+n+"&endIndex="+t,i=this;$.ajax({type:"get",url:a,data:r,contentType:"text/xml",dataType:"json",async:!0,beforeSend:function(e){},success:function(e,n){var t=i.parseAddress(e);void 0!=s&&s(t)},complete:function(e,n){},error:function(e,n,t){}})}},parseAddress:function(e){if(null==e)return null;var n=e.success;return 1!=n?n:e.data}});